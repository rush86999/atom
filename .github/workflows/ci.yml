name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: atom_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Free Disk Space (Ubuntu)
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/.ghcup
          sudo docker image prune -a -f

      - uses: actions/checkout@v4



      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Verify backend imports
        working-directory: ./backend
        env:
          DATABASE_URL: "sqlite:///:memory:"
          BYOK_ENCRYPTION_KEY: test_key_for_ci_only
          ENVIRONMENT: test
          ATOM_DISABLE_LANCEDB: true
          ATOM_MOCK_DATABASE: true
        run: |
          python debug_ci_imports.py

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-nextjs/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend-nextjs
        run: npm ci --legacy-peer-deps

      - name: Type check
        working-directory: ./frontend-nextjs
        run: npm run type-check || true

      - name: Lint
        working-directory: ./frontend-nextjs
        run: npm run lint || true

      - name: Build
        working-directory: ./frontend-nextjs
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8001
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: ci-test-secret-key
          SKIP_ENV_VALIDATION: true
        run: npm run build

      - name: Upload Frontend Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-nextjs-build
          path: frontend-nextjs/.next
          retention-days: 7
          if-no-files-found: warn

  docker-build:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-build]
    steps:
      - name: Free Disk Space (Ubuntu)
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/.ghcup
          sudo docker image prune -a -f

      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: atom-backend:ci
          cache-from: type=gha
          cache-to: type=gha,mode=min

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-nextjs
          file: ./frontend-nextjs/Dockerfile.production
          push: false
          tags: atom-frontend:ci
          cache-from: type=gha
          cache-to: type=gha,mode=min
          build-args: |
             SKIP_ENV_VALIDATION=true

  # Tauri build validation (multi-platform)
  tauri-build-check:
    needs: frontend-build
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            os: 'macos-13'
            artifacts_name: 'tauri-macos-builds'
            artifacts_path: |
              frontend-nextjs/src-tauri/target/release/bundle/dmg/*.dmg
              frontend-nextjs/src-tauri/target/release/bundle/macos/*.app
          - platform: 'ubuntu-22.04'
            os: 'linux'
            artifacts_name: 'tauri-linux-builds'
            artifacts_path: |
              frontend-nextjs/src-tauri/target/release/bundle/deb/*.deb
              frontend-nextjs/src-tauri/target/release/bundle/appimage/*.AppImage
          - platform: 'windows-latest'
            os: 'windows'
            artifacts_name: 'tauri-windows-builds'
            artifacts_path: |
              frontend-nextjs/src-tauri/target/release/bundle/msi/*.msi

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri dependencies (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        working-directory: ./frontend-nextjs
        run: npm ci --legacy-peer-deps

      - name: Build Next.js static export for Tauri
        working-directory: ./frontend-nextjs
        shell: bash
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8001
          SKIP_ENV_VALIDATION: true
        run: |
          # Create static export config
          cat > next.config.tauri.js << EOF
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            output: 'export',
            images: { unoptimized: true },
            typescript: { ignoreBuildErrors: true },
            eslint: { ignoreDuringBuilds: true },
          };
          module.exports = nextConfig;
          EOF

          # Backup and replace config
          if [ -f next.config.js ]; then mv next.config.js next.config.js.bak; fi
          mv next.config.tauri.js next.config.js

          npm run build

          # Restore config
          rm next.config.js
          if [ -f next.config.js.bak ]; then mv next.config.js.bak next.config.js; fi

      - name: Upload Static Export Artifacts (Linux only)
        if: matrix.os == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-static-export
          path: frontend-nextjs/out
          retention-days: 7
          if-no-files-found: warn

      - name: Verify Tauri config
        working-directory: ./frontend-nextjs
        run: |
          echo "Checking Tauri configuration..."
          cat src-tauri/tauri.conf.json | head -20
          echo "Tauri frontendDist: $(grep frontendDist src-tauri/tauri.conf.json)"

      - name: Build Tauri App
        working-directory: ./frontend-nextjs
        run: npm run tauri build -- --verbose

      - name: Upload Tauri Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifacts_name }}
          path: ${{ matrix.artifacts_path }}
          retention-days: 30
          if-no-files-found: warn

      - name: List Build Artifacts
        working-directory: ./frontend-nextjs
        shell: bash
        run: |
          echo "=== Tauri Build Artifacts (${{ matrix.os }}) ==="
          find src-tauri/target/release/bundle -type f 2>/dev/null | head -20 || echo "No bundle files found"
          echo ""
          echo "=== File Sizes ==="
          if [ "${{ matrix.os }}" = "windows" ]; then
            find src-tauri/target/release/bundle -type f -exec ls -lh {} \; 2>/dev/null || true
          else
            find src-tauri/target/release/bundle -type f -exec ls -lh {} \; | awk '{print $5, $9}' 2>/dev/null || true
          fi
