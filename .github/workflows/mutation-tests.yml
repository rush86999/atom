name: Mutation Tests

on:
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  mutation-tests:
    name: Mutation Testing (Weekly)
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      matrix:
        target-module:
          - financial_ops_engine
          - security
          - security_dependencies
          - episode_retrieval_service
          - episode_segmentation_service
          - agent_governance_service
          - governance_cache
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-testing.txt

      - name: Run mutation tests - ${{ matrix.target-module }}
        working-directory: ./backend
        env:
          DATABASE_URL: "sqlite:///:memory:"
          BYOK_ENCRYPTION_KEY: test_key_for_ci_only
          ENVIRONMENT: test
          ATOM_DISABLE_LANCEDB: true
          ATOM_MOCK_DATABASE: true
        run: |
          # Initialize mutmut
          mutmut init

          # Configure mutation score targets
          mutmut config set target_module core/${{ matrix.target-module }}

          # Run mutation testing
          mutmut run --paths-to-mutate core/${{ matrix.target-module }}.py --runner "pytest tests/"

          # Generate mutation report
          mutmut html

      - name: Check mutation score thresholds
        working-directory: ./backend
        run: |
          # Parse mutation score
          SCORE=$(mutmut results | grep "Mutation score" | awk '{print $3}' | sed 's/%//')

          # Define thresholds by module priority
          case "${{ matrix.target-module }}" in
            financial_ops_engine|security|security_dependencies)
              THRESHOLD=95
              ;;
            episode_retrieval_service|episode_segmentation_service|agent_governance_service)
              THRESHOLD=90
              ;;
            *)
              THRESHOLD=85
              ;;
          esac

          echo "Mutation score: $SCORE%"
          echo "Threshold: $THRESHOLD%"

          if [ "$SCORE" -lt "$THRESHOLD" ]; then
            echo "❌ Mutation score below threshold ($THRESHOLD%)"
            exit 1
          else
            echo "✅ Mutation score meets threshold"
          fi

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report-${{ matrix.target-module }}
          path: backend/html/
          retention-days: 30

      - name: Create mutation summary
        if: always()
        run: |
          echo "## Mutation Test Report - ${{ matrix.target-module }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check uploaded artifacts for detailed report" >> $GITHUB_STEP_SUMMARY

  mutation-summary:
    name: Mutation Testing Summary
    runs-on: ubuntu-latest
    needs: mutation-tests
    if: always()

    steps:
      - name: Mutation test summary
        run: |
          echo "## Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Weekly mutation testing completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Score Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "- Financial/Security: >95%" >> $GITHUB_STEP_SUMMARY
          echo "- Core Business Logic: >90%" >> $GITHUB_STEP_SUMMARY
          echo "- API/Tools: >85%" >> $GITHUB_STEP_SUMMARY
