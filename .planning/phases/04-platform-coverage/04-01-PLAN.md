---
phase: 04-platform-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/jest.setup.js
  - mobile/src/__tests__/helpers/mockExpoModules.ts
  - mobile/src/__tests__/helpers/testUtils.ts
  - mobile/package.json
autonomous: true

must_haves:
  truths:
    - "Developer can run Jest tests with npm test from mobile/ directory"
    - "Expo modules are mocked for camera, location, notifications, biometric"
    - "Test helpers provide Platform.OS mocking for iOS/Android testing"
    - "AsyncStorage is mocked for storage tests"
    - "Tests can be run with coverage reporting (npm run test:coverage)"
  artifacts:
    - path: "mobile/jest.setup.js"
      provides: "Jest global setup with Expo module mocks"
      min_lines: 30
    - path: "mobile/src/__tests__/helpers/mockExpoModules.ts"
      provides: "Centralized Expo module mocking utilities"
      min_lines: 80
    - path: "mobile/src/__tests__/helpers/testUtils.ts"
      provides: "Test utilities for Platform.OS mocking, cleanup"
      min_lines: 50
  key_links:
    - from: "mobile/jest.setup.js"
      to: "jest-expo preset"
      via: "setupFilesAfterEnv configuration"
      pattern: "setupFilesAfterEnv.*jest.setup"
---

<objective>
Create mobile test infrastructure with Jest, Expo module mocks, and test helpers to enable React Native component and service testing.

**Purpose:** Establish the testing foundation for mobile React Native components using jest-expo and React Native Testing Library. Without proper Expo module mocking, tests fail with native module errors. This plan creates reusable mock infrastructure for all subsequent mobile test plans.

**Output:**
- `jest.setup.js` with global Expo module mocks
- `mockExpoModules.ts` with centralized mock objects
- `testUtils.ts` with Platform.OS mocking and cleanup utilities
- Updated `package.json` scripts for test execution
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-platform-coverage/04-RESEARCH.md
@.planning/REQUIREMENTS.md

# Existing Patterns
@mobile/src/__tests__/services/offlineSync.test.ts
@mobile/package.json
@backend/tests/factories/base.py
</context>

<tasks>

<task type="auto">
  <name>Create Jest setup file with Expo module mocks</name>
  <files>mobile/jest.setup.js</files>
  <action>
    Create `mobile/jest.setup.js` with the following:
    1. Import @testing-library/jest-native for custom matchers
    2. Mock expo-camera with requestCameraPermissionsAsync, getCameraPermissionsAsync, takePictureAsync
    3. Mock expo-location with requestForegroundPermissionsAsync, getCurrentPositionAsync
    4. Mock expo-notifications with requestPermissionsAsync, scheduleNotificationAsync, getPermissionsAsync
    5. Mock expo-local-authentication with hasHardwareAsync, isEnrolledAsync, authenticateAsync
    6. Mock expo-secure-store with getItemAsync, setItemAsync, deleteItemAsync
    7. Mock @react-native-async-storage/async-storage with in-memory Map
    8. Mock expo-device with Device.osName, Device.deviceId

    Follow the offlineSync.test.ts mocking pattern as reference (lines 14-28). Each mock should return sensible defaults (granted permissions, successful operations).

    IMPORTANT: Do NOT duplicate existing mocks. The existing offlineSync.test.ts already mocks react-native-mmkv and AsyncStorage - ensure jest.setup.js provides compatible mocks.
  </action>
  <verify>
    Run `cd mobile && npm test -- --no-coverage` to verify Jest discovers tests and setup loads without errors
  </verify>
  <done>
    Jest setup file loads successfully with all Expo modules mocked, no "Cannot read property 'askAsync' of undefined" errors
  </done>
</task>

<task type="auto">
  <name>Create centralized Expo module mock helpers</name>
  <files>mobile/src/__tests__/helpers/mockExpoModules.ts</files>
  <action>
    Create `mobile/src/__tests__/helpers/mockExpoModules.ts` with:
    1. MockCamera object with configurable permission status and photo capture
    2. MockLocation object with configurable permissions and coordinates
    3. MockNotifications object with permission states and notification scheduling
    4. MockLocalAuthentication object with hardware availability and auth results
    5. MockSecureStore object with in-memory storage (Map)
    6. MockAsyncStorage object with in-memory storage
    7. Helper function `resetAllMocks()` to clear mock state between tests
    8. Helper function `setPermissionGranted(module, granted)` to control permission test scenarios

    Each mock should be exportable so individual tests can import and configure them for specific test scenarios (granted/denied permissions).

    Pattern reference: The offlineSync.test.ts uses jest.mock() directly - this file centralizes that pattern.
  </action>
  <verify>
    Create a simple test file `mobile/src/__tests__/helpers/__tests__/mockExpoModules.test.ts` that imports each mock and verifies they are callable
  </verify>
  <done>
    All mock objects export correctly and can be imported by test files, resetAllMocks() clears mock state
  </done>
</task>

<task type="auto">
  <name>Create test utilities for Platform.OS mocking</name>
  <files>mobile/src/__tests__/helpers/testUtils.ts</files>
  <action>
    Create `mobile/src/__tests__/helpers/testUtils.ts` with:
    1. `mockPlatform(platform: 'ios' | 'android')` function that uses jest.spyOn(Platform, 'OS', 'get')
    2. `restorePlatform()` function to restore original Platform.OS
    3. `mockDevice(deviceInfo)` helper for expo-device mocking
    4. `createMockTestComponent()` helper for rendering components with default props
    5. `waitForAsync()` wrapper around React Native Testing Library's waitFor with timeout
    6. `flushPromises()` helper to resolve all pending promises
    7. Export cleanup utilities that can be used in afterEach blocks

    Platform.OS mocking is critical for MOBL-03 (platform-specific permission tests). The pattern uses:
    ```typescript
    jest.spyOn(Platform, 'OS', 'get').mockReturnValue('ios');
    jest.restoreAllMocks();
    ```
  </action>
  <verify>
    Create a test that mocks Platform.OS to 'ios', then 'android', verifying the mock returns correct values
  </verify>
  <done>
    Platform.OS mocking works correctly, cleanup functions restore original state
  </done>
</task>

</tasks>

<verification>
1. Run `npm test` from mobile/ directory - Jest should discover tests without errors
2. Run `npm run test:coverage` - Coverage report should generate successfully
3. Verify all Expo modules mocked: no "undefined" errors when importing expo-* modules in tests
4. Test helpers are importable from `__tests__/helpers/` directory
5. Platform.OS mocking switches between ios/android correctly
</verification>

<success_criteria>
1. Jest executes tests successfully with jest-expo preset
2. All 5 Expo modules (camera, location, notifications, local-authentication, secure-store) are mocked
3. AsyncStorage is mocked with in-memory storage
4. Platform.OS can be mocked to 'ios' or 'android' for platform-specific testing
5. Test helpers are exported and importable by test files
6. Coverage reporting works with npm run test:coverage
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-coverage/04-01-SUMMARY.md` with:
- List of all mocks created (camera, location, notifications, biometric, storage)
- Test helper utilities available for subsequent plans
- Any issues encountered with Expo module mocking
- Notes on platform-specific testing setup
</output>
