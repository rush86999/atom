---
phase: 04-platform-coverage
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - mobile/src/__tests__/contexts/AuthContext.test.tsx
  - mobile/src/__tests__/contexts/DeviceContext.test.tsx
  - mobile/src/__tests__/helpers/platformPermissions.test.ts
autonomous: true

must_haves:
  truths:
    - "AuthContext tests verify login, logout, biometric auth, token refresh"
    - "DeviceContext tests verify device registration, capability checks, permission handling"
    - "Platform-specific permission tests verify iOS vs Android permission differences"
    - "Platform.OS mocking correctly switches between iOS and Android behavior"
  artifacts:
    - path: "mobile/src/__tests__/contexts/AuthContext.test.tsx"
      provides: "AuthContext provider tests with biometric authentication"
      min_lines: 150
    - path: "mobile/src/__tests__/contexts/DeviceContext.test.tsx"
      provides: "DeviceContext provider tests with permission handling"
      min_lines: 150
    - path: "mobile/src/__tests__/helpers/platformPermissions.test.ts"
      provides: "Platform-specific permission test utilities"
      min_lines: 100
  key_links:
    - from: "AuthContext.test.tsx"
      to: "AuthContext.tsx"
      via: "import { AuthProvider, useAuth }"
      pattern: "from.*AuthContext"
    - from: "DeviceContext.test.tsx"
      to: "DeviceContext.tsx"
      via: "import { DeviceProvider, useDevice }"
      pattern: "from.*DeviceContext"
    - from: "platformPermissions.test.ts"
      to: "testUtils.ts"
      via: "import { mockPlatform }"
      pattern: "from.*testUtils"
---

<objective>
Create authentication and device context tests with platform-specific permission handling for iOS and Android.

**Purpose:** Test React Context providers that manage authentication state and device capabilities. These contexts are critical for mobile app functionality and handle biometric authentication, device registration, and permission requests that differ between iOS and Android platforms.

**Output:**
- `AuthContext.test.tsx` - Tests for authentication flows including login, logout, biometric auth, token management
- `DeviceContext.test.tsx` - Tests for device registration, capability checks, permission handling
- `platformPermissions.test.ts` - Platform-specific permission test utilities and scenarios
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-platform-coverage/04-RESEARCH.md
@.planning/REQUIREMENTS.md

# Existing Patterns
@mobile/src/__tests__/services/offlineSync.test.ts
@mobile/src/contexts/AuthContext.tsx
@mobile/src/contexts/DeviceContext.tsx
@.planning/phases/04-platform-coverage/04-01-PLAN.md
@.planning/phases/04-platform-coverage/04-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Create AuthContext tests with login, biometric, and token flows</name>
  <files>mobile/src/__tests__/contexts/AuthContext.test.tsx</files>
  <action>
    Create `mobile/src/__tests__/contexts/AuthContext.test.tsx` with:
    1. Mock expo-secure-store, expo-local-authentication, AsyncStorage before imports
    2. Test suite for login flow with valid/invalid credentials
    3. Test suite for token storage in SecureStore (access token, refresh token)
    4. Test suite for biometric authentication (hasHardware, isEnrolled, authenticate success/failure)
    5. Test suite for token refresh before expiry
    6. Test suite for logout and token cleanup
    7. Test suite for authentication state persistence across app restarts

    Use React Native Testing Library for context provider rendering:
    ```typescript
    import { render, screen, waitFor, act } from '@testing-library/react-native';
    import { AuthProvider, useAuth } from '../../contexts/AuthContext';

    const TestComponent = () => {
      const { login, logout, isAuthenticated } = useAuth();
      return <TestWrapper />;
    };
    ```

    Mock fetch for API calls (login endpoint, token refresh endpoint).

    IMPORTANT: The AuthContext.tsx already exists (15099 lines). Read it carefully to understand actual implementation before writing tests. Focus on testing the public interface: login, logout, refreshToken, registerBiometric, authenticateWithBiometric, isBiometricAvailable, registerDevice.

    NOTE: Add TODO comments for any methods referenced but not yet implemented.
  </action>
  <verify>
    Run `cd mobile && npm test -- AuthContext.test.tsx` - all tests pass
  </verify>
  <done>
    AuthContext tests cover login, logout, biometric auth, token refresh, state persistence with >75% coverage
  </done>
</task>

<task type="auto">
  <name>Create DeviceContext tests with registration and capability checks</name>
  <files>mobile/src/__tests__/contexts/DeviceContext.test.tsx</files>
  <action>
    Create `mobile/src/__tests__/contexts/DeviceContext.test.tsx` with:
    1. Mock expo-device, AsyncStorage, and capability modules (Camera, Location, Notifications, LocalAuthentication)
    2. Test suite for device registration with push token
    3. Test suite for capability permission requests (camera, location, notifications, biometric)
    4. Test suite for device state persistence (deviceId, deviceToken, capabilities)
    5. Test suite for device sync with backend
    6. Test suite for device unregistration
    7. Test suite for capability checking (isSupported, isEnabled)

    Use Platform.OS mocking to test iOS vs Android behavior:
    ```typescript
    import { mockPlatform, restorePlatform } from '../helpers/testUtils';

    beforeEach(() => {
      mockPlatform('ios');
    });

    afterEach(() => {
      restorePlatform();
    });
    ```

    Mock fetch for device registration API calls.

    IMPORTANT: The DeviceContext.tsx already exists (15343 lines). Read it carefully to understand actual implementation. Test the public interface: registerDevice, updateDeviceToken, requestCapability, checkCapability, syncDevice, unregisterDevice.

    Test platform-specific behavior:
    - iOS: Different permission request strings, biometric types (Face ID vs Touch ID)
    - Android: Different permission strings, fingerprint biometric only
  </action>
  <verify>
    Run `cd mobile && npm test -- DeviceContext.test.tsx` - all tests pass
  </verify>
  <done>
    DeviceContext tests cover registration, capabilities, permissions, sync with >75% coverage
  </done>
</task>

<task type="auto">
  <name>Create platform-specific permission test utilities and scenarios</name>
  <files>mobile/src/__tests__/helpers/platformPermissions.test.ts</files>
  <action>
    Create `mobile/src/__tests__/helpers/platformPermissions.test.ts` with:
    1. Test utilities for iOS permission scenarios (NSCameraUsageDescription, NSLocationWhenInUseUsageDescription)
    2. Test utilities for Android permission scenarios (CAMERA, ACCESS_FINE_LOCATION in AndroidManifest.xml)
    3. Test suite for iOS-specific permission flows (incremental permissions in iOS 14+)
    4. Test suite for Android-specific permission flows (runtime permissions, rationale display)
    5. Test suite for permission denial handling (don't ask again on Android)
    6. Test suite for background location permission (always-allow on iOS, background location on Android)

    This file serves as both documentation and test utilities for platform differences.

    Use test.each() for running the same test on both platforms:
    ```typescript
    describe.each(['ios', 'android'])('Camera permission on %s', (platform) => {
      beforeEach(() => {
        mockPlatform(platform);
      });

      it('requests camera permission on mount', async () => {
        // Test implementation
      });
    });
    ```

    Document key differences:
    - iOS: Permission description strings in Info.plist, one-time prompt, Settings app for changes
    - Android: Runtime permissions, can request again after denial, "Don't ask again" checkbox

    NOTE: These tests validate the permission handling logic exists. Add TODO comments for any platform-specific behavior not yet implemented.
  </action>
  <verify>
    Run `cd mobile && npm test -- platformPermissions.test.ts` - all tests pass
  </verify>
  <done>
    Platform permission tests document iOS vs Android differences and validate permission handling for both platforms
  </done>
</task>

</tasks>

<verification>
1. Run `npm test` from mobile/ - all context tests pass
2. Verify Platform.OS mocking switches between iOS and Android correctly
3. Check coverage report with `npm run test:coverage` - target >75% for contexts
4. Verify biometric authentication tests cover both Face ID (iOS) and fingerprint (Android)
5. Verify permission denial scenarios are tested
6. Verify device state persistence is tested ( AsyncStorage mocks)
</verification>

<success_criteria>
1. AuthContext tests cover login, logout, biometric auth, token refresh, state persistence
2. DeviceContext tests cover registration, capabilities, permissions, sync
3. Platform-specific permission tests document iOS vs Android differences
4. Platform.OS mocking works correctly in all tests
5. Coverage >75% for both context providers
6. All tests use React Native Testing Library patterns
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-coverage/04-03-SUMMARY.md` with:
- Coverage metrics for AuthContext and DeviceContext
- List of platform-specific permission differences documented
- Any implementation gaps discovered
- Notes on biometric authentication testing limitations (mocks vs real devices)
</output>
