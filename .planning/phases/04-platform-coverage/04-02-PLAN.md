---
phase: 04-platform-coverage
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - mobile/src/__tests__/services/cameraService.test.ts
  - mobile/src/__tests__/services/locationService.test.ts
  - mobile/src/__tests__/services/notificationService.test.ts
  - mobile/src/__tests__/services/biometricService.test.ts
autonomous: true

must_haves:
  truths:
    - "Camera service tests verify permission requests, photo capture, error handling"
    - "Location service tests verify permission requests, position retrieval, geocoding"
    - "Notification service tests verify permission requests, scheduling, cancellation"
    - "Biometric service tests verify hardware detection, enrollment status, authentication"
    - "All tests pass with mocked Expo modules"
  artifacts:
    - path: "mobile/src/__tests__/services/cameraService.test.ts"
      provides: "Camera service unit tests with Expo mocks"
      min_lines: 80
    - path: "mobile/src/__tests__/services/locationService.test.ts"
      provides: "Location service unit tests with Expo mocks"
      min_lines: 80
    - path: "mobile/src/__tests__/services/notificationService.test.ts"
      provides: "Notification service unit tests with Expo mocks"
      min_lines: 80
    - path: "mobile/src/__tests__/services/biometricService.test.ts"
      provides: "Biometric service unit tests with Expo mocks"
      min_lines: 80
  key_links:
    - from: "cameraService.test.ts"
      to: "mockExpoModules.ts"
      via: "import { mockCamera }"
      pattern: "import.*mockExpoModules"
    - from: "locationService.test.ts"
      to: "locationService.ts"
      via: "import { locationService }"
      pattern: "from.*locationService"
    - from: "notificationService.test.ts"
      to: "expo-notifications mock"
      via: "jest.mock"
      pattern: "jest.mock.*expo-notifications"
    - from: "biometricService.test.ts"
      to: "expo-local-authentication mock"
      via: "jest.mock"
      pattern: "jest.mock.*expo-local-authentication"
---

<objective>
Create device capability service tests for Camera, Location, Notifications, and Biometric using Expo module mocks.

**Purpose:** Validate mobile device capability services work correctly with native modules. These services wrap Expo modules and need to handle permission requests, error scenarios, and platform differences. Tests ensure the services correctly delegate to Expo modules and handle failures gracefully.

**Output:**
- `cameraService.test.ts` - Tests camera permission, capture, error handling
- `locationService.test.ts` - Tests location permission, position retrieval, geocoding
- `notificationService.test.ts` - Tests notification permissions, scheduling, cancellation
- `biometricService.test.ts` - Tests biometric hardware detection, authentication
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-platform-coverage/04-RESEARCH.md
@.planning/REQUIREMENTS.md

# Existing Patterns
@mobile/src/__tests__/services/offlineSync.test.ts
@mobile/src/services/cameraService.ts
@mobile/src/services/locationService.ts
@mobile/src/services/notificationService.test.ts
@.planning/phases/04-platform-coverage/04-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Create camera service tests with permission and capture scenarios</name>
  <files>mobile/src/__tests__/services/cameraService.test.ts</files>
  <action>
    Create `mobile/src/__tests__/services/cameraService.test.ts` with:
    1. Mock expo-camera before importing cameraService
    2. Test suite for permission requests (granted, denied, undetermined)
    3. Test suite for photo capture with success/failure scenarios
    4. Test suite for camera availability checking
    5. Test error handling for camera not available, permission denied
    6. Test platform-specific camera types (front/back for iOS vs Android)

    Use jest.mock for expo-camera:
    ```typescript
    jest.mock('expo-camera', () => ({
      Camera: {
        requestCameraPermissionsAsync: jest.fn(),
        getCameraPermissionsAsync: jest.fn(),
      },
      Constants: {
        Type: { back: 'back', front: 'front' }
      }
    }));
    ```

    Follow the offlineSync.test.ts structure (lines 44-60) for test organization with describe blocks.

    NOTE: Check if cameraService.ts exists first. If not implemented, add TODO comments indicating tests are ready for implementation.
  </action>
  <verify>
    Run `cd mobile && npm test -- cameraService.test.ts` - all tests pass
  </verify>
  <done>
    Camera service tests cover permissions, capture, availability, error handling with >80% coverage of cameraService.ts
  </done>
</task>

<task type="auto">
  <name>Create location service tests with permission and position scenarios</name>
  <files>mobile/src/__tests__/services/locationService.test.ts</files>
  <action>
    Create `mobile/src/__tests__/services/locationService.test.ts` with:
    1. Mock expo-location before importing locationService
    2. Test suite for foreground permission requests (granted, denied)
    3. Test suite for getCurrentPosition with valid coordinates
    4. Test suite for geocoding (reverse geocoding if supported)
    5. Test error handling for location disabled, timeout scenarios
    6. Test accuracy levels (low, balanced, high, highest)

    Use jest.mock for expo-location with configurable mock results:
    ```typescript
    jest.mock('expo-location', () => ({
      requestForegroundPermissionsAsync: jest.fn(),
      getCurrentPositionAsync: jest.fn(),
      getForegroundPermissionsAsync: jest.fn(),
    }));
    ```

    Test both success scenarios (returns coords object) and failure scenarios (throws error, returns null).

    NOTE: Check if locationService.ts exists first. If not implemented, add TODO comments.
  </action>
  <verify>
    Run `cd mobile && npm test -- locationService.test.ts` - all tests pass
  </verify>
  <done>
    Location service tests cover permissions, position retrieval, geocoding, error handling with >80% coverage
  </done>
</task>

<task type="auto">
  <name>Create notification service tests with scheduling and cancellation</name>
  <files>mobile/src/__tests__/services/notificationService.test.ts</files>
  <action>
    Create `mobile/src/__tests__/services/notificationService.test.ts` with:
    1. Mock expo-notifications before importing notificationService
    2. Test suite for notification permission requests (granted, denied)
    3. Test suite for scheduling notifications with content, trigger, repeats
    4. Test suite for canceling scheduled notifications (single, all)
    5. Test suite for getting pending/scheduled notification list
    6. Test error handling for invalid triggers, missing permissions

    Use jest.mock for expo-notifications:
    ```typescript
    jest.mock('expo-notifications', () => ({
      requestPermissionsAsync: jest.fn(),
      getPermissionsAsync: jest.fn(),
      scheduleNotificationAsync: jest.fn(),
      cancelScheduledNotificationAsync: jest.fn(),
      getAllScheduledNotificationsAsync: jest.fn(),
    }));
    ```

    Test notification content object structure: { title, body, data, sound, badge }.

    NOTE: The existing notificationService.ts exists - verify the implementation and match test expectations to actual service methods.
  </action>
  <verify>
    Run `cd mobile && npm test -- notificationService.test.ts` - all tests pass
  </verify>
  <done>
    Notification service tests cover permissions, scheduling, cancellation, listing with >80% coverage
  </done>
</task>

<task type="auto">
  <name>Create biometric service tests with hardware and authentication scenarios</name>
  <files>mobile/src/__tests__/services/biometricService.test.ts</files>
  <action>
    Create `mobile/src/__tests__/services/biometricService.test.ts` with:
    1. Mock expo-local-authentication before importing
    2. Test suite for hardware availability (hasHardwareAsync)
    3. Test suite for enrollment check (isEnrolledAsync)
    4. Test suite for authentication success/failure/cancellation
    5. Test suite for biometric type detection (Face ID vs Touch ID on iOS, fingerprint on Android)
    6. Test error handling for no hardware, not enrolled, user cancellation

    Use jest.mock for expo-local-authentication:
    ```typescript
    jest.mock('expo-local-authentication', () => ({
      hasHardwareAsync: jest.fn(),
      isEnrolledAsync: jest.fn(),
      authenticateAsync: jest.fn(),
      supportedAuthenticationTypesAsync: jest.fn(() => Promise.resolve([1, 2])),
    }));
    ```

    Test authentication result object: { success, error }.

    NOTE: Biometric functionality may be in AuthContext.tsx rather than a separate service. If so, test the relevant biometric methods there.
  </action>
  <verify>
    Run `cd mobile && npm test -- biometricService.test.ts` - all tests pass
  </verify>
  <done>
    Biometric service tests cover hardware detection, enrollment, authentication success/failure with >80% coverage
  </done>
</task>

</tasks>

<verification>
1. Run `npm test` from mobile/ - all device capability tests pass
2. Verify each service test file imports and uses the correct Expo module mocks
3. Check coverage report with `npm run test:coverage` - target >80% for tested services
4. Verify permission-denied scenarios are tested (not just happy path)
5. Verify error handling is tested (module errors, timeouts, unavailability)
</verification>

<success_criteria>
1. All 4 device capability test files created and passing
2. Expo modules properly mocked using jest.mock()
3. Permission-granted and permission-denied scenarios tested
4. Error handling tested for each service
5. Coverage >80% for implemented service code
6. Tests follow the offlineSync.test.ts pattern for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-coverage/04-02-SUMMARY.md` with:
- Coverage metrics for each service tested
- List of permission scenarios tested (granted/denied/undetermined)
- Any implementation gaps discovered (services not yet implemented)
- Notes on platform-specific behavior differences
</output>
