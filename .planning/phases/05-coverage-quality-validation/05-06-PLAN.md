---
phase: 05-coverage-quality-validation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile/src/__tests__/contexts/DeviceContext.test.tsx
  - mobile/src/__tests__/helpers/platformPermissions.test.ts
  - mobile/package.json
  - mobile/jest.config.js
autonomous: true

must_haves:
  truths:
    - "Mobile app achieves 80% test coverage for React Native components and services"
    - "Device context provider has tests for device registration and permission handling"
    - "Platform-specific permission tests verify iOS vs Android differences"
    - "Expo SDK 50 + Jest compatibility blocker is resolved"
    - "Mobile coverage is tracked in CI/CD"
  artifacts:
    - path: "mobile/src/__tests__/contexts/DeviceContext.test.tsx"
      provides: "DeviceContext provider tests with permission handling"
      contains: "describe.*DeviceContext"
    - path: "mobile/src/__tests__/helpers/platformPermissions.test.ts"
      provides: "Platform-specific permission test utilities"
      contains: "describe.*PlatformPermissions"
    - path: "mobile/package.json"
      provides: "Updated with coverage tracking scripts"
      contains: "test:coverage"
    - path: "mobile/jest.config.js"
      provides: "Jest configuration with 80% coverage threshold"
      contains: "coverageThreshold"
  key_links:
    - from: "DeviceContext.test.tsx"
      to: "src/contexts/DeviceContext.tsx"
      via: "direct imports and expo module mocks"
      pattern: "from.*DeviceContext"
    - from: "platformPermissions.test.ts"
      to: "src/__tests__/helpers/mockExpoModules.ts"
      via: "shared permission mocking utilities"
      pattern: "from.*mockExpoModules"
---

<objective>
Resolve Expo SDK 50 + Jest compatibility blocker and achieve 80% mobile test coverage. This plan completes the mobile coverage requirements for Phase 5.

Purpose: Phase 4 created extensive mobile tests (458 passing, 95% pass rate) but was blocked by Expo SDK 50's babel transformation to `expo/virtual/env` which prevents AuthContext and DeviceContext tests from running. This plan resolves that blocker and completes mobile coverage to 80%.

**Context from Phase 4:**
- Mobile tests: 458 passing (94% pass rate)
- Blocked tests: AuthContext (1100+ lines), DeviceContext (not created), biometric tests (347 lines)
- Root cause: `process.env.EXPO_PUBLIC_API_URL` triggers babel transformation to `expo/virtual/env`
- Screen components: 167 tests passing (WorkflowsList, AgentChat, CanvasViewer, Settings)
- Device capabilities: 76 tests passing (Camera 38, Location 38), Notification partial (11/19), Biometric blocked

Output: Resolved expo/virtual/env blocker, DeviceContext tests, platform permission tests, 80% mobile coverage achieved.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-coverage-quality-validation/05-RESEARCH.md
@.planning/phases/04-platform-coverage/04-PLATFORM-COVERAGE-VERIFICATION.md

@mobile/src/contexts/DeviceContext.tsx
@mobile/src/contexts/AuthContext.tsx
@mobile/jest.setup.js
@mobile/package.json
@mobile/src/__tests__/contexts/AuthContext.test.tsx
@mobile/src/__tests__/contexts/AuthContext.biometric.test.ts
@mobile/src/__tests__/helpers/mockExpoModules.ts

# Phase 4 created 458 passing mobile tests but was blocked by expo/virtual/env
# This plan resolves the blocker and completes mobile coverage to 80%
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resolve Expo SDK 50 + Jest compatibility blocker</name>
  <files>mobile/src/contexts/AuthContext.tsx mobile/src/contexts/DeviceContext.tsx</files>
  <action>
Resolve the expo/virtual/env blocker that prevents AuthContext and DeviceContext tests from running:

**Problem:** babel-preset-expo transforms `process.env.EXPO_PUBLIC_API_URL` to `import { env } from 'expo/virtual/env'` which doesn't exist in Jest.

**Solution:** Modify AuthContext.tsx and DeviceContext.tsx to use Constants.expoConfig pattern instead:

1. **Update AuthContext.tsx** (line 73):
   - Before: `const API_BASE_URL = process.env.EXPO_PUBLIC_API_URL || 'http://localhost:8000';`
   - After: `const API_BASE_URL = Constants.expoConfig?.extra?.apiUrl || 'http://localhost:8000';`
   - Add import: `import Constants from 'expo-constants';`

2. **Update DeviceContext.tsx** (line 64):
   - Same pattern as AuthContext
   - Use Constants.expoConfig for environment variables

3. **Update app.config.js or app.json**:
   - Add `extra.apiUrl` to expo config
   - Example: `"extra": { "apiUrl": "http://localhost:8000" }`

4. **Create Jest mock for expo-constants**:
   - Add to jest.setup.js: `Constants.expoConfig = { extra: { apiUrl: 'http://localhost:8000' } };`

5. **Verify AuthContext tests now run**:
   - Run: `npm test -- AuthContext.test.tsx`
   - Verify no expo/virtual/env errors

DO NOT downgrade Expo SDK (would break other dependencies).
DO NOT create custom babel preset (too complex).
Use Constants.expoConfig pattern which is Expo-recommended.
  </action>
  <verify>
# Verify expo/virtual/env is no longer imported
! grep -r "expo/virtual/env" mobile/src/contexts/

# Verify Constants.expoConfig pattern is used
grep -q "Constants.expoConfig" mobile/src/contexts/AuthContext.tsx
grep -q "Constants.expoConfig" mobile/src/contexts/DeviceContext.tsx

# Verify AuthContext tests now run
cd mobile && npm test -- AuthContext.test.tsx --passWithNoTests 2>&1 | grep -v "expo/virtual/env"
  </verify>
  <done>
expo/virtual/env references removed from contexts/
Constants.expoConfig pattern implemented in AuthContext and DeviceContext
expo-constants mock added to jest.setup.js
AuthContext tests run without expo/virtual/env errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DeviceContext tests</name>
  <files>mobile/src/__tests__/contexts/DeviceContext.test.tsx</files>
  <action>
Create comprehensive DeviceContext tests covering:

1. **Device registration**:
   - Test device registration with device ID
   - Test device info collection (platform, OS version, app version)
   - Test registration error handling

2. **Capability checking**:
   - Test checking device capabilities (camera, location, notifications)
   - Test capability updates after permission changes
   - Test capability caching

3. **Permission handling**:
   - Test permission request flow
   - Test permission status updates
   - Test iOS vs Android permission differences
   - Test permission denial handling

4. **Device state management**:
   - Test device state (registered, unregistered, pending)
   - Test device info updates
   - Test context re-renders on state change

5. **Integration with AuthContext**:
   - Test device registration after authentication
   - Test device cleanup on logout
   - Test device token management

Use React Testing Library for component testing.
Mock Expo modules using mockExpoModules.ts.
Follow patterns from AuthContext.test.tsx (1100+ lines already written).

DO NOT duplicate AuthContext tests.
Focus on device-specific functionality (registration, capabilities, permissions).
  </action>
  <verify>
cd mobile && npm test -- DeviceContext.test.tsx
grep -q "describe.*DeviceContext" mobile/src/__tests__/contexts/DeviceContext.test.tsx
  </verify>
  <done>
DeviceContext.test.tsx created with comprehensive tests
Tests for device registration, capability checking, permission handling
All DeviceContext tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Create platform-specific permission tests</name>
  <files>mobile/src/__tests__/helpers/platformPermissions.test.ts</files>
  <action>
Create platform-specific permission test utilities and tests covering:

1. **iOS permission tests**:
   - Test iOS-specific permission prompts (NSCameraUsageDescription, etc.)
   - Test iOS permission flow (prompt -> allow/deny)
   - Test iOS permission settings deep link

2. **Android permission tests**:
   - Test Android runtime permissions (API 23+)
   - Test Android permission rationale display
   - Test Android "Don't ask again" handling

3. **Cross-platform utilities**:
   - Test Platform.OS detection for iOS vs Android
   - Test permission request abstraction layer
   - Test permission status normalization

4. **Permission edge cases**:
   - Test permission revoked during app use
   - Test permission prompt cancellation
   - Test permission recovery flow

5. **Test utilities export**:
   - Export mockPermission utility for use in other tests
   - Export createPermissionMock for dynamic mock creation
   - Export assertPermissionRequested assertion helper

Use Platform.OS from react-native for platform detection.
Follow patterns from testUtils.test.ts (24 tests passing).
Mock expo modules using mockExpoModules.ts.

DO NOT test actual native permission prompts (Jest can't do that).
Focus on permission logic and flow handling.
  </action>
  <verify>
cd mobile && npm test -- platformPermissions.test.ts
grep -q "describe.*PlatformPermissions\|describe.*platform.*permission" mobile/src/__tests__/helpers/platformPermissions.test.ts
  </verify>
  <done>
platformPermissions.test.ts created with iOS/Android permission tests
Permission utilities exported for reuse
All platform permission tests pass
  </done>
</task>

<task type="auto">
  <name>Task 4: Configure 80% coverage threshold for mobile</name>
  <files>mobile/package.json mobile/jest.config.js</files>
  <action>
Configure Jest to enforce 80% coverage threshold for mobile:

1. **Update package.json**:
   - Ensure test:coverage script exists: `"test:coverage": "jest --coverage"`
   - Add coverage output directory: `"--coverageDirectory='coverage/'"`
   - Add coverage reporters: `"--coverageReporters='json' 'lcov' 'text'"`

2. **Update or create jest.config.js**:
   - Set collectCoverageFrom to include src/ but exclude mocks/stories
   - Set coverageThreshold to 80% for global (lines, branches, functions, statements)
   - Exclude test files from coverage calculation

3. **Configure mobile-specific coverage targets**:
   - Services: 80% coverage target
   - Contexts: 80% coverage target
   - Screens: 80% coverage target
   - Helpers: 80% coverage target

4. **Create .gitignore rule for coverage**:
   - Ignore coverage/ directory (generated reports)
   - Keep coverage JSON for CI/CD tracking

5. **Document coverage reporting**:
   - Add comment to package.json explaining coverage scripts
   - Document how to run coverage locally vs CI

DO NOT set threshold to 100% (too strict, diminishing returns).
DO NOT exclude significant source files from coverage.
Set realistic 80% threshold aligned with Phase 5 goals.
  </action>
  <verify>
# Verify coverage script exists
grep -q "test:coverage" mobile/package.json

# Verify coverage threshold is configured
grep -q "coverageThreshold" mobile/jest.config.js
grep -q "80" mobile/jest.config.js

# Verify coverage can be generated
cd mobile && npm run test:coverage 2>&1 | grep -E "All files|statements|branches"
  </verify>
  <done>
package.json has test:coverage script with proper flags
jest.config.js has 80% coverage threshold configured
coverage/ directory in .gitignore
Coverage reports generate successfully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify blocker is resolved:
   ```bash
   cd mobile
   npm test -- AuthContext.test.tsx
   npm test -- DeviceContext.test.tsx
   # Should pass without expo/virtual/env errors
   ```

2. Verify all mobile tests pass:
   ```bash
   cd mobile && npm test
   # Should show 600+ tests passing (was 458 before)
   ```

3. Verify coverage threshold is met:
   ```bash
   cd mobile && npm run test:coverage
   # Should show >=80% coverage overall
   ```

4. Verify platform-specific tests:
   ```bash
   cd mobile && npm test -- platformPermissions.test.ts
   # Should verify iOS vs Android permission handling
   ```

5. Check coverage report:
   ```bash
   cat mobile/coverage/coverage-summary.json | jq '.total'
   # Should show lines.pct >= 80
   ```
</verification>

<success_criteria>
1. expo/virtual/env blocker is resolved (no errors in AuthContext/DeviceContext tests)
2. AuthContext tests (1100+ lines) now execute successfully
3. DeviceContext tests created and passing
4. Platform permission tests created and passing
5. Mobile coverage >= 80% (verified by npm run test:coverage)
6. All mobile tests pass (600+ tests, up from 458)
</success_criteria>

<output>
After completion, create `.planning/phases/05-coverage-quality-validation/05-06-SUMMARY.md` with:
- Blocker resolution details (expo/virtual/env fix)
- Mobile coverage achieved (target 80%)
- Total number of mobile tests (was 458, should be 600+)
- New test files created (DeviceContext, platformPermissions)
- Next steps for mobile testing
</output>
