---
phase: 68-byok-cognitive-tier-system
plan: 05
type: execute
wave: 2
depends_on: [68-01, 68-02]
files_modified:
  - backend/core/models.py
  - backend/alembic/versions/xxx_add_cognitive_tier_preference.py
  - backend/api/cognitive_tier_routes.py
  - backend/tests/test_cognitive_tier_api.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - REST API endpoints for tier preference management (GET, POST, PUT, DELETE)
    - CognitiveTierPreference model stores per-workspace tier settings
    - Cost estimation endpoint returns projected costs per tier
    - Tier comparison endpoint shows quality vs cost tradeoffs
    - All endpoints require authentication (AUTONOMOUS governance)
  artifacts:
    - path: backend/core/models.py
      provides: CognitiveTierPreference database model
      contains: "class CognitiveTierPreference"
    - path: backend/alembic/versions/xxx_add_cognitive_tier_preference.py
      provides: Database migration for tier preferences
      min_lines: 50
    - path: backend/api/cognitive_tier_routes.py
      provides: REST API for tier management
      min_lines: 350
    - path: backend/tests/test_cognitive_tier_api.py
      provides: API endpoint tests
      min_lines: 400
  key_links:
    - from: backend/api/cognitive_tier_routes.py
      to: backend/core/models.py
      via: from core.models import CognitiveTierPreference
      pattern: "from core.models import CognitiveTierPreference"
    - from: backend/api/cognitive_tier_routes.py
      to: backend/core/llm/cognitive_tier_system.py
      via: from core.llm.cognitive_tier_system import CognitiveTier
      pattern: "from core.llm.cognitive_tier_system import CognitiveTier"
    - from: backend/api/cognitive_tier_routes.py
      to: backend/core/dynamic_pricing_fetcher.py
      via: from core.dynamic_pricing_fetcher import get_pricing_fetcher
      pattern: "from core.dynamic_pricing_fetcher import get_pricing_fetcher"

## Objective

Create REST API endpoints for managing cognitive tier preferences, cost estimation, and tier comparison. Allows workspaces to configure their preferred tier strategy, see projected costs, and compare quality vs cost tradeoffs across all available models.

**Purpose:** Provide programmatic access to cognitive tier management for frontend integration and automation.

**Output:** Complete REST API with 6 endpoints, database model, and comprehensive tests.

## Context

@/Users/rushiparikh/projects/atom/.planning/phases/68-byok-cognitive-tier-system/68-RESEARCH.md
@/Users/rushiparikh/projects/atom/backend/core/llm/cognitive_tier_system.py (from Plan 01)
@/Users/rushiparikh/projects/atom/backend/core/dynamic_pricing_fetcher.py
@/Users/rushiparikh/projects/atom/backend/api/workspace_routes.py

## Tasks

<task type="auto">
  <name>Task 1: Create CognitiveTierPreference database model</name>
  <files>backend/core/models.py</files>
  <action>
Extend `backend/core/models.py` with CognitiveTierPreference model:

Add after EscalationLog model:

```python
class CognitiveTierPreference(Base):
    """Per-workspace cognitive tier routing preferences"""
    __tablename__ = "cognitive_tier_preferences"

    id = Column(String, primary_key=True, default=lambda: str(uuid.uuid4()))
    workspace_id = Column(String, ForeignKey("workspaces.id"), nullable=False, unique=True, index=True)

    # Tier selection
    default_tier = Column(String, nullable=False, default="standard")  # micro, standard, versatile, heavy, complex
    min_tier = Column(String, nullable=True)  # Never route below this tier
    max_tier = Column(String, nullable=True)  # Never route above this tier (cost control)

    # Cost controls
    monthly_budget_cents = Column(Integer, nullable=True)  # Budget in cents
    max_cost_per_request_cents = Column(Integer, nullable=True)  # Per-request limit

    # Feature flags
    enable_cache_aware_routing = Column(Boolean, default=True)
    enable_auto_escalation = Column(Boolean, default=True)
    enable_minimax_fallback = Column(Boolean, default=True)

    # Provider preferences (ordered list)
    preferred_providers = Column(JSON, default=list)  # ["deepseek", "openai"]

    # Metadata
    metadata_json = Column(JSON, nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())

    # Relationships
    workspace = relationship("Workspace", backref="cognitive_tier_preference")
```

Import Column, Boolean, Integer at top if not present (should be).

DO NOT create indexes beyond what's specified (unique constraint on workspace_id serves as index).
</action>
  <verify>
python -c "
from core.models import CognitiveTierPreference
print('Model created:', hasattr(CognitiveTierPreference, 'default_tier'))
print('Has enable_cache_aware_routing:', hasattr(CognitiveTierPreference, 'enable_cache_aware_routing'))
"
  </verify>
  <done>
CognitiveTierPreference model added with default_tier, min_tier, max_tier, monthly_budget_cents, enable_cache_aware_routing, enable_auto_escalation, preferred_providers fields
</done>
</task>

<task type="auto">
  <name>Task 2: Create database migration for tier preferences</name>
  <files>backend/alembic/versions/xxx_add_cognitive_tier_preference.py</files>
  <action>
Create Alembic migration file:

1. Generate new migration:
   ```bash
   cd backend && alembic revision -m "add cognitive tier preference table"
   ```

2. Edit the generated migration:
   ```python
   from alembic import op
   import sqlalchemy as sa

   def upgrade():
       op.create_table(
           'cognitive_tier_preferences',
           sa.Column('id', sa.String(), nullable=False),
           sa.Column('workspace_id', sa.String(), nullable=False),
           sa.Column('default_tier', sa.String(), nullable=False),
           sa.Column('min_tier', sa.String(), nullable=True),
           sa.Column('max_tier', sa.String(), nullable=True),
           sa.Column('monthly_budget_cents', sa.Integer(), nullable=True),
           sa.Column('max_cost_per_request_cents', sa.Integer(), nullable=True),
           sa.Column('enable_cache_aware_routing', sa.Boolean(), nullable=True),
           sa.Column('enable_auto_escalation', sa.Boolean(), nullable=True),
           sa.Column('enable_minimax_fallback', sa.Boolean(), nullable=True),
           sa.Column('preferred_providers', sa.JSON(), nullable=True),
           sa.Column('metadata_json', sa.JSON(), nullable=True),
           sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
           sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
           sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id']),
           sa.PrimaryKeyConstraint('id'),
           sa.UniqueConstraint('workspace_id')
       )
       op.create_index('ix_cognitive_tier_preferences_workspace_id', 'cognitive_tier_preferences', ['workspace_id'], unique=True)

   def downgrade():
       op.drop_index('ix_cognitive_tier_preferences_workspace_id', table_name='cognitive_tier_preferences')
       op.drop_table('cognitive_tier_preferences')
   ```

DO NOT use autogenerate - write explicitly as shown.
</action>
  <verify>
cd backend && alembic upgrade head && python -c "
from sqlalchemy import inspect
from core.database import engine
inspector = inspect(engine.engine)
print('Table exists:', 'cognitive_tier_preferences' in inspector.get_table_names())
"
  </verify>
  <done>
Migration created and applied, cognitive_tier_preferences table exists with all columns, unique constraint on workspace_id
</done>
</task>

<task type="auto">
  <name>Task 3: Create cognitive tier REST API</name>
  <files>backend/api/cognitive_tier_routes.py</files>
  <action>
Create new file `backend/api/cognitive_tier_routes.py` with:

1. **Router setup**:
   ```python
   from fastapi import APIRouter, Depends, HTTPException
   from pydantic import BaseModel
   from sqlalchemy.orm import Session
   from typing import List, Optional, Dict, Any

   from core.base_routes import BaseAPIRouter
   from core.database import get_db
   from core.models import CognitiveTierPreference

   router = BaseAPIRouter(
       prefix="/api/v1/cognitive-tier",
       tags=["Cognitive Tier Management"]
   )
   ```

2. **Request/Response models** (Pydantic):
   - TierPreferenceRequest: default_tier, min_tier, max_tier, budgets, feature flags
   - TierPreferenceResponse: id, workspace_id, all preference fields
   - CostEstimateRequest: prompt, estimated_tokens, tier
   - CostEstimateResponse: tier, estimated_cost_usd, models_in_tier

3. **6 endpoints**:

   **GET /preferences/{workspace_id}**:
   - Returns workspace's tier preference or default if not set
   - Query db.query(CognitiveTierPreference).filter_by(workspace_id=workspace_id).first()

   **POST /preferences/{workspace_id}**:
   - Create or update tier preference
   - Use merge() for upsert behavior

   **PUT /preferences/{workspace_id}/budget**:
   - Update monthly_budget_cents and max_cost_per_request_cents
   - Validate budget >= 0

   **GET /estimate-cost**:
   - Input: prompt, estimated_tokens (optional)
   - Calculate cost per tier using DynamicPricingFetcher
   - Return cost for all 5 tiers with recommended tier

   **GET /compare-tiers**:
   - Return comparison table: tier, quality_range, cost_range, example_models
   - Include cache-aware costs where applicable

   **DELETE /preferences/{workspace_id}**:
   - Delete custom preference (reset to default)
   - Returns success message

4. **AUTONOMOUS governance** on all endpoints (from core.agent_governance_service import requires_autonomous)

5. **Add comprehensive docstrings** for each endpoint with examples.
</action>
  <verify>
pytest tests/test_cognitive_tier_api.py -v -k "test_api"
  </verify>
  <done>
6 endpoints created (GET/POST/PUT preferences, GET estimate-cost, GET compare-tiers, DELETE preferences), Pydantic models defined, AUTONOMOUS governance applied
</done>
</task>

<task type="auto">
  <name>Task 4: Create cognitive tier API tests</name>
  <files>backend/tests/test_cognitive_tier_api.py</files>
  <action>
Create `backend/tests/test_cognitive_tier_api.py` with:

1. **Preference CRUD tests** (8 tests):
   - test_get_preferences_default: Returns default when none set
   - test_create_preferences: POST creates new preference
   - test_update_preferences: POST updates existing preference
   - test_update_budget: PUT updates budget fields only
   - test_delete_preferences: DELETE resets to default
   - test_unique_workspace_constraint: One preference per workspace
   - test_invalid_tier_rejected: Invalid tier string returns 400
   - test_negative_budget_rejected: Negative budget returns 400

2. **Cost estimation tests** (5 tests):
   - test_estimate_cost_returns_all_tiers: All 5 tiers with costs
   - test_estimate_cost_uses_token_count: Token count affects cost
   - test_estimate_cost_cache_aware: Includes cached pricing when available
   - test_recommended_tier_selection: Recommends tier based on complexity
   - test_estimate_cost_with_prompt: Auto-estimates tokens from prompt

3. **Tier comparison tests** (3 tests):
   - test_compare_tiers_returns_comparison_table: All tiers with quality/cost
   - test_compare_tiers_includes_example_models: Each tier has model list
   - test_compare_tiers_includes_cache_info: Cache support indicated

4. **Governance tests** (2 tests):
   - test_autonomous_governance_required: AUTONOMOUS required for all endpoints
   - test_unauthorized_access_blocked: Non-AUTONOMOUS rejected

5. **Integration tests** (4 tests):
   - test_preference_saved_to_database: Persists correctly
   - test_preference_retrieval_by_workspace: Workspace isolation
   - test_cost_estimation_uses_pricing_fetcher: Real pricing data
   - test_feature_flags_persist: enable_cache_aware_routing saved

Use TestClient for FastAPI testing. Mock database with test session.
</action>
  <verify>
pytest tests/test_cognitive_tier_api.py -v --cov=backend/api/cognitive_tier_routes.py --cov-report=term-missing
  </verify>
  <done>
22 tests created, all passing, >80% coverage for cognitive_tier_routes.py, all 6 endpoints functional
</done>
</task>

## Verification

1. **API endpoints registered**:
   ```bash
   python -c "
   from backend.main import app
   routes = [r.path for r in app.routes if 'cognitive-tier' in r.path]
   print('Routes:', routes)
   assert '/api/v1/cognitive-tier/preferences/{workspace_id}' in routes
   "
   ```

2. **Database model accessible**:
   ```bash
   python -c "
   from core.models import CognitiveTierPreference
   from sqlalchemy import create_table
   print('Model has default_tier:', hasattr(CognitiveTierPreference, 'default_tier'))
   "
   ```

3. **Cost estimation works**:
   ```bash
   curl -X GET "http://localhost:8000/api/v1/cognitive-tier/estimate-cost?prompt=hello&estimated_tokens=10"
   ```

4. **Test coverage**: >80% for cognitive_tier_routes module

## Success Criteria

1. CognitiveTierPreference model with workspace_id unique constraint
2. 6 REST endpoints (GET/POST/PUT/DELETE preferences, estimate-cost, compare-tiers)
3. AUTONOMOUS governance on all endpoints
4. Cost estimation returns all 5 tiers with pricing
5. Tier comparison includes quality ranges and example models
6. 22+ tests covering CRUD, estimation, comparison, governance
7. Database migration applies cleanly

## Output

After completion, create `.planning/phases/68-byok-cognitive-tier-system/68-05-SUMMARY.md` with:
- API endpoint documentation
- Test coverage report
- Example API responses for each endpoint
- Migration SQL statements
