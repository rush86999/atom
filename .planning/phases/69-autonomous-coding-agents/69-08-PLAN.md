---
phase: 69-autonomous-coding-agents
plan: 08
type: execute
wave: 4
depends_on: [69-04, 69-05, 69-06, 69-07]
files_modified:
  - backend/core/autonomous_committer_agent.py
  - backend/tests/test_autonomous_committer_agent.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Git commits are created with conventional commit format"
    - "Pull requests are generated with descriptions"
    - "Commits include Co-Authored-By attribution"
    - "Commit messages follow Atom conventions"
    - "PR descriptions include test results and coverage"
    - "Integration with gitpython for Git operations"
    - "Integration with GitHub API for PR creation"
  artifacts:
    - path: "backend/core/autonomous_committer_agent.py"
      provides: "Automated commit and PR creation"
      min_lines: 250
      exports: ["CommitterAgent", "create_commit", "create_pull_request", "generate_commit_message"]
    - path: "backend/tests/test_autonomous_committer_agent.py"
      provides: "Test coverage for committer"
      min_lines: 200
  key_links:
    - from: "backend/core/autonomous_committer_agent.py"
      to: "core/autonomous_coder_agent.py"
      via: "Generated code for commits"
      pattern: "from core.autonomous_coder_agent import CodeGeneratorOrchestrator"
    - from: "backend/core/autonomous_committer_agent.py"
      to: "core/test_runner_service.py"
      via: "Test results for PR description"
      pattern: "from core.test_runner_service import TestRunnerService"
    - from: "backend/core/autonomous_committer_agent.py"
      to: "git"
      via: "gitpython for Git operations"
      pattern: "import git"
---

<objective>
Implement Commit Manager Service that automatically creates Git commits with conventional commit messages, generates pull requests with detailed descriptions, and tracks all changes for audit trail.

Purpose: Automate the final step of the SDLC by committing all changes with proper attribution and creating PRs ready for human review.
Output: CommitterAgent with conventional commits, PR generation, Git integration, comprehensive tests
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/69-autonomous-coding-agents/69-RESEARCH.md
@.planning/STATE.md
@backend/core/models.py
@backend/core/autonomous_coder_agent.py
@backend/core/test_runner_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement conventional commit message generator</name>
  <files>backend/core/autonomous_committer_agent.py</files>
  <action>
    Create CommitterAgent with commit message generation:

    ```python
    import git
    from typing import List, Dict, Any, Optional
    from pathlib import Path
    from datetime import datetime
    import subprocess

    class CommitMessageGenerator:
        \"\"\"Generate conventional commit messages.\"\"\"

        # Conventional commit types
        COMMIT_TYPES = {
            \"feat\": \"New feature\",
            \"fix\": \"Bug fix\",
            \"docs\": \"Documentation only changes\",
            \"style\": \"Code style changes (formatting, etc.)\",
            \"refactor\": \"Code refactoring\",
            \"test\": \"Adding or updating tests\",
            \"chore\": \"Maintenance tasks\"
        }

        def __init__(self, db: Session, byok_handler: BYOKHandler):
            self.db = db
            self.byok_handler = byok_handler

        def generate_commit_message(
            self,
            implementation_summary: Dict[str, Any],
            test_results: Dict[str, Any]
        ) -> str:
            \"\"\"Generate conventional commit message.

            Format: <type>(<scope>): <subject>

            <body>

            <footer>

            Args:
                implementation_summary: Summary of code changes
                test_results: Test results and coverage

            Returns complete commit message.
            \"\"\"

        def infer_commit_type(
            self,
            summary: Dict[str, Any]
        ) -> str:
            \"\"\"Infer commit type from changes.
            - New files: feat
            - Bug fixes: fix
            - Only docs changed: docs
            - Only tests changed: test
            - Refactoring: refactor
            \"\"\"

        def infer_scope(
            self,
            files_changed: List[str]
        ) -> str:
            \"\"\"Infer scope from changed files.
            Returns: core, api, tests, docs, etc.
            \"\"\"

        def generate_subject(
            self,
            summary: Dict[str, Any]
        ) -> str:
            \"\"\"Generate commit subject line.
            Imperative mood, 50 char limit.
            Example: \"add OAuth2 authentication with Google and GitHub\"
            \"\"\"

        def generate_body(
            self,
            files_created: List[str],
            files_modified: List[str],
            test_summary: str
        ) -> str:
            \"\"\"Generate commit body.
            Lists changes made and test results.
            \"\"\"

        def generate_footer(
            self,
            test_results: Dict[str, Any],
            coverage: Dict[str, Any]
        ) -> str:
            \"\"\"Generate commit footer.
            Includes:
            - Co-Authored-By: Claude Sonnet <noreply@anthropic.com>
            - Test results
            - Coverage metrics
            \"\"\"

        async def refine_message_with_llm(
            self,
            draft_message: str,
            context: Dict[str, Any]
        ) -> str:
            \"\"\"Use LLM to refine commit message.
            Improves clarity and formatting.
            \"\"\"
    ```

    Implementation requirements:
    - Follow conventional commits specification
    - Infer type from changes (feat, fix, docs, etc.)
    - Generate clear subject lines (imperative mood)
    - Include Co-Authored-By footer
    - List all changes in body
    - Minimum 100 lines for commit message generation

    Conventional commit format:
    ```
    feat(oauth): add OAuth2 authentication with Google and GitHub

    - Add User and OAuthSession models
    - Implement Google OAuth2 flow
    - Implement GitHub OAuth2 flow
    - Create OAuth login UI
    - Add comprehensive tests (87% coverage)

    Test Results:
    - 12/12 tests passing
    - Coverage: 87% (target: 85%)

    Co-Authored-By: Claude Sonnet <noreply@anthropic.com>
    ```
  </action>
  <verify>grep -n "class CommitMessageGenerator\|generate_commit_message" backend/core/autonomous_committer_agent.py</verify>
  <done>CommitMessageGenerator with conventional commits</done>
</task>

<task type="auto">
  <name>Task 2: Implement Git operations wrapper</name>
  <files>backend/core/autonomous_committer_agent.py</files>
  <action>
    Add Git operations wrapper:

    ```python
    class GitOperations:
        \"\"\"Wrapper for Git operations using gitpython.\"\"\"

        def __init__(self, repo_path: str = \".\"):
            self.repo_path = Path(repo_path).resolve()
            try:
                self.repo = git.Repo(self.repo_path)
            except git.exc.InvalidGitRepositoryError:
                raise ValueError(f\"Not a Git repository: {self.repo_path}\")

        def get_changed_files(
            self,
            include_untracked: bool = True
        ) -> Dict[str, List[str]]:
            \"\"\"Get list of changed files.

            Returns:
                {
                    \"added\": [str],
                    \"modified\": [str],
                    \"deleted\": [str],
                    \"untracked\": [str]
                }
            \"\"\"

        def stage_files(
            self,
            files: Optional[List[str]] = None
        ) -> None:
            \"\"\"Stage files for commit.
            If files is None, stages all changes (git add .).
            \"\"\"

        def create_commit(
            self,
            message: str,
            allow_empty: bool = False
        ) -> str:
            \"\"\"Create commit with message.

            Returns commit SHA.
            Raises exception if commit fails.
            \"\"\"

        def get_current_branch(self) -> str:
            \"\"\"Get current branch name.\"\"\"

        def get_latest_commit(self) -> git.Commit:
            \"\"\"Get latest commit object.\"\"\"

        def create_branch(
            self,
            branch_name: str,
            start_point: Optional[str] = None
        ) -> str:
            \"\"\"Create and checkout new branch.
            Returns branch name.
            \"\"\"

        def check_merge_conflicts(self) -> List[str]:
            \"\"\"Check for merge conflicts.
            Returns list of conflicted files.
            \"\"\"

        def get_commit_diff(
            self,
            commit_sha: str
        ) -> str:
            \"\"\"Get diff for commit.
            Returns unified diff string.
            \"\"\"

        def rollback_commit(
            self,
            commit_sha: str
        ) -> None:
            \"\"\"Rollback to commit.
            Resets HEAD to commit SHA.
            \"\"\"
    ```

    Implementation requirements:
    - Use gitpython for all Git operations
    - Handle Git errors gracefully
    - Support staging specific files or all changes
    - Create branches for PR workflows
    - Detect merge conflicts
    - Minimum 80 lines for Git wrapper

    Error handling:
    - GitError: Operation failed
    - InvalidGitRepositoryError: Not a repo
    - ValueError: Invalid input
  </action>
  <verify>grep -n "class GitOperations\|create_commit\|stage_files" backend/core/autonomous_committer_agent.py</verify>
  <done>GitOperations with gitpython integration</done>
</task>

<task type="auto">
  <name>Task 3: Implement pull request generator</name>
  <files>backend/core/autonomous_committer_agent.py</files>
  <action>
    Add PR generation methods:

    ```python
    class PullRequestGenerator:
        \"\"\"Generate pull requests using GitHub API.\"\"\"

        def __init__(self, repo_owner: str, repo_name: str, github_token: Optional[str] = None):
            self.repo_owner = repo_owner
            self.repo_name = repo_name
            self.github_token = github_token or os.getenv(\"GITHUB_TOKEN\")
            self.api_base = \"https://api.github.com\"

        def generate_pr_title(
            self,
            commit_message: str
        ) -> str:
            \"\"\"Generate PR title from commit message.
            Uses subject line from commit.
            Max 70 characters for GitHub.
            \"\"\"

        def generate_pr_description(
            self,
            implementation_summary: Dict[str, Any],
            test_results: Dict[str, Any],
            coverage: Dict[str, Any]
        ) -> str:
            \"\"\"Generate PR description in Markdown.

            Structure:
            # Summary
            Brief description of changes

            ## Changes
            - ✅ Item 1
            - ✅ Item 2

            ## Testing
            Test results and coverage

            ## Configuration
            Environment variables needed

            ## Checklist
            - [x] Tests passing
            - [x] Coverage met
            - [x] Docs updated

            Returns complete Markdown description.
            \"\"\"

        def generate_checklist(
            self,
            changes: Dict[str, Any]
        ) -> List[str]:
            \"\"\"Generate PR checklist items.
            Includes tests, coverage, docs, etc.
            \"\"\"

        async def create_pull_request(
            self,
            source_branch: str,
            target_branch: str,
            title: str,
            description: str
        ) -> Dict[str, Any]:
            \"\"\"Create PR via GitHub API.

            Returns PR data including number, URL, state.
            Raises exception if API call fails.
            \"\"\"

        def _call_github_api(
            self,
            endpoint: str,
            method: str = \"GET\",
            data: Optional[Dict[str, Any]] = None
        ) -> Dict[str, Any]:
            \"\"\"Call GitHub API.
            Handles authentication and pagination.
            \"\"\"

        def get_pr_status(
            self,
            pr_number: int
        ) -> Dict[str, Any]:
            \"\"\"Get PR status (checks, reviews, comments).
            Returns status information.
            \"\"\"
    ```

    Implementation requirements:
    - Generate Markdown PR descriptions
    - Include test results and coverage
    - Add configuration sections
    - Create PR via GitHub API
    - Handle missing GitHub token gracefully
    - Minimum 100 lines for PR generation

    PR description structure:
    ```markdown
    # OAuth2 Authentication for Google and GitHub

    ## Summary
    Implements OAuth2 authentication flow for Google and GitHub providers.

    ## Changes
    - ✅ Database: Add User, OAuthSession models
    - ✅ Backend: OAuthService with Google/GitHub flows
    - ✅ Frontend: Login UI with OAuth buttons
    - ✅ Tests: 12 unit tests, 87% coverage
    - ✅ Docs: Setup guide, API documentation

    ## Testing
    All tests passing (12/12)
    Coverage: 87% (target: 85%)

    ## Configuration
    Add to `.env`:
    ```
    GOOGLE_OAUTH_CLIENT_ID=...
    GOOGLE_OAUTH_CLIENT_SECRET=...
    GITHUB_OAUTH_CLIENT_ID=...
    GITHUB_OAUTH_CLIENT_SECRET=...
    ```

    ## Checklist
    - [x] Tests passing
    - [x] Coverage ≥85%
    - [x] mypy: No type errors
    - [x] Black: Formatted
    - [x] Documentation updated
    - [x] No breaking changes
    ```
  </action>
  <verify>grep -n "class PullRequestGenerator\|generate_pr_description\|create_pull_request" backend/core/autonomous_committer_agent.py</verify>
  <done>PullRequestGenerator with GitHub API integration</done>
</task>

<task type="auto">
  <name>Task 4: Implement main CommitterAgent orchestration</name>
  <files>backend/core/autonomous_committer_agent.py</files>
  <action>
    Create main CommitterAgent class:

    ```python
    class CommitterAgent:
        \"\"\"Main agent for automated commits and PRs.\"\"\"

        def __init__(
            self,
            db: Session,
            byok_handler: BYOKHandler,
            repo_path: str = \".\",
            github_token: Optional[str] = None
        ):
            self.db = db
            self.byok_handler = byok_handler
            self.message_generator = CommitMessageGenerator(db, byok_handler)
            self.git_ops = GitOperations(repo_path)
            self.pr_generator = PullRequestGenerator(
                repo_owner=self._infer_repo_owner(),
                repo_name=self._infer_repo_name(),
                github_token=github_token
            )

        async def create_commit(
            self,
            implementation_result: Dict[str, Any],
            test_results: Dict[str, Any],
            workflow_id: str
        ) -> Dict[str, Any]:
            \"\"\"Create Git commit for implementation.

            Args:
                implementation_result: Code generation result
                test_results: Test execution results
                workflow_id: Workflow tracking ID

            Returns:
                {
                    \"commit_sha\": str,
                    \"commit_message\": str,
                    \"files_committed\": int,
                    \"branch\": str
                }
            \"\"\"

        async def create_commit_with_review(
            self,
            implementation_result: Dict[str, Any],
            test_results: Dict[str, Any]
        ) -> Dict[str, Any]:
            \"\"\"Create commit with human review checkpoint.

            Pauses after generating commit message for human approval.
            Returns after approval.
            \"\"\"

        async def create_pull_request(
            self,
            implementation_result: Dict[str, Any],
            test_results: Dict[str, Any],
            coverage: Dict[str, Any]
        ) -> Dict[str, Any]:
            \"\"\"Create pull request for changes.

            Creates branch if needed, commits changes, creates PR.
            Returns PR data.
            \"\"\"

        async def commit_and_pr_workflow(
            self,
            implementation_result: Dict[str, Any],
            test_results: Dict[str, Any],
            coverage: Dict[str, Any],
            create_pr: bool = True
        ) -> Dict[str, Any]:
            \"\"\"Full commit + PR workflow.

            1. Create feature branch
            2. Stage all changes
            3. Create commit with conventional message
            4. Create pull request
            5. Return PR URL

            Returns complete workflow result.
            \"\"\"

        def save_commit_to_workflow(
            self,
            workflow_id: str,
            commit_result: Dict[str, Any]
        ) -> None:
            \"\"\"Save commit result to AutonomousWorkflow.
            Updates workflow with commit SHA and PR info.
            \"\"\"

        def _infer_repo_owner(self) -> str:
            \"\"\"Infer GitHub repo owner from git remote.\"\"\"

        def _infer_repo_name(self) -> str:
            \"\"\"Infer GitHub repo name from git remote.\"\"\"
    ```

    Orchestration requirements:
    - Coordinate commit message generation
    - Stage and commit changes
    - Create branches for PRs
    - Generate and create PRs
    - Save results to workflow
    - Minimum 80 lines for orchestration

    Total file size target: 250+ lines
  </action>
  <verify>grep -n "class CommitterAgent\|create_commit\|create_pull_request" backend/core/autonomous_committer_agent.py && wc -l backend/core/autonomous_committer_agent.py | awk '{print $1 " lines (target: 250+)"}'</verify>
  <done>CommitterAgent with full orchestration</done>
</task>

<task type="auto">
  <name>Task 5: Create comprehensive tests for CommitterAgent</name>
  <files>backend/tests/test_autonomous_committer_agent.py</files>
  <action>
    Create test file with 200+ lines covering:

    Test cases:
    1. test_commit_message_generator_type - Commit type inference
    2. test_commit_message_generator_scope - Scope inference
    3. test_commit_message_generator_subject - Subject generation
    4. test_commit_message_generator_body - Body generation
    5. test_commit_message_generator_footer - Footer with Co-Authored-By
    6. test_commit_message_conventional_format - Conventional commit format
    7. test_git_operations_changed_files - Changed files detection
    8. test_git_operations_stage - File staging
    9. test_git_operations_commit - Commit creation
    10. test_git_operations_branch - Branch creation
    11. test_git_operations_conflicts - Merge conflict detection
    12. test_git_operations_rollback - Rollback functionality
    13. test_pr_generator_title - PR title generation
    14. test_pr_generator_description - PR description generation
    15. test_pr_generator_checklist - Checklist generation
    16. test_committer_create_commit - Full commit workflow
    17. test_committer_create_pr - Full PR workflow
    18. test_committer_commit_and_pr - Combined workflow
    19. test_committer_save_to_workflow - Workflow result storage
    20. test_git_error_handling - Git error handling

    Fixtures:
    - db_session (SQLAlchemy session)
    - mock_byok_handler (Mock BYOKHandler)
    - temp_git_repo (Temporary Git repo for testing)
    - sample_implementation_result (Sample code generation result)
    - sample_test_results (Sample test results)
    - committer_agent (CommitterAgent instance)

    Test approach:
    - Create temp Git repo for safe testing
    - Test commit message format validation
    - Mock GitHub API for PR testing
    - Test error handling for Git failures
    - Verify Co-Authored-By footer included

    Coverage target: >= 80% for CommitterAgent
  </action>
  <verify>pytest backend/tests/test_autonomous_committer_agent.py -v --cov=backend/core/autonomous_committer_agent --cov-report=term-missing</verify>
  <done>All tests passing with 80%+ coverage</done>
</task>

</tasks>

<verification>
1. Run tests: pytest backend/tests/test_autonomous_committer_agent.py -v
2. Verify coverage: pytest --cov=backend/core/autonomous_committer_agent --cov-report=html
3. Test commit generation: Generate commit and verify conventional format
4. Test Git operations: Create temp repo and verify commit
5. Test PR generation: Generate PR description and verify format
6. Test full workflow: Run commit_and_pr_workflow end-to-end
7. Verify Co-Authored-By: Check footer includes attribution
8. Test error handling: Test with invalid Git state
9. Check result storage: Verify workflow record updated
</verification>

<success_criteria>
1. Commit messages follow conventional commits spec
2. Commit type inferred correctly from changes
3. Subject lines are imperative mood and <50 chars
4. Body lists all changes and test results
5. Footer includes Co-Authored-By attribution
6. Git operations work correctly (stage, commit, branch)
7. PR descriptions are clear and comprehensive
8. PR includes test results and coverage
9. Configuration sections included when needed
10. Test coverage >= 80% for CommitterAgent
11. All tests passing with no flaky tests
</success_criteria>

<output>
After completion, create `.planning/phases/69-autonomous-coding-agents/69-08-SUMMARY.md` with:
- Files created/modified
- Lines of code added
- Test coverage achieved
- Example commit message
- Example PR description
- Next steps (Plan 69-09 depends on commit/PR)
</output>
