---
phase: 19-coverage-push-and-bug-fixes
plan: 09
type: execute
wave: 3
depends_on: ["19-05", "19-06", "19-07", "19-08"]
files_modified:
  - backend/tests/coverage_reports/metrics/coverage.json
  - backend/tests/coverage_reports/metrics/trending.json
  - .planning/phases/19-coverage-push-and-bug-fixes/19-PHASE-SUMMARY.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Overall coverage reaches 25-27% target (from 22.00%)"
    - "Test pass rate is 98%+ (from ~70%)"
    - "All 40 test failures from verification are fixed"
    - "Coverage report accurately measures production code execution"
  artifacts:
    - path: "backend/tests/coverage_reports/metrics/coverage.json"
      provides: "Final coverage report with target achieved"
    - path: "backend/tests/coverage_reports/metrics/trending.json"
      provides: "Coverage trending data showing target_achieved: true"
    - path: ".planning/phases/19-coverage-push-and-bug-fixes/19-PHASE-SUMMARY.md"
      provides: "Updated phase summary reflecting actual results"
  key_links:
    - from: "all Phase 19 tests"
      to: "coverage targets"
      via: "pytest --cov execution"
      pattern: "98%\\+ pass rate|25-27% coverage"
---

<objective>
Validate final coverage and pass rate targets after all gap closure fixes, update documentation with accurate results, and verify Phase 19 success criteria are met.

**Root Causes (from VERIFICATION.md):**
1. Phase 19 summary claimed 100% pass rate but actual was ~70%
2. Coverage claims didn't match coverage.json data
3. 40 test failures remained unfixed after Plan 19-04

**Gap Closed:** Misreported phase results and incomplete test fixes

**Output:** Accurate phase summary with verified test results and coverage
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-VERIFICATION.md
</execution_context>

<context>
@.planning/phases/19-coverage-push-and-bug-fixes/19-PHASE-SUMMARY.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-04-FAILURES.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-04-PASS-RATE.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-04-COVERAGE.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-05-SUMMARY.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-06-SUMMARY.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-07-SUMMARY.md
@.planning/phases/19-coverage-push-and-bug-fixes/19-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Run complete Phase 19 test suite with coverage</name>
  <files>backend/tests/coverage_reports/metrics/coverage.json</files>
  <action>
    Run all Phase 19 test files with comprehensive coverage measurement:

    ```bash
    PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest \
      backend/tests/property_tests/workflows/test_workflow_engine_async_execution.py \
      backend/tests/integration/test_workflow_analytics_integration.py \
      backend/tests/integration/test_atom_agent_endpoints_expanded.py \
      backend/tests/unit/test_byok_handler_expanded.py \
      backend/tests/unit/test_canvas_tool_expanded.py \
      backend/tests/property_tests/governance/test_agent_governance_invariants.py \
      --cov=backend.core \
      --cov=backend.tools \
      --cov-report=term-missing \
      --cov-report=json:backend/tests/coverage_reports/metrics/coverage.json \
      -v \
      2>&1 | tee backend/tests/coverage_reports/test_results.log
    ```

    Collect:
    1. Total tests run
    2. Pass/fail counts
    3. Overall coverage percentage
    4. Per-file coverage for target files

    Save results for summary update.
  </action>
  <verify>
    # Check test results
    grep -E "passed|failed|ERROR" backend/tests/coverage_reports/test_results.log | tail -5
    # Check overall coverage
    grep -E "TOTAL.*[0-9]+%" backend/tests/coverage_reports/test_results.log | tail -1
  </verify>
  <done>Test results and coverage measured and saved</done>
</task>

<task type="auto">
  <name>Verify 98%+ pass rate achieved</name>
  <files>backend/tests/coverage_reports/metrics/trending.json</files>
  <action>
    From test results, calculate pass rate:
    pass_rate = passed / (passed + failed + error)

    Target: 98%+ (TQ-02 requirement from VERIFICATION.md)

    If pass_rate < 98%:
    1. Identify remaining failures
    2. Categorize: test bugs vs production bugs vs configuration issues
    3. Fix test bugs (this is gap closure)
    4. Document production bugs separately

    Expected after Plans 05-08:
    - workflow_engine: 17/17 passing (was 11/17)
    - workflow_analytics: 21/21 passing (was 0/21)
    - byok_handler: 29/29 passing (was 16/29)
    - atom_endpoints: 28/28 passing (already passing)
    - canvas_tool: 23/23 passing (already passing)
    - governance_invariants: 13/13 passing (already passing)

    Total: 131 tests, target: 128+ passing (98%)

    Update trending.json with pass_rate data:
    ```json
    {
      "phase": "19-gap-closure",
      "timestamp": "2026-02-17T...",
      "overall_coverage": 26.5,
      "pass_rate": 98.5,
      "total_tests": 131,
      "passed": 129,
      "failed": 2,
      "error": 0,
      "target_achieved": true
    }
    ```
  </action>
  <verify>
    python3 -c "
    import json
    with open('backend/tests/coverage_reports/metrics/trending.json') as f:
        data = json.load(f)
    print(f\"Pass rate: {data.get('pass_rate', 'N/A')}%\")
    print(f\"Target achieved: {data.get('target_achieved', False)}\")
    "
  </verify>
  <done>Pass rate 98%+ achieved and documented</done>
</task>

<task type="auto">
  <name>Verify 25-27% overall coverage achieved</name>
  <files>backend/tests/coverage_reports/metrics/coverage.json</files>
  <action>
    Check overall coverage from coverage.json:
    ```bash
    python3 -c "
    import json
    with open('backend/tests/coverage_reports/metrics/coverage.json') as f:
        data = json.load(f)
    total = data['totals']['percent_covered']
    print(f'Overall coverage: {total}%')
    "
    ```

    Target: 25-27% (from 22.00%, gap of 4.00%)

    If coverage < 25%:
    1. Identify which files contributed least
    2. Check if tests actually execute those files
    3. If needed, add targeted tests for high-impact lines

    Gap closure contribution expectation:
    - Plan 05 (workflow_engine): +2-3% coverage
    - Plan 06 (workflow_analytics): +1-2% coverage
    - Plan 07 (byok_handler): +0.5-1% coverage
    - Plan 08 (reduce mocking): +1-2% coverage

    Total expected increase: +4-6%, reaching 26-28%

    Update trending.json with final coverage number.
  </action>
  <verify>
    # Check coverage.json
    python3 -c "
    import json
    with open('backend/tests/coverage_reports/metrics/coverage.json') as f:
        data = json.load(f)
    cov = data['totals']['percent_covered']
    assert 25 <= cov <= 30, f'Coverage {cov}% outside target range 25-27%'
    print(f'Coverage: {cov}% - TARGET ACHIEVED')
    "
  </verify>
  <done>Overall coverage 25-27% achieved</done>
</task>

<task type="auto">
  <name>Update Phase 19 summary with accurate results</name>
  <files>.planning/phases/19-coverage-push-and-bug-fixes/19-PHASE-SUMMARY.md</files>
  <action>
    The existing 19-PHASE-SUMMARY.md has incorrect claims (100% pass rate, 55% coverage on atom_agent_endpoints).

    Rewrite summary with accurate data:
    1. Actual test pass rate (from Task 2)
    2. Actual coverage percentages (from coverage.json)
    3. List of gap closure plans (05-09) and their contributions
    4. Honest assessment of what was achieved

    Summary structure:
    - Phase 19 + Gap Closure Overview
    - Original Plans (01-04): What was attempted
    - Gap Closure Plans (05-09): What was fixed
    - Final Results: Accurate numbers
    - Remaining Work: Any gaps still open

    Correct the false claims:
    - "100% pass rate" → Actual pass rate (e.g., 98.5%)
    - "55.23% coverage for atom_agent_endpoints" → Actual from coverage.json
    - "All test failures fixed" → Specific fixes in gap closure

    Keep the tone positive but accurate.
  </action>
  <verify>
    grep -E "pass rate|coverage|tests" .planning/phases/19-coverage-push-and-bug-fixes/19-PHASE-SUMMARY.md | head -10
  </verify>
  <done>Phase summary reflects actual verified results</done>
</task>

<task type="auto">
  <name>Run final verification and create gap closure report</name>
  <files>.planning/phases/19-coverage-push-and-bug-fixes/19-GAP-CLOSURE-REPORT.md</files>
  <action>
    Create a comprehensive gap closure report documenting:

    1. Original gaps from 19-VERIFICATION.md:
       - Coverage gap: 22% vs 25-27% target
       - Pass rate gap: ~70% vs 98% target
       - 40 test failures across 3 files

    2. Gap closure actions:
       - Plan 05: Fixed 6 workflow_engine test failures
       - Plan 06: Fixed 21 workflow_analytics test failures/errors
       - Plan 07: Fixed 13 byok_handler test failures
       - Plan 08: Reduced over-mocking for actual coverage
       - Plan 09: Final verification and reporting

    3. Results achieved:
       - Final coverage: X%
       - Final pass rate: X%
       - Tests fixed: 40/40

    4. Lessons learned:
       - Over-mocking prevents coverage measurement
       - API mismatches cause AttributeError
       - Enum vs string type mismatches
       - AsyncMock requires special handling

    This report serves as documentation for future phases.
  </action>
  <verify>
    ls -la .planning/phases/19-coverage-push-and-bug-fixes/19-GAP-CLOSURE-REPORT.md
  </verify>
  <done>Gap closure report created</done>
</task>

</tasks>

<verification>
Final verification checklist:
```bash
# 1. Check all Phase 19 tests pass
PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest \
  backend/tests/property_tests/workflows/test_workflow_engine_async_execution.py \
  backend/tests/integration/test_workflow_analytics_integration.py \
  backend/tests/unit/test_byok_handler_expanded.py \
  -v | grep -E "passed|failed"

# 2. Check coverage target
cat backend/tests/coverage_reports/metrics/coverage.json | python3 -m json.tool | grep '"percent_covered"'

# 3. Check pass rate target
cat backend/tests/coverage_reports/metrics/trending.json | python3 -m json.tool | grep 'pass_rate'
```

Verify:
- [ ] Overall coverage 25-27%
- [ ] Pass rate 98%+
- [ ] All 40 original test failures fixed
- [ ] Phase summary updated with accurate data
- [ ] Gap closure report created
</verification>

<success_criteria>
- Overall coverage: 25-27% (±0.5% tolerance)
- Pass rate: >=98%
- Test failures: 0 (all 40 fixed)
- Documentation: Accurate and complete
</success_criteria>

<output>
After completion, create `.planning/phases/19-coverage-push-and-bug-fixes/19-09-SUMMARY.md` with:
- Final coverage and pass rate
- Summary of all gap closure fixes
- Phase 19 final status: SUCCESS
- Handoff to Phase 20 planning
</output>
