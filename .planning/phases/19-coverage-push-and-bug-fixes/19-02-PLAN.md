---
phase: 19-coverage-push-and-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/integration/test_atom_agent_endpoints_expanded.py
  - backend/tests/unit/test_byok_handler_expanded.py
  - backend/tests/coverage_reports/metrics/coverage.json
autonomous: true

must_haves:
  truths:
    - "atom_agent_endpoints.py streaming endpoint and error handling are tested"
    - "llm/byok_handler.py provider failover and token streaming are tested"
    - "Integration tests cover all major FastAPI endpoints"
    - "Both files achieve 50%+ coverage target"
    - "All tests pass with proper async handling"
  artifacts:
    - path: "backend/tests/integration/test_atom_agent_endpoints_expanded.py"
      provides: "Expanded integration tests for atom_agent_endpoints.py"
      min_lines: 500
      exports: ["TestStreamingEndpoints", "TestErrorHandling", "TestGovernanceIntegration"]
    - path: "backend/tests/unit/test_byok_handler_expanded.py"
      provides: "Expanded unit tests for llm/byok_handler.py"
      min_lines: 500
      exports: ["TestProviderFailover", "TestTokenStreaming", "TestCostOptimization"]
  key_links:
    - from: "test_atom_agent_endpoints_expanded.py"
      to: "core/atom_agent_endpoints.py"
      via: "FastAPI TestClient with dependency overrides"
      pattern: "TestClient.*atom_agent_endpoints"
    - from: "test_byok_handler_expanded.py"
      to: "core/llm/byok_handler.py"
      via: "AsyncMock for LLM provider clients"
      pattern: "AsyncMock.*openai.*anthropic"
---

# Phase 19 Plan 02: Agent Endpoints & BYOK Handler Coverage

**Objective:** Achieve 50% coverage on atom_agent_endpoints.py (668 uncovered lines) and llm/byok_handler.py (491 uncovered lines) using expanded integration tests for API endpoints and unit tests for LLM provider routing.

**Purpose:** These are Tier 1 high-impact files. Testing streaming endpoints and provider failover will provide +1.0% overall coverage contribution per file.

**Output:** Expanded integration tests for chat endpoints, unit tests for BYOK handler multi-provider routing, updated coverage report.

## <execution_context>

@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md

</execution_context>

## <context>

@.planning/phases/19-coverage-push-and-bug-fixes/19-RESEARCH.md
@.planning/phases/12-tier-1-coverage-push/12-tier-1-coverage-push-02-SUMMARY.md
@backend/core/atom_agent_endpoints.py
@backend/core/llm/byok_handler.py
@backend/tests/unit/test_atom_agent_endpoints.py
@backend/tests/unit/test_byok_handler.py

## <tasks>

<task type="auto">
  <name>Task 1: Create expanded integration tests for atom_agent_endpoints.py</name>
  <files>backend/tests/integration/test_atom_agent_endpoints_expanded.py</files>
  <action>
Create `backend/tests/integration/test_atom_agent_endpoints_expanded.py` with ~500 lines covering:

1. **Streaming Endpoint Tests (TestStreamingEndpoints):**
   - test_streaming_chat_with_generator
   - test_streaming_with_agent_governance
   - test_streaming_error_handling
   - test_streaming_timeout
   - test_streaming_with_conversation_context

2. **Error Handling Tests (TestErrorHandling):**
   - test_chat_with_invalid_request_format
   - test_chat_with_missing_user_id
   - test_chat_with_llm_service_failure
   - test_chat_with_database_error
   - test_chat_timeout_handling
   - test_streaming_connection_closed

3. **Governance Integration Tests (TestGovernanceIntegration):**
   - test_student_agent_blocked_from_dangerous_actions
   - test_intern_agent_requires_approval
   - test_supervised_agent_with_realtime_monitoring
   - test_autonomous_agent_full_access
   - test_governance_cache_hit

4. **Feedback System Tests (TestFeedbackSystem):**
   - test_submit_feedback_success
   - test_feedback_with_correction
   - test_feedback_analytics_aggregation
   - test_feedback_associated_with_session

**Use FastAPI TestClient with dependency overrides (from Phase 12-02):**
```python
@pytest.fixture
def client():
    from fastapi.testclient import TestClient
    from core.atom_agent_endpoints import router

    app = FastAPI()
    app.include_router(router)

    # Override dependencies
    def override_get_db():
        db = SessionLocal()
        try:
            yield db
        finally:
            db.close()

    app.dependency_overrides[get_db] = override_get_db
    return TestClient(app)
```

**Target:** 50% coverage on atom_agent_endpoints.py (368 of 736 lines)
  </action>
  <verify>
PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/integration/test_atom_agent_endpoints_expanded.py -v --cov=core/atom_agent_endpoints --cov-report=term-missing
  </verify>
  <done>
All endpoint tests pass, coverage report shows 50%+ on atom_agent_endpoints.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Create expanded unit tests for llm/byok_handler.py</name>
  <files>backend/tests/unit/test_byok_handler_expanded.py</files>
  <action>
Create `backend/tests/unit/test_byok_handler_expanded.py` with ~500 lines covering:

1. **Provider Failover Tests (TestProviderFailover):**
   - test_openai_fails_over_to_anthropic
   - test_anthropic_fails_over_to_deepseek
   - test_all_providers_fail_raises_error
   - test_provider_timeout_triggers_failover
   - test_provider_rate_limit_triggers_failover

2. **Token Streaming Tests (TestTokenStreaming):**
   - test_stream_tokens_openai
   - test_stream_tokens_anthropic
   - test_stream_tokens_with_stop_sequence
   - test_stream_tokens_error_handling
   - test_stream_tokens_accumulates_usage

3. **Cost Optimization Tests (TestCostOptimization):**
   - test_query_complexity_classification
   - test_simple_query_uses_flash_model
   - test_complex_query_uses_full_model
   - test_cost_tracking_by_provider
   - test_budget_enforcement

4. **Multi-Provider Routing Tests (TestMultiProviderRouting):**
   - test_route_to_openai_by_default
   - test_route_to_anthropic_for_complex_tasks
   - test_route_to_gemini_for_multimodal
   - test_route_with_explicit_provider_override
   - test_provider_health_check

**Use AsyncMock for all LLM provider clients:**
```python
@pytest.fixture
def mock_openai_client():
    client = AsyncMock()
    client.chat.completions.create = AsyncMock(
        return_value=MagicMock(
            choices=[MagicMock(message=MagicMock(content="Test response"))],
            usage=MagicMock(total_tokens=100)
        )
    )
    return client

@pytest.mark.asyncio
async def test_stream_tokens_openai(mock_openai_client):
    with patch('core.llm.byok_handler.AsyncOpenAI', return_value=mock_openai_client):
        handler = BYOKHandler(provider_id="openai")
        tokens = []
        async for token in handler.stream("Test prompt"):
            tokens.append(token)
        assert len(tokens) > 0
```

**Target:** 50% coverage on llm/byok_handler.py (275 of 549 lines)
  </action>
  <verify>
PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/unit/test_byok_handler_expanded.py -v --cov=core/llm/byok_handler --cov-report=term-missing
  </verify>
  <done>
All BYOK tests pass, coverage report shows 50%+ on llm/byok_handler.py
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate coverage report and validate targets</name>
  <files>backend/tests/coverage_reports/metrics/coverage.json</files>
  <action>
1. Run coverage for both files:
```bash
PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest \
  backend/tests/integration/test_atom_agent_endpoints_expanded.py \
  backend/tests/unit/test_byok_handler_expanded.py \
  --cov=core/atom_agent_endpoints \
  --cov=core/llm/byok_handler \
  --cov-report=html \
  --cov-report=json \
  --cov-report=term-missing
```

2. Verify targets met:
- atom_agent_endpoints.py: 50%+ coverage (368 of 736 lines)
- llm/byok_handler.py: 50%+ coverage (275 of 549 lines)

3. Document coverage results in plan summary

4. If targets not met:
- Review coverage report for uncovered lines
- Add targeted tests for specific uncovered functions
- Re-run coverage until targets achieved
  </action>
  <verify>
python -c "import json; data = json.load(open('backend/tests/coverage_reports/metrics/coverage.json')); aae = data['files'].get('core/atom_agent_endpoints.py', {}); byok = data['files'].get('core/llm/byok_handler.py', {}); print(f'atom_agent_endpoints.py: {aae[\"summary\"][\"percent_covered\"]}%'); print(f'llm/byok_handler.py: {byok[\"summary\"][\"percent_covered\"]}%')"
  </verify>
  <done>
Both files achieve 50%+ coverage, coverage.json updated with results
  </done>
</task>

</tasks>

## <verification>

After completion, verify:
1. Test files exist with minimum line counts (endpoints ~500 lines, byok ~500 lines)
2. All tests pass: pytest backend/tests/integration/test_atom_agent_endpoints_expanded.py backend/tests/unit/test_byok_handler_expanded.py -v
3. Coverage targets achieved: atom_agent_endpoints.py 50%+, llm/byok_handler.py 50%+
4. No async handling issues (all async tests properly decorated)
5. Coverage report generated in backend/tests/coverage_reports/metrics/coverage.json

</verification>

## <success_criteria>

- [ ] test_atom_agent_endpoints_expanded.py created with 500+ lines
- [ ] test_byok_handler_expanded.py created with 500+ lines
- [ ] atom_agent_endpoints.py coverage >= 50% (368+ lines)
- [ ] llm/byok_handler.py coverage >= 50% (275+ lines)
- [ ] All tests pass (100% pass rate)
- [ ] Coverage report generated and documented

## <output>

After completion, create `.planning/phases/19-coverage-push-and-bug-fixes/19-02-SUMMARY.md`
</output>
