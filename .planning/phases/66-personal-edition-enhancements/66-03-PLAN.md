---
phase: 66-personal-edition-enhancements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/core/creative/ffmpeg_service.py
  - backend/tools/creative_tool.py
  - backend/api/creative_routes.py
  - backend/requirements.txt
  - docker-compose-personal.yml
autonomous: false
user_setup:
  - service: ffmpeg
    why: "FFmpeg binary for video/audio processing"
    install: "brew install ffmpeg (macOS) or apt install ffmpeg (Ubuntu) - included in Docker image"

must_haves:
  truths:
    - "Agent can trim videos to specified start time and duration"
    - "Agent can extract audio from video files"
    - "Agent can generate video thumbnails at specified timestamps"
    - "Agent can convert video formats (MP4, WebM, MOV, etc.)"
    - "Agent can normalize audio volume and convert audio formats"
    - "Long-running FFmpeg jobs run asynchronously with progress tracking"
    - "All file operations restricted to designated directories (security boundary)"
    - "STUDENT, INTERN, and SUPERVISED agents blocked (AUTONOMOUS only for file safety)"
  artifacts:
    - path: "backend/core/creative/ffmpeg_service.py"
      provides: "FFmpeg video/audio processing service"
      min_lines: 200
      exports: ["FFmpegService", "trim_video", "extract_audio", "generate_thumbnail", "convert_format"]
    - path: "backend/tools/creative_tool.py"
      provides: "LangChain BaseTool for creative operations"
      min_lines: 100
      exports: ["FFmpegTool"]
    - path: "backend/api/creative_routes.py"
      provides: "REST API endpoints for creative operations"
      min_lines: 150
      exports: ["POST /creative/video/trim", "POST /creative/audio/extract", "GET /creative/jobs/{job_id}/status"]
    - path: "docker-compose-personal.yml"
      provides: "Docker Compose with FFmpeg installed"
      contains: "ffmpeg"
  key_links:
    - from: "backend/core/creative/ffmpeg_service.py"
      to: "ffmpeg-python"
      via: "Pythonic FFmpeg wrapper for video/audio processing"
      pattern: "import ffmpeg"
    - from: "backend/tools/creative_tool.py"
      to: "backend/core/governance_cache.py"
      via: "Maturity level check (AUTONOMOUS only)"
      pattern: "maturity_required.*AUTONOMOUS"
    - from: "backend/api/creative_routes.py"
      to: "asyncio.create_task"
      via: "Async background task for long-running FFmpeg jobs"
      pattern: "asyncio\\.create_task"
---

<objective>
Implement FFmpeg-based video and audio processing service with async job execution and security boundaries.

**Purpose**: Enable Atom agents to perform common video/audio editing tasks for personal productivity (e.g., "trim the screencast to 5 minutes", "extract audio from the recorded meeting", "generate thumbnails for my video library").

**Output**: Working FFmpeg service with async job processing, progress tracking, file security boundaries, AUTONOMOUS-only governance, and REST API endpoints.

**Why this matters**: Creative tool capabilities differentiate Atom from basic assistants. Video/audio processing is computationally expensive, so async job processing is required to avoid blocking the API. AUTONOMOUS-only gate ensures only trusted agents can modify files.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-personal-edition-enhancements/66-RESEARCH.md
@.planning/ROADMAP.md

# Existing patterns to reuse
@backend/tools/device_tool.py  # Device control governance patterns
@backend/tools/registry.py  # Tool registration
@backend/core/models.py  # Job tracking models
@docker-compose-personal.yml  # Docker Compose configuration
</context>

<tasks>

<task type="auto">
  <name>Create FFmpeg service for video/audio processing</name>
  <files>backend/core/creative/ffmpeg_service.py</files>
  <action>
Create `backend/core/creative/ffmpeg_service.py` with:

1. **FFmpegService class**:
   - Use ffmpeg-python library (Pythonic wrapper around FFmpeg binary)
   - Validate FFmpeg binary is available on import

2. **Video operations**:
   - async trim_video(input_path: str, output_path: str, start_time: str, duration: str) -> Dict
     - start_time: HH:MM:SS format
     - duration: HH:MM:SS or seconds
     - Use -ss (start) and -t (duration) parameters
     - Use codec copy for fast trimming (no re-encoding)
   - async convert_format(input_path: str, output_path: str, format: str) -> Dict
     - Convert to MP4, WebM, MOV, AVI
     - Preset quality: "medium" (balance speed/quality)
   - async generate_thumbnail(video_path: str, thumbnail_path: str, timestamp: str = "00:00:01") -> Dict
     - Extract single frame at timestamp
     - Output as JPEG

3. **Audio operations**:
   - async extract_audio(video_path: str, audio_path: str, format: str = "mp3") -> Dict
     - Extract audio track to MP3, M4A, WAV, FLAC
     - Use libmp3lame for MP3, aac for M4A
   - async normalize_audio(input_path: str, output_path: str) -> Dict
     - Normalize volume to -16 LUFS (EBU R128 standard)
     - Use loudnorm filter

4. **Async job management**:
   - Create FFmpegJob model (id, user_id, operation, status, progress, input_path, output_path, created_at)
   - async run_async_job(job_id: str, operation: Callable) -> None
     - Run FFmpeg in background thread
     - Update job status: pending -> running -> completed/failed
     - Store progress percentage
   - async get_job_status(job_id: str) -> Dict
     - Return current job status and progress

5. **Security boundaries**:
   - validate_path(path: str, allowed_dirs: List[str]) -> bool
     - Ensure file paths are within allowed directories
     - Reject paths with .. (directory traversal)
   - Allowed directories: ./data/media, ./data/exports (configurable via env)
   - Reject absolute paths outside allowed dirs

6. **Error handling**:
   - FFmpeg binary not found (install instruction)
   - File not found
   - Invalid format/codec
   - Out of disk space

7. **Progress tracking**:
   - Use ffmpeg-python progress hook if available
   - Otherwise estimate based on file size

Note: FFmpeg operations are synchronous. Use asyncio.to_thread() to run in background without blocking event loop.
  </action>
  <verify>python -c "from core.creative.ffmpeg_service import FFmpegService; print('FFmpegService imported successfully')"</verify>
  <done>FFmpegService class exists with video/audio operations, async job management, path validation</done>
</task>

<task type="auto">
  <name>Create creative tool with AUTONOMOUS-only governance</name>
  <files>backend/tools/creative_tool.py</files>
  <action>
Create `backend/tools/creative_tool.py` with LangChain BaseTool wrapper:

1. **FFmpegTool class** (extends BaseTool):
   - name: "ffmpeg_edit"
   - description: "Edit video and audio files. Trim, convert formats, extract audio, generate thumbnails. Requires AUTONOMOUS maturity (file safety)."
   - complexity: 3 (HIGH) - Modifies user files
   - maturity_required: "AUTONOMOUS"
   - _run method:
     - Check governance_cache.check_permission(agent_id, "ffmpeg_edit", maturity_level)
     - Reject STUDENT/INTERN/SUPERVISED agents with clear error
     - Load FFmpegService
     - Actions: trim_video, convert_format, extract_audio, generate_thumbnail, normalize_audio
     - Validate file paths against allowed directories
     - Return job_id for async operations

2. **Action parameter parsing**:
   - action: Which operation to perform
   - input_path: Source file path (within allowed dirs)
   - output_path: Destination file path (within allowed dirs)
   - Additional parameters: start_time, duration, format, timestamp

3. **Tool registration**:
   - Register with ToolRegistry
   - Category: "creative"
   - Tags: ["video", "audio", "ffmpeg", "media", "editing"]

4. **Governance enforcement**:
   - AUTONOMOUS ONLY - no exceptions
   - STUDENT/INTERN/SUPERVISED agents receive PermissionDeniedError
   - Log all FFmpeg operations with input/output paths
   - Include job_id in audit trail for tracking

5. **Error handling**:
   - Clear error messages for permission denied
   - "FFmpeg editing requires AUTONOMOUS maturity level. Your agent is at {level} maturity."
   - "File path outside allowed directory: {path}"
   - "FFmpeg binary not found - install with: brew install ffmpeg"

Use device_tool.py as reference for governance patterns.
  </action>
  <verify>python -c "from tools.creative_tool import FFmpegTool; print('FFmpegTool imported successfully')"</verify>
  <done>FFmpegTool exists with AUTONOMOUS-only governance, path validation, registered in ToolRegistry</done>
</task>

<task type="auto">
  <name>Create creative REST API endpoints with async jobs</name>
  <files>backend/api/creative_routes.py</files>
  <action>
Create `backend/api/creative_routes.py` with FastAPI router:

1. **Video endpoints**:
   - POST /creative/video/trim - Trim video (body: {input_path, output_path, start_time, duration})
     - Returns: {job_id, status: "pending"}
   - POST /creative/video/convert - Convert format (body: {input_path, output_path, format})
     - Returns: {job_id, status: "pending"}
   - POST /creative/video/thumbnail - Generate thumbnail (body: {video_path, thumbnail_path, timestamp})
     - Returns: {job_id, status: "pending"}

2. **Audio endpoints**:
   - POST /creative/audio/extract - Extract audio from video (body: {video_path, audio_path, format})
     - Returns: {job_id, status: "pending"}
   - POST /creative/audio/normalize - Normalize audio volume (body: {input_path, output_path})
     - Returns: {job_id, status: "pending"}

3. **Job status endpoints**:
   - GET /creative/jobs/{job_id} - Get job status
     - Returns: {job_id, status, progress, input_path, output_path, created_at, error}
   - GET /creative/jobs - List user's jobs
     - Query params: status (pending/running/completed/failed), limit

4. **File management endpoints**:
   - GET /creative/files - List allowed directory files
   - POST /creative/files/upload - Upload file to allowed directory
   - DELETE /creative/files/{file_path} - Delete file

5. **Error responses**:
   - 400: Invalid parameters (path outside allowed dirs, invalid format)
   - 403: AUTONOMOUS maturity required
   - 404: Job not found
   - 500: FFmpeg error

6. **Background task handling**:
   - Use BackgroundTasks from FastAPI for async jobs
   - Or asyncio.create_task() for fire-and-forget

7. **Router registration**:
   - Include in main_api_app with prefix /creative
   - Add tags: ["creative", "media"]

All endpoints require authentication (get_current_user dependency).
  </action>
  <verify>grep -q "creative_routes" backend/main_api_app.py || echo "Router not yet registered"</verify>
  <done>All creative endpoints defined, async job handling implemented, router created</done>
</task>

<task type="auto">
  <name>Add FFmpeg dependencies and Docker image</name>
  <files>backend/requirements.txt docker-compose-personal.yml</files>
  <action>
1. **Add to requirements.txt**:
```
# Creative tools (Phase 66)
ffmpeg-python>=0.2.0
```

2. **Update docker-compose-personal.yml**:
   - Add FFmpeg installation to backend service:
```yaml
atom-backend:
  build:
    context: ./backend
    dockerfile: Dockerfile
  # ... existing config ...
```

   - Update backend/Dockerfile to install FFmpeg:
```dockerfile
# Install FFmpeg for video/audio processing
RUN apt-get update && apt-get install -y ffmpeg && rm -rf /var/lib/apt/lists/*
```

   - Add allowed directories volume:
```yaml
volumes:
  - ./data:/app/data
  - ./data/media:/app/data/media  # FFmpeg input/output
```

   - Add environment variable for allowed directories:
```yaml
environment:
  - FFMPEG_ALLOWED_DIRS=/app/data/media,/app/data/exports
```

3. **Create .ffmpeg directory structure** (if needed):
   - mkdir -p data/media/input data/media/output data/exports
   - Document in setup guide

ffmpeg-python is a Pythonic wrapper that requires FFmpeg binary. The binary must be installed separately (apt-get install ffmpeg).
  </action>
  <verify>grep -E "(ffmpeg-python|ffmpeg)" backend/requirements.txt docker-compose-personal.yml</verify>
  <done>ffmpeg-python added to requirements, FFmpeg installed in Docker image, allowed directories configured</done>
</task>

<task type="checkpoint:human-verify">
  <name>Human verification checkpoint</name>
  <what-built>Complete FFmpeg creative tool service (3 files + Docker config)</what-built>
  <how-to-verify>
1. Start Personal Edition: `docker-compose -f docker-compose-personal.yml up -d`
2. Verify FFmpeg installed: `docker exec atom-personal-backend which ffmpeg` (should return /usr/bin/ffmpeg)
3. Upload test video to data/media/input/
4. Test trim endpoint: `curl -X POST http://localhost:8000/creative/video/trim -H "Content-Type: application/json" -d '{"input_path": "/app/data/media/input/test.mp4", "output_path": "/app/data/media/output/test_trim.mp4", "start_time": "00:00:00", "duration": "00:00:10"}'`
5. Check job status: `curl http://localhost:8000/creative/jobs/{job_id}`
6. Verify output file created: `ls -la data/media/output/test_trim.mp4`
7. Test governance: Try with STUDENT/INTERN agent (should be blocked)
  </how-to-verify>
  <resume-signal>Type "approved" if FFmpeg is working, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Import check**: `python -c "from core.creative.ffmpeg_service import FFmpegService; from tools.creative_tool import FFmpegTool; print('All imports successful')"`

2. **FFmpeg binary check**: `which ffmpeg` (or in Docker: `docker exec atom-personal-backend which ffmpeg`)

3. **API routes check**: `curl http://localhost:8000/docs` should show /creative endpoints

4. **Governance check**: Tool registered with category="creative", maturity_required="AUTONOMOUS"

5. **Security check**: Path validation rejects ../ and absolute paths outside allowed dirs

6. **Async job check**: Jobs return immediately with job_id, status updates in background
</verification>

<success_criteria>
1. FFmpeg binary available in backend container
2. Agent can trim videos: "Trim the screencast from 5:00 to 10:00"
3. Agent can convert formats: "Convert this video to WebM"
4. Agent can extract audio: "Extract the audio from the meeting recording"
5. Agent can generate thumbnails: "Create a thumbnail at 30 seconds for each video"
6. Long-running jobs don't block API (async processing)
7. File operations restricted to allowed directories only
8. AUTONOMOUS-only governance enforced (STUDENT/INTERN/SUPERVISED blocked)
9. Job status tracking works with progress updates
</success_criteria>

<output>
After completion, create `.planning/phases/66-personal-edition-enhancements/66-03-SUMMARY.md` with:
- Files created (4 files)
- FFmpeg operations implemented (5 operations)
- Async job handling method (asyncio.create_task)
- Governance maturity level (AUTONOMOUS only)
- Security boundaries (allowed directories, path validation)
- Docker FFmpeg installation method
- Test commands for manual verification
</output>
