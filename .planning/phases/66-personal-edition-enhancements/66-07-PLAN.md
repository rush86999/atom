---
phase: 66-personal-edition-enhancements
plan: 07
type: execute
wave: 3
depends_on: [66-01, 66-02, 66-03, 66-04, 66-05, 66-06]
files_modified:
  - backend/tests/test_media_tool.py
  - backend/tests/test_smarthome_tool.py
  - backend/tests/test_creative_tool.py
  - backend/tests/test_productivity_tool.py
  - backend/tests/test_local_only_guard.py
  - backend/tests/test_audit_logger.py
  - docs/PERSONAL_EDITION_GUIDE.md
autonomous: true
must_haves:
  truths:
    - "All media control tests pass (Spotify, Sonos tool tests)"
    - "All smart home tests pass (Hue, Home Assistant tests)"
    - "All creative tool tests pass (FFmpeg operations)"
    - "All productivity tests pass (Notion integration)"
    - "Security tests pass (local-only guard, token encryption, audit logging)"
    - "Comprehensive documentation exists for users"
    - "Quick start guide tested and working"
  artifacts:
    - path: "backend/tests/test_media_tool.py"
      provides: "Tests for Spotify and Sonos tools"
      min_lines: 150
    - path: "backend/tests/test_smarthome_tool.py"
      provides: "Tests for Hue and Home Assistant tools"
      min_lines: 150
    - path: "backend/tests/test_creative_tool.py"
      provides: "Tests for FFmpeg creative tool"
      min_lines: 100
    - path: "backend/tests/test_productivity_tool.py"
      provides: "Tests for Notion integration"
      min_lines: 150
    - path: "backend/tests/test_local_only_guard.py"
      provides: "Tests for local-only mode enforcement"
      min_lines: 80
    - path: "docs/PERSONAL_EDITION_GUIDE.md"
      provides: "User guide for Personal Edition"
      min_lines: 300
  key_links:
    - from: "backend/tests/test_*.py"
      to: "backend/tools/*_tool.py"
      via: "Tool testing imports and mocks"
      pattern: "from tools\\..*_tool import"
    - from: "docs/PERSONAL_EDITION_GUIDE.md"
      to: "docker-compose-personal.yml"
      via: "Quick start instructions"
      pattern: "docker-compose.*personal"
---

<objective>
Create comprehensive test suite for all Phase 66 integrations and complete user documentation.

**Purpose**: Ensure all media, smart home, creative, and productivity integrations are tested and documented for reliable operation.

**Output**: Test files for all tools with mocks, security tests, and complete Personal Edition user guide.

**Why this matters**: Testing ensures integrations work correctly and handle errors. Documentation enables users to actually use the features. Both are essential for a production-ready Personal Edition.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-personal-edition-enhancements/66-RESEARCH.md
@.planning/ROADMAP.md

# Existing patterns to reuse
@backend/tests/test_browser_tool.py  # Tool testing patterns
@backend/tests/test_device_tool.py  # Device control testing patterns
@backend/tests/conftest.py  # Test fixtures
</context>

<tasks>

<task type="auto">
  <name>Create media control tests</name>
  <files>backend/tests/test_media_tool.py</files>
  <action>
Create `backend/tests/test_media_tool.py` with:

1. **SpotifyService tests** (with mocks):
   - test_get_authorization_url_generates_valid_url
     - Mock OAuthHandler
     - Verify URL contains client_id, redirect_uri, scopes
   - test_exchange_code_for_tokens_stores_encrypted
     - Mock token exchange response
     - Verify token stored encrypted (not plaintext)
   - test_get_current_track_returns_track_info
     - Mock Spotify API response
     - Verify track parsing
   - test_play_track_success
   - test_pause_playback_success
   - test_expired_token_refreshes_automatically
   - test_unauthorized_error_handling

2. **SonosService tests** (with mocks):
   - test_discover_speakers_returns_speaker_list
     - Mock SoCo discovery
     - Return list of {ip, name, model}
   - test_play_on_speaker
   - test_set_volume
   - test_join_group
   - test_speaker_not_found_error

3. **SpotifyTool tests**:
   - test_internet_agent_blocked_from_spotify_control
     - Verify STUDENT/INTERN blocked
   - test_supervised_agent_can_control_playback
   - test_autonomous_agent_has_full_access
   - test_governance_check_called

4. **SonosTool tests**:
   - test_governance_enforcement
   - test_discover_action
   - test_volume_control

5. **Integration tests** (with real services optional):
   - Mark with @pytest.mark.integration
   - Skip by default (requires real credentials)
   - Run with: pytest -m integration

Use pytest fixtures for db_session, mock_agent. Mock external API calls with pytest.mock.patch.
  </action>
  <verify>pytest backend/tests/test_media_tool.py -v --collect-only | grep "test_"</verify>
  <done>test_media_tool.py exists with 15+ tests covering Spotify and Sonos</done>
</task>

<task type="auto">
  <name>Create smart home tests</name>
  <files>backend/tests/test_smarthome_tool.py</files>
  <action>
Create `backend/tests/test_smarthome_tool.py` with:

1. **HueService tests** (with mocks):
   - test_discover_bridges_returns_ip_list
     - Mock python-hue-v2 BridgeFinder
   - test_connect_to_bridge_success
   - test_get_all_lights
   - test_set_light_state_on_off
   - test_set_light_state_brightness
   - test_set_light_state_color_xy
   - test_activate_scene
   - test_invalid_api_key_error

2. **HomeAssistantService tests** (with mocks):
   - test_get_states_returns_entity_list
     - Mock httpx AsyncClient
     - Verify Authorization header with Bearer token
   - test_get_state_single_entity
   - test_call_service_turn_on_light
   - test_call_service_switch_toggle
   - test_trigger_automation
   - test_unauthorized_token_error
   - test_connection_error_handling

3. **HueTool tests**:
   - test_supervised_agent_can_control_lights
   - test_student_agent_blocked
   - test_discover_action
   - test_set_light_action
   - test_scene_activation

4. **HomeAssistantTool tests**:
   - test_governance_enforcement
   - test_get_state_action
   - test_call_service_action

5. **Local network tests**:
   - test_local_services_work_without_internet
   - test_mdns_discovery_fallback_to_manual_ip

Use pytest-asyncio for async tests. Mock httpx.AsyncClient for HA tests.
  </action>
  <verify>pytest backend/tests/test_smarthome_tool.py -v --collect-only | grep "test_"</verify>
  <done>test_smarthome_tool.py exists with 15+ tests covering Hue and Home Assistant</done>
</task>

<task type="auto">
  <name>Create creative tool tests</name>
  <files>backend/tests/test_creative_tool.py</files>
  <action>
Create `backend/tests/test_creative_tool.py` with:

1. **FFmpegService tests** (with mocks):
   - test_trim_video_success
     - Mock ffmpeg-python run
     - Verify parameters: input, ss, t
   - test_extract_audio_success
     - Verify audio codec selection
   - test_generate_thumbnail_success
     - Verify vframes=1, format=image2
   - test_convert_format_success
   - test_normalize_audio_success
   - test_file_not_found_error
   - test_invalid_path_blocked
     - Verify path validation rejects ../

2. **Async job tests**:
   - test_job_created_returns_pending_status
   - test_job_runs_in_background
   - test_job_status_updates_progress
   - test_completed_job_has_output_path

3. **FFmpegTool tests**:
   - test_autonomous_agent_only_can_use_ffmpeg
     - Verify STUDENT/INTERN/SUPERVISED blocked
   - test_path_validation_enforced
   - test_trim_action
   - test_extract_audio_action

4. **Security tests**:
   - test_path_traversal_blocked
     - Attempt ../../etc/passwd should fail
   - test_absolute_path_outside_allowed_dir_blocked
   - test_allowed_dirs_enforced

5. **Integration tests** (requires FFmpeg binary):
   - test_real_ffmpeg_trim_operation
     - Mark with @pytest.mark.integration
     - Use test video file
   - test_real_ffmpeg_thumbnail_generation

Use test video fixtures (short 5-second video). Clean up output files after tests.
  </action>
  <verify>pytest backend/tests/test_creative_tool.py -v --collect-only | grep "test_"</verify>
  <done>test_creative_tool.py exists with 12+ tests covering FFmpeg operations and security</done>
</task>

<task type="auto">
  <name>Create productivity tests</name>
  <files>backend/tests/test_productivity_tool.py</files>
  <action>
Create `backend/tests/test_productivity_tool.py` with:

1. **NotionService tests** (with mocks):
   - test_get_authorization_url_generates_valid_url
     - Mock OAuthHandler
     - Verify Notion OAuth URL format
   - test_exchange_code_for_tokens_stores_workspace_info
     - Mock Notion token response
     - Verify workspace_id, workspace_name stored
   - test_search_workspace_returns_results
     - Mock Notion search API
     - Verify query parameter
   - test_list_databases
   - test_query_database
   - test_get_database_schema
   - test_get_page
   - test_create_page_success
   - test_update_page_success
   - test_append_page_blocks
   - test_rate_limit_handling

2. **NotionTool tests**:
   - test_student_agent_blocked_from_notion
   - test_intern_agent_can_read_only
     - Verify search, query, get_page allowed
     - Verify create_page, update_page blocked
   - test_supervised_agent_can_write
     - Verify create_page, update_page allowed
   - test_local_only_mode_blocks_notion

3. **API key authentication tests**:
   - test_api_key_authentication_works
   - test_oauth_and_api_key_both_supported

4. **Error handling tests**:
   - test_page_not_found_error
   - test_invalid_properties_error
   - test_rate_limit_retry_logic

5. **Integration tests** (requires real Notion credentials):
   - test_real_notion_search
   - test_real_notion_create_page
   - Mark with @pytest.mark.integration
   - Skip by default

Use pytest fixtures for Notion API mocking. Mock notion_client.Client for all unit tests.
  </action>
  <verify>pytest backend/tests/test_productivity_tool.py -v --collect-only | grep "test_"</verify>
  <done>test_productivity_tool.py exists with 15+ tests covering Notion integration</done>
</task>

<task type="auto">
  <name>Create security tests</name>
  <files>backend/tests/test_local_only_guard.py backend/tests/test_audit_logger.py</files>
  <action>
Create `backend/tests/test_local_only_guard.py` with:

1. **LocalOnlyGuard tests**:
   - test_is_local_only_enabled_returns_false_by_default
   - test_is_local_only_enabled_returns_true_when_env_set
   - test_allow_external_request_returns_true_when_disabled
   - test_allow_external_request_raises_when_enabled
     - Verify LocalOnlyModeError raised
     - Verify error message contains service name
   - test_require_local_allowed_decorator_blocks_function
   - test_get_blocked_services_list
   - test_get_local_allowed_services_list
   - test_local_services_not_blocked
     - Verify sonos, hue, home_assistant, ffmpeg allowed

2. **Create backend/tests/test_audit_logger.py** with:

3. **AuditLogger tests**:
   - test_log_media_action_creates_entry
     - Verify JSON format
     - Verify required fields (user_id, agent_id, action, service)
   - test_log_smarthome_action_creates_entry
   - test_log_creative_action_creates_entry
   - test_log_local_only_block_creates_entry
   - test_get_user_audit_log_returns_filtered_entries
   - test_get_service_audit_log_returns_filtered_entries
   - test_audit_log_rotation
     - Verify daily log file created
   - test_audit_log_retention
     - Verify old logs compressed/deleted

4. **Token encryption tests** (add to existing security tests or create new):
   - test_encrypt_token_produces_different_ciphertext
     - Same plaintext encrypts to different ciphertext (IV)
   - test_decrypt_token_recovers_plaintext
   - test_decrypt_with_wrong_key_raises_error
   - test_encrypt_api_key_calls_encrypt_token
   - test_token_rotation_updates_all_tokens

5. **OAuthToken model tests**:
   - test_token_encrypted_before_save
     - Intercept save and verify encryption
   - test_token_decrypted_after_load
   - test_is_expired_returns_true_for_expired_token
   - test_needs_refresh_returns_true_for_soon_expiring

Use pytest fixtures for temporary log files. Clean up test logs after tests.
  </action>
  <verify>pytest backend/tests/test_local_only_guard.py backend/tests/test_audit_logger.py -v --collect-only | grep "test_"</verify>
  <done>test_local_only_guard.py and test_audit_logger.py exist with 10+ tests each</done>
</task>

<task type="auto">
  <name>Create Personal Edition user guide</name>
  <files>docs/PERSONAL_EDITION_GUIDE.md</files>
  <action>
Create `docs/PERSONAL_EDITION_GUIDE.md` with comprehensive user documentation:

1. **Quick Start** (5 minutes to running):
```markdown
# Atom Personal Edition - User Guide

## Quick Start (5 Minutes)

1. **Install Prerequisites**
   - Docker Desktop: https://www.docker.com/products/docker-desktop
   - Git: https://git-scm.com/downloads

2. **Clone and Start**
   \`\`\`bash
   git clone https://github.com/your-org/atom.git
   cd atom
   cp .env.personal .env
   # Edit .env with at least one AI provider key
   docker-compose -f docker-compose-personal.yml up -d
   \`\`\`

3. **Access Atom**
   - Frontend: http://localhost:3000
   - API: http://localhost:8000
   - API Docs: http://localhost:8000/docs

4. **Stop**
   \`\`\`bash
   docker-compose -f docker-compose-personal.yml down
   \`\`\`
```

2. **Configuration**:
```markdown
## Configuration

### Required Settings
- One AI provider (OpenAI, Anthropic, or DeepSeek)
- Encryption keys (generate with: openssl rand -base64 32)

### Optional Integrations

#### Music Control (Spotify)
1. Create app: https://developer.spotify.com/dashboard
2. Set Redirect URI: http://localhost:8000/integrations/spotify/callback
3. Set SPOTIFY_CLIENT_ID and SPOTIFY_CLIENT_SECRET in .env
4. Authorize in UI: Settings -> Integrations -> Spotify

#### Smart Home (Philips Hue)
1. Find bridge IP (check router or Hue app)
2. Generate API key: Hue app -> Settings -> Hue Bridge -> Local API
3. Set HUE_BRIDGE_IP and HUE_API_KEY in .env
4. Auto-discovery works on local network

#### Smart Home (Home Assistant)
1. Create long-lived token: HA -> Settings -> Profile -> Long-Lived Access Tokens
2. Set HOME_ASSISTANT_URL (use http://host.docker.internal:8123 for Docker)
3. Set HOME_ASSISTANT_TOKEN in .env

#### Productivity (Notion)
Option 1: OAuth (recommended)
1. Create integration: https://www.notion.so/my-integrations
2. Set NOTION_CLIENT_ID and NOTION_CLIENT_SECRET

Option 2: API Key (simpler)
1. Create integration: https://www.notion.so/my-integrations
2. Copy "Internal Integration Token"
3. Set NOTION_API_KEY in .env
```

3. **Local-Only Mode**:
```markdown
## Local-Only Mode (Privacy)

Enable local-only mode to block all cloud services:

\`\`\`bash
# In .env
ATOM_LOCAL_ONLY=true
\`\`\`

### What Works in Local-Only Mode
- Sonos speakers (local network)
- Philips Hue lights (local network)
- Home Assistant (local network)
- FFmpeg video/audio processing (local)

### What's Blocked in Local-Only Mode
- Spotify (cloud API)
- Notion (cloud API)
- Any future OAuth-based service

### Privacy Guarantees
- All tokens stored encrypted in database
- Audit logs track all device/media actions
- No telemetry or metrics sent to external servers
- Docker network isolation prevents data leaks
```

4. **Agent Commands**:
```markdown
## Agent Commands

### Music Control
- "Pause the music"
- "Play my focus playlist"
- "Skip this track"
- "Volume to 50%"
- "What's playing?"

### Smart Home
- "Turn on the living room light"
- "Set bedroom to blue"
- "Activate movie scene"
- "What's the thermostat set to?"
- "Turn off all lights"

### Productivity
- "Create a task for tomorrow's meeting"
- "Search for pages about project X"
- "Add this to my todo list"
- "Show me tasks due this week"

### Creative Tools
- "Trim the screencast from 5:00 to 10:00"
- "Extract audio from the meeting recording"
- "Generate thumbnails for my videos"
- "Convert this video to WebM"
```

5. **Troubleshooting**:
```markdown
## Troubleshooting

### Port Already in Use
\`\`\`bash
# Check what's using port 8000
lsof -i :8000
# Kill the process or change port in docker-compose-personal.yml
\`\`\`

### Hue Bridge Not Found
- mDNS discovery may fail in Docker
- Set HUE_BRIDGE_IP manually in .env
- Find bridge IP in router admin or Hue app

### Home Assistant Connection Failed
- Verify HOME_ASSISTANT_URL is accessible from container
- Use http://host.docker.internal:8123 for local HA
- Check HA is running and token is valid

### FFmpeg Not Found
- FFmpeg is pre-installed in Docker image
- Verify with: docker exec atom-personal-backend which ffmpeg
- If missing, rebuild image: docker-compose build

### Spotify Authorization Fails
- Verify Redirect URI matches exactly (including http:// and port)
- Check Client ID and Secret are correct
- Ensure Spotify app is created (not just viewed)

### Database Locked
\`\`\`bash
# Reset database (CAUTION: loses all data)
docker-compose -f docker-compose-personal.yml down
rm data/atom.db
docker-compose -f docker-compose-personal.yml up -d
\`\`\`
```

6. **Advanced**:
```markdown
## Advanced Configuration

### Custom FFmpeg Directories
\`\`\`bash
# In .env
FFMPEG_ALLOWED_DIRS=/app/data/media,/app/data/exports,/custom/path
\`\`\`

### Audit Log Retention
\`\`\`bash
# In .env
AUDIT_LOG_RETENTION_DAYS=365  # Keep for 1 year
\`\`\`

### Database Migration
\`\`\`bash
# Enter backend container
docker exec -it atom-personal-backend bash

# Run migrations
alembic upgrade head

# Check migration status
alembic current
\`\`\`

### Backup Data
\`\`\`bash
# Backup all data
cp -r data data-backup-$(date +%Y%m%d)

# Restore from backup
docker-compose down
rm -rf data
cp -r data-backup-20260220 data
docker-compose up -d
\`\`\`
```

7. **Security Best Practices**:
```markdown
## Security Best Practices

1. **Generate Strong Encryption Keys**
   \`\`\`bash
   openssl rand -base64 32
   \`\`\`

2. **Never Commit .env File**
   - .env is in .gitignore
   - Use .env.personal as template

3. **Use Long-Lived Tokens for Local Services**
   - Hue API key (not cloud account)
   - Home Assistant long-lived token

4. **Enable Local-Only Mode for Privacy**
   - Blocks all cloud services
   - Only local devices work

5. **Review Audit Logs Regularly**
   - Location: data/logs/audit.log
   - All device/media actions logged
```

8. **Getting Help**:
```markdown
## Getting Help

- Documentation: https://docs.atom.ai
- GitHub Issues: https://github.com/your-org/atom/issues
- Discord: https://discord.gg/atom

### Debug Mode
\`\`\`bash
# Enable debug logging
docker-compose -f docker-compose-personal.yml logs -f backend
\`\`\`
```

Include diagrams, screenshots, and code examples where helpful.
  </action>
  <verify>wc -l docs/PERSONAL_EDITION_GUIDE.md && grep -E "(Quick Start|Configuration|Troubleshooting)" docs/PERSONAL_EDITION_GUIDE.md</verify>
  <done>docs/PERSONAL_EDITION_GUIDE.md exists with comprehensive user documentation</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Test collection**: `pytest backend/tests/test_media_tool.py backend/tests/test_smarthome_tool.py backend/tests/test_creative_tool.py backend/tests/test_productivity_tool.py backend/tests/test_local_only_guard.py backend/tests/test_audit_logger.py --collect-only | wc -l` (should be 60+ tests)

2. **Run tests**: `pytest backend/tests/test_media_tool.py backend/tests/test_smarthome_tool.py backend/tests/test_creative_tool.py backend/tests/test_productivity_tool.py -v -k "not integration"` (skip integration tests)

3. **Security tests**: `pytest backend/tests/test_local_only_guard.py backend/tests/test_audit_logger.py -v`

4. **Documentation**: `wc -l docs/PERSONAL_EDITION_GUIDE.md` (should be 300+ lines)

5. **Quick start verification**: Follow guide from scratch with fresh .env
</verification>

<success_criteria>
1. All tool tests pass (60+ tests total)
2. Security tests pass (local-only guard, audit logging, token encryption)
3. Integration tests exist and can be run with -m integration
4. User guide is comprehensive (300+ lines)
5. Quick start tested and working (fresh install succeeds)
6. Troubleshooting section covers common issues
7. Code examples are accurate and tested
8. Documentation is clear for non-technical users
</success_criteria>

<output>
After completion, create `.planning/phases/66-personal-edition-enhancements/66-07-SUMMARY.md` with:
- Files created (6 test files + 1 documentation)
- Test count breakdown (media: 15, smarthome: 15, creative: 12, productivity: 15, security: 20)
- Test coverage summary
- Documentation sections created
- Quick start verification results
</output>
