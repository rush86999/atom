---
phase: 66-personal-edition-enhancements
plan: 06
type: execute
wave: 2
depends_on: [66-01, 66-02, 66-03, 66-04, 66-05]
files_modified:
  - docker-compose-personal.yml
  - .env.personal
  - backend/Dockerfile
  - docker/personal-entrypoint.sh
autonomous: true
must_haves:
  truths:
    - "Single docker-compose command starts all Personal Edition services"
    - "All Personal Edition integrations pre-configured in Docker image"
    - "Environment variables documented in .env.personal"
    - "Health check endpoints verify service status"
    - "Data persists across container restarts (volumes)"
    - "Local network discovery works (mDNS for Hue/Sonos)"
    - "FFmpeg binary available for video/audio processing"
    - "Quick start guide gets user running in <5 minutes"
  artifacts:
    - path: "docker-compose-personal.yml"
      provides: "Docker Compose configuration for Personal Edition"
      min_lines: 150
      contains: "services", "volumes", "networks"
    - path: ".env.personal"
      provides: "Personal Edition environment configuration"
      min_lines: 100
      contains: "ATOM_LOCAL_ONLY", "SPOTIFY", "HUE", "HOME_ASSISTANT"
    - path: "backend/Dockerfile"
      provides: "Backend Docker image with all dependencies"
      contains: "ffmpeg", "spotipy", "SoCo", "notion-sdk-py"
    - path: "docker/personal-entrypoint.sh"
      provides: "Container startup script with health checks"
      min_lines: 50
      exports: ["/app/docker/personal-entrypoint.sh"]
  key_links:
    - from: "docker-compose-personal.yml"
      to: ".env.personal"
      via: "env_file configuration"
      pattern: "env_file.*\\.env"
    - from: "backend/Dockerfile"
      to: "requirements.txt"
      via: "Python package installation"
      pattern: "RUN pip install.*-r requirements.txt"
    - from: "docker/personal-entrypoint.sh"
      to: "/health/live"
      via: "Container health check"
      pattern: "curl.*health/live"
---

<objective>
Enhance Personal Edition Docker Compose configuration with all Phase 66 integrations pre-configured for single-command setup.

**Purpose**: Enable users to start Personal Edition with `docker-compose -f docker-compose-personal.yml up -d` and have all media, smart home, creative, and productivity integrations ready to configure.

**Output**: Updated Docker Compose with all services, enhanced environment configuration, FFmpeg pre-installed, quick start documentation.

**Why this matters**: Personal Edition's value proposition is simplicity. Users shouldn't need to manually install Python dependencies or configure services. Docker Compose should "just work" with credential configuration.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-personal-edition-enhancements/66-RESEARCH.md
@.planning/ROADMAP.md

# Existing patterns to reuse
@docker-compose-personal.yml  # Current Personal Edition configuration
@.env.personal  # Current environment template
@backend/Dockerfile  # Current backend Docker image
</context>

<tasks>

<task type="auto">
  <name>Update Docker Compose with Phase 66 services</name>
  <files>docker-compose-personal.yml</files>
  <action>
Update `docker-compose-personal.yml` with:

1. **Backend service enhancements**:
```yaml
atom-backend:
  build:
    context: ./backend
    dockerfile: Dockerfile
  container_name: atom-personal-backend
  ports:
    - "8000:8000"
  environment:
    # Database (SQLite for Personal Edition)
    - DATABASE_URL=sqlite:///./data/atom.db
    - SQLITE_PATH=./data/atom.db

    # Basic configuration
    - ENVIRONMENT=development
    - LOG_LEVEL=INFO
    - PYTHONUNBUFFERED=1

    # AI Providers (required)
    - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}

    # Encryption keys (required)
    - BYOK_ENCRYPTION_KEY=${BYOK_ENCRYPTION_KEY:-default-insecure-key-change-me}
    - JWT_SECRET_KEY=${JWT_SECRET_KEY:-default-jwt-secret-change-me}

    # Vector embeddings
    - LANCEDB_PATH=./data/lancedb
    - ENABLE_LANCEDB=true
    - EMBEDDING_PROVIDER=fastembed
    - FASTEMBED_MODEL=BAAI/bge-small-en-v1.5

    # Redis (Valkey)
    - REDIS_URL=redis://valkey:6379

    # ==============================================================================
    # PHASE 66: Personal Edition Enhancements
    # ==============================================================================

    # Local-Only Mode (Privacy)
    - ATOM_LOCAL_ONLY=${ATOM_LOCAL_ONLY:-false}

    # Media Integrations (OAuth)
    - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID:-}
    - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET:-}
    - SPOTIFY_REDIRECT_URI=http://localhost:8000/integrations/spotify/callback

    # Smart Home (Local - work in local-only mode)
    - HUE_BRIDGE_IP=${HUE_BRIDGE_IP:-}  # Auto-discovered if not set
    - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL:-http://host.docker.internal:8123}
    - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN:-}

    # Productivity (OAuth - blocked in local-only mode)
    - NOTION_CLIENT_ID=${NOTION_CLIENT_ID:-}
    - NOTION_CLIENT_SECRET=${NOTION_CLIENT_SECRET:-}
    - NOTION_REDIRECT_URI=http://localhost:8000/integrations/notion/callback
    - NOTION_API_KEY=${NOTION_API_KEY:-}  # Alternative to OAuth

    # Creative Tools
    - FFMPEG_ALLOWED_DIRS=/app/data/media,/app/data/exports

    # Security & Audit
    - AUDIT_LOG_PATH=logs/audit.log
    - AUDIT_LOG_RETENTION_DAYS=${AUDIT_LOG_RETENTION_DAYS:-90}

  volumes:
    # Persist all data
    - ./data:/app/data
    - ./backend:/app  # Hot reload for development
  working_dir: /app
  command: uvicorn main_api_app:app --host 0.0.0.0 --port 8000 --reload
  restart: unless-stopped
  depends_on:
    valkey:
      condition: service_healthy
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/health/live"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
  networks:
    - atom-local
  # Extra hosts for local network access
  extra_hosts:
    - "host.docker.internal:host-gateway"
```

2. **Valkey service** (unchanged - already exists):
```yaml
valkey:
  image: valkey/valkey:latest
  container_name: atom-personal-valkey
  ports:
    - "6379:6379"
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 10s
  restart: unless-stopped
  networks:
    - atom-local
```

3. **Frontend service** (unchanged - already exists):
```yaml
atom-frontend:
  build:
    context: ./frontend-nextjs
    dockerfile: Dockerfile
  container_name: atom-personal-frontend
  ports:
    - "3000:3000"
  environment:
    - NEXT_PUBLIC_API_URL=http://localhost:8000
    - NODE_ENV=development
  volumes:
    - ./frontend-nextjs:/app
    - /app/node_modules
    - /app/.next
  restart: unless-stopped
  depends_on:
    - atom-backend
  networks:
    - atom-local
```

4. **Browser service** (optional - already exists):
```yaml
browser-node:
  image: browserless/chrome:latest
  container_name: atom-personal-browser
  ports:
    - "3001:3000"
  environment:
    - MAX_CONCURRENT_SESSIONS=3
    - PREBOOT_CHROME=true
  restart: unless-stopped
  networks:
    - atom-local
```

5. **Networks**:
```yaml
networks:
  atom-local:
    driver: bridge
    internal: false  # Allow outbound for OAuth, local-only mode controls this
    ipam:
      config:
        - subnet: 172.28.0.0/16
```

6. **Volumes**:
```yaml
volumes:
  atom-personal-data:
    driver: local
```

7. **Comments**:
   - Add comments explaining each service
   - Document which integrations work in local-only mode
   - Include quick start instructions at top

Keep existing browser-node service optional (commented if not needed).
  </action>
  <verify>grep -E "(SPOTIFY|HUE|HOME_ASSISTANT|NOTION|FFMPEG|ATOM_LOCAL_ONLY)" docker-compose-personal.yml</verify>
  <done>docker-compose-personal.yml updated with all Phase 66 environment variables</done>
</task>

<task type="auto">
  <name>Update .env.personal with all integration credentials</name>
  <files>.env.personal</files>
  <action>
Update `.env.personal` with comprehensive configuration:

1. **Add quick start header**:
```bash
# ==============================================================================
# Atom Personal Edition - Environment Configuration
# ==============================================================================
# Quick Start:
#   1. Copy this file to .env: cp .env.personal .env
#   2. Edit .env with your API keys and preferences
#   3. Start: docker-compose -f docker-compose-personal.yml up -d
#   4. Access: http://localhost:8000 (API) or http://localhost:3000 (frontend)
#
# Minimum Required:
#   - One AI provider key (OpenAI, Anthropic, or DeepSeek)
#   - Encryption keys (generate with: openssl rand -base64 32)
#
# Optional Integrations (see below):
#   - Media: Spotify
#   - Smart Home: Philips Hue, Home Assistant
#   - Productivity: Notion
# ==============================================================================
```

2. **Add Phase 66 sections** (merge with existing):

```bash
# ==============================================================================
# LOCAL-ONLY MODE (Privacy Feature)
# ==============================================================================
# When enabled, blocks all cloud-based services (Spotify, Notion, etc.)
# Local services continue to work: Sonos, Hue, Home Assistant, FFmpeg
# Set to 'true' for complete privacy, 'false' to enable cloud integrations
ATOM_LOCAL_ONLY=false

# ==============================================================================
# MEDIA INTEGRATIONS (Optional)
# ==============================================================================
# Spotify - Get credentials from: https://developer.spotify.com/dashboard
# 1. Create an app
# 2. Set Redirect URI to: http://localhost:8000/integrations/spotify/callback
# 3. Copy Client ID and Secret
SPOTIFY_CLIENT_ID=your-spotify-client-id
SPOTIFY_CLIENT_SECRET=your-spotify-client-secret

# Sonos - No credentials required (local network discovery)
# Sonos speakers are auto-discovered via mDNS/SSDP

# ==============================================================================
# SMART HOME INTEGRATIONS (Local - Work in Local-Only Mode)
# ==============================================================================
# Philips Hue Bridge
# 1. Find bridge IP: Check router admin or use Hue app
# 2. Generate API key: Hue app -> Settings -> Hue Bridge -> Local API -> Create
# 3. Optional: Leave HUE_BRIDGE_IP empty for auto-discovery
HUE_BRIDGE_IP=192.168.1.100
HUE_API_KEY=your-hue-api-key-from-app

# Home Assistant
# 1. Create long-lived token: HA Settings -> Profile -> Long-Lived Access Tokens
# 2. Set URL (use http://host.docker.internal:8123 for Docker)
HOME_ASSISTANT_URL=http://host.docker.internal:8123
HOME_ASSISTANT_TOKEN=your-ha-long-lived-token

# ==============================================================================
# PRODUCTIVITY INTEGRATIONS (Optional - Blocked in Local-Only Mode)
# ==============================================================================
# Notion - Two setup options:
#
# Option 1: OAuth (Recommended for multi-user)
# 1. Create integration: https://www.notion.so/my-integrations
# 2. Copy Client ID and Secret
# 3. Set Redirect URI to: http://localhost:8000/integrations/notion/callback
NOTION_CLIENT_ID=your-notion-client-id
NOTION_CLIENT_SECRET=your-notion-client-secret
#
# Option 2: API Key (Simpler for Personal Edition)
# 1. Create integration: https://www.notion.so/my-integrations
# 2. Copy "Internal Integration Token"
# 3. Set NOTION_API_KEY (no OAuth required)
NOTION_API_KEY=your-notion-internal-integration-token

# ==============================================================================
# CREATIVE TOOLS (Local - Work in Local-Only Mode)
# ==============================================================================
# FFmpeg - Pre-installed in Docker image
# Define allowed directories for video/audio processing
FFMPEG_ALLOWED_DIRS=/app/data/media,/app/data/exports

# ==============================================================================
# SECURITY & AUDIT
# ==============================================================================
# Audit logging for device/media/smarthome/creative actions
AUDIT_LOG_RETENTION_DAYS=90
```

3. **Add usage notes**:
```bash
# ==============================================================================
# USAGE NOTES
# ==============================================================================
# Local-Only Mode:
#   - Set ATOM_LOCAL_ONLY=true to block all cloud services
#   - Sonos, Hue, Home Assistant, FFmpeg continue to work
#   - No data leaves your local network
#
# Smart Home Discovery:
#   - Hue bridges and Sonos speakers use mDNS for discovery
#   - Docker networking may block mDNS - use host IPs if needed
#   - Home Assistant must be accessible from container
#
# File Processing:
#   - Upload files to ./data/media/input/
#   - Processed files saved to ./data/media/output/
#   - FFmpeg operations restricted to these directories
```

4. **Preserve existing sections**:
   - AI provider keys
   - Encryption keys
   - Database settings
   - Vector embeddings
   - Redis configuration

Merge with existing .env.personal content to preserve any user customizations.
  </action>
  <verify>grep -E "(SPOTIFY|HUE|HOME_ASSISTANT|NOTION|FFMPEG|ATOM_LOCAL_ONLY)" .env.personal</verify>
  <done>.env.personal updated with all Phase 66 integration credentials</done>
</task>

<task type="auto">
  <name>Update backend Dockerfile with Phase 66 dependencies</name>
  <files>backend/Dockerfile</files>
  <action>
Update `backend/Dockerfile` to include all Phase 66 dependencies:

1. **Install FFmpeg**:
```dockerfile
# Install FFmpeg for video/audio processing
RUN apt-get update && apt-get install -y \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*
```

2. **Install Python dependencies** (ensure requirements.txt is copied):
```dockerfile
# Copy requirements first for better caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt
```

3. **Create directories for Personal Edition**:
```dockerfile
# Create data directories for Personal Edition
RUN mkdir -p /app/data/media/input \
    /app/data/media/output \
    /app/data/exports \
    /app/data/lancedb \
    /app/logs

# Set permissions
RUN chmod -R 755 /app/data /app/logs
```

4. **Health check** (ensure curl is available):
```dockerfile
# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health/live || exit 1
```

5. **Complete example** (merge with existing Dockerfile):
```dockerfile
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application
COPY . .

# Create directories
RUN mkdir -p /app/data/media/input \
    /app/data/media/output \
    /app/data/exports \
    /app/data/lancedb \
    /app/logs

# Set permissions
RUN chmod -R 755 /app/data /app/logs

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health/live || exit 1

# Run application
CMD ["uvicorn", "main_api_app:app", "--host", "0.0.0.0", "--port", "8000"]
```

6. **Multi-stage build** (optional for smaller image):
```dockerfile
# Build stage
FROM python:3.11-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# Runtime stage
FROM python:3.11-slim
WORKDIR /app
RUN apt-get update && apt-get install -y curl ffmpeg && rm -rf /var/lib/apt/lists/*
COPY --from=builder /root/.local /root/.local
COPY . .
ENV PATH=/root/.local/bin:$PATH
# ... rest of configuration
```

Verify all Phase 66 packages are in requirements.txt (spotipy, SoCo, python-hue-v2, notion-sdk-py, ffmpeg-python).
  </action>
  <verify>grep -E "(ffmpeg|curl)" backend/Dockerfile</verify>
  <done>backend/Dockerfile updated with FFmpeg, curl, and directory creation</done>
</task>

<task type="auto">
  <name>Create Personal Edition entrypoint script</name>
  <files>docker/personal-entrypoint.sh</files>
  <action>
Create `docker/personal-entrypoint.sh` with:

1. **Container startup checks**:
```bash
#!/bin/bash
set -e

echo "Starting Atom Personal Edition..."

# Check if encryption key is set (not default)
if [ "$BYOK_ENCRYPTION_KEY" = "default-insecure-key-change-me" ] || [ -z "$BYOK_ENCRYPTION_KEY" ]; then
    echo "‚ö†Ô∏è  WARNING: Using default encryption key!"
    echo "   Generate a secure key with: openssl rand -base64 32"
    echo "   Set BYOK_ENCRYPTION_KEY in .env file"
fi

# Check if at least one AI provider is configured
if [ -z "$OPENAI_API_KEY" ] && [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$DEEPSEEK_API_KEY" ]; then
    echo "‚ö†Ô∏è  WARNING: No AI provider API key configured!"
    echo "   Set OPENAI_API_KEY, ANTHROPIC_API_KEY, or DEEPSEEK_API_KEY in .env"
fi

# Check local-only mode
if [ "$ATOM_LOCAL_ONLY" = "true" ]; then
    echo "‚ÑπÔ∏è  Local-only mode ENABLED (cloud services blocked)"
    echo "   Available: Sonos, Hue, Home Assistant, FFmpeg"
else
    echo "‚ÑπÔ∏è  Local-only mode DISABLED (cloud services available)"
    echo "   Available: All integrations (Spotify, Notion, etc.)"
fi

# Create required directories
mkdir -p /app/data/media/input
mkdir -p /app/data/media/output
mkdir -p /app/data/exports
mkdir -p /app/data/lancedb
mkdir -p /app/logs

echo "‚úÖ Personal Edition startup checks complete"
echo "üöÄ Starting Atom backend..."

# Run the main command
exec "$@"
```

2. **Make executable**:
```bash
chmod +x docker/personal-entrypoint.sh
```

3. **Update docker-compose-personal.yml** to use entrypoint:
```yaml
atom-backend:
  # ... other config ...
  entrypoint: ["/app/docker/personal-entrypoint.sh"]
  command: ["uvicorn", "main_api_app:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

4. **Health indicators**:
   - Check for FFmpeg binary
   - Check Python packages installed
   - Display startup status

5. **Error handling**:
   - Graceful handling of missing directories
   - Clear error messages for misconfiguration
   - Continue startup with warnings (not fatal)

The entrypoint script provides helpful feedback on container startup and validates configuration.
  </action>
  <verify>chmod +x docker/personal-entrypoint.sh && head -5 docker/personal-entrypoint.sh</verify>
  <done>docker/personal-entrypoint.sh created with startup checks and helpful messages</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Docker Compose syntax**: `docker-compose -f docker-compose-personal.yml config` (should parse without errors)

2. **Environment variables**: `grep -E "(SPOTIFY|HUE|HOME_ASSISTANT|NOTION|FFMPEG|ATOM_LOCAL_ONLY)" docker-compose-personal.yml`

3. **Dockerfile build**: `docker build -f backend/Dockerfile .` (should build successfully)

4. **Entrypoint script**: `bash -n docker/personal-entrypoint.sh` (syntax check)

5. **Full stack test**:
   - `docker-compose -f docker-compose-personal.yml up -d`
   - Check logs for startup messages
   - Verify health endpoint: `curl http://localhost:8000/health/live`
   - Check services running: `docker ps`

6. **Integration status**:
   - Check FFmpeg installed: `docker exec atom-personal-backend which ffmpeg`
   - Check Python packages: `docker exec atom-personal-backend pip list | grep -E "(spotipy|soco|notion)"`
</verification>

<success_criteria>
1. Single command starts all services: `docker-compose -f docker-compose-personal.yml up -d`
2. All Phase 66 integrations pre-configured (environment variables set)
3. FFmpeg binary available in container
4. Entrypoint script shows helpful configuration warnings
5. Health check endpoint responds
6. Data persists across container restarts
7. Quick start guide works for new users (<5 minutes to running)
8. Local-only mode flag documented and functional
</success_criteria>

<output>
After completion, create `.planning/phases/66-personal-edition-enhancements/66-06-SUMMARY.md` with:
- Files created/updated (4 files)
- Docker Compose services (4 services: backend, valkey, frontend, browser)
- Pre-installed Python packages list
- Quick start steps
- Configuration checklist
- Troubleshooting common issues
</output>
