---
phase: 66-personal-edition-enhancements
plan: 05
type: execute
wave: 2
depends_on: [66-04]
files_modified:
  - backend/core/productivity/notion_service.py
  - backend/tools/productivity_tool.py
  - backend/api/productivity_routes.py
  - backend/requirements.txt
  - backend/core/models.py
autonomous: true
user_setup:
  - service: notion
    why: "Notion API integration for database and page access"
    env_vars:
      - name: NOTION_CLIENT_ID
        source: "Notion My Integrations -> Create integration -> Client ID"
      - name: NOTION_CLIENT_SECRET
        source: "Notion My Integrations -> Create integration -> Client Secret"
      - name: NOTION_REDIRECT_URI
        source: "Set to http://localhost:8000/integrations/notion/callback"
      - name: NOTION_API_KEY
        source: "Alternative: Notion My Integrations -> Internal Integration Token (no OAuth required)"

must_haves:
  truths:
    - "User can authorize Atom to access their Notion workspace via OAuth"
    - "Agent can query Notion databases and retrieve pages"
    - "Agent can create and edit Notion pages and database entries"
    - "Agent can search Notion workspace for content"
    - "All Notion API tokens stored encrypted in database"
    - "Notion blocked in local-only mode (requires external API)"
    - "INTERN+ agents can read, SUPERVISED+ agents can write (governance)"
  artifacts:
    - path: "backend/core/productivity/notion_service.py"
      provides: "Notion API integration with OAuth"
      min_lines: 200
      exports: ["NotionService", "get_database", "query_database", "create_page", "update_page"]
    - path: "backend/tools/productivity_tool.py"
      provides: "LangChain BaseTool for productivity operations"
      min_lines: 100
      exports: ["NotionTool"]
    - path: "backend/api/productivity_routes.py"
      provides: "REST API endpoints for productivity integrations"
      min_lines: 120
      exports: ["GET /integrations/notion/authorize", "GET /productivity/notion/databases", "POST /productivity/notion/pages"]
  key_links:
    - from: "backend/core/productivity/notion_service.py"
      to: "notion-sdk-py"
      via: "Official Notion Python SDK"
      pattern: "from notion_client import Client"
    - from: "backend/core/productivity/notion_service.py"
      to: "backend/core/oauth_handler.py"
      via: "OAuth flow for Notion authorization"
      pattern: "OAuthHandler"
    - from: "backend/tools/productivity_tool.py"
      to: "backend/core/security/local_only_guard.py"
      via: "Local-only mode check for Notion"
      pattern: "require_local_allowed.*notion"
    - from: "backend/tools/productivity_tool.py"
      to: "backend/core/governance_cache.py"
      via: "Maturity level checks (INTERN+ read, SUPERVISED+ write)"
      pattern: "maturity_required"
---

<objective>
Implement Notion API integration with OAuth authentication, database querying, page creation/editing, and governance integration.

**Purpose**: Enable Atom agents to interact with Notion workspaces for personal productivity (e.g., "Create a task in my Notion todo database", "Find pages about project X", "Add meeting notes to the database").

**Output**: Working Notion integration with encrypted token storage, OAuth flow, INTERN+ read/SUPERVISED+ write governance, and REST API endpoints.

**Why this matters**: Notion is the standard for personal knowledge management. Integration enables agents to be truly helpful for personal productivity - organizing tasks, retrieving information, and maintaining documentation.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-personal-edition-enhancements/66-RESEARCH.md
@.planning/ROADMAP.md

# Existing patterns to reuse
@backend/core/oauth_handler.py  # OAuth 2.0 flow (Notion uses Basic Auth for token exchange)
@backend/core/security/local_only_guard.py  # Local-only mode enforcement
@backend/core/models.py  # OAuthToken model for encrypted storage
@backend/core/media/spotify_service.py  # OAuth pattern reference
</context>

<tasks>

<task type="auto">
  <name>Create Notion service with OAuth integration</name>
  <files>backend/core/productivity/notion_service.py</files>
  <action>
Create `backend/core/productivity/notion_service.py` with:

1. **NotionService class**:
   - Use notion-sdk-py (official Notion Python client)
   - OAuth 2.0 flow with Notion-specific handling

2. **OAuth configuration**:
   - SCOPES = (Notion doesn't use scopes - all access granted)
   - OAuthConfig with:
     - client_id_env="NOTION_CLIENT_ID"
     - client_secret_env="NOTION_CLIENT_SECRET"
     - redirect_uri_env="NOTION_REDIRECT_URI"
     - auth_url="https://api.notion.com/v1/oauth/authorize"
     - token_url="https://api.notion.com/v1/oauth/token"
   - Notion requires Basic Auth for token exchange (already in oauth_handler.py)

3. **OAuth methods**:
   - async get_authorization_url(user_id: str) -> str
     - Generate OAuth authorization URL
     - Include state parameter for CSRF protection
   - async exchange_code_for_tokens(code: str, user_id: str) -> Dict
     - Exchange code for access token
     - Notion returns: access_token, workspace_id, workspace_name, workspace_icon
     - Store encrypted in OAuthToken model
     - Notion tokens don't expire (no refresh token)

4. **Workspace methods**:
   - async search_workspace(query: str, user_id: str) -> List[Dict]
     - Search pages, databases, child pages
     - Return: id, title, type, parent
   - async list_databases(user_id: str) -> List[Dict]
     - List all databases in workspace
     - Return: id, title, description

5. **Database methods**:
   - async query_database(database_id: str, user_id: str, filter: Dict = None) -> List[Dict]
     - Query database with optional filter
     - Return list of page results
     - Support pagination (handle Notion's cursor-based pagination)
   - async get_database_schema(database_id: str, user_id: str) -> Dict
     - Get database schema (properties, title)
     - Return property types (title, text, number, date, select, etc.)

6. **Page methods**:
   - async get_page(page_id: str, user_id: str) -> Dict
     - Get page content (blocks, properties)
     - Return formatted page data
   - async create_page(database_id: str, user_id: str, properties: Dict) -> Dict
     - Create new page in database
     - Properties formatted per Notion API spec
   - async update_page(page_id: str, user_id: str, properties: Dict) -> Dict
     - Update existing page properties
     - Partial updates allowed
   - async append_page_blocks(page_id: str, user_id: str, blocks: List[Dict]) -> Dict
     - Add content blocks to page
     - Support: paragraph, heading, bullet list, numbered list, todo, code, quote

7. **Alternative: API key authentication**:
   - Support NOTION_API_KEY environment variable (internal integration token)
   - No OAuth required for personal use
   - Simpler setup for Personal Edition users

8. **Error handling**:
   - 401 Unauthorized (invalid token)
   - 404 Not Found (page/database doesn't exist)
   - 400 Bad Request (invalid properties/filter)
   - 429 Rate Limited (Notion rate limit: 3 requests/second)

9. **Local-only mode**:
   - Import and use @require_local_allowed("notion")
   - Block all Notion API calls when ATOM_LOCAL_ONLY=true

Use httpx.AsyncClient for direct API calls if notion-sdk-py doesn't support async well.
  </action>
  <verify>python -c "from core.productivity.notion_service import NotionService; print('NotionService imported successfully')"</verify>
  <done>NotionService class exists with OAuth, workspace search, database query, page CRUD</done>
</task>

<task type="auto">
  <name>Create productivity tool with read/write governance</name>
  <files>backend/tools/productivity_tool.py</files>
  <action>
Create `backend/tools/productivity_tool.py` with LangChain BaseTool wrapper:

1. **NotionTool class** (extends BaseTool):
   - name: "notion_workspace"
   - description: "Access Notion workspace. Search pages, query databases, create/edit pages. Read operations require INTERN+, write operations require SUPERVISED+."
   - complexity: 2 (MODERATE)
   - maturity_required_read: "INTERN" - For search, get_page, query_database
   - maturity_required_write: "SUPERVISED" - For create_page, update_page, append_blocks

2. **Action parsing with maturity gates**:
   - _run method checks action type and applies appropriate maturity gate:
     - Read actions (INTERN+): search, list_databases, query_database, get_page, get_schema
     - Write actions (SUPERVISED+): create_page, update_page, append_blocks

3. **Action parameter support**:
   - action: Which operation to perform
   - query: Search query for workspace search
   - database_id: Target database for query/create
   - page_id: Target page for get/update/append
   - properties: Page properties (for create/update)
   - blocks: Content blocks (for append)
   - filter: Database query filter

4. **Response formatting**:
   - Format Notion API responses into user-friendly text
   - Extract titles, properties, content from nested structures
   - Handle Notion's rich text formatting (plain text extraction)

5. **Tool registration**:
   - Register with ToolRegistry
   - Category: "productivity"
   - Tags: ["notion", "knowledge", "database", "tasks", "notes"]

6. **Governance enforcement**:
   - STUDENT agents blocked from all Notion operations
   - INTERN agents can read only (search, query, get)
   - SUPERVISED+ agents can write (create, update, append)
   - AUTONOMOUS agents have full access
   - Log all Notion operations with resource identification

7. **Error handling**:
   - "Notion integration requires INTERN+ maturity level. Your agent is at {level}."
   - "Page creation requires SUPERVISED+ maturity level."
   - "Notion blocked in local-only mode. Enable cloud services to use Notion."
   - "Database '{database_id}' not found. Available databases: {list}"

8. **Caching** (optional):
   - Cache database schemas (rarely change)
   - Cache page content for 5 minutes (reduce API calls)

Use media_tool.py and smarthome_tool.py as references for governance patterns.
  </action>
  <verify>python -c "from tools.productivity_tool import NotionTool; print('NotionTool imported successfully')"</verify>
  <done>NotionTool exists with read/write maturity gates, registered in ToolRegistry</done>
</task>

<task type="auto">
  <name>Create productivity REST API endpoints</name>
  <files>backend/api/productivity_routes.py</files>
  <action>
Create `backend/api/productivity_routes.py` with FastAPI router:

1. **Notion OAuth endpoints**:
   - GET /integrations/notion/authorize - Redirect to Notion OAuth
     - Query param: redirect_uri (optional override)
     - Returns authorization URL
   - GET /integrations/notion/callback - OAuth callback
     - Query params: code, state, error
     - Exchange code for token, store encrypted, return success

2. **Notion workspace endpoints**:
   - GET /productivity/notion/search - Search workspace
     - Query param: q (search query)
     - Returns: pages, databases matching query
   - GET /productivity/notion/databases - List all databases
     - Returns: database id, title, description

3. **Notion database endpoints**:
   - GET /productivity/notion/databases/{database_id} - Get database schema
     - Returns: properties, title, description
   - POST /productivity/notion/databases/{database_id}/query - Query database
     - Body: {filter} (optional Notion filter object)
     - Returns: list of pages with properties

4. **Notion page endpoints**:
   - GET /productivity/notion/pages/{page_id} - Get page content
     - Returns: page properties and blocks
   - POST /productivity/notion/pages - Create page
     - Body: {database_id, properties}
     - Returns: created page
   - PATCH /productivity/notion/pages/{page_id} - Update page
     - Body: {properties}
     - Returns: updated page
   - POST /productivity/notion/pages/{page_id}/blocks - Append content
     - Body: {blocks}
     - Returns: appended blocks

5. **Error responses**:
   - 401: Not connected to Notion (no OAuth token)
   - 403: Maturity level too low (governance block)
   - 404: Page/database not found
   - 429: Rate limited (Notion API limit)
   - 502: Notion API unavailable

6. **Rate limiting**:
   - Implement per-user rate limiting: 3 requests/second
   - Use Redis (Valkey) for distributed counter
   - Return 429 with Retry-After header

7. **Router registration**:
   - Include in main_api_app with prefix /productivity
   - Add tags: ["productivity", "integrations", "notion"]

All endpoints require authentication (get_current_user dependency).
  </action>
  <verify>grep -q "productivity_routes" backend/main_api_app.py || echo "Router not yet registered"</verify>
  <done>All Notion OAuth and CRUD endpoints defined, rate limiting implemented, router created</done>
</task>

<task type="auto">
  <name>Add Notion dependencies and update OAuth handler</name>
  <files>backend/requirements.txt backend/core/models.py</files>
  <action>
1. **Add to requirements.txt**:
```
# Productivity integrations (Phase 66)
notion-sdk-py>=2.2.1
```

2. **Update OAuthToken model in core/models.py** (if needed):
   - Notion tokens don't expire, but OAuthToken model has expires_at
   - Set expires_at to far future (2099-12-31) for Notion tokens
   - Add workspace_id, workspace_name fields for Notion context

3. **Alternative API key support**:
   - Support NOTION_API_KEY environment variable
   - When set, use API key instead of OAuth flow
   - Useful for Personal Edition users (simpler setup)

4. **Migration** (if adding fields to OAuthToken):
   - alembic revision -m "add_notion_workspace_fields"
   - Add workspace_id, workspace_name columns
   - Update upgrade/downgrade

notion-sdk-py is the official Notion Python client with full API coverage and async support.
  </action>
  <verify>grep -E "(notion-sdk-py|workspace)" backend/requirements.txt backend/core/models.py</verify>
  <done>notion-sdk-py added to requirements, OAuthToken model supports Notion workspace fields</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Import check**: `python -c "from core.productivity.notion_service import NotionService; from tools.productivity_tool import NotionTool; print('All imports successful')"`

2. **OAuth flow check**: Manual test of Notion authorization flow (browser)

3. **API routes check**: `curl http://localhost:8000/docs` should show /productivity endpoints

4. **Governance check**: Tool registered with category="productivity", read maturity="INTERN", write maturity="SUPERVISED"

5. **Local-only check**: Notion blocked when ATOM_LOCAL_ONLY=true

6. **Rate limiting check**: 4 requests/second triggers rate limit
</verification>

<success_criteria>
1. Notion OAuth flow completes (authorize -> callback -> token storage)
2. Agent can search workspace: "Find pages about project X"
3. Agent can query databases: "Show me tasks due this week"
4. Agent can create pages: "Create a new task for tomorrow's meeting"
5. Agent can update pages: "Mark the meeting task as complete"
6. INTERN agents can read, SUPERVISED+ agents can write
7. STUDENT agents blocked from all Notion operations
8. Notion blocked in local-only mode with clear error
9. Rate limiting prevents API abuse
10. Audit trail captures all Notion operations
</success_criteria>

<output>
After completion, create `.planning/phases/66-personal-edition-enhancements/66-05-SUMMARY.md` with:
- Files created (4 files)
- Notion SDK version (notion-sdk-py 2.2.1+)
- OAuth flow vs API key setup options
- Maturity gates (INTERN+ read, SUPERVISED+ write)
- Rate limiting configuration
- Local-only mode blocking
- Test commands for manual verification
</output>
