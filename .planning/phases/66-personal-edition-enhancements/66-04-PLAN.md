---
phase: 66-personal-edition-enhancements
plan: 04
type: execute
wave: 2
depends_on: [66-01, 66-02, 66-03]
files_modified:
  - backend/core/security/local_only_guard.py
  - backend/core/security/token_encryption.py
  - backend/core/security/audit_logger.py
  - backend/core/models.py
  - backend/core/security/__init__.py
  - .env.personal
autonomous: true
must_haves:
  truths:
    - "All OAuth tokens stored encrypted with Fernet using BYOK_ENCRYPTION_KEY"
    - "All API keys stored encrypted in database (never plaintext)"
    - "Local-only mode flag blocks external API calls when enabled"
    - "mDNS/local network device discovery works without internet"
    - "Audit trail records all device and media control actions"
    - "No telemetry or metrics sent to external services in local-only mode"
    - "Docker network isolation prevents cloud relay fallbacks"
  artifacts:
    - path: "backend/core/security/local_only_guard.py"
      provides: "Local-only mode enforcement guard"
      min_lines: 100
      exports: ["LocalOnlyGuard", "allow_external_request", "is_local_only_enabled"]
    - path: "backend/core/security/token_encryption.py"
      provides: "Centralized token encryption utilities"
      min_lines: 80
      exports: ["encrypt_token", "decrypt_token", "encrypt_api_key", "decrypt_api_key"]
    - path: "backend/core/security/audit_logger.py"
      provides: "Audit logging for device/media/smarthome actions"
      min_lines: 120
      exports: ["AuditLogger", "log_device_action", "log_media_action", "log_smarthome_action"]
    - path: ".env.personal"
      provides: "Personal Edition environment configuration"
      contains: "ATOM_LOCAL_ONLY"
  key_links:
    - from: "backend/core/security/local_only_guard.py"
      to: "backend/core/media/spotify_service.py"
      via: "Local-only check before Spotify API calls"
      pattern: "local_only_guard\\.allow_external_request"
    - from: "backend/core/security/token_encryption.py"
      to: "backend/core/models.py"
      via: "Token encryption helpers for OAuthToken model"
      pattern: "_encrypt_token|_decrypt_token"
    - from: "backend/core/security/audit_logger.py"
      to: "backend/tools/smarthome_tool.py"
      via: "Audit logging for smart home actions"
      pattern: "audit_logger\\.log_smarthome_action"
---

<objective>
Implement local-first privacy architecture with encrypted token storage, local-only mode enforcement, and comprehensive audit logging.

**Purpose**: Ensure Personal Edition users have complete privacy - all credentials stored locally encrypted, no cloud telemetry, and optional local-only mode that blocks external API calls entirely.

**Output**: LocalOnlyGuard service, centralized token encryption, audit logger for device actions, updated environment configuration.

**Why this matters**: Privacy is the core value proposition of Personal Edition. Users trust Atom with their home automation and media control - this trust is maintained through encryption, local-only operation, and transparent audit logging.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-personal-edition-enhancements/66-RESEARCH.md
@.planning/ROADMAP.md

# Existing patterns to reuse
@backend/core/models.py  # Existing _encrypt_token() and _decrypt_token()
@backend/core/oauth_handler.py  # OAuth token handling
@backend/monitoring.py  # Existing metrics collection
@.env.personal  # Personal Edition environment variables
</context>

<tasks>

<task type="auto">
  <name>Create local-only guard service</name>
  <files>backend/core/security/local_only_guard.py</files>
  <action>
Create `backend/core/security/local_only_guard.py` with:

1. **LocalOnlyGuard class**:
   - Singleton pattern for global state
   - Reads ATOM_LOCAL_ONLY environment variable (default: false)
   - Caches setting to avoid repeated env lookups

2. **Methods**:
   - is_local_only_enabled() -> bool
     - Check if local-only mode is active
     - Read from env var or cache

   - allow_external_request(service: str, reason: str = None) -> bool
     - Return True if local-only is disabled
     - Return False if local-only is enabled (block request)
     - Log blocked requests for audit
     - Raises LocalOnlyModeError if blocked

   - get_blocked_services() -> List[str]
     - Return list of services blocked in local-only mode
     - Includes: spotify, notion, openai, anthropic, etc.

   - get_local_allowed_services() -> List[str]
     - Return services that work locally (no external API)
     - Includes: sonos, hue, home_assistant, ffmpeg

3. **LocalOnlyModeError exception**:
   - Custom exception for blocked requests
   - Message: "Service '{service}' blocked in local-only mode. {reason if provided}"
   - Include suggestion to disable local-only mode

4. **Decorator**:
   - @require_local_allowed(service_name: str)
   - Decorator for functions that should be blocked in local-only mode
   - Raises LocalOnlyModeError before function execution

5. **Usage examples**:
```python
# In spotify_service.py
@require_local_allowed("spotify")
async def get_current_track(self, user_id: str):
    # This will raise LocalOnlyModeError if local-only is enabled
    pass
```

6. **Configuration**:
   - Environment: ATOM_LOCAL_ONLY=true|false
   - Default: false (allow external APIs)
   - When true: Block all OAuth-based services (Spotify, Notion)
   - Local services still work: Sonos, Hue, Home Assistant, FFmpeg

7. **Logging**:
   - Log blocked requests at WARNING level
   - Include service name, attempted operation, timestamp
  </action>
  <verify>python -c "from core.security.local_only_guard import LocalOnlyGuard; print('LocalOnlyGuard imported successfully')"</verify>
  <done>LocalOnlyGuard class exists with is_local_only_enabled, allow_external_request, @require_local_allowed decorator</done>
</task>

<task type="auto">
  <name>Create centralized token encryption utilities</name>
  <files>backend/core/security/token_encryption.py</files>
  <action>
Create `backend/core/security/token_encryption.py` with:

1. **Token encryption functions** (centralized from models.py):

   - encrypt_token(plaintext: str, key: str = None) -> str
     - Encrypt token using Fernet symmetric encryption
     - Default key: BYOK_ENCRYPTION_KEY environment variable
     - Generate random key if none provided (warning logged)
     - Return URL-safe base64 encoded ciphertext

   - decrypt_token(ciphertext: str, key: str = None) -> str
     - Decrypt token using Fernet
     - Raise InvalidToken if decryption fails
     - Return plaintext

   - encrypt_api_key(api_key: str, service: str) -> str
     - Wrapper for encrypt_token with service-specific logging
     - Log encryption event (without key value)

   - decrypt_api_key(encrypted_key: str, service: str) -> str
     - Wrapper for decrypt_token with service-specific logging
     - Log decryption event

2. **Key management**:
   - get_encryption_key() -> bytes
     - Read BYOK_ENCRYPTION_KEY from environment
     - Generate and warn if missing (development safety)
     - Cache key for performance

   - validate_encryption_key(key: str) -> bool
     - Check if key is valid Fernet key (32 bytes base64)
     - Return False if invalid format

   - generate_encryption_key() -> str
     - Generate new Fernet-compatible key
     - Return base64 encoded key
     - Use for initial setup

3. **Token rotation support**:
   - rotate_tokens(old_key: str, new_key: str) -> Dict
     - Re-encrypt all tokens with new key
     - Update OAuthToken, HomeAssistantConnection, HueBridge models
     - Return count of rotated tokens

4. **Security utilities**:
   - is_encrypted_value(value: str) -> bool
     - Check if value looks like Fernet ciphertext (base64 with valid format)
     - Used to validate tokens before storage

5. **Error handling**:
   - InvalidToken: Decryption failed (wrong key or corrupted data)
   - MissingKeyError: Encryption key not configured
   - InvalidKeyError: Key format invalid

Note: This centralizes token encryption logic that may be scattered across models.py and other files.
  </action>
  <verify>python -c "from core.security.token_encryption import encrypt_token, decrypt_token; test = encrypt_token('test'); print('Encryption works:', decrypt_token(test) == 'test')"</verify>
  <done>Token encryption utilities exist with encrypt/decrypt, key management, rotation support</done>
</task>

<task type="auto">
  <name>Create audit logger for device and media actions</name>
  <files>backend/core/security/audit_logger.py</files>
  <action>
Create `backend/core/security/audit_logger.py` with:

1. **AuditLogger class**:
   - Singleton pattern
   - Structured logging with JSON output
   - Separate audit log file: logs/audit.log

2. **Action logging methods**:
   - log_media_action(
       user_id: str, agent_id: str, action: str,
       service: str, details: Dict, result: str
     ) -> None
     - Log Spotify/Sonos actions
     - Include: track_uri, speaker_ip, device_id

   - log_smarthome_action(
       user_id: str, agent_id: str, action: str,
       service: str, details: Dict, result: str
     ) -> None
     - Log Hue/HomeAssistant actions
     - Include: entity_id, light_id, bridge_ip

   - log_creative_action(
       user_id: str, agent_id: str, action: str,
       operation: str, details: Dict, result: str
     ) -> None
     - Log FFmpeg operations
     - Include: input_path, output_path, job_id

   - log_local_only_block(
       user_id: str, agent_id: str, service: str,
       attempted_action: str
     ) -> None
     - Log when local-only mode blocks request
     - Include reason and suggestion

3. **Log format** (JSON):
```json
{
  "timestamp": "2026-02-20T10:30:00Z",
  "user_id": "user_123",
  "agent_id": "agent_456",
  "action": "pause_playback",
  "category": "media",
  "service": "spotify",
  "details": {"device_id": "device_abc"},
  "result": "success",
  "ip_address": "192.168.1.100"
}
```

4. **Query methods**:
   - get_user_audit_log(user_id: str, limit: int = 100) -> List[Dict]
     - Retrieve audit entries for user
   - get_service_audit_log(service: str, limit: int = 100) -> List[Dict]
     - Retrieve audit entries for service

5. **Retention and rotation**:
   - Rotate audit logs daily (audit-YYYY-MM-DD.log)
   - Retain logs for 90 days (configurable via AUDIT_LOG_RETENTION_DAYS)
   - Compress old logs with gzip

6. **Performance**:
   - Async logging to avoid blocking operations
   - Buffer writes and flush periodically
   - Use separate file handler from main logger

7. **Configuration**:
   - Environment: AUDIT_LOG_PATH (default: logs/audit.log)
   - Environment: AUDIT_LOG_RETENTION_DAYS (default: 90)

Integrate with existing structured_logger.py if possible.
  </action>
  <verify>python -c "from core.security.audit_logger import AuditLogger; print('AuditLogger imported successfully')"</verify>
  <done>AuditLogger class exists with action logging for media/smarthome/creative, JSON format, rotation</done>
</task>

<task type="auto">
  <name>Update models and integrate security services</name>
  <files>backend/core/models.py backend/core/security/__init__.py</files>
  <action>
1. **Update backend/core/models.py**:
   - Move _encrypt_token() and _decrypt_token() to use token_encryption module
   - Add import: `from core.security.token_encryption import encrypt_token, decrypt_token`
   - Update OAuthToken model to use centralized encryption
   - Add audit logging to token create/update/delete operations

2. **Add LocalOnlyModeError to core exceptions**:
   - In core/models.py or core/exceptions.py:
```python
class LocalOnlyModeError(Exception):
    """Raised when external service is blocked in local-only mode"""
    def __init__(self, service: str, reason: str = None):
        self.service = service
        self.reason = reason
        message = f"Service '{service}' is blocked in local-only mode"
        if reason:
            message += f": {reason}"
        message += ". Disable local-only mode or use local services only."
        super().__init__(message)
```

3. **Create backend/core/security/__init__.py**:
```python
"""
Security utilities for local-first privacy and encrypted storage.
"""

from core.security.local_only_guard import (
    LocalOnlyGuard,
    LocalOnlyModeError,
    require_local_allowed
)
from core.security.token_encryption import (
    encrypt_token,
    decrypt_token,
    encrypt_api_key,
    decrypt_api_key
)
from core.security.audit_logger import AuditLogger

__all__ = [
    "LocalOnlyGuard",
    "LocalOnlyModeError",
    "require_local_allowed",
    "encrypt_token",
    "decrypt_token",
    "encrypt_api_key",
    "decrypt_api_key",
    "AuditLogger",
]
```

4. **Update services to use security utilities**:
   - spotify_service.py: Import and use encrypt_token, require_local_allowed
   - sonos_service.py: No changes (local service)
   - hue_service.py: No changes (local service)
   - home_assistant_service.py: Import and use encrypt_token
   - ffmpeg_service.py: No changes (local service)

5. **Add audit logging to tools**:
   - media_tool.py: Log actions via AuditLogger
   - smarthome_tool.py: Log actions via AuditLogger
   - creative_tool.py: Log actions via AuditLogger

6. **Migration**:
   - No database migration needed (logic changes only)
   - Document new security features in docs/PERSONAL_EDITION_SECURITY.md

7. **Testing**:
   - Verify token encryption works with existing OAuthToken model
   - Verify local-only mode blocks Spotify/Notion
   - Verify audit logs are written to logs/audit.log
  </action>
  <verify>python -c "from core.security import LocalOnlyGuard, encrypt_token, AuditLogger; print('Security module imported successfully')"</verify>
  <done>Security module exported, models use centralized encryption, audit logging integrated</done>
</task>

<task type="auto">
  <name>Update Personal Edition environment configuration</name>
  <files>.env.personal</files>
  <action>
Update `.env.personal` with new security and privacy settings:

1. **Add local-only mode configuration**:
```bash
# ==============================================================================
# LOCAL-ONLY MODE (Privacy - Block all external API calls)
# ==============================================================================
# When enabled, blocks all cloud-based services (Spotify, Notion, etc.)
# Local services still work: Sonos, Hue, Home Assistant, FFmpeg
# Set to 'true' for complete privacy, 'false' to enable cloud integrations
ATOM_LOCAL_ONLY=false
```

2. **Add encryption key configuration** (if not exists):
```bash
# ==============================================================================
# ENCRYPTION KEYS (REQUIRED for token storage)
# ==============================================================================
# Generate with: openssl rand -base64 32
# These encrypt your API keys and OAuth tokens in the database
BYOK_ENCRYPTION_KEY=change-this-to-a-secure-key-generate-with-openssl
```

3. **Add audit logging configuration**:
```bash
# ==============================================================================
# AUDIT LOGGING (Security - Track device and media actions)
# ==============================================================================
# Path for audit log file (relative to backend directory)
AUDIT_LOG_PATH=logs/audit.log

# Retention period for audit logs (days)
AUDIT_LOG_RETENTION_DAYS=90
```

4. **Add service-specific credentials** (update existing section):
```bash
# ==============================================================================
# MEDIA INTEGRATIONS (Optional - blocked in local-only mode)
# ==============================================================================
# Spotify (for music control - requires OAuth)
SPOTIFY_CLIENT_ID=your-spotify-client-id
SPOTIFY_CLIENT_SECRET=your-spotify-client-secret
SPOTIFY_REDIRECT_URI=http://localhost:8000/integrations/spotify/callback

# ==============================================================================
# SMART HOME INTEGRATIONS (Local - work in local-only mode)
# ==============================================================================
# Philips Hue Bridge (local network - no cloud)
HUE_BRIDGE_IP=192.168.1.100  # Optional - auto-discovered if not set
HUE_API_KEY=your-hue-api-key  # Generate via Hue app

# Home Assistant (local network - no cloud)
HOME_ASSISTANT_URL=http://localhost:8123
HOME_ASSISTANT_TOKEN=your-long-lived-access-token  # Generate in HA Settings

# ==============================================================================
# FILE PROCESSING (Local - work in local-only mode)
# ==============================================================================
# FFmpeg allowed directories (security boundary)
FFMPEG_ALLOWED_DIRS=/app/data/media,/app/data/exports
```

5. **Add comments explaining privacy tradeoffs**:
```bash
# PRIVACY NOTE:
# - Local-only mode (ATOM_LOCAL_ONLY=true) blocks all cloud services
# - Local services (Sonos, Hue, Home Assistant, FFmpeg) always work
# - All tokens encrypted with BYOK_ENCRYPTION_KEY before database storage
# - Audit logs track all device/media/smarthome actions
# - No telemetry or metrics sent to external servers
```

6. **Document setup steps**:
   - Generate encryption key: `openssl rand -base64 32`
   - For Spotify: Create app at https://developer.spotify.com/dashboard
   - For Hue: Generate API key in Hue app (Settings -> Hue Bridge -> Local API)
   - For Home Assistant: Create token in Settings -> Profile -> Long-Lived Access Tokens
  </action>
  <verify>grep -E "(ATOM_LOCAL_ONLY|BYOK_ENCRYPTION_KEY|AUDIT_LOG|SPOTIFY|HUE|HOME_ASSISTANT)" .env.personal</verify>
  <done>.env.personal updated with local-only mode, encryption keys, audit logging, service credentials</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Import check**: `python -c "from core.security import LocalOnlyGuard, encrypt_token, AuditLogger; print('Security module works')"`

2. **Encryption check**: `python -c "from core.security.token_encryption import encrypt_token, decrypt_token; test = 'sensitive_token'; encrypted = encrypt_token(test); print('Decrypted:', decrypt_token(encrypted) == test)"`

3. **Local-only check**: `ATOM_LOCAL_ONLY=true python -c "from core.security import LocalOnlyGuard; print('Local-only:', LocalOnlyGuard().is_local_only_enabled())"`

4. **Audit log check**: `ls -la logs/audit.log` (should exist after running any media/smarthome action)

5. **Integration check**: Verify spotify_service.py imports and uses security utilities

6. **Environment check**: All new variables documented in .env.personal
</verification>

<success_criteria>
1. LocalOnlyGuard blocks external services when ATOM_LOCAL_ONLY=true
2. All OAuth tokens encrypted with Fernet before database storage
3. Audit logs capture all device/media/smarthome/creative actions
4. Local services (Sonos, Hue, Home Assistant, FFmpeg) work in local-only mode
5. Cloud services (Spotify, Notion) blocked in local-only mode with clear error
6. Encryption key validation prevents accidental plaintext storage
7. Audit log rotation and retention configured
8. Personal Edition .env.personal fully documented
</success_criteria>

<output>
After completion, create `.planning/phases/66-personal-edition-enhancements/66-04-SUMMARY.md` with:
- Files created (4 files)
- Encryption method (Fernet symmetric encryption)
- Local-only blocked services list
- Audit log format (JSON with rotation)
- Environment variables added
- Privacy guarantees documented
- Security testing commands
</output>
