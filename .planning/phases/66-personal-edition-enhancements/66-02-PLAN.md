---
phase: 66-personal-edition-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/core/smarthome/hue_service.py
  - backend/core/smarthome/home_assistant_service.py
  - backend/tools/smarthome_tool.py
  - backend/api/smarthome_routes.py
  - backend/requirements.txt
  - backend/core/models.py
autonomous: true
user_setup:
  - service: philips-hue
    why: "Philips Hue API v2 key for local bridge control"
    manual_steps:
      - task: "Get Hue Bridge IP"
        location: "Hue app -> Settings -> Hue Bridge settings -> Network information"
      - task: "Generate API key"
        location: "Hue app -> Settings -> Hue Bridge settings -> Local API -> press button to create username"
  - service: home-assistant
    why: "Home Assistant long-lived access token for local API"
    env_vars:
      - name: HOME_ASSISTANT_URL
        source: "Home Assistant URL (http://localhost:8123 or http://homeassistant:8123 for Docker)"
      - name: HOME_ASSISTANT_TOKEN
        source: "Home Assistant Settings -> Profile -> Long-Lived Access Tokens -> Create Token"

must_haves:
  truths:
    - "User can discover Hue bridges on local network via mDNS"
    - "Agent can control Hue lights (on/off, brightness, color, scenes)"
    - "Agent can query and control Home Assistant entities"
    - "Agent can trigger Home Assistant automations and services"
    - "All smart home communications stay on local network (no cloud relay)"
    - "STUDENT and INTERN agents blocked from smart home control (SUPERVISED+ required)"
    - "All device control actions logged to audit trail"
  artifacts:
    - path: "backend/core/smarthome/hue_service.py"
      provides: "Philips Hue API v2 integration with local discovery"
      min_lines: 180
      exports: ["HueService", "discover_bridges", "set_light_state", "get_all_lights"]
    - path: "backend/core/smarthome/home_assistant_service.py"
      provides: "Home Assistant REST API integration"
      min_lines: 150
      exports: ["HomeAssistantService", "get_states", "call_service", "trigger_automation"]
    - path: "backend/tools/smarthome_tool.py"
      provides: "LangChain BaseTool for smart home control"
      min_lines: 120
      exports: ["HueTool", "HomeAssistantTool"]
    - path: "backend/api/smarthome_routes.py"
      provides: "REST API endpoints for smart home control"
      min_lines: 180
      exports: ["GET /smarthome/hue/bridges", "POST /smarthome/hue/lights/{id}/state", "GET /smarthome/homeassistant/states"]
  key_links:
    - from: "backend/core/smarthome/hue_service.py"
      to: "python_hue_v2.Hue"
      via: "python-hue-v2 library for Hue API v2"
      pattern: "from python_hue_v2 import Hue"
    - from: "backend/core/smarthome/home_assistant_service.py"
      to: "httpx.AsyncClient"
      via: "Home Assistant REST API calls"
      pattern: "httpx.AsyncClient.*post.*api/services"
    - from: "backend/tools/smarthome_tool.py"
      to: "backend/core/governance_cache.py"
      via: "Maturity level check before device operations"
      pattern: "governance_cache\\.check_permission"
---

<objective>
Implement Philips Hue and Home Assistant integration with local-first architecture and governance integration.

**Purpose**: Enable Atom agents to control smart home devices locally without cloud dependencies for privacy-focused home automation (e.g., "turn off lights at bedtime", "set movie scene when Netflix starts").

**Output**: Working Hue and Home Assistant integration with local network discovery, API v2 support, SUPERVISED+ governance, and REST API endpoints.

**Why this matters**: Smart home control is a core personal assistant capability. Local-only execution preserves privacy (no cloud relays recording when lights turn on/off). Hue API v2 is required for newer bridges.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/66-personal-edition-enhancements/66-RESEARCH.md
@.planning/ROADMAP.md

# Existing patterns to reuse
@backend/tools/device_tool.py  # Device control patterns
@backend/tools/registry.py  # Tool registration with governance
@backend/core/models.py  # Encrypted credential storage
@backend/api/media_routes.py  # OAuth patterns from Plan 01
</context>

<tasks>

<task type="auto">
  <name>Create Philips Hue service with API v2 support</name>
  <files>backend/core/smarthome/hue_service.py</files>
  <action>
Create `backend/core/smarthome/hue_service.py` with:

1. **HueService class**:
   - Use python-hue-v2 library (NOT phue - deprecated API 1.0)
   - No OAuth required (API key generated via bridge button press)

2. **Bridge discovery**:
   - async discover_bridges() -> List[str] - Discover Hue bridges via mDNS/UPnP
   - Use BridgeFinder from python-hue-v2
   - Return list of bridge IPs
   - Handle Docker network isolation (require host IP if discovery fails)

3. **Connection management**:
   - async connect_to_bridge(bridge_ip: str, api_key: str) -> Hue
   - Test connection with hue.bridge.is_authorized
   - Cache bridge connections in memory

4. **Light control methods**:
   - async get_all_lights(bridge_ip: str, api_key: str) -> List[Dict]
     - Return light id, name, on, brightness, color_xy for all lights
   - async set_light_state(
       bridge_ip: str, api_key: str, light_id: str,
       on: bool = None, brightness: float = None, color_xy: Tuple[float, float] = None
     ) -> Dict
     - Set light state (partial updates allowed)
     - brightness: 0-100 (convert to Hue 0-254 scale)
   - async get_light_state(bridge_ip: str, api_key: str, light_id: str) -> Dict

5. **Scene management**:
   - async get_scenes(bridge_ip: str, api_key: str) -> List[Dict]
   - async activate_scene(bridge_ip: str, api_key: str, scene_id: str) -> Dict

6. **Configuration storage**:
   - Store bridge IPs and API keys in encrypted settings (not OAuthToken - Hue uses API keys)
   - Create HueBridge model or use KeyValue model for storage
   - Fields: user_id, bridge_ip, api_key (encrypted)

7. **Error handling**:
   - Hue bridge not found (discovery failed)
   - Unauthorized (invalid API key)
   - Light not found

Note: mDNS discovery fails in Docker containers. Allow manual bridge IP configuration via environment variable HUE_BRIDGE_IP.
  </action>
  <verify>python -c "from core.smarthome.hue_service import HueService; print('HueService imported successfully')"</verify>
  <done>HueService class exists with discovery, light control, scene management, uses API v2</done>
</task>

<task type="auto">
  <name>Create Home Assistant service for local API integration</name>
  <files>backend/core/smarthome/home_assistant_service.py</files>
  <action>
Create `backend/core/smarthome/home_assistant_service.py` with:

1. **HomeAssistantService class**:
   - Use Home Assistant REST API (no Python library needed - simple HTTP)
   - Use long-lived access tokens (not OAuth for simplicity in Personal Edition)

2. **Configuration**:
   - __init__(base_url: str, token: str)
   - Load from environment: HOME_ASSISTANT_URL, HOME_ASSISTANT_TOKEN
   - Store token encrypted per user (multi-user support)

3. **State retrieval**:
   - async get_states() -> List[Dict] - Get all entity states
   - async get_state(entity_id: str) -> Dict - Get single entity state
   - Return: entity_id, state, attributes, last_changed

4. **Service calling**:
   - async call_service(domain: str, service: str, entity_id: str = None, data: Dict = None) -> Dict
     - Example: call_service("light", "turn_on", "light.living_room", {"brightness_pct": 80})
     - POST to /api/services/{domain}/{service}
     - Include Bearer token in Authorization header

5. **Automation triggers**:
   - async trigger_automation(automation_id: str) -> Dict
     - POST to /api/services/automation/trigger

6. **Entity filtering**:
   - async get_entities_by_domain(domain: str) -> List[Dict]
   - async get_lights() -> List[Dict] - Shorthand for domain="light"
   - async get_switches() -> List[Dict] - Shorthand for domain="switch"

7. **Error handling**:
   - Connection refused (Home Assistant not running)
   - 401 Unauthorized (invalid token)
   - 404 Not Found (entity doesn't exist)
   - 400 Bad Request (invalid service data)

Use httpx.AsyncClient for all API calls with proper timeout (10 seconds).
  </action>
  <verify>python -c "from core.smarthome.home_assistant_service import HomeAssistantService; print('HomeAssistantService imported successfully')"</verify>
  <done>HomeAssistantService class exists with state retrieval, service calling, automation triggers</done>
</task>

<task type="auto">
  <name>Create smart home control tool with governance integration</name>
  <files>backend/tools/smarthome_tool.py</files>
  <action>
Create `backend/tools/smarthome_tool.py` with LangChain BaseTool wrappers:

1. **HueTool class** (extends BaseTool):
   - name: "hue_control"
   - description: "Control Philips Hue lights. Discover bridges, turn on/off, set brightness, change colors, activate scenes. Requires SUPERVISED+ maturity."
   - complexity: 2 (MODERATE)
   - maturity_required: "SUPERVISED"
   - _run method:
     - Check governance_cache.check_permission(agent_id, "hue_control", maturity_level)
     - Load bridge IP and API key from encrypted storage
     - Actions: discover, lights, set_state, get_state, scenes, activate_scene
     - Return formatted response with light states or confirmation

2. **HomeAssistantTool class** (extends BaseTool):
   - name: "home_assistant_control"
   - description: "Control Home Assistant entities and automations. Get states, call services, trigger automations. Requires SUPERVISED+ maturity."
   - complexity: 2 (MODERATE)
   - maturity_required: "SUPERVISED"
   - _run method:
     - Check governance_cache.check_permission(agent_id, "home_assistant_control", maturity_level)
     - Load HA URL and token from encrypted storage
     - Actions: get_state, get_states, call_service, trigger_automation, get_lights, get_switches
     - Return formatted response with entity states or confirmation

3. **Tool registration**:
   - Register both tools with ToolRegistry
   - Category: "smarthome"
   - Tags: ["home", "automation", "hue", "home-assistant", "lights"]

4. **Governance enforcement**:
   - STUDENT and INTERN agents blocked
   - Log all smart home control actions with entity_id, action, result
   - Include device identification in audit trail

5. **Error handling**:
   - Return user-friendly error messages
   - "Bridge not found - check network connectivity"
   - "Light 'office' not found - available lights: living_room, bedroom"
   - "Home Assistant not responding - check if service is running"

Use media_tool.py from Plan 01 as reference for tool structure.
  </action>
  <verify>python -c "from tools.smarthome_tool import HueTool, HomeAssistantTool; print('Smart home tools imported successfully')"</verify>
  <done>HueTool and HomeAssistantTool exist with governance checks, registered in ToolRegistry</done>
</task>

<task type="auto">
  <name>Create smart home REST API endpoints</name>
  <files>backend/api/smarthome_routes.py</files>
  <action>
Create `backend/api/smarthome_routes.py` with FastAPI router:

1. **Hue endpoints**:
   - GET /smarthome/hue/bridges - Discover Hue bridges on local network
   - POST /smarthome/hue/connect - Connect to bridge (body: {bridge_ip, api_key})
   - GET /smarthome/hue/lights - Get all lights (requires connected bridge)
   - GET /smarthome/hue/lights/{light_id} - Get light state
   - PUT /smarthome/hue/lights/{light_id}/state - Set light state (body: {on, brightness, color_xy})
   - GET /smarthome/hue/scenes - Get all scenes
   - POST /smarthome/hue/scenes/{scene_id}/activate - Activate scene

2. **Home Assistant endpoints**:
   - POST /smarthome/homeassistant/connect - Connect to HA (body: {url, token})
   - GET /smarthome/homeassistant/states - Get all entity states
   - GET /smarthome/homeassistant/states/{entity_id} - Get entity state
   - POST /smarthome/homeassistant/services/{domain}/{service} - Call service (body: {entity_id, data})
   - POST /smarthome/homeassistant/automations/{automation_id}/trigger - Trigger automation

3. **Convenience endpoints**:
   - GET /smarthome/homeassistant/lights - Get all light entities
   - GET /smarthome/homeassistant/switches - Get all switch entities
   - GET /smarthome/homeassistant/groups - Get all groups (areas)

4. **Error responses**:
   - 400: Invalid request data
   - 401: Not connected (no bridge/HA configured)
   - 404: Entity/light not found
   - 503: Bridge/HA not responding

5. **Configuration storage**:
   - Store Hue bridge credentials per user (encrypted)
   - Store HA credentials per user (encrypted)
   - Use OAuthToken model or create SmartHomeCredential model

6. **Router registration**:
   - Include in main_api_app with prefix /smarthome
   - Add tags: ["smarthome", "integrations"]

All endpoints require authentication (get_current_user dependency).
  </action>
  <verify>grep -q "smarthome_routes" backend/main_api_app.py || echo "Router not yet registered"</verify>
  <done>All Hue and Home Assistant endpoints defined, router created, returns structured JSON</done>
</task>

<task type="auto">
  <name>Add smart home dependencies and models</name>
  <files>backend/requirements.txt backend/core/models.py</files>
  <action>
1. **Add to requirements.txt**:
```
# Smart home control (Phase 66)
python-hue-v2>=0.20.0
```

2. **Add HueBridge model to core/models.py** (if not using OAuthToken):
```python
class HueBridge(Base):
    __tablename__ = "hue_bridges"

    id = Column(Integer, primary_key=True)
    user_id = Column(String, index=True)
    bridge_ip = Column(String)  # Stored plaintext (local network IP)
    api_key = Column(String)  # Encrypted with _encrypt_token()
    bridge_id = Column(String)  # Hue bridge ID
    name = Column(String)  # User-defined name
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())

    user = relationship("User", back_populates="hue_bridges")
```

3. **Add HomeAssistantConnection model to core/models.py** (if not using OAuthToken):
```python
class HomeAssistantConnection(Base):
    __tablename__ = "home_assistant_connections"

    id = Column(Integer, primary_key=True)
    user_id = Column(String, index=True)
    url = Column(String)  # Stored plaintext (local URL)
    token = Column(String)  # Encrypted with _encrypt_token()
    name = Column(String)  # User-defined name
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())

    user = relationship("User", back_populates="ha_connections")
```

4. **Create Alembic migration**:
   - alembic revision -m "add_smart_home_credentials"
   - Generate upgrade/downgrade for HueBridge and HomeAssistantConnection

5. **Update User model** (if needed):
   - Add hue_bridges and ha_connections relationships

python-hue-v2 is the modern library for Hue API v2. The older phue library only supports API 1.0 (deprecated).
  </action>
  <verify>grep -E "(python-hue-v2|HueBridge|HomeAssistantConnection)" backend/requirements.txt backend/core/models.py</verify>
  <done>python-hue-v2 added to requirements, HueBridge and HomeAssistantConnection models defined, migration created</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Import check**: `python -c "from core.smarthome.hue_service import HueService; from core.smarthome.home_assistant_service import HomeAssistantService; from tools.smarthome_tool import HueTool, HomeAssistantTool; print('All imports successful')"`

2. **Model check**: `python -c "from core.models import HueBridge, HomeAssistantConnection; print('Smart home models available')"`

3. **Migration check**: `alembic current` should show smart home migration applied

4. **API routes check**: `curl http://localhost:8000/docs` should show /smarthome endpoints

5. **Local network check**: Hue bridge discovery works on local network (may require host network for Docker)

6. **Governance check**: Tools registered with category="smarthome", maturity_required="SUPERVISED"
</verification>

<success_criteria>
1. Hue bridges discoverable on local network or configurable via IP
2. Agent can control Hue lights: "Turn on living room light", "Set bedroom to blue", "Activate movie scene"
3. Agent can query Home Assistant states: "What's the thermostat set to?"
4. Agent can control Home Assistant: "Turn off the office switch", "Trigger bedtime automation"
5. All smart home communications stay on local network (no cloud relays)
6. API keys and tokens stored encrypted in database
7. STUDENT/INTERN agents blocked from smart home control
8. Audit trail captures all device control actions with entity identification
</success_criteria>

<output>
After completion, create `.planning/phases/66-personal-edition-enhancements/66-02-SUMMARY.md` with:
- Files created (5 files)
- Hue API version (v2 via python-hue-v2)
- Home Assistant authentication method (long-lived access tokens)
- Discovery method (mDNS for Hue, manual URL for HA)
- Governance maturity level (SUPERVISED+)
- Local-only architecture verification
- Docker networking considerations
- Test commands for manual verification
</output>
