---
phase: 01-test-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-test-infrastructure-02"]
files_modified:
  - backend/tests/conftest.py
  - backend/tests/pytest.ini
autonomous: true

must_haves:
  truths:
    - "Developer can run `pytest --cov` and generate HTML, terminal, and JSON coverage reports"
    - "Coverage reports are generated in tests/coverage_reports/ directory"
    - "Coverage threshold is enforced (--cov-fail-under=80)"
    - "Coverage metrics are tracked in JSON format for trending"
  artifacts:
    - path: "backend/pytest.ini"
      contains: "--cov-report=html"
      contains: "--cov-report=json"
      contains: "--cov-fail-under=80"
    - path: "backend/tests/coverage_reports/html/index.html"
      provides: "HTML coverage report"
      min_lines: 10
    - path: "backend/tests/coverage_reports/metrics/coverage.json"
      provides: "JSON coverage metrics"
  key_links:
    - from: "pytest --cov"
      to: "coverage_reports/html/index.html"
      via: "pytest-cov plugin"
      pattern: "--cov-report=html"
    - from: "coverage.json"
      to: "CI quality gates"
      via: "JSON parsing"
      pattern: "--cov-report=json"
---

<objective>
Configure pytest-cov for multi-format coverage reporting (HTML, terminal, JSON) with quality gate enforcement.

Purpose: Enable coverage tracking with human-readable HTML reports, CI-friendly JSON metrics, and enforceable quality thresholds.
Output: Coverage reports in HTML/JSON/terminal formats with 80% minimum threshold
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md
@backend/pytest.ini
@backend/tests/coverage_reports/metrics/coverage.json
</context>

<tasks>

<task type="auto">
  <name>Verify and enhance pytest-cov configuration</name>
  <files>backend/pytest.ini</files>
  <action>
    1. Verify backend/pytest.ini has existing coverage configuration (lines 48-58)
    2. Ensure the following coverage options are configured correctly:

    ```ini
    # Reporting
    addopts =
        -v --strict-markers --tb=short
        # Coverage reporting
        --cov=core
        --cov=api
        --cov=tools
        --cov-report=html:tests/coverage_reports/html
        --cov-report=term-missing:skip-covered
        --cov-report=json:tests/coverage_reports/metrics/coverage.json
        # Coverage thresholds
        --cov-fail-under=80
        --cov-branch  # Add branch coverage measurement
        # Show local variables in tracebacks
        --showlocals
    ```

    3. Add `--cov-branch` flag if not present (enables branch coverage, more accurate than line coverage)
    4. Ensure coverage.json path is: `tests/coverage_reports/metrics/coverage.json`

    DO NOT modify existing markers, asyncio_mode, or other pytest settings.
  </action>
  <verify>grep -E "(--cov-report|--cov-fail-under|--cov-branch)" backend/pytest.ini</verify>
  <done>pytest.ini has complete coverage configuration with HTML, JSON, terminal reports and 80% threshold</done>
</task>

<task type="auto">
  <name>Create coverage trending infrastructure</name>
  <files>backend/tests/coverage_reports/metrics/.gitkeep</files>
  <action>
    1. Create the coverage metrics directory if it doesn't exist:

    ```bash
    mkdir -p backend/tests/coverage_reports/metrics
    ```

    2. Create backend/tests/coverage_reports/metrics/README.md with trending documentation:

    ```markdown
    # Coverage Metrics

    This directory stores coverage metrics for trending analysis.

    ## Files

    - `coverage.json` - Latest coverage metrics (generated by pytest-cov)
    - `coverage_history.json` - Historical coverage data for trending

    ## Usage

    Generate latest metrics:
    ```bash
    pytest --cov=core --cov-report=json
    ```

    View coverage trend:
    ```bash
    python -c "import json; print(json.dumps(json.load(open('coverage.json')), indent=2))"
    ```
    ```

    3. Add to .gitignore if needed (coverage.json is generated, may want to track in git for trending):

    Check if `backend/tests/coverage_reports/metrics/coverage.json` is in .gitignore.
    - If NOT in .gitignore: Keep it (we want to track coverage in git for trending)
    - If in .gitignore: Remove from .gitignore to enable tracking
  </action>
  <verify>ls -la backend/tests/coverage_reports/metrics/</verify>
  <done>Coverage metrics directory exists with README for trending documentation</done>
</task>

<task type="auto">
  <name>Add coverage summary fixture to conftest.py</name>
  <files>backend/tests/conftest.py</files>
  <action>
    Add a pytest hook to display coverage summary after test run:

    ```python
    def pytest_terminal_summary(terminalreporter, exitstatus, config):
        """
        Display coverage summary after test run.

        This hook runs after all tests complete to show coverage metrics.
        """
        try:
            import json
            from pathlib import Path

            coverage_path = Path("tests/coverage_reports/metrics/coverage.json")
            if coverage_path.exists():
                with open(coverage_path) as f:
                    coverage_data = json.load(f)

                # Extract key metrics
                total_lines = coverage_data.get('totals', {}).get('num_statements', 0)
                covered_lines = coverage_data.get('totals', {}).get('covered_lines', 0)
                line_coverage = coverage_data.get('totals', {}).get('percent_covered', 0)
                branch_coverage = coverage_data.get('totals', {}).get('percent_covered', 0)  # Simplified

                terminalreporter.write_sep("=", f"Coverage: {line_coverage:.1f}% lines", red=True)
                terminalreporter.write_line(f"  Total lines: {total_lines}")
                terminalreporter.write_line(f"  Covered: {covered_lines}")
                terminalreporter.write_line(f"  Report: tests/coverage_reports/html/index.html")
        except Exception:
            # Silently fail if coverage file not available
            pass
    ```

    Add this function AFTER the existing `ensure_numpy_available` fixture in conftest.py.
  </action>
  <verify>grep -A5 "pytest_terminal_summary" backend/tests/conftest.py</verify>
  <done>pytest_terminal_summary hook exists and displays coverage summary</done>
</task>

<task type="auto">
  <name>Create coverage report interpretation guide</name>
  <files>backend/tests/coverage_reports/README.md</files>
  <action>
    Create backend/tests/coverage_reports/README.md:

    ```markdown
    # Coverage Reports

    This directory contains code coverage reports for the Atom platform.

    ## HTML Report

    Open `html/index.html` in a web browser for interactive coverage visualization:

    ```bash
    open backend/tests/coverage_reports/html/index.html
    ```

    Features:
    - Click files to see line-by-line coverage
    - Red lines = not covered, Green lines = covered
    - Yellow lines = partially covered (branch conditions)

    ## Terminal Report

    Run tests with terminal coverage:

    ```bash
    pytest --cov=core --cov-report=term-missing
    ```

    Legend:
    - `85%` = Line coverage percentage
    - `25` = Number of missing lines

    ## JSON Report

    Machine-readable metrics for CI/CD:

    ```bash
    pytest --cov=core --cov-report=json
    cat tests/coverage_reports/metrics/coverage.json
    ```

    ## Coverage Targets

    | Module | Target | Current |
    |--------|--------|---------|
    | Governance | 80% | TBD |
    | Security | 80% | TBD |
    | Episodes | 80% | TBD |
    | Core | 80% | TBD |

    ## Improving Coverage

    1. Identify low-coverage files in HTML report
    2. Add tests for uncovered paths
    3. Re-run coverage report
    4. Verify improvement

    ## Quality Gates

    - Minimum 80% coverage enforced by `--cov-fail-under=80`
    - PRs with <80% coverage will fail CI
    ```
    ```
  </action>
  <verify>cat backend/tests/coverage_reports/README.md | head -20</verify>
  <done>README exists with coverage report interpretation guide</done>
</task>

</tasks>

<verification>
1. Run `pytest --cov=core --cov-report=html --cov-report=json --co -q` to verify coverage config
2. Run `pytest tests/property_tests/conftest.py -v --cov` on small test to generate coverage
3. Verify coverage.json is generated in tests/coverage_reports/metrics/
4. Open HTML report to verify it renders correctly
</verification>

<success_criteria>
- Coverage is configured with HTML, JSON, and terminal reports
- 80% minimum threshold is enforced (--cov-fail-under=80)
- Branch coverage is enabled (--cov-branch)
- Coverage summary is displayed after test run
- README explains how to interpret coverage reports
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-test-infrastructure-03-SUMMARY.md`
</output>
