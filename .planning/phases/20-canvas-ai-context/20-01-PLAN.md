---
phase: 20-canvas-ai-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend-nextjs/components/canvas/AgentOperationTracker.tsx
  - frontend-nextjs/components/canvas/ViewOrchestrator.tsx
  - frontend-nextjs/components/canvas/OperationErrorGuide.tsx
  - frontend-nextjs/components/canvas/AgentRequestPrompt.tsx
  - frontend-nextjs/components/canvas/IntegrationConnectionGuide.tsx
  - frontend-nextjs/components/canvas/LineChart.tsx
  - frontend-nextjs/components/canvas/BarChart.tsx
  - frontend-nextjs/components/canvas/PieChart.tsx
  - frontend-nextjs/components/canvas/InteractiveForm.tsx
autonomous: true

must_haves:
  truths:
    - "AI agents can read canvas state without OCR by querying hidden accessibility divs"
    - "All 7 canvas types expose structured state via role='log' hidden elements"
    - "Screen readers can announce canvas changes via aria-live attributes"
    - "Performance overhead for accessibility trees is <10ms per canvas render"
    - "Canvas state includes relevant data: lines, cursorPos, formData, chart metadata"
  artifacts:
    - path: "frontend-nextjs/components/canvas/AgentOperationTracker.tsx"
      provides: "Agent operation tracking with accessibility tree"
      contains: "role='log' aria-live accessibility div"
    - path: "frontend-nextjs/components/canvas/ViewOrchestrator.tsx"
      provides: "Multi-view layout with accessibility tree"
      contains: "hidden state mirror div"
    - path: "frontend-nextjs/components/canvas/OperationErrorGuide.tsx"
      provides: "Error guidance with accessibility tree"
      contains: "role='alert' aria-live hidden state"
    - path: "frontend-nextjs/components/canvas/types/index.ts"
      provides: "Canvas state type definitions"
      contains: "CanvasState export type"
  key_links:
    - from: "frontend-nextjs/components/canvas/AgentOperationTracker.tsx"
      to: "hidden accessibility div"
      via: "state object rendered in invisible div"
      pattern: "style=\{\{display:'none'\}\} role='log'"
---

<objective>
Add canvas accessibility trees (hidden divs with state mirrors) for all 7 canvas types to enable AI agents to read canvas content without OCR.

**Purpose**: Canvas terminals/components create blind spots for AI agents who can't see canvas content (only see empty `<canvas>` tags). This plan implements the dual representation pattern: visual (pixels) + logical (state) representations.

**Output**: Hidden accessibility divs with `role="log"` and `aria-live` attributes exposing structured state JSON for AI agents and screen readers.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/20-canvas-ai-context/20-RESEARCH.md
@.planning/ROADMAP.md
@.planning/STATE.md

@frontend-nextjs/components/canvas/AgentOperationTracker.tsx
@frontend-nextjs/components/canvas/ViewOrchestrator.tsx
@frontend-nextjs/components/canvas/types/index.ts
@backend/core/models.py
</context>

<tasks>

<task type="auto">
  <name>Add accessibility tree to AgentOperationTracker</name>
  <files>frontend-nextjs/components/canvas/AgentOperationTracker.tsx</files>
  <action>
    Add a hidden accessibility div after the main component that exposes the operation state for AI agents:

    1. After the main closing `</div>` tag (line 265), add:
    ```tsx
    {/* Accessibility Tree - Hidden from visual display, readable by AI agents and screen readers */}
    <div
      role="log"
      aria-live="polite"
      aria-label="Agent operation state"
      style={{ display: 'none' }}
      data-canvas-state="agent_operation_tracker"
      data-operation-id={operation?.operation_id}
      data-agent-id={operation?.agent_id}
      data-agent-name={operation?.agent_name}
      data-operation-type={operation?.operation_type}
      data-status={operation?.status}
      data-progress={operation?.progress}
      data-current-step={operation?.current_step}
      data-current-step-index={operation?.current_step_index}
      data-total-steps={operation?.total_steps}
      data-context-what={operation?.context?.what}
      data-context-why={operation?.context?.why}
      data-context-next={operation?.context?.next}
      data-logs-count={operation?.logs?.length}
      data-started-at={operation?.started_at}
      data-completed-at={operation?.completed_at}
    >
      {operation && JSON.stringify({
        operation_id: operation.operation_id,
        agent_id: operation.agent_id,
        agent_name: operation.agent_name,
        operation_type: operation.operation_type,
        status: operation.status,
        current_step: operation.current_step,
        total_steps: operation.total_steps,
        current_step_index: operation.current_step_index,
        progress: operation.progress,
        context: operation.context,
        logs_count: operation.logs.length,
        started_at: operation.started_at,
        completed_at: operation.completed_at,
        logs: operation.logs.map(l => ({
          timestamp: l.timestamp,
          level: l.level,
          message: l.message
        }))
      })}
    </div>
    ```

    2. When operation is null, still render empty state structure:
    ```tsx
    <div
      role="log"
      aria-live="polite"
      aria-label="Agent operation state"
      style={{ display: 'none' }}
      data-canvas-state="agent_operation_tracker"
      data-status="loading"
    >
      {JSON.stringify({ status: 'loading', message: 'Waiting for operation data...' })}
    </div>
    ```

    Do NOT modify visual rendering - only add hidden state div.
  </action>
  <verify>
    1. File contains `role="log"` hidden div
    2. `data-canvas-state="agent_operation_tracker"` attribute present
    3. State object JSON serialized in div content
    4. Visual rendering unchanged (no UI changes)
  </verify>
  <done>
    AI agents can read AgentOperationTracker state by querying the hidden accessibility div without using OCR.
  </done>
</task>

<task type="auto">
  <name>Add accessibility tree to ViewOrchestrator</name>
  <files>frontend-nextjs/components/canvas/ViewOrchestrator.tsx</files>
  <action>
    Add a hidden accessibility div that exposes the view orchestration state:

    1. After the main closing `</div>` tag (line 307), add:
    ```tsx
    {/* Accessibility Tree - View orchestration state for AI agents */}
    <div
      role="log"
      aria-live="polite"
      aria-label="View orchestration state"
      style={{ display: 'none' }}
      data-canvas-state="view_orchestrator"
      data-layout={orchestration?.layout}
      data-current-view={orchestration?.current_view}
      data-active-views-count={orchestration?.active_views?.length}
      data-canvas-expanded={canvasExpanded}
    >
      {orchestration && JSON.stringify({
        layout: orchestration.layout,
        active_views: orchestration.active_views.map(v => ({
          view_id: v.view_id,
          view_type: v.view_type,
          title: v.title,
          status: v.status,
          position: v.position,
          size: v.size,
          url: v.url,
          command: v.command
        })),
        canvas_guidance: orchestration.canvas_guidance ? {
          agent_id: orchestration.canvas_guidance.agent_id,
          message: orchestration.canvas_guidance.message,
          what_youre_seeing: orchestration.canvas_guidance.what_youre_seeing,
          controls: orchestration.canvas_guidance.controls
        } : null,
        current_view: orchestration.current_view
      })}
    </div>
    ```

    2. When orchestration is null or no views:
    ```tsx
    <div
      role="log"
      aria-live="polite"
      aria-label="View orchestration state"
      style={{ display: 'none' }}
      data-canvas-state="view_orchestrator"
      data-status="empty"
    >
      {JSON.stringify({ status: 'empty', message: 'No active views' })}
    </div>
    ```

    Do NOT modify visual rendering.
  </action>
  <verify>
    1. File contains `role="log"` hidden div
    2. `data-canvas-state="view_orchestrator"` attribute present
    3. View orchestration state JSON serialized
    4. Active views array properly mapped
  </verify>
  <done>
    AI agents can read view orchestration state including active views, layout, and canvas guidance.
  </done>
</task>

<task type="auto">
  <name>Add accessibility trees to remaining canvas components</name>
  <files>
    frontend-nextjs/components/canvas/OperationErrorGuide.tsx
    frontend-nextjs/components/canvas/AgentRequestPrompt.tsx
    frontend-nextjs/components/canvas/IntegrationConnectionGuide.tsx
  </files>
  <action>
    Add accessibility trees to the remaining 3 canvas components (OperationErrorGuide, AgentRequestPrompt, IntegrationConnectionGuide).

    For each component:

    **OperationErrorGuide.tsx:**
    - Add hidden div after main component with `data-canvas-state="operation_error_guide"`
    - Expose: error_category, error_title, error_description, suggested_actions (array), troubleshooting_steps (array)
    - Use `role="alert"` and `aria-live="assertive"` for errors

    **AgentRequestPrompt.tsx:**
    - Add hidden div after main component with `data-canvas-state="agent_request_prompt"`
    - Expose: request_id, agent_id, request_type, prompt_message, options (array), user_decision

    **IntegrationConnectionGuide.tsx:**
    - Add hidden div after main component with `data-canvas-state="integration_connection_guide"`
    - Expose: integration_name, connection_status, steps_required (array), current_step, progress_percentage

    Pattern for each:
    ```tsx
    {/* Accessibility Tree - Hidden state for AI agents */}
    <div
      role="[log|alert]"
      aria-live="[polite|assertive]"
      aria-label="[Component] state"
      style={{ display: 'none' }}
      data-canvas-state="[component_name]"
      [data attributes for key values]
    >
      {state && JSON.stringify({
        [relevant state fields]
      })}
    </div>
    ```

    Do NOT modify visual rendering in any component.
  </action>
  <verify>
    1. All 3 components have hidden accessibility divs
    2. Each div has unique `data-canvas-state` attribute
    3. Error guide uses `role="alert"` (errors need immediate attention)
    4. State objects include relevant fields for each component type
  </verify>
  <done>
    All canvas components (5 guidance components) now expose structured state for AI agents.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. Run `grep -r "role=.log." frontend-nextjs/components/canvas/` - should find 5+ matches
2. Run `grep -r "data-canvas-state" frontend-nextjs/components/canvas/` - should find 5+ matches
3. Run `grep -r "aria-live" frontend-nextjs/components/canvas/` - should find 5+ matches
4. Confirm no visual changes (components render identically)
5. Confirm state is JSON-serializable (no circular references)
</verification>

<success_criteria>
1. All 5 guidance canvas components have hidden accessibility divs
2. Each div exposes component-specific state (operation, view, error, request, integration)
3. AI agents can query `document.querySelector('[data-canvas-state]')` to read state
4. Screen readers can announce changes via aria-live attributes
5. Performance overhead <10ms per render (JSON serialization only)
</success_criteria>

<output>
After completion, create `.planning/phases/20-canvas-ai-context/20-01-SUMMARY.md`
</output>
