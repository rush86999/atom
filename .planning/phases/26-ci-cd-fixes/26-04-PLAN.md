---
phase: 26-ci-cd-fixes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/conftest.py
  - backend/tests/test_feedback_enhanced.py
  - backend/tests/test_health_monitoring.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Tests run without UNIQUE constraint failed: users.email errors"
    - "Tests run without duplicate index definition errors"
    - "Each test gets a fresh database state"
    - "In-memory database is used for all test fixtures"
  artifacts:
    - path: "backend/tests/conftest.py"
      provides: "Database session fixture with fresh state per test"
      min_lines: 60
    - path: "backend/tests/test_feedback_enhanced.py"
      provides: "Tests using standardized db_session fixture"
      contains: "@pytest.fixture"
    - path: "backend/tests/test_health_monitoring.py"
      provides: "Tests using standardized db_session fixture"
      contains: "def db_session"
  key_links:
    - from: "backend/tests/conftest.py"
      to: "core.database.Base"
      via: "Base.metadata.create_all with checkfirst=True"
      pattern: "Base\.metadata\.create_all.*checkfirst"
---

# Plan 26-04: Database Cleanup Infrastructure

## Objective

Add pytest conftest hooks for database cleanup to resolve UNIQUE constraint and duplicate index errors preventing test verification.

**Purpose:** Tests are failing due to pre-existing database state in atom_dev.db. Each test needs a fresh in-memory database.

**Output:** Tests run with clean database state per function.

## Context

@.planning/phases/26-ci-cd-fixes/26-01-SUMMARY.md
@.planning/phases/26-ci-cd-fixes/26-VERIFICATION.md

### Gap Being Closed

**Gap 1: Database state pollution**
- 19 tests in test_feedback_enhanced.py error with UNIQUE constraint failed: users.email
- 7 tests in test_health_monitoring.py error with duplicate index definitions
- Root cause: atom_dev.db has stale test data; test files use local SessionLocal() instead of standardized db_session fixture
- Missing: Migration to use conftest.py's standardized db_session fixture that creates fresh in-memory database per test

### Existing Infrastructure

The root conftest.py already has a standardized `db_session` fixture (lines 139-198):
- Uses tempfile-based SQLite file for stability
- Creates fresh database with `Base.metadata.create_all(engine, checkfirst=True)`
- Handles missing foreign key references gracefully
- Auto-cleanup on yield exit
- This is the CORRECT approach - test files should use this fixture

### Problem Files

1. **test_feedback_enhanced.py** (lines 28-35): Uses its own `db` fixture with `SessionLocal()` - connects to atom_dev.db which has stale data
2. **test_health_monitoring.py** (lines 35-44): Uses its own `db_session` fixture with in-memory database but `Base.metadata.create_all(bind=engine)` without checkfirst - causes duplicate index errors

## Tasks

<task type="auto">
  <name>Fix test_feedback_enhanced.py to use standardized db_session fixture</name>
  <files>backend/tests/test_feedback_enhanced.py</files>
  <action>
    1. Remove the local `db` fixture (lines 28-35)
    2. Remove the `from core.database import SessionLocal` import
    3. Update all test function signatures to use `db_session` instead of `db`
    4. Add `from core.models import User, AgentRegistry, AgentExecution, AgentFeedback` import (if not present)
    5. Verify cleanup code in fixtures uses `db_session` parameter name

    The standardized conftest.py fixture:
    - Creates fresh temp database file per test
    - Uses checkfirst=True to handle existing tables gracefully
    - Auto-cleans up after test completes
    - Prevents UNIQUE constraint violations from stale data
  </action>
  <verify>
    grep -n "def db(" backend/tests/test_feedback_enhanced.py && echo "FAIL: local db fixture still exists" || echo "PASS: local fixture removed"
    grep -n "def.*db_session" backend/tests/test_feedback_enhanced.py | wc -l | grep -q "0" && echo "PASS: no local db_session fixture" || echo "INFO: checking parameter usage..."
  </verify>
  <done>
    - No local `db` fixture defined in test_feedback_enhanced.py
    - All test methods use `db_session` parameter from conftest.py
    - No import of SessionLocal from core.database
  </done>
</task>

<task type="auto">
  <name>Fix test_health_monitoring.py to use standardized db_session fixture</name>
  <files>backend/tests/test_health_monitoring.py</files>
  <action>
    1. Remove the local `db_session` fixture (lines 35-44 in current file)
    2. Remove the local engine creation and TestingSessionLocal (lines 27-33)
    3. Keep the test_user, test_agent, and health_service fixtures but change their `db_session: Session` parameter to use the standardized fixture
    4. Remove the `from sqlalchemy import create_engine` and `sessionmaker` imports (no longer needed)
    5. Ensure fixtures reference the conftest.py db_session fixture correctly

    The standardized fixture handles:
    - tempfile-based database (not :memory: for better multiprocessing support)
    - checkfirst=True on create_all (prevents duplicate index errors)
    - Auto-cleanup after each test
  </action>
  <verify>
    grep -n "Base.metadata.create_all" backend/tests/test_health_monitoring.py && echo "FAIL: local create_all still exists" || echo "PASS: using standardized fixture"
    grep -n "create_engine" backend/tests/test_health_monitoring.py && echo "INFO: checking engine imports..."
  </verify>
  <done>
    - No local `db_session` fixture defined in test_health_monitoring.py
    - No local engine or TestingSessionLocal
    - test_user, test_agent, health_service fixtures use standardized db_session
  </done>
</task>

<task type="auto">
  <name>Verify tests pass with clean database state</name>
  <files>backend/tests/test_feedback_enhanced.py, backend/tests/test_health_monitoring.py</files>
  <action>
    Run both test files with fresh database state to verify:
    1. No UNIQUE constraint errors
    2. No duplicate index errors
    3. Tests can create User objects with email="test@example.com" without collision

    Command:
    ```bash
    PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/test_feedback_enhanced.py backend/tests/test_health_monitoring.py -v --tb=short
    ```

    Expected results:
    - test_feedback_enhanced.py: At least 15+ tests pass (previously all errored)
    - test_health_monitoring.py: At least 6+ tests pass (previously all errored)
  </action>
  <verify>
    PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/test_feedback_enhanced.py -v 2>&1 | grep -E "PASSED|FAILED|ERROR" | tail -5
    PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/test_health_monitoring.py -v 2>&1 | grep -E "PASSED|FAILED|ERROR" | tail -5
  </verify>
  <done>
    - No "UNIQUE constraint failed: users.email" errors
    - No "index ix_* already exists" errors
    - At least 20 total tests pass between both files
  </done>
</task>

## Verification

After completion, verify:

1. **Database State Isolation**: Each test function gets fresh database
   - Run tests twice in succession - same results both times
   - No collision between test_email@example.com in different tests

2. **No UNIQUE Errors**: test_feedback_enhanced.py tests pass
   - `pytest backend/tests/test_feedback_enhanced.py -v` shows 15+ PASSED
   - No "UNIQUE constraint" in stderr

3. **No Index Errors**: test_health_monitoring.py tests pass
   - `pytest backend/tests/test_health_monitoring.py -v` shows 6+ PASSED
   - No "already exists" in stderr

## Success Criteria

1. test_feedback_enhanced.py: 15+ tests pass (previously 0 due to UNIQUE errors)
2. test_health_monitoring.py: 6+ tests pass (previously 0 due to index errors)
3. No database state pollution between tests
4. Standardized db_session fixture from conftest.py is used consistently

## Output

After completion, create `.planning/phases/26-ci-cd-fixes/26-04-SUMMARY.md` with:
- Number of tests now passing (was 0, expected 20+)
- Confirmation of UNIQUE constraint error resolution
- Confirmation of duplicate index error resolution
- Note about test_health_check fixture (separate issue for plan 26-05)
