---
phase: 26-ci-cd-fixes
plan: 05
type: execute
wave: 2
depends_on: [26-04]
files_modified:
  - backend/tests/test_health_monitoring.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "test_health_check either runs successfully or is removed"
    - "No 'fixture 'client' not found' errors in test output"
    - "All TestHealthMonitoringAPI tests are runnable"
  artifacts:
    - path: "backend/tests/test_health_monitoring.py"
      provides: "Health monitoring tests with valid fixtures"
      contains: "class TestHealthMonitoringAPI"
  key_links:
    - from: "TestHealthMonitoringAPI.test_health_check"
      to: "FastAPI TestClient or removed"
      via: "fixture definition or test removal"
      pattern: "client|@pytest.fixture"
---

# Plan 26-05: Fix Missing Test Client Fixture

## Objective

Fix or remove test_health_check in test_health_monitoring.py which references undefined 'client' fixture.

**Purpose:** The test_health_check method expects a FastAPI TestClient fixture named 'client' that doesn't exist.

**Output:** Either a working API test with proper TestClient fixture, or test removed if not applicable.

## Context

@.planning/phases/26-ci-cd-fixes/26-04-SUMMARY.md
@.planning/phases/26-ci-cd-fixes/26-VERIFICATION.md

### Gap Being Closed

**Gap 3: Missing test fixture**
- TestHealthMonitoringAPI.test_health_check (line 260) references undefined 'client' fixture
- Error: "fixture 'client' not found"
- Root cause: Test was written for FastAPI TestClient integration testing but no fixture provides it
- Missing: Either add FastAPI TestClient fixture or remove test if duplicate/unnecessary

### Current Test Code (lines 257-272)

```python
class TestHealthMonitoringAPI:
    """Test health monitoring API endpoints"""

    def test_health_check(self, client):
        """Test health check endpoint"""
        response = client.get("/api/health/health")
        # Note: This might fail if the route isn't loaded in test client
        # We'll just verify the import works for now
        try:
            assert response.status_code == 200
            data = response.json()
            assert data["status"] == "healthy"
            assert data["service"] == "health_monitoring"
        except:
            # If the route isn't loaded, that's OK for this test
            pass
```

### Decision Required

Is this test meant to be:
1. **API integration test** - Needs FastAPI TestClient fixture with app loaded
2. **Duplicate/unneeded** - The health monitoring service tests already cover functionality via health_service fixture

After analysis, this test appears to be outdated - the note "if the route isn't loaded, that's OK" suggests it was written tentatively. The service-level tests (TestHealthMonitoringService) already provide adequate coverage.

## Tasks

<task type="auto">
  <name>Remove test_health_check or add client fixture</name>
  <files>backend/tests/test_health_monitoring.py</files>
  <action>
    The test_health_check method (line 260-272) references a 'client' fixture that doesn't exist.

    Based on code analysis:
    1. The test has a TODO-style note saying "might fail if route isn't loaded"
    2. It's wrapped in try/except that silently ignores failures
    3. TestHealthMonitoringService class already provides comprehensive testing

    DECISION: Remove the entire TestHealthMonitoringAPI class (lines 257-272)

    Steps:
    1. Delete lines 257-272 (entire TestHealthMonitoringAPI class)
    2. Keep TestHealthMonitoringService class (lines 85-255) - those tests are valid
    3. No other changes needed

    Rationale:
    - API endpoint tests require FastAPI app initialization which isn't set up
    - Service-level tests provide better coverage for health monitoring functionality
    - The test as written provides no value (silent failures, no assertions verified)
  </action>
  <verify>
    grep -n "class TestHealthMonitoringAPI" backend/tests/test_health_monitoring.py && echo "FAIL: class still exists" || echo "PASS: class removed"
    grep -n "test_health_check" backend/tests/test_health_monitoring.py && echo "INFO: checking for other references..."
  </verify>
  <done>
    - TestHealthMonitoringAPI class removed from test_health_monitoring.py
    - No 'client' fixture references in file
    - TestHealthMonitoringService class unchanged (8 tests remain)
  </done>
</task>

<task type="auto">
  <name>Verify test_health_monitoring.py runs without fixture errors</name>
  <files>backend/tests/test_health_monitoring.py</files>
  <action>
    Run the full test file to verify:
    1. No "fixture 'client' not found" errors
    2. All remaining tests (TestHealthMonitoringService) can run

    Command:
    ```bash
    PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/test_health_monitoring.py -v --tb=short
    ```

    Expected results:
    - 8 tests in TestHealthMonitoringService class attempt to run
    - No fixture-related errors
    - Note: Some tests may still fail due to other issues (mock setup, etc.) but no fixture errors
  </action>
  <verify>
    PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest backend/tests/test_health_monitoring.py -v 2>&1 | grep -i "fixture.*not found" && echo "FAIL: fixture error" || echo "PASS: no fixture errors"
  </verify>
  <done>
    - No "fixture 'client' not found" error in test output
    - 8 tests in TestHealthMonitoringService are collected and run
    - Test collection succeeds without errors
  </done>
</task>

## Verification

After completion, verify:

1. **No Fixture Errors**: `pytest --collect-only` shows no missing fixture warnings
2. **Class Removed**: TestHealthMonitoringAPI no longer exists in file
3. **Service Tests Remain**: TestHealthMonitoringService class still has 8 test methods

## Success Criteria

1. test_health_monitoring.py runs without "fixture 'client' not found" error
2. TestHealthMonitoringAPI class removed
3. TestHealthMonitoringService class remains with 8 tests
4. No import errors or collection failures

## Output

After completion, create `.planning/phases/26-ci-cd-fixes/26-05-SUMMARY.md` with:
- Confirmation of TestHealthMonitoringAPI removal
- Test collection output showing 8 tests (down from 9)
- Note that service-level tests remain intact
