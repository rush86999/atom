---
phase: 26-ci-cd-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_atom_governance.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - Tests use correct AtomMetaAgent API
    - No references to removed '_step_act' method on AtomMetaAgent
    - test_atom_governance.py tests pass
  artifacts:
    - path: "backend/tests/test_atom_governance.py"
      provides: "Agent governance tests using correct API"
      removes: "_step_act method calls"
  key_links:
    - from: "backend/tests/test_atom_governance.py"
      to: "core/atom_meta_agent.py:AtomMetaAgent"
      via: "Direct AtomMetaAgent usage"
      pattern: "from core.atom_meta_agent import AtomMetaAgent"
---

<objective>
Fix test_atom_governance.py which incorrectly calls removed '_step_act' method on AtomMetaAgent.

Root cause analysis:
- AtomMetaAgent (core/atom_meta_agent.py:143) does NOT inherit from GenericAgent
- AtomMetaAgent does NOT have a '_step_act' method
- test_atom_governance.py:33 incorrectly calls `await atom._step_act("delete_file", {"path": "/tmp/test"}, {})`

The test should use the correct AtomMetaAgent public API:
- `atom.execute(request, context, trigger_mode, step_callback, execution_id)` - main entry point
- Governance checks happen inside execute() via AgentGovernanceService
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# AtomMetaAgent class definition
@backend/core/atom_meta_agent.py:143-200

# GenericAgent._step_act for reference (NOT available on AtomMetaAgent)
@backend/core/generic_agent.py:412
</context>

<tasks>

<task type="auto">
  <name>Fix test_atom_governance_gating to use correct API</name>
  <files>backend/tests/test_atom_governance.py</files>
  <action>
    Update test_atom_governance_gating function (lines 12-52) to use AtomMetaAgent.execute() instead of _step_act():

    Current incorrect code (lines 32-36):
    ```python
    # "delete_file" (complexity 4) should be blocked for level 0 Student
    result = await atom._step_act("delete_file", {"path": "/tmp/test"}, {})

    assert "Governance Error" in result
    assert "maturity" in result.lower()
    ```

    Change to:
    ```python
    # Request deletion - should be blocked for STUDENT agent
    result = await atom.execute("Delete the file at /tmp/test")

    # STUDENT agents should get governance error for high-complexity actions
    assert result.get("status") == "blocked" or "governance" in result.get("error", "").lower()
    ```

    Key changes:
    1. Use `execute(request_string)` instead of `_step_act(tool_name, args, context)`
    2. Check response structure matches AtomMetaAgent.execute() return format
    3. Verify governance blocking works for STUDENT maturity level
  </action>
  <verify>grep -n "_step_act" backend/tests/test_atom_governance.py returns nothing</verify>
  <done>test_atom_governance_gating uses AtomMetaAgent.execute() API, verifies STUDENT agent blocking</done>
</task>

<task type="auto">
  <name>Verify test_atom_learning_progression uses correct API</name>
  <files>backend/tests/test_atom_governance.py</files>
  <action>
    Review test_atom_learning_progression (lines 54-97) to ensure it uses correct API.

    The test currently calls `await atom.execute("Test task")` which IS correct.

    Verify:
    1. No calls to `_step_act` method
    2. LLM mocking is correctly set up for atom.llm.generate_response
    3. Assertions check AgentRegistry confidence_score and status updates

    If any issues found, update to use correct AtomMetaAgent patterns.
  </action>
  <verify>pytest backend/tests/test_atom_governance.py::test_atom_learning_progression -v passes</verify>
  <done>test_atom_learning_progression correctly uses AtomMetaAgent.execute() and verifies confidence progression</done>
</task>

</tasks>

<verification>
Run the updated test file:
```bash
pytest backend/tests/test_atom_governance.py -v
```

Expected result: Both tests pass without AttributeError about '_step_act'.
</verification>

<success_criteria>
- test_atom_governance.py: Both tests pass
- No AttributeError: 'AtomMetaAgent' object has no attribute '_step_act'
- Tests use AtomMetaAgent.execute() public API
- Governance blocking verification works for STUDENT agents
</success_criteria>

<output>
After completion, create `.planning/phases/26-ci-cd-fixes/26-02-SUMMARY.md` with:
- Changes made to test assertions
- pytest output showing passing tests
- Explanation of correct AtomMetaAgent API usage
</output>
