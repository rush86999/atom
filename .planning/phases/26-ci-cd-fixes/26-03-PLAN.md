---
phase: 26-ci-cd-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/saas/models.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - SQLAlchemy relationship reference resolves correctly
    - No import errors during test collection
    - Integration tests can import models without mapper errors
  artifacts:
    - path: "backend/saas/models.py"
      provides: "Fixed relationship reference to Subscription model"
      removes: "Invalid string reference path"
  key_links:
    - from: "backend/saas/models.py:53"
      to: "backend/ecommerce/models.py:Subscription"
      via: "SQLAlchemy relationship string reference"
      pattern: "relationship\\(\"Subscription\""
---

<objective>
Fix SQLAlchemy relationship reference in saas/models.py that causes mapper errors during test collection.

Current issue (saas/models.py:53):
```python
subscription = relationship("ecommerce.models.Subscription", backref="usage_events")
```

Problem: The string reference "ecommerce.models.Subscription" doesn't resolve because SQLAlchemy can't find the class in that module path format.

Solution: Use the correct string reference format that SQLAlchemy can resolve. Since both models use Base from core.database, we can use either:
1. Just the class name: "Subscription" (if in same module)
2. Full module path with proper format (for cross-module references)
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# Problem relationship in saas/models.py
@backend/saas/models.py:50-53

# Target Subscription model
@backend/ecommerce/models.py:111-140
</context>

<tasks>

<task type="auto">
  <name>Fix SQLAlchemy relationship reference in saas/models.py</name>
  <files>backend/saas/models.py</files>
  <action>
    Update the relationship reference in UsageEvent class (line 53):

    Current incorrect code:
    ```python
    subscription = relationship("ecommerce.models.Subscription", backref="usage_events")
    ```

    Change to (use proper SQLAlchemy cross-module reference format):
    ```python
    # Import Subscription model at module level for relationship
    # Add at top of file with other imports:
    # from ecommerce.models import Subscription

    # Then update relationship to:
    subscription = relationship("Subscription", backref="usage_events")
    ```

    Implementation steps:
    1. Add import at top of saas/models.py: `from ecommerce.models import Subscription`
    2. Change relationship string from "ecommerce.models.Subscription" to "Subscription"

    DO NOT:
    - Remove the relationship entirely (it's needed for ORM)
    - Use back_populates unless you add the reverse side too
  </action>
  <verify>python -c "from saas.models import UsageEvent; print('Import successful')" works without mapper error</verify>
  <done>SQLAlchemy can resolve the relationship reference, no mapper errors during import</done>
</task>

<task type="auto">
  <name>Verify test collection works</name>
  <files>backend/tests/</files>
  <action>
    Run pytest collection to verify no mapper errors:

    ```bash
    cd backend
    pytest --collect-only -q 2>&1 | grep -i "mapper\|error" || echo "No mapper errors found"
    ```

    Also run specific integration tests that might use these models:
    ```bash
    pytest backend/tests/integration/ -v -k "subscription or usage" 2>&1 || true
    ```

    If other mapper errors are found, document them in SUMMARY.md for future fixes (out of scope for this plan).
  </action>
  <verify>pytest --collect-only completes without SQLAlchemy mapper errors about ecommerce.models.Subscription</verify>
  <done>Test collection succeeds, models import without errors</done>
</task>

</tasks>

<verification>
Verify the fix with both import test and collection:
```bash
# Test direct import
python -c "from saas.models import UsageEvent; from ecommerce.models import Subscription; print('OK')"

# Test pytest collection
pytest --collect-only -q 2>&1 | head -20
```

Expected: No "sqlalchemy.exc.InvalidRequestError" about unresolved relationships.
</verification>

<success_criteria>
- saas/models.py imports Subscription from ecommerce.models
- Relationship uses "Subscription" string reference that SQLAlchemy can resolve
- No mapper errors during test collection
- UsageEvent.subscription relationship works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/26-ci-cd-fixes/26-03-SUMMARY.md` with:
- Import statement added to saas/models.py
- Relationship reference change made
- pytest collection output showing no mapper errors
- Any additional mapper errors found (if any) for future work
</output>
