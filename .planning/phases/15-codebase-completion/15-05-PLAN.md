---
phase: 15-codebase-completion
plan: 05
type: execute
wave: 2
depends_on: [15-01, 15-02, 15-03, 15-04]
files_modified:
  - backend/core/llm/byok_handler.py
  - backend/core/agent_governance_service.py
  - backend/core/workflow_engine.py
  - backend/mypy.ini
  - backend/docs/CODE_QUALITY_STANDARDS.md
autonomous: true

must_haves:
  truths:
    - "Type hints added to critical service functions (governance, BYOK, workflow)"
    - "MyPy configuration exists for type checking"
    - "Error handling follows standardized patterns across core services"
    - "Code quality standards document exists"
  artifacts:
    - path: "backend/mypy.ini"
      provides: "MyPy configuration for type checking"
      contains: "\\[mypy\\]"
    - path: "backend/docs/CODE_QUALITY_STANDARDS.md"
      provides: "Code quality guidelines and standards"
      contains: "## Type Hints"
  key_links:
    - from: "backend/mypy.ini"
      to: "backend/core/llm/byok_handler.py"
      via: "type hint enforcement"
      pattern: "from typing import"
    - from: "backend/docs/CODE_QUALITY_STANDARDS.md"
      to: "backend/core/agent_governance_service.py"
      via: "error handling pattern reference"
      pattern: "except Exception as e:"
---

<objective>
Add type hints to critical services, configure MyPy for type checking, and document code quality standards.

Purpose: Type safety improves code maintainability and catches bugs at development time. Critical services (governance, BYOK, workflow) need type hints for production reliability.

Output: Type hints on critical services, MyPy configuration, code quality standards documentation.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-codebase-completion/15-RESEARCH.md
@.planning/ROADMAP.md

# Type hint patterns from STATE.md (Phase 10-fix-tests)
- Add type hints to all function signatures: `def foo(x: int) -> str:`
- Use `from typing import Optional, List, Dict, Any` for complex types
- Run mypy in CI/CD: `mypy core/ --strict` (incremental adoption)

# Error handling patterns from previous phases
- Use specific exception types when possible
- Log errors with context using structured logging
- Return error responses with status codes (API layer)
- Never swallow exceptions silently

# Services requiring type hints
- byok_handler.py: LLM routing logic
- agent_governance_service.py: Agent lifecycle management
- workflow_engine.py: Workflow orchestration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type hints to critical services</name>
  <files>backend/core/llm/byok_handler.py, backend/core/agent_governance_service.py, backend/core/workflow_engine.py</files>
  <action>
    1. Add type hints to backend/core/llm/byok_handler.py:
       - Function parameters: provider, model, messages, stream
       - Return types: str, AsyncIterator[str], dict
       - Use Optional for nullable returns
       - Use List and Dict for complex types

    2. Add type hints to backend/core/agent_governance_service.py:
       - Function parameters: agent_id, action, maturity_level
       - Return types: bool, dict, AgentRegistry
       - Use Optional for database queries that may return None
       - Use TypedDict for structured dictionaries

    3. Add type hints to backend/core/workflow_engine.py:
       - Function parameters: workflow_id, context, inputs
       - Return types: WorkflowExecution, dict
       - Use List for workflow steps
       - Use Dict for context variables

    4. Import required types from typing module:
       - Optional, List, Dict, Any, TypedDict, Union
       - AsyncIterator for async generators
       - Callable for function parameters

    Per 15-RESEARCH.md type hint patterns:
    - Add type hints to all function signatures
    - Use Optional for nullable types
    - Use complex types (List, Dict) for collections
  </action>
  <verify>
    Command: `grep -c "def.*->.*:" backend/core/llm/byok_handler.py backend/core/agent_governance_service.py backend/core/workflow_engine.py`
    Expected: 30+ functions with return type annotations
  </verify>
  <done>
    Type hints added to critical service functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure MyPy and create code quality standards</name>
  <files>backend/mypy.ini, backend/docs/CODE_QUALITY_STANDARDS.md</files>
  <action>
    1. Create backend/mypy.ini with:
       ```ini
       [mypy]
       python_version = 3.11
       warn_return_any = True
       warn_unused_configs = True
       disallow_untyped_defs = False  # Incremental adoption
       check_untyped_defs = True
       ignore_missing_imports = True  # For third-party libs
       exclude = (?x)(
           tests/
           | mobile/
           | desktop/
       )
       ```
    2. Add mypy to requirements.txt: `mypy>=1.8.0`

    3. Create backend/docs/CODE_QUALITY_STANDARDS.md with:
       - Type hints requirements (new code must have 100%, existing code incremental)
       - Error handling patterns (specific exceptions, logging context)
       - Logging standards (use structlog, include context)
       - Documentation standards (docstrings with Args/Returns)
       - Code formatting (use black, 88 char line length)
       - Linting (use ruff for fast linting)
       - Testing standards (pytest with type-safe fixtures)

    Per 15-RESEARCH.md code quality tools:
    - mypy: Static type checking
    - black: Code formatting
    - ruff: Fast linter
  </action>
  <verify>
    Command: `cd backend && python -c "import mypy.api; print(mypy.api.run(['--config-file', 'mypy.ini', 'core/llm/byok_handler.py']))"`
    Expected: MyPy runs without critical errors (warnings OK during incremental adoption)
  </verify>
  <done>
    MyPy configured, code quality standards documented
  </done>
</task>

<task type="auto">
  <name>Task 3: Standardize error handling and create SUMMARY</name>
  <files>backend/core/agent_governance_service.py, backend/core/llm/byok_handler.py, backend/core/workflow_engine.py, .planning/phases/15-codebase-completion/15-05-SUMMARY.md</files>
  <action>
    1. Review and standardize error handling in critical services:
       - Use specific exception types (ValueError, KeyError, HTTPException)
       - Never use bare `except:` (always specify exception type)
       - Log errors with context using structured logging
       - Include error messages that explain the problem
       - Preserve original exception with `raise ... from e`

    2. Add error handling patterns to services:
       - Database errors: SQLAlchemyError
       - Validation errors: ValueError with descriptive message
       - Not found errors: Return None or raise specific exception
       - Permission errors: Custom PermissionDeniedException

    3. Create SUMMARY.md documenting:
       - Type hints added (count of functions annotated)
       - MyPy configuration
       - Code quality standards created
       - Error handling improvements
       - Phase 15 complete status (all 5 plans)

    4. Add CI step for type checking (commented out for incremental adoption):
       ```yaml
       # - name: Type check with mypy
       #   run: mypy core/ --config-file backend/mypy.ini
       ```
  </action>
  <verify>
    Command: `grep -c "except.*:" backend/core/agent_governance_service.py backend/core/llm/byok_handler.py backend/core/workflow_engine.py`
    Expected: All except clauses specify exception type (no bare except:)
  </verify>
  <done>
    Error handling standardized, SUMMARY.md complete, Phase 15 complete
  </done>
</task>

</tasks>

<verification>
1. Run mypy on core services: `cd backend && mypy core/llm/byok_handler.py core/agent_governance_service.py`
2. Check type hint coverage: `grep -c "def.*->.*:" backend/core/llm/byok_handler.py`
3. Verify mypy.ini exists: `cat backend/mypy.ini`
4. Read CODE_QUALITY_STANDARDS.md: Should cover type hints, error handling, logging
5. Check error handling: No bare `except:` in critical services
</verification>

<success_criteria>
1. Type hints added to 30+ functions across 3 critical services
2. mypy.ini configured with appropriate settings
3. CODE_QUALITY_STANDARDS.md documents quality requirements
4. Error handling uses specific exception types
5. No bare `except:` clauses in critical services
6. SUMMARY.md marks Phase 15 complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-codebase-completion/15-05-SUMMARY.md`
</output>
