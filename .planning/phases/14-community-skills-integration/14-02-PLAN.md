---
phase: 14-community-skills-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/core/skill_sandbox.py
  - backend/alembic/versions/20260216_community_skills_model_extensions.py
  - backend/tests/test_skill_sandbox.py
  - backend/requirements.txt
autonomous: true

must_haves:
  truths:
    - "HazardSandbox executes Python code in isolated Docker containers"
    - "Containers have resource limits: mem_limit, cpu_quota, network_disabled, read_only"
    - "Sandbox captures stdout/stderr and returns execution results"
    - "Containers auto-remove after execution (ephemeral)"
    - "Security constraints prevent container escape (no privileged mode, no socket mount)"
    - "Alembic migration adds community skill columns to SkillExecution table"
    - "Tests cover container lifecycle, resource limits, and error scenarios"
  artifacts:
    - path: "backend/core/skill_sandbox.py"
      provides: "Docker sandbox for isolated Python skill execution"
      min_lines: 200
      contains: "class HazardSandbox", "execute_python", "mem_limit", "cpu_quota", "network_disabled"
    - path: "backend/alembic/versions/20260216_community_skills_model_extensions.py"
      provides: "Database migration for community skill columns"
      min_lines: 80
      contains: "upgrade()", "downgrade()", "skill_source", "security_scan_result", "sandbox_enabled"
    - path: "backend/tests/test_skill_sandbox.py"
      provides: "Sandbox tests covering container lifecycle and security"
      min_lines: 120
    - path: "backend/requirements.txt"
      provides: "Docker SDK dependency"
      contains: "docker"
  key_links:
    - from: "backend/core/skill_adapter.py"
      to: "backend/core/skill_sandbox.py"
      via: "Python skill execution via sandbox"
      pattern: "HazardSandbox|execute_python"
    - from: "backend/core/skill_sandbox.py"
      to: "backend/core/models.py"
      via: "SkillExecution.container_id reference"
      pattern: "container_id"
---

<objective>
Create HazardSandbox service that executes untrusted Python skill code in isolated Docker containers with resource limits (memory, CPU, network disabled, read-only filesystem). Create Alembic migration for SkillExecution model extensions.

Purpose: Provide defense-in-depth security for community skill execution - even if a malicious skill passes LLM security scanning, sandbox isolation prevents system damage.

Output: HazardSandbox service for Docker container execution, Alembic migration for community skill model columns.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/14-community-skills-integration/14-CONTEXT.md
@.planning/phases/14-community-skills-integration/14-RESEARCH.md
@.planning/ROADMAP.md
@.planning/STATE.md

@backend/core/models.py (SkillExecution model for reference)
@backend/alembic/versions/20260207_supervision_learning_integration.py (migration pattern reference)
@backend/tests/test_governance_cache.py (test patterns)
</context>

<tasks>

<task type="auto">
  <name>Create HazardSandbox for Docker execution</name>
  <files>backend/core/skill_sandbox.py</files>
  <action>
Create backend/core/skill_sandbox.py with the following implementation:

1. Import dependencies:
   - import docker (Docker SDK for Python)
   - import uuid, logging, json
   - from typing import Dict, Any, Optional

2. Create HazardSandbox class:
   - __init__(self): Initialize docker.from_env() client
   - _validate_docker_available(): Check if Docker daemon is running

3. Implement execute_python method with signature:
   def execute_python(
       self,
       code: str,
       inputs: Dict[str, Any],
       timeout_seconds: int = 30,
       memory_limit: str = "256m",
       cpu_limit: float = 0.5
   ) -> str

4. Container execution logic:
   - Generate container_id = f"skill_{uuid.uuid4().hex[:8]}"
   - Create wrapper script that injects inputs and executes code
   - Use docker.from_env().containers.run() with:
     * image="python:3.11-slim"
     * command=["python", "-c", wrapper_script]
     * name=container_id
     * mem_limit=memory_limit
     * cpu_quota=int(cpu_limit * 100000)
     * cpu_period=100000
     * network_disabled=True (CRITICAL for security)
     * read_only=True
     * tmpfs={"/tmp": "size=10m"}
     * auto_remove=True
     * stdout=True, stderr=True
     * timeout=timeout_seconds

5. Error handling:
   - Catch docker.errors.ContainerError: return execution error details
   - Catch docker.errors.APIError: return Docker API error
   - Catch Exception: return generic sandbox error
   - Log all errors with container_id

6. Security constraints (per RESEARCH.md Pitfall 3):
   - NEVER mount /var/run/docker.sock
   - NEVER use --privileged mode
   - Always use network_disabled=True
   - Always use read_only=True
   - Limit resources with mem_limit and cpu_quota

7. Add cleanup method cleanup_container(container_id: str) for manual cleanup if needed

Reference: RESEARCH.md Pattern 3 "Docker Sandbox with Resource Limits"

IMPORTANT: If Docker is not available, raise clear error message - don't fail silently.
  </action>
  <verify>
python -c "from core.skill_sandbox import HazardSandbox; print('HazardSandbox imported successfully')"
  </verify>
  <done>
HazardSandbox class created with execute_python method. Uses Docker SDK with security constraints (network disabled, read-only, resource limits).
  </done>
</task>

<task type="auto">
  <name>Create Alembic migration for community skill model</name>
  <files>backend/alembic/versions/20260216_community_skills_model_extensions.py</files>
  <action>
Create backend/alembic/versions/20260216_community_skills_model_extensions.py with:

1. Migration header:
   revision = '20260216_community_skills'
   down_revision = 'LATEST_MIGRATION_ID'  # Find latest from alembic/versions/
   create_date = '2026-02-16'

2. upgrade() function:
   - Add columns to skill_executions table:
     * op.add_column('skill_executions', sa.Column('skill_source', sa.String(), default='cloud', nullable=True))
     * op.add_column('skill_executions', sa.Column('security_scan_result', sa.JSON(), nullable=True))
     * op.add_column('skill_executions', sa.Column('sandbox_enabled', sa.Boolean(), default=False, nullable=True))
     * op.add_column('skill_executions', sa.Column('container_id', sa.String(), nullable=True))

   - Create indexes:
     * op.create_index('ix_skill_executions_skill_source', 'skill_executions', ['skill_source'])
     * op.create_index('ix_skill_executions_sandbox_enabled', 'skill_executions', ['sandbox_enabled'])

   - Update existing records: set skill_source='cloud' for NULL values

3. downgrade() function:
   - Drop indexes
   - Drop columns (in reverse order)

4. Migration must be reversible (downgrade removes all added columns)

Reference: backend/alembic/versions/20260207_supervision_learning_integration.py for pattern

NOTE: First check latest migration ID with: ls -lt backend/alembic/versions/ | head -2
  </action>
  <verify>
cd /Users/rushiparikh/projects/atom/backend && alembic history | grep "20260216_community_skills"
  </verify>
  <done>
Alembic migration file created with upgrade() and downgrade() functions. Migration adds skill_source, security_scan_result, sandbox_enabled, container_id columns.
  </done>
</task>

<task type="auto">
  <name>Add Docker SDK dependency and create sandbox tests</name>
  <files>backend/requirements.txt backend/tests/test_skill_sandbox.py</files>
  <action>
1. Update backend/requirements.txt:
   - Add: docker>=7.0.0,<8.0.0
   - Place near other infrastructure dependencies

2. Create backend/tests/test_skill_sandbox.py (120+ lines) with tests:

   Test cases (use pytest and mock docker for unit tests):
   - test_docker_client_initialization: Verify Docker client creates
   - test_execute_python_success: Mock successful container execution
   - test_execute_python_timeout: Verify timeout handling
   - test_execute_python_memory_limit: Verify memory constraint applied
   - test_execute_python_network_disabled: Verify network isolation
   - test_execute_python_read_only_filesystem: Verify read-only constraint
   - test_execute_python_error_handling: Verify errors are caught and logged
   - test_cleanup_container: Verify container cleanup
   - test_docker_unavailable_error: Verify clear error when Docker not running

3. Mock docker client (don't require actual Docker for tests):
   - Use unittest.mock.patch for docker.from_env()
   - Mock container.run() to return fake output
   - Mock container errors for error handling tests

4. Security constraint tests (critical):
   - Verify network_disabled=True is always set
   - Verify read_only=True is always set
   - Verify mem_limit is applied
   - Verify cpu_quota is applied

Reference: backend/tests/test_governance_cache.py for mock patterns
Reference: RESEARCH.md Pitfall 3 for security constraints

IMPORTANT: These are unit tests with mocks - integration tests with real Docker are out of scope for this phase.
  </action>
  <verify>
cd /Users/rushiparikh/projects/atom/backend && PYTHONPATH=/Users/rushiparikh/projects/atom/backend pytest tests/test_skill_sandbox.py -v
  </verify>
  <done>
Docker SDK added to requirements.txt. All sandbox tests pass. Tests cover container lifecycle, resource limits, security constraints, and error handling.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Import HazardSandbox successfully
2. Verify migration file exists and is valid: alembic history | grep community_skills
3. Run pytest on test_skill_sandbox.py - all pass (using mocks)
4. Verify docker dependency in requirements.txt
5. Check that security constraints are enforced (network_disabled, read_only)
</verification>

<success_criteria>
1. HazardSandbox executes Python code in Docker containers
2. Containers have resource limits (256m memory, 0.5 CPU by default)
3. Network access disabled, filesystem read-only (security constraints)
4. Alembic migration created for SkillExecution model extensions
5. All sandbox tests pass with mocked Docker client
6. Docker SDK dependency added to requirements.txt
</success_criteria>

<output>
After completion, create `.planning/phases/14-community-skills-integration/14-02-SUMMARY.md` with:
- Files created/modified
- Test results (pass/fail counts)
- Docker security constraints applied
- Migration ID and revision details
- Next steps (Plan 03: Skills Registry)
</output>
