# Plan 65-07: Mobile Testing Infrastructure

---

**wave:** 3
**depends_on:** [65-01, 65-02, 65-03, 65-04, 65-05]
**files_modified:**
  - mobile/src/__tests__/screens/auth/LoginScreen.test.tsx
  - mobile/src/__tests__/screens/auth/RegisterScreen.test.tsx
  - mobile/src/__tests__/screens/chat/AgentChatScreen.test.tsx
  - mobile/src/__tests__/screens/chat/ConversationListScreen.test.tsx
  - mobile/src/__tests__/components/canvas/CanvasWebView.test.tsx
  - mobile/src/__tests__/components/offline/OfflineSyncService.test.ts
  - mobile/src/__tests__/services/agentService.test.ts
  - mobile/src/__tests__/contexts/AuthContext.test.tsx
  - mobile/src/__tests__/contexts/WebSocketContext.test.tsx
  - mobile/jest.setup.js
  - mobile/src/test-utils/testRender.tsx
  - mobile/src/test-utils/mockData.ts
**autonomous:** true

---

## Overview

Create comprehensive testing infrastructure for the mobile app including unit tests, integration tests, and E2E tests. Cover all major screens, components, and services with appropriate mocking and test utilities.

**Existing Assets:**
- Basic jest configuration
- Existing test for offline sync
- Test utilities structure

**To Be Created:**
- Comprehensive test suites for all screens
- Component testing with React Native Testing Library
- Service testing with mocked API calls
- Context testing with custom hooks
- E2E testing with Detox or Appium
- Test utilities and mocks

---

## Tasks

### Task 01: Create Test Utilities and Mocks

Build a comprehensive set of test utilities, mocks, and fixtures for consistent testing.

**Files:**
- `mobile/src/test-utils/testRender.tsx`
- `mobile/src/test-utils/mockData.ts`
- `mobile/src/test-utils/mockHandlers.ts`
- `mobile/src/test-utils/mockStorage.ts`
- `mobile/jest.setup.js`

**Requirements:**
- Custom render function with providers
- Mock navigation prop
- Mock WebSocket connection
- Mock AsyncStorage/MMKV
- Mock API handlers (MSW)
- Mock auth token
- Mock device info
- Mock location/camera/notifications
- Test fixtures (agents, canvases, workflows, episodes)
- Mock timers for async tests

**Acceptance Criteria:**
- [ ] Custom render wraps all providers
- [ ] Mock navigation works
- [ ] WebSocket mock emits events
- [ ] Storage mocks persist data
- [ ] API handlers intercept requests
- [ ] Auth tokens mock correctly
- [ ] Device info mocks return expected values
- [ ] Device capability mocks work
- [ ] Test fixtures cover all entities
- [ ] Mock timers work for async tests

---

### Task 02: Test Auth Screens

Create comprehensive tests for all authentication screens.

**Files:**
- `mobile/src/__tests__/screens/auth/LoginScreen.test.tsx`
- `mobile/src/__tests__/screens/auth/RegisterScreen.test.tsx`
- `mobile/src/__tests__/screens/auth/ForgotPasswordScreen.test.tsx`
- `mobile/src/__tests__/screens/auth/BiometricAuthScreen.test.tsx`

**Requirements:**
- LoginScreen tests:
  - Renders correctly
  - Form validation works
  - Login successful navigates to app
  - Login failed shows error
  - Biometric button shows when available
  - Loading state displays
- RegisterScreen tests:
  - Renders correctly
  - Password strength indicator works
  - Form validation prevents invalid submission
  - Registration successful auto-logins
  - Terms checkbox required
  - Error handling works
- ForgotPasswordScreen tests:
  - Renders correctly
  - Email validation works
  - Send button triggers API
  - Success state shows
  - Resend countdown works
- BiometricAuthScreen tests:
  - Renders correctly
  - Auto-triggers biometric
  - Success navigates to app
  - Fallback to password works
  - Max attempts enforced

**Acceptance Criteria:**
- [ ] All auth screen tests pass
- [ ] 20+ test cases for auth screens
- [ ] All user flows covered
- [ ] Error states tested
- [ ] Loading states tested
- [ ] Navigation tested

---

### Task 03: Test Chat Screens and Components

Create comprehensive tests for chat functionality.

**Files:**
- `mobile/src/__tests__/screens/chat/AgentChatScreen.test.tsx`
- `mobile/src/__tests__/screens/chat/ConversationListScreen.test.tsx`
- `mobile/src/__tests__/components/chat/StreamingText.test.tsx`
- `mobile/src/__tests__/components/chat/MessageList.test.tsx`
- `mobile/src/__tests__/components/chat/MessageInput.test.tsx`
- `mobile/src/__tests__/components/chat/TypingIndicator.test.tsx`

**Requirements:**
- AgentChatScreen tests:
  - Renders with agent
  - Messages display correctly
  - Streaming updates work
  - Send message triggers API
  - Typing indicator shows
  - Empty state displays
  - Error handling works
- ConversationListScreen tests:
  - Renders conversations
  - Search filters correctly
  - Sort options work
  - Swipe actions trigger
  - Pull-to-refresh updates
  - Navigation to chat works
- Component tests:
  - StreamingText animates correctly
  - MessageList groups messages
  - MessageInput handles attachments
  - TypingIndicator animates

**Acceptance Criteria:**
- [ ] All chat tests pass
- [ ] 30+ test cases for chat
- [ ] Streaming behavior tested
- [ ] Offline mode tested
- [ ] Message actions tested

---

### Task 04: Test Canvas Components

Create comprehensive tests for canvas rendering and interactions.

**Files:**
- `mobile/src/__tests__/components/canvas/CanvasWebView.test.tsx`
- `mobile/src/__tests__/components/canvas/CanvasChart.test.tsx`
- `mobile/src/__tests__/components/canvas/CanvasForm.test.tsx`
- `mobile/src/__tests__/components/canvas/CanvasSheet.test.tsx`
- `mobile/src/__tests__/screens/canvas/CanvasViewerScreen.test.tsx`

**Requirements:**
- CanvasWebView tests:
  - Renders WebView
  - Handles postMessage
  - Injects JavaScript
  - Handles loading states
  - Handles errors
  - Gesture handling
- CanvasChart tests:
  - Renders chart types
  - Touch events work
  - Pinch-to-zoom functions
  - Data displays correctly
- CanvasForm tests:
  - Form fields render
  - Validation works
  - Submission works
  - File upload handled
- CanvasSheet tests:
  - Table renders
  - Scroll works
  - Sorting works
  - Selection works
- CanvasViewerScreen tests:
  - Loads canvas
  - Displays metadata
  - Actions work
  - Offline mode works

**Acceptance Criteria:**
- [ ] All canvas tests pass
- [ ] 25+ test cases for canvas
- [ ] All canvas types tested
- [ ] Gesture interactions tested
- [ ] Offline mode tested

---

### Task 05: Test Device Services

Create comprehensive tests for device capabilities.

**Files:**
- `mobile/src/__tests__/services/cameraService.test.ts`
- `mobile/src/__tests__/services/locationService.test.ts`
- `mobile/src/__tests__/services/notificationService.test.ts`
- `mobile/src/__tests__/services/biometricService.test.ts`

**Requirements:**
- Camera service tests:
  - Permission requests
  - Photo capture
  - Barcode scanning
  - Gallery picker
  - Error handling
- Location service tests:
  - Permission requests
  - Location tracking
  - Geofencing
  - Distance calculations
  - Background tracking
- Notification service tests:
  - Token registration
  - Notification display
  - Scheduled notifications
  - Action handling
  - Badge updates
- Biometric service tests:
  - Availability check
  - Authentication
  - Fallback handling
  - Lockout enforcement

**Acceptance Criteria:**
- [ ] All device service tests pass
- [ ] 30+ test cases for services
- [ ] Permissions tested
- [ ] Error handling tested
- [ ] Mock device APIs work

---

### Task 06: Test Context Providers

Create comprehensive tests for React contexts.

**Files:**
- `mobile/src/__tests__/contexts/AuthContext.test.tsx`
- `mobile/src/__tests__/contexts/WebSocketContext.test.tsx`
- `mobile/src/__tests__/contexts/DeviceContext.test.tsx`

**Requirements:**
- AuthContext tests:
  - Login flow
  - Logout flow
  - Token refresh
  - Biometric auth
  - Token storage
  - Session persistence
- WebSocketContext tests:
  - Connection flow
  - Reconnection logic
  - Event emission
  - Room joining
  - Message handling
- DeviceContext tests:
  - Device registration
  - Permission requests
  - Capability checks
  - Device sync
  - Token updates

**Acceptance Criteria:**
- [ ] All context tests pass
- [ ] 25+ test cases for contexts
- [ ] Provider wrapping works
- [ ] Custom hooks work
- [ ] State updates propagate

---

### Task 07: Test Offline Sync

Expand existing offline sync tests for comprehensive coverage.

**File:** `mobile/src/__tests__/services/offlineSyncService.test.ts`

**Requirements:**
- Action queuing tests
- Sync trigger tests
- Conflict resolution tests
- Priority handling tests
- Batch processing tests
- Retry logic tests
- Storage quota tests
- Network state tests
- Entity-specific sync tests

**Acceptance Criteria:**
- [ ] All sync tests pass
- [ ] 20+ test cases for sync
- [ ] All entity types tested
- [ ] All conflict strategies tested
- [ ] Edge cases covered

---

### Task 08: Create E2E Test Suite

Create end-to-end tests for critical user journeys.

**Files:**
- `mobile/e2e/auth.e2e.ts`
- `mobile/e2e/chat.e2e.ts`
- `mobile/e2e/canvas.e2e.ts`
- `mobile/e2e/offline.e2e.ts`

**Requirements:**
- Auth flow E2E:
  - Register new user
  - Login with credentials
  - Logout
- Chat flow E2E:
  - Send message
  - Receive streaming response
  - View conversation history
- Canvas flow E2E:
  - View canvas
  - Submit form
  - View chart
- Offline flow E2E:
  - Go offline
  - Queue action
  - Go online
  - Sync action

**Acceptance Criteria:**
- [ ] All E2E tests pass
- [ ] 10+ E2E test cases
- [ ] Critical journeys covered
- [ ] Tests are reliable
- [ ] Tests complete in <10 minutes

---

## Verification Criteria

### Functional Verification
- [ ] **V-01:** All unit tests pass (>200 tests)
- [ ] **V-02:** All integration tests pass (>100 tests)
- [ ] **V-03:** All E2E tests pass (>10 tests)
- [ ] **V-04:** Test coverage >60% for mobile code
- [ ] **V-05:** No flaky tests (99% pass rate over 10 runs)
- [ ] **V-06:** Tests complete in reasonable time (<5 minutes unit, <10 minutes E2E)

### Quality Verification
- [ ] **V-07:** Tests follow AAA pattern (Arrange, Act, Assert)
- [ ] **V-08:** Tests have descriptive names
- [ ] **V-09:** Tests are independent (can run in any order)
- [ ] **V-10:** Tests mock external dependencies appropriately

---

## must_haves

### Goal-Backward Requirements (Phase 65 Success Criteria)
1. **Mobile testing** - Comprehensive test coverage for mobile app
2. **Quality assurance** - Tests prevent regressions

### Plan-Specific must_haves
1. **M-01:** Test utilities and mocks created
2. **M-02:** Auth screen tests (20+ tests)
3. **M-03:** Chat screen tests (30+ tests)
4. **M-04:** Canvas component tests (25+ tests)
5. **M-05:** Device service tests (30+ tests)
6. **M-06:** Context tests (25+ tests)
7. **M-07:** Offline sync tests (20+ tests)
8. **M-08:** E2E tests (10+ tests)

---

## Success Metrics

- Total unit tests: >200
- Total integration tests: >100
- Total E2E tests: >10
- Code coverage: >60%
- Test pass rate: >99%
- Test suite runtime: <5 minutes (unit), <10 minutes (E2E)

---

## Estimated Duration

**5-6 days** (8 tasks, ~4-6 hours each)

---

## Notes

- Use React Native Testing Library for component tests
- Use Detox or Appium for E2E tests
- Use MSW (Mock Service Worker) for API mocking
- Use jest-expo for React Native Jest presets
- Tests should run in CI/CD pipeline
- Consider using visual regression tests for UI components
- Mock all native modules (expo-camera, expo-location, etc.)
