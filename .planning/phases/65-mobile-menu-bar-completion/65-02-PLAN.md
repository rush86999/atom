# Plan 65-02: Mobile Chat Screen with WebSocket Streaming

---

**wave:** 1
**depends_on:** [65-01]
**files_modified:**
  - mobile/src/screens/chat/AgentChatScreen.tsx
  - mobile/src/screens/chat/ConversationListScreen.tsx
  - mobile/src/components/chat/StreamingText.tsx
  - mobile/src/components/chat/MessageList.tsx
  - mobile/src/components/chat/MessageInput.tsx
  - mobile/src/components/chat/TypingIndicator.tsx
  - mobile/src/contexts/WebSocketContext.tsx
  - mobile/src/services/chatService.ts
**autonomous:** true

---

## Overview

Enhance the mobile chat experience with real-time WebSocket streaming, improved message rendering, typing indicators, and robust offline handling. The current AgentChatScreen exists but needs UI polish, better streaming UX, and integration with the WebSocket context.

**Existing Assets:**
- AgentChatScreen with basic streaming support
- WebSocketContext with Socket.IO integration
- AgentService with chat API calls
- StreamingText and MessageList components

**To Be Enhanced:**
- Improved streaming UI with smooth token rendering
- Typing indicators for agent responses
- Message actions (copy, feedback, regenerate)
- Offline message queuing
- Better error handling and retry logic

---

## Tasks

### Task 01: Enhance Streaming Text Component

Improve the streaming text component for smooth token-by-token rendering with proper animations and markdown support.

**File:** `mobile/src/components/chat/StreamingText.tsx`

**Requirements:**
- Smooth token-by-token text animation (typewriter effect)
- Markdown rendering support (bold, italic, code blocks, lists)
- Syntax highlighting for code blocks
- Custom rendering for:
  - Agent governance badges
  - Canvas presentation cards
  - Workflow trigger cards
  - Form submission cards
- Truncate long messages with "Show more" option
- Copy button for code blocks
- Progress indicator during streaming
- Support for streaming completion

**Acceptance Criteria:**
- [ ] Tokens animate smoothly (no jitter)
- [ ] Markdown renders correctly
- [ ] Code blocks have syntax highlighting
- [ ] Governance badges display properly
- [ ] Cards render for canvas/workflow/form mentions
- [ ] Copy button works for code blocks
- [ ] "Show more" truncates long messages
- [ ] Streaming completion detected accurately

---

### Task 02: Enhance Message List Component

Improve the message list with better grouping, timestamps, and user experience.

**File:** `mobile/src/components/chat/MessageList.tsx`

**Requirements:**
- Group consecutive messages from same sender
- Show timestamp for first message in group
- Show avatars for agents (colored initials or icons)
- User messages aligned right, agent messages left
- Scroll to bottom button when new messages arrive
- Auto-scroll during streaming, manual scroll otherwise
- Message actions (long-press for menu):
  - Copy text
  - Submit feedback (thumbs up/down)
  - Regenerate response
  - Delete (user messages only)
- Empty state illustration
- Date separators for conversations spanning multiple days
- Read receipts for user messages

**Acceptance Criteria:**
- [ ] Messages grouped by sender
- [ ] Timestamps show on first message in group
- [ ] Avatars display for agents
- [ ] Message alignment correct (user right, agent left)
- [ ] Scroll-to-bottom button appears when scrolled up
- [ ] Auto-scroll works during streaming
- [ ] Long-press menu shows all actions
- [ ] Copy, feedback, regenerate, delete work correctly
- [ ] Empty state shows illustration and CTA
- [ ] Date separators display correctly

---

### Task 03: Create Enhanced Message Input Component

Build a polished message input with attachment support, voice input, and quick actions.

**File:** `mobile/src/components/chat/MessageInput.tsx`

**Requirements:**
- Multi-line text input with auto-grow
- Character counter (max 2000)
- Attachment button (camera, gallery, documents)
- Voice input button (hold to record)
- Quick action chips (recent agents, common commands)
- Send button (disabled when empty)
- Emoji picker button
- @mention support for agents
- Preview for attachments
- Cancel recording button (voice input)
- Input state persists during screen navigation
- Keyboard avoidance with proper insets

**Acceptance Criteria:**
- [ ] Input grows to 5 lines max
- [ ] Character counter shows
- [ ] Attachment button opens picker
- [ ] Voice input records and transcribes
- [ ] Quick chips display and work
- [ ] Send button enables/disables correctly
- [ ] Emoji picker opens and inserts emojis
- [ ] @mentions show agent suggestions
- [ ] Attachment previews display
- [ ] Recording can be cancelled
- [ ] Input state persists across navigation
- [ ] Keyboard doesn't hide input field

---

### Task 04: Create Typing Indicator Component

Build an animated typing indicator for agent responses.

**File:** `mobile/src/components/chat/TypingIndicator.tsx`

**Requirements:**
- Three-dot animation (bounce or fade)
- Agent name label ("Agent is typing...")
- Small avatar or icon
- Smooth entrance/exit animations
- Shown before first streaming token
- Hidden when streaming starts
- Multiple agents typing support

**Acceptance Criteria:**
- [ ] Three dots animate smoothly
- [ ] Agent name displays
- [ ] Avatar/icon shows
- [ ] Entrance/exit animations work
- [ ] Hidden when streaming begins
- [ ] Multiple agents can be shown

---

### Task 05: Create Chat Service

Implement a dedicated chat service for API calls and WebSocket management.

**File:** `mobile/src/services/chatService.ts`

**Requirements:**
- Send message (streaming and non-streaming)
- Get conversation history
- Get message feedback options
- Submit message feedback
- Regenerate agent response
- Delete message (user only)
- Search messages
- Get conversation list
- Mark messages as read
- Retry failed messages
- Queue messages for offline send

**Acceptance Criteria:**
- [ ] All API methods implemented
- [ ] Streaming messages work via WebSocket
- [ ] Non-streaming fallback works
- [ ] Feedback submission works
- [ ] Message deletion works
- [ ] Search returns relevant results
- [ ] Offline queuing works
- [ ] Failed messages can be retried

---

### Task 06: Enhance WebSocket Context

Add chat-specific methods and improve reconnection handling for seamless chat experience.

**File:** `mobile/src/contexts/WebSocketContext.tsx`

**Requirements:**
- Add `sendStreamingMessage` method with callback
- Add `subscribeToStream` method for message updates
- Add `subscribeToTyping` method for typing indicators
- Improve reconnection logic (preserve pending messages)
- Add connection quality indicator
- Heartbeat ping/pong for connection health
- Automatic message replay after reconnect
- Queue messages while disconnected
- Connection state persistence across app restarts

**Acceptance Criteria:**
- [ ] Streaming message method works
- [ ] Stream subscription receives all tokens
- [ ] Typing subscription receives indicators
- [ ] Reconnection preserves pending messages
- [ ] Connection quality indicator accurate
- [ ] Heartbeat maintains connection
- [ ] Messages replay after reconnect
- [ ] Disconnected messages queue for later send
- [ ] Connection state persists

---

### Task 07: Integrate Offline Sync with Chat

Combine the offline sync service with chat for seamless messaging even when offline.

**Files:**
- `mobile/src/services/chatService.ts`
- `mobile/src/services/offlineSyncService.ts`

**Requirements:**
- Queue chat messages when offline
- Show "Sending..." state for queued messages
- Show "Failed" state with retry option
- Sync messages when connection restored
- Conflict resolution for concurrent edits
- Offline indicator in chat UI
- Pending message count badge
- Optimistic UI updates

**Acceptance Criteria:**
- [ ] Messages queue when offline
- [ ] "Sending..." state shows
- [ ] Failed messages show retry button
- [ ] Sync triggers on reconnect
- [ ] Conflicts resolved (last-write-wins)
- [ ] Offline indicator displays
- [ ] Pending count badge accurate
- [ ] Optimistic updates render immediately

---

### Task 08: Create Conversation List Screen

Build the conversation list screen for the Chat tab.

**File:** `mobile/src/screens/chat/ConversationListScreen.tsx`

**Requirements:**
- List of all conversations with agents
- Search conversations
- Filter by agent maturity level
- Sort by recent or unread
- Swipe actions (archive, delete, mark read)
- Pull to refresh
- Infinite scroll
- Empty state
- Unread message badges
- Last message preview (truncated)
- Timestamp (relative: "2m ago", "1h ago")
- Agent avatar and name
- Long-press for multi-select

**Acceptance Criteria:**
- [ ] Conversations list displays
- [ ] Search filters conversations
- [ ] Filter by maturity works
- [ ] Sort options work
- [ ] Swipe actions function
- [ ] Pull to refresh updates
- [ ] Infinite scroll loads more
- [ ] Empty state shows
- [ ] Unread badges display
- [ ] Last message preview shows
- [ ] Relative timestamps accurate
- [ ] Agent avatars render
- [ ] Multi-select works

---

## Verification Criteria

### Functional Verification
- [ ] **V-01:** Streaming messages display token-by-token smoothly
- [ ] **V-02:** Typing indicators show before streaming starts
- [ ] **V-03:** Message actions (copy, feedback, regenerate) work
- [ ] **V-04:** Offline messages queue and send when online
- [ ] **V-05:** WebSocket reconnection preserves pending messages
- [ ] **V-06:** Conversation list displays all conversations
- [ ] **V-07:** Search and filter work on conversations
- [ ] **V-08:** Voice input records and transcribes

### UI/UX Verification
- [ ] **V-09:** Streaming animation is smooth (no flicker)
- [ ] **V-10:** Message grouping feels natural
- [ ] **V-11:** Auto-scroll works correctly during streaming
- [ ] **V-12:** Keyboard doesn't hide input field
- [ ] **V-13:** Attachment previews display correctly
- [ ] **V-14:** Empty states are helpful and actionable

### Performance Verification
- [ ] **V-15:** First token appears <1 second after send
- [ ] **V-16:** Streaming tokens update at 30-50ms intervals
- [ ] **V-17:** Conversation list scrolls smoothly (60fps)
- [ ] **V-18:** Message list handles 100+ messages without lag

---

## must_haves

### Goal-Backward Requirements (Phase 65 Success Criteria)
1. **Real-time WebSocket streaming** - Token-by-token streaming works smoothly
2. **Offline chat support** - Messages queue and sync when online
3. **Chat UX complete** - Typing indicators, message actions, search all work

### Plan-Specific must_haves
1. **M-01:** StreamingText component with smooth animation
2. **M-02:** MessageList with grouping and actions
3. **M-03:** MessageInput with attachments and voice
4. **M-04:** TypingIndicator component
5. **M-05:** ChatService with all API methods
6. **M-06:** Enhanced WebSocket context for chat
7. **M-07:** Offline sync integrated with chat
8. **M-08:** ConversationListScreen fully functional

---

## Success Metrics

- Streaming message first token latency: <1 second
- Streaming token update interval: 30-50ms
- WebSocket reconnection success rate: >95%
- Offline message delivery rate: >98% (when back online)
- Chat crash rate: <0.1%

---

## Estimated Duration

**4-5 days** (8 tasks, ~4-6 hours each)

---

## Notes

- WebSocketContext already has Socket.IO integration
- OfflineSyncService exists and just needs chat integration
- Consider adding push notifications for new agent messages
- Voice transcription can use expo-speech or device speech API
- Markdown rendering can use react-native-markdown-display
- Syntax highlighting can use react-native-syntax-highlighter
