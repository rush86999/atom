# Plan 65-04: Device Capabilities Integration

---

**wave:** 2
**depends_on:** [65-01]
**files_modified:**
  - mobile/src/services/cameraService.ts
  - mobile/src/services/locationService.ts
  - mobile/src/services/notificationService.ts
  - mobile/src/services/biometricService.ts
  - mobile/src/screens/device/CameraScreen.tsx
  - mobile/src/screens/device/LocationScreen.tsx
  - mobile/src/screens/device/NotificationPreferencesScreen.tsx
  - mobile/src/contexts/DeviceContext.tsx
**autonomous:** true

---

## Overview

Complete the mobile device capabilities integration with camera, location, notifications, and biometric features. The current DeviceContext exists with permission handling foundation, but the actual device services and screens need completion.

**Existing Assets:**
- DeviceContext with permission request framework
- Basic cameraService, locationService
- Biometric authentication in AuthContext

**To Be Completed:**
- Full camera service with document capture
- Location service with geofencing
- Notification service with rich notifications
- Biometric service for secure actions
- Device permission screens
- Device capability integration with agents

---

## Tasks

### Task 01: Complete Camera Service

Implement a full-featured camera service with document capture, barcode scanning, and image processing.

**File:** `mobile/src/services/cameraService.ts`

**Requirements:**
- Document capture with auto-edge detection
- Image cropping and rotation
- Barcode/QR code scanning
- Multiple photo capture
- Front/back camera switching
- Flash control (auto/on/off)
- Image compression
- EXIF data preservation
- Gallery picker integration
- Permission handling
- Camera availability check
- Error handling

**Acceptance Criteria:**
- [ ] Document capture detects edges
- [ ] Images can be cropped and rotated
- [ ] Barcode scanner reads common formats
- [ ] QR codes are parsed correctly
- [ ] Multiple photos can be captured
- [ ] Camera switching works
- [ ] Flash modes function
- [ ] Images compress appropriately
- [ ] EXIF data is preserved
- [ ] Gallery picker opens
- [ ] Permissions requested properly
- [ ] Errors handled gracefully

---

### Task 02: Complete Location Service

Implement a comprehensive location service with foreground/background tracking and geofencing.

**File:** `mobile/src/services/locationService.ts`

**Requirements:**
- Foreground location tracking
- Background location (with permission)
- Geofencing (enter/exit events)
- Location accuracy settings
- Distance calculations (Haversine)
- Location history storage
- Battery optimization awareness
- Permission dialogs
- Location settings deep link
- Mock location for testing
- Location updates throttling

**Acceptance Criteria:**
- [ ] Foreground location updates
- [ ] Background tracking works
- [ ] Geofencing triggers events
- [ ] Accuracy settings apply
- [ ] Distance calculated correctly
- [ ] History stored in AsyncStorage
- [ ] Battery optimization handled
- [ ] Permission dialogs show
- [ ] Settings deep link works
- [ ] Mock location works for testing
- [ ] Updates throttled appropriately

---

### Task 03: Create Notification Service

Implement a notification service with rich notifications, channels, and scheduling.

**File:** `mobile/src/services/notificationService.ts`

**Requirements:**
- Push notification registration
- Rich notifications (images, actions)
- Notification channels (Android)
- Scheduled notifications
- Notification categories (agent alerts, workflow updates, system)
- Notification badges
- Notification history
- Deep linking from notifications
- Notification preferences
- Notification sounds
- Notification groups
- Action buttons on notifications

**Acceptance Criteria:**
- [ ] Push token registered
- [ ] Rich notifications display
- [ ] Channels created (Android)
- [ ] Notifications can be scheduled
- [ ] Categories work correctly
- [ ] Badge count updates
- [ ] History stored
- [ ] Deep links navigate correctly
- [ ] Preferences apply
- [ ] Custom sounds play
- [ ] Notifications group appropriately
- [ ] Action buttons function

---

### Task 04: Create Biometric Service

Implement a standalone biometric service for secure action authentication.

**File:** `mobile/src/services/biometricService.ts`

**Requirements:**
- Biometric availability check
- Biometric authentication
- Biometric enrollment check
- Fallback to passcode
- Biometric preference storage
- Authentication attempts tracking
- Lockout after failures
- Biometric type detection (Face ID vs Touch ID)
- Prompt customization
- Error handling

**Acceptance Criteria:**
- [ ] Availability check returns correct status
- [ ] Authentication prompts for biometric
- [ ] Enrollment status detected
- [ ] Passcode fallback works
- [ ] Preferences persist
- [ ] Attempts tracked
- [ ] Lockout enforced after failures
- [ ] Face ID vs Touch ID detected
- [ ] Prompts customize correctly
- [ ] Errors handled appropriately

---

### Task 05: Create Camera Screen

Build a full-featured camera screen for document/photo capture.

**File:** `mobile/src/screens/device/CameraScreen.tsx`

**Requirements:**
- Live camera preview
- Capture button with animation
- Front/back camera toggle
- Flash control button
- Gallery thumbnail (last photo)
- Document mode with edge detection overlay
- Barcode/QR mode with scanning overlay
- Multi-capture review
- Retake/delete options
- Crop/edit before confirm
- Permission request overlay

**Acceptance Criteria:**
- [ ] Live preview displays
- [ ] Capture button triggers photo
- [ ] Camera toggle works
- [ ] Flash modes switch
- [ ] Gallery thumbnail shows
- [ ] Document mode overlay displays
- [ ] Barcode mode overlay displays
- [ ] Multi-capture review works
- [ ] Retake/delete options function
- [ ] Crop/edit screen opens
- [ ] Permission overlay shows

---

### Task 06: Create Location Screen

Build a location preferences and monitoring screen.

**File:** `mobile/src/screens/device/LocationScreen.tsx`

**Requirements:**
- Current location display
- Location on map
- Location history list
- Geofence management
- Location accuracy selector
- Background tracking toggle
- Location permissions status
- Battery usage indicator
- Clear history button
- Test location button (dev mode)

**Acceptance Criteria:**
- [ ] Current location shows
- [ ] Map displays location
- [ ] History list shows recent
- [ ] Geofences can be added/removed
- [ ] Accuracy selector works
- [ ] Background toggle functions
- [ ] Permission status displays
- [ ] Battery usage indicated
- [ ] Clear history works
- [ ] Test location works (dev)

---

### Task 07: Create Notification Preferences Screen

Build a notification preferences management screen.

**File:** `mobile/src/screens/device/NotificationPreferencesScreen.tsx`

**Requirements:**
- Enable/disable notifications toggle
- Category toggles (agent alerts, workflow updates, system)
- Sound selector
- Quiet hours (start/end time)
- Badge app icon toggle
- Preview notification button
- Notification history list
- Clear history button
- Permission status display
- Settings deep link

**Acceptance Criteria:**
- [ ] Master toggle works
- [ ] Category toggles function
- [ ] Sound selector works
- [ ] Quiet hours set correctly
- [ ] Badge toggle functions
- [ ] Preview sends test notification
- [ ] History list displays
- [ ] Clear history works
- [ ] Permission status shows
- [ ] Settings link opens system settings

---

### Task 08: Integrate Device Capabilities with Agents

Enable agents to request and use device capabilities through a governance-controlled API.

**Files:**
- `mobile/src/services/agentDeviceBridge.ts`
- `mobile/src/contexts/DeviceContext.tsx`

**Requirements:**
- Agent device request API
- Governance check before permission grant
- User approval prompt for sensitive actions
- Capability result return to agent
- Audit logging for device usage
- Capability timeout handling
- Error handling for denials
- Device capability discovery API

**Acceptance Criteria:**
- [ ] Agents can request capabilities
- [ ] Governance checks enforced
- [ ] User approval prompts show
- [ ] Results returned to agent
- [ ] Usage logged in audit trail
- [ ] Timeouts handled correctly
- [ ] Denials reported to agent
- [ ] Discovery API returns available capabilities

---

## Verification Criteria

### Functional Verification
- [ ] **V-01:** Camera captures documents and photos
- [ ] **V-02:** Barcode/QR scanner reads codes
- [ ] **V-03:** Location tracking works in foreground and background
- [ ] **V-04:** Geofencing triggers enter/exit events
- [ ] **V-05:** Push notifications arrive and display
- [ ] **V-06:** Rich notifications with images/actions work
- [ ] **V-07:** Biometric authentication works for secure actions
- [ ] **V-08:** Agents can request device capabilities with governance

### UI/UX Verification
- [ ] **V-09:** Permission requests are clear and actionable
- [ ] **V-10:** Camera controls are intuitive
- [ ] **V-11:** Location map is readable and accurate
- [ ] **V-12:** Notification preferences are easy to configure
- [ ] **V-13:** Biometric prompts feel native
- [ ] **V-14:** Error states guide users to resolution

### Security Verification
- [ ] **V-15:** Camera permissions required before access
- [ ] **V-16:** Location permissions required with explanation
- [ ] **V-17:** Biometric fallback requires passcode
- [ ] **V-18:** Agent device requests require user approval for sensitive actions
- [ ] **V-19:** All device usage is logged for audit

---

## must_haves

### Goal-Backward Requirements (Phase 65 Success Criteria)
1. **Device capabilities integrated** - Camera, location, notifications work
2. **Biometric authentication** - Secure actions require biometric
3. **Agent device access** - Agents can use capabilities with governance

### Plan-Specific must_haves
1. **M-01:** Camera service with document capture and barcode scanning
2. **M-02:** Location service with tracking and geofencing
3. **M-03:** Notification service with rich notifications
4. **M-04:** Biometric service for secure actions
5. **M-05:** Camera screen with all controls
6. **M-06:** Location screen with map and history
7. **M-07:** Notification preferences screen
8. **M-08:** Agent device bridge with governance

---

## Success Metrics

- Camera capture success rate: >95%
- Barcode scan accuracy: >98%
- Location accuracy (foreground): <10 meters
- Location accuracy (background): <100 meters
- Push notification delivery rate: >98%
- Biometric authentication success rate: >90%
- Agent device request approval rate: >80%

---

## Estimated Duration

**4-5 days** (8 tasks, ~4-6 hours each)

---

## Notes

- Use expo-camera for camera functionality
- Use expo-location for location services
- Use expo-notifications for push notifications
- Use expo-local-authentication for biometrics
- Consider using react-native-maps for location display
- Barcode scanning can use expo-camera with barcode detection
- Document edge detection can use OpenCV or ML Kit
- Background location requires special permissions and setup
