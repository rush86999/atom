# Plan 65-03: Canvas Mobile Rendering with WebView

---

**wave:** 1
**depends_on:** [65-01]
**files_modified:**
  - mobile/src/components/canvas/CanvasWebView.tsx
  - mobile/src/components/canvas/CanvasChart.tsx
  - mobile/src/components/canvas/CanvasForm.tsx
  - mobile/src/components/canvas/CanvasSheet.tsx
  - mobile/src/screens/canvas/CanvasViewerScreen.tsx
  - mobile/src/services/canvasService.ts
  - mobile/src/types/canvas.ts
**autonomous:** true

---

## Overview

Complete the mobile canvas rendering system with WebView-based canvas presentation, touch interactions, and responsive design. The current CanvasWebView component exists as a foundation but needs enhancements for all canvas types and better mobile UX.

**Existing Assets:**
- CanvasWebView component with basic WebView setup
- Canvas types defined
- Basic canvas service

**To Be Enhanced:**
- Support for all 7 canvas types (generic, docs, email, sheets, orchestration, terminal, coding)
- Touch-friendly interactions
- Responsive canvas layouts
- Pinch-to-zoom for charts
- Form input handling on mobile
- Offline canvas caching

---

## Tasks

### Task 01: Enhance Canvas WebView Bridge

Improve the JavaScript bridge for bidirectional communication between React Native and WebView canvases.

**File:** `mobile/src/components/canvas/CanvasWebView.tsx`

**Requirements:**
- Enhanced postMessage API for canvas → RN communication
- Injected JavaScript for RN → canvas commands
- Canvas state API exposure (getState, setState, subscribe)
- Touch event handling (tap, long-press, pinch)
- Gesture event forwarding
- Error boundary for WebView crashes
- Loading skeleton with animation
- Refresh on pull-to-refresh
- Canvas health check (ping/pong)
- Canvas resize observer

**Acceptance Criteria:**
- [ ] postMessage works bidirectionally
- [ ] getState API returns canvas state
- [ ] setState API updates canvas state
- [ ] subscribe API receives state updates
- [ ] Touch events forward correctly
- [ ] Long-press triggers context menu
- [ ] Pinch-to-zoom works on charts
- [ ] Error boundary catches WebView crashes
- [ ] Pull-to-refresh refreshes canvas
- [ ] Health check detects unresponsive canvases

---

### Task 02: Create Canvas Chart Component

Build a mobile-optimized chart component using WebView with touch interactions.

**File:** `mobile/src/components/canvas/CanvasChart.tsx`

**Requirements:**
- Support for line, bar, pie charts
- Touch-friendly data point tooltips
- Pinch-to-zoom for detailed viewing
- Pan gestures for large datasets
- Legend toggle
- Data export button (CSV)
- Portrait and landscape layouts
- Responsive chart sizing
- Loading skeleton
- Empty state for no data
- Error state for failed loads

**Acceptance Criteria:**
- [ ] Line charts render correctly
- [ ] Bar charts render correctly
- [ ] Pie charts render correctly
- [ ] Tap shows data point tooltip
- [ ] Pinch-to-zoom works
- [ ] Pan gestures work
- [ ] Legend toggles visibility
- [ ] Export downloads CSV
- [ ] Portrait/landscape layouts adapt
- [ ] Responsive sizing works
- [ ] Loading state shows
- [ ] Empty state displays
- [ ] Error state handles failures

---

### Task 03: Create Canvas Form Component

Build a mobile-optimized form component for canvas presentations with native form controls.

**File:** `mobile/src/components/canvas/CanvasForm.tsx`

**Requirements:**
- Native form inputs (not WebView) for better UX
- Support for text, number, email, phone inputs
- Dropdown/picker selects
- Date/time pickers
- Toggle switches
- Multi-select checkboxes
- File uploads (camera, gallery)
- Form validation
- Submit button with loading state
- Field-level error messages
- Auto-save draft
- Form progress indicator

**Acceptance Criteria:**
- [ ] All input types render correctly
- [ ] Text/number/email/phone inputs work
- [ ] Dropdown selects work
- [ ] Date/time pickers show native UI
- [ ] Toggle switches function
- [ ] Multi-select checkboxes work
- [ ] File upload opens picker
- [ ] Validation shows errors
- [ ] Submit button shows loading
- [ ] Field errors display
- [ ] Draft saves automatically
- [ ] Progress indicator shows

---

### Task 04: Create Canvas Sheet Component

Build a data sheet component for tabular canvas presentations with mobile-optimized viewing.

**File:** `mobile/src/components/canvas/CanvasSheet.tsx`

**Requirements:**
- Horizontal scroll for wide tables
- Sticky header row
- Column freezing (first column)
- Row selection (single/multi)
- Sort on column header tap
- Filter button with modal
- Search functionality
- Export to CSV
- Cell tap for details
- Pull-to-refresh
- Infinite scroll for large datasets
- Empty/loading/error states

**Acceptance Criteria:**
- [ ] Horizontal scroll works smoothly
- [ ] Header row sticks while scrolling
- [ ] First column freezes
- [ ] Row selection works (single and multi)
- [ ] Column sorting functions
- [ ] Filter modal opens and applies
- [ ] Search filters rows
- [ ] Export downloads CSV
- [ ] Cell tap shows details
- [ ] Pull-to-refresh updates
- [ ] Infinite scroll loads more
- [ ] All states display correctly

---

### Task 05: Create Canvas Terminal Component

Build a terminal emulator component for coding/orchestration canvas types.

**File:** `mobile/src/components/canvas/CanvasTerminal.tsx`

**Requirements:**
- Monospace font with correct sizing
- Read-only terminal output
- Auto-scroll on new output
- Copy all button
- ANSI color support
- Command history (for input terminals)
- Keyboard for input (optional)
- Wrap/unwrap text toggle
- Font size controls
- Dark theme terminal
- Output buffering for performance

**Acceptance Criteria:**
- [ ] Monospace font renders
- [ ] Read-only output displays
- [ ] Auto-scroll works on new output
- [ ] Copy all button works
- [ ] ANSI colors render correctly
- [ ] Command history shows
- [ ] Keyboard input works (if enabled)
- [ ] Text wrap toggle works
- [ ] Font size controls adjust
- [ ] Dark theme applies

---

### Task 06: Enhance Canvas Viewer Screen

Complete the canvas viewer screen with header actions, sharing, and offline support.

**File:** `mobile/src/screens/canvas/CanvasViewerScreen.tsx`

**Requirements:**
- Canvas title and agent name header
- Governance badge display
- Full-screen button
- Share button
- Refresh button
- Canvas type indicator
- Loading skeleton
- Error state with retry
- Offline indicator
- Cached canvas loading
- Canvas metadata display (created, updated, etc.)
- Related canvases navigation
- Feedback button (thumbs up/down)

**Acceptance Criteria:**
- [ ] Header shows title and agent
- [ ] Governance badge displays
- [ ] Full-screen button toggles
- [ ] Share opens native share sheet
- [ ] Refresh reloads canvas
- [ ] Canvas type indicator shows
- [ ] Loading skeleton displays
- [ ] Error state allows retry
- [ ] Offline indicator shows
- [ ] Cached canvas loads offline
- [ ] Metadata displays
- [ ] Related canvases navigate
- [ ] Feedback buttons work

---

### Task 07: Implement Canvas Offline Caching

Add offline caching for canvases to enable viewing without network.

**Files:**
- `mobile/src/services/canvasService.ts`
- `mobile/src/services/storageService.ts`

**Requirements:**
- Cache canvas HTML and data on load
- Cache expiration (24 hours)
- Cache invalidation on refresh
- Offline detection for cached canvases
- Storage quota management (LRU eviction)
- Cache stats (size, count)
- Clear cache button
- Background cache refresh
- Progressive loading (cached first, live update)

**Acceptance Criteria:**
- [ ] Canvas caches on load
- [ ] Cache expires after 24 hours
- [ ] Refresh invalidates cache
- [ ] Offline displays cached version
- [ ] Storage quota enforced
- [ ] LRU eviction works
- [ ] Cache stats accurate
- [ ] Clear cache button works
- [ ] Background refresh updates cache
- [ ] Progressive loading shows cached then live

---

### Task 08: Add Canvas Touch Gesture System

Implement a comprehensive touch gesture system for canvas interactions.

**File:** `mobile/src/components/canvas/CanvasGestures.tsx`

**Requirements:**
- Tap (select, activate)
- Double-tap (zoom, fullscreen)
- Long-press (context menu, details)
- Pinch-to-zoom (charts, images)
- Pan (large canvases)
- Swipe (next/previous, dismiss)
- Two-finger tap (reset zoom)
- Three-finger swipe (back)
- Haptic feedback on gestures
- Gesture conflict resolution
- Accessibility gesture alternatives

**Acceptance Criteria:**
- [ ] Tap gesture works
- [ ] Double-tap zooms
- [ ] Long-press shows menu
- [ ] Pinch-to-zoom functions
- [ ] Pan gestures work
- [ ] Swipe navigates
- [ ] Two-finger tap resets
- [ ] Three-finger swipe goes back
- [ ] Haptic feedback triggers
- [ ] Conflicts resolve correctly
- [ ] Accessibility alternatives exist

---

## Verification Criteria

### Functional Verification
- [ ] **V-01:** All 7 canvas types render correctly
- [ ] **V-02:** Touch interactions work for all gesture types
- [ ] **V-03:** Forms submit successfully
- [ ] **V-04:** Charts display with tooltips
- [ ] **V-05:** Sheets scroll and sort correctly
- [ ] **V-06:** Terminal output displays properly
- [ ] **V-07:** Offline canvases load from cache
- [ ] **V-08:** WebView bridge communication works bidirectionally

### UI/UX Verification
- [ ] **V-09:** Canvases are responsive (portrait/landscape)
- [ ] **V-10:** Loading states show appropriate skeletons
- [ ] **V-11:** Error states are recoverable
- [ ] **V-12:** Pinch-to-zoom is smooth (60fps)
- [ ] **V-13:** Native form inputs feel better than WebView
- [ ] **V-14:** Haptic feedback provides good feedback

### Performance Verification
- [ ] **V-15:** Canvas initial load <2 seconds
- [ ] **V-16:** Canvas interactions <100ms latency
- [ ] **V-17:** Cached canvas load <500ms
- [ ] **V-18:** WebView memory <50MB per canvas

---

## must_haves

### Goal-Backward Requirements (Phase 65 Success Criteria)
1. **Canvas presentations render on mobile** - All 7 canvas types work
2. **Touch interactions functional** - Tap, pinch, pan gestures work
3. **Offline canvas viewing** - Cached canvases load without network

### Plan-Specific must_haves
1. **M-01:** Enhanced CanvasWebView with gesture support
2. **M-02:** CanvasChart for line/bar/pie charts
3. **M-03:** CanvasForm with native inputs
4. **M-04:** CanvasSheet for tabular data
5. **M-05:** CanvasViewerScreen complete
6. **M-06:** Offline caching implemented
7. **M-07:** Touch gesture system working
8. **M-08:** All canvas types render correctly

---

## Success Metrics

- Canvas load time: <2 seconds
- Canvas interaction latency: <100ms
- Cached canvas load: <500ms
- Touch gesture accuracy: >98%
- Canvas crash rate: <0.5%

---

## Estimated Duration

**4-5 days** (8 tasks, ~4-6 hours each)

---

## Notes

- Use react-native-webview for WebView
- Consider using react-native-gesture-handler for gestures
- Native form inputs provide better UX than WebView forms
- Cache using AsyncStorage for HTML, MMKV for data
- Consider adding canvas sharing (export as image/PDF)
- WebView debugging enabled in dev mode only
