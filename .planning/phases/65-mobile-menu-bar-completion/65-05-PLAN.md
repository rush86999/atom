# Plan 65-05: Offline Mode & Data Sync

---

**wave:** 2
**depends_on:** [65-01, 65-02]
**files_modified:**
  - mobile/src/services/offlineSyncService.ts
  - mobile/src/services/storageService.ts
  - mobile/src/components/offline/OfflineIndicator.tsx
  - mobile/src/components/offline/SyncProgressModal.tsx
  - mobile/src/components/offline/PendingActionsList.tsx
  - mobile/src/services/agentSyncService.ts
  - mobile/src/services/workflowSyncService.ts
  - mobile/src/services/canvasSyncService.ts
**autonomous:** true

---

## Overview

Complete the offline mode and data sync system for the mobile app. The current offlineSyncService exists with queuing and basic sync, but needs enhanced conflict resolution, comprehensive entity syncing, and better UI feedback.

**Existing Assets:**
- offlineSyncService with action queuing and basic sync
- storageService with MMKV integration
- AsyncStorage for persistence
- NetInfo for network detection

**To Be Enhanced:**
- Comprehensive entity sync (agents, workflows, canvases, episodes)
- Advanced conflict resolution (manual, server-wins, merge)
- Sync progress UI with detailed feedback
- Offline data management
- Sync quality metrics

---

## Tasks

### Task 01: Enhance Offline Sync Service

Add comprehensive entity syncing and improved conflict resolution.

**File:** `mobile/src/services/offlineSyncService.ts`

**Requirements:**
- Sync priority levels (critical, high, normal, low)
- Entity-based sync (agents, workflows, canvases, episodes)
- Batch sync operations
- Delta sync (only changed data)
- Conflict resolution strategies:
  - Last-write-wins
  - Server-wins
  - Client-wins
  - Manual resolution
  - Merge (for compatible changes)
- Sync retry with exponential backoff
- Sync cancellation
- Sync progress reporting
- Sync quality metrics
- Storage quota management

**Acceptance Criteria:**
- [ ] Priority levels applied correctly
- [ ] All entity types sync
- [ ] Batch operations work
- [ ] Delta sync reduces data transfer
- [ ] All conflict strategies function
- [ ] Retry backoff increases appropriately
- [ ] Sync can be cancelled
- [ ] Progress reports are accurate
- [ ] Quality metrics tracked
- [ ] Storage quota enforced

---

### Task 02: Create Agent Sync Service

Implement specific sync logic for agents and agent configurations.

**File:** `mobile/src/services/agentSyncService.ts`

**Requirements:**
- Sync agent list and configurations
- Sync agent maturity levels
- Sync agent capabilities
- Cache agent prompts
- Sync agent execution history
- Offline agent execution queue
- Agent conflict resolution (config changes)
- Agent sync health check
- Background agent refresh
- Agent favorites sync

**Acceptance Criteria:**
- [ ] Agent list syncs
- [ ] Agent configurations sync
- [ ] Maturity levels update
- [ ] Capabilities sync correctly
- [ ] Prompts cached locally
- [ ] Execution history syncs
- [ ] Offline execution queues
- [ ] Config conflicts resolved
- [ ] Health check passes
- [ ] Background refresh works
- [ ] Favorites sync across devices

---

### Task 03: Create Workflow Sync Service

Implement specific sync logic for workflows and executions.

**File:** `mobile/src/services/workflowSyncService.ts`

**Requirements:**
- Sync workflow definitions
- Sync workflow executions
- Sync execution logs
- Cache workflow schemas
- Offline workflow trigger queue
- Workflow execution status sync
- Workflow conflict resolution
- Workflow execution replay
- Background workflow monitoring
- Workflow metrics sync

**Acceptance Criteria:**
- [ ] Workflow definitions sync
- [ ] Executions sync correctly
- [ ] Logs transfer completely
- [ ] Schemas cached locally
- [ ] Offline triggers queue
- [ ] Execution status updates
- [ ] Conflicts resolved appropriately
- [ ] Execution replay works
- [ ] Background monitoring functions
- [ ] Metrics sync across devices

---

### Task 04: Create Canvas Sync Service

Implement specific sync logic for canvases and canvas data.

**File:** `mobile/src/services/canvasSyncService.ts`

**Requirements:**
- Sync canvas definitions
- Sync canvas data (charts, sheets, forms)
- Cache canvas HTML/CSS
- Offline canvas viewing
- Canvas form submission queue
- Canvas data conflict resolution
- Canvas cache invalidation
- Canvas metadata sync
- Background canvas refresh
- Canvas favorites sync

**Acceptance Criteria:**
- [ ] Canvas definitions sync
- [ ] Canvas data syncs correctly
- [ ] HTML/CSS cached locally
- [ ] Offline viewing works
- [ ] Form submissions queue
- [ ] Data conflicts resolved
- [ ] Cache invalidates on changes
- [ ] Metadata syncs completely
- [ ] Background refresh works
- [ ] Favorites sync across devices

---

### Task 05: Create Offline Indicator Component

Build a prominent offline indicator with sync status and action buttons.

**File:** `mobile/src/components/offline/OfflineIndicator.tsx`

**Requirements:**
- Top banner indicator when offline
- Connection status (connected, connecting, disconnected)
- Pending actions count
- "Sync Now" button when online
- Last successful sync time
- Animated icon for connecting state
- Dismissible banner
- Sync progress bar during sync
- Error state with retry
- Tap to view pending actions

**Acceptance Criteria:**
- [ ] Banner shows when offline
- [ ] Connection status displays
- [ ] Pending count accurate
- [ ] Sync button works when online
- [ ] Last sync time shows
- [ ] Animations smooth
- [ ] Banner can be dismissed
- [ ] Progress bar updates
- [ ] Error state allows retry
- [ ] Tap opens pending list

---

### Task 06: Create Sync Progress Modal

Build a detailed sync progress modal for comprehensive sync feedback.

**File:** `mobile/src/components/offline/SyncProgressModal.tsx`

**Requirements:**
- Modal triggered during sync
- Overall progress percentage
- Entity-by-entity progress
- Current sync operation display
- Estimated time remaining
- Sync speed indicator
- Cancel sync button
- Background sync option
- Sync log (verbose mode)
- Sync summary on completion
- Error details for failed items

**Acceptance Criteria:**
- [ ] Modal opens on sync
- [ ] Overall percentage accurate
- [ ] Entity progress shows
- [ ] Current operation displays
- [ ] Time remaining estimated
- [ ] Speed indicator works
- [ ] Cancel stops sync cleanly
- [ ] Background option available
- [ ] Verbose log toggles
- [ ] Summary shows on complete
- [ ] Errors display details

---

### Task 07: Create Pending Actions List

Build a list component showing all pending offline actions with management options.

**File:** `mobile/src/components/offline/PendingActionsList.tsx`

**Requirements:**
- List of all pending actions
- Action type icons
- Timestamp display
- Retry failed actions
- Delete pending actions
- Prioritize actions
- Select multiple actions
- Batch operations (retry, delete)
- Sort by type, time, priority
- Filter by status
- Empty state
- Pull-to-refresh

**Acceptance Criteria:**
- [ ] All pending actions listed
- [ ] Icons match action types
- [ ] Timestamps show correctly
- [ ] Retry works for failed
- [ ] Delete removes actions
- [ ] Priority changes apply
- [ ] Multi-select works
- [ ] Batch operations function
- [ ] Sort options work
- [ ] Filters apply correctly
- [ ] Empty state displays
- [ ] Pull-to-refresh updates

---

### Task 08: Implement Storage Quota Management

Add storage quota management to prevent offline data from filling device storage.

**Files:**
- `mobile/src/services/storageService.ts`
- `mobile/src/services/offlineSyncService.ts`

**Requirements:**
- Storage usage tracking
- Quota warning at 80%
- Quota enforcement at 95%
- LRU eviction strategy
- Clear all cached data button
- Storage breakdown by entity type
- Automatic cleanup of old data
- Compress large cached items
- Storage quality metrics

**Acceptance Criteria:**
- [ ] Usage tracked accurately
- [ ] Warning shows at 80%
- [ ] Enforcement triggers at 95%
- [ ] LRU eviction works
- [ ] Clear all button functions
- [ ] Breakdown shows by type
- [ ] Old data auto-cleans
- [ ] Large items compress
- [ ] Quality metrics collected

---

## Verification Criteria

### Functional Verification
- [ ] **V-01:** Offline mode activates when network unavailable
- [ ] **V-02:** All entity types sync correctly when back online
- [ ] **V-03:** Conflict resolution strategies work as expected
- [ ] **V-04:** Sync progress updates accurately
- [ ] **V-05:** Pending actions can be managed
- [ ] **V-06:** Storage quota enforced without data loss
- [ ] **V-07:** Background sync runs periodically
- [ ] **V-08:** Delta sync reduces data transfer

### UI/UX Verification
- [ ] **V-09:** Offline indicator is prominent but not intrusive
- [ ] **V-10:** Sync progress provides clear feedback
- [ ] **V-11:** Pending actions list is manageable
- [ ] **V-12:** Storage warnings are actionable
- [ ] **V-13:** Conflicts are presented clearly for manual resolution
- [ ] **V-14:** Sync can be cancelled without corruption

### Performance Verification
- [ ] **V-15:** Initial sync completes <30 seconds
- [ ] **V-16:** Delta sync completes <5 seconds
- [ ] **V-17:** Offline queue holds 1000+ actions
- [ ] **V-18:** Storage overhead <50MB for typical usage

---

## must_haves

### Goal-Backward Requirements (Phase 65 Success Criteria)
1. **Offline mode functional** - App works without network
2. **AsyncStorage sync** - Local data syncs when online
3. **Conflict resolution** - Sync conflicts handled gracefully

### Plan-Specific must_haves
1. **M-01:** Enhanced offline sync service with all entity types
2. **M-02:** Agent sync service complete
3. **M-03:** Workflow sync service complete
4. **M-04:** Canvas sync service complete
5. **M-05:** Offline indicator component
6. **M-06:** Sync progress modal
7. **M-07:** Pending actions list
8. **M-08:** Storage quota management

---

## Success Metrics

- Offline mode activation: <1 second after network loss
- Sync success rate: >98%
- Conflict rate: <5% of sync operations
- Manual conflict resolution: <1% of conflicts
- Storage overhead: <50MB typical, <100MB max
- Sync bandwidth: <10MB/day typical user

---

## Estimated Duration

**4-5 days** (8 tasks, ~4-6 hours each)

---

## Notes

- MMKV provides better performance than AsyncStorage for large data
- Use indexeddb-style patterns for entity queries
- Consider using WatermelonDB for complex offline queries
- Sync quality metrics help identify problematic entities
- LRU eviction should preserve user favorites
- Compress images before caching
- Background sync should respect battery optimization
