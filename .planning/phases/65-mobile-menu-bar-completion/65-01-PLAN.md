# Plan 65-01: Mobile Navigation & Auth Screen Enhancement

---

**wave:** 1
**depends_on:** []
**files_modified:**
  - mobile/src/navigation/AppNavigator.tsx
  - mobile/src/screens/auth/LoginScreen.tsx
  - mobile/src/screens/auth/RegisterScreen.tsx
  - mobile/src/screens/auth/BiometricAuthScreen.tsx
  - mobile/src/screens/auth/ForgotPasswordScreen.tsx
  - mobile/src/navigation/types.ts
  - mobile/src/navigation/AuthNavigator.tsx
  - mobile/app.config.js
**autonomous:** true

---

## Overview

Complete the mobile authentication flow with proper navigation structure, login/register screens, biometric authentication, and seamless transition to authenticated app experience. The current app has AuthContext implemented but lacks the actual auth UI screens and proper navigation flow.

**Existing Assets:**
- AuthContext with login/logout, biometric support, token management
- DeviceContext with permission handling
- Basic navigation structure with bottom tabs

**To Be Created:**
- Complete auth screen suite (Login, Register, Forgot Password, Biometric)
- Auth navigation stack with proper flow
- Transition between authenticated and unauthenticated states

---

## Tasks

### Task 01: Create Auth Navigation Stack

Create a dedicated auth navigator that handles the authentication flow and conditionally renders auth screens or main app based on authentication state.

**File:** `mobile/src/navigation/AuthNavigator.tsx`

**Requirements:**
- Create NativeStack for auth flow (Login → Register → Forgot Password)
- Implement conditional rendering based on AuthContext state
- Add screen transition animations (slide from right)
- Handle auth state changes with proper navigation
- Add loading state during token validation
- Support deep linking to auth screens (atom://auth/login)

**Acceptance Criteria:**
- [ ] AuthNavigator created with 4 screens (Login, Register, ForgotPassword, Biometric)
- [ ] Conditional rendering works (unauthenticated → auth flow, authenticated → main app)
- [ ] Loading state shown during auth check
- [ ] Deep links navigate to correct auth screens
- [ ] Token refresh on app start works seamlessly

---

### Task 02: Create Login Screen

Build a polished login screen with email/password authentication, biometric quick login, and proper error handling.

**File:** `mobile/src/screens/auth/LoginScreen.tsx`

**Requirements:**
- Email and password input fields with validation
- Secure password entry with visibility toggle
- "Remember me" checkbox with AsyncStorage persistence
- "Forgot password" link navigation
- "Don't have an account? Sign up" link
- Biometric quick login button (Face ID/Touch ID) when available
- Show/hide password toggle
- Form validation (email format, password length)
- Loading state during authentication
- Error display with user-friendly messages
- Success animation on login
- Auto-focus email field on mount

**Acceptance Criteria:**
- [ ] Login form with all required fields
- [ ] Email validation (valid email format)
- [ ] Password validation (min 8 characters)
- [ ] Biometric login button shown when available
- [ ] Loading indicator shown during authentication
- [ ] Error messages displayed inline
- [ ] Successful login navigates to main app
- [ ] Failed login shows appropriate error (invalid credentials, network error, etc.)

---

### Task 03: Create Registration Screen

Build a registration flow with email validation, password strength indicator, and terms acceptance.

**File:** `mobile/src/screens/auth/RegisterScreen.tsx`

**Requirements:**
- Full name, email, password, confirm password fields
- Real-time password strength indicator (weak/medium/strong)
- Email format validation
- Password matching validation
- Terms of service checkbox (required)
- Privacy policy link (opens in-app browser)
- "Already have an account? Sign in" link
- Loading state during registration
- Error handling (email already exists, weak password, etc.)
- Success confirmation with auto-login

**Acceptance Criteria:**
- [ ] Registration form with all fields
- [ ] Password strength indicator updates in real-time
- [ ] Terms checkbox required to enable submit
- [ ] Email validation prevents invalid formats
- [ ] Password mismatch shows error
- [ ] Registration API call succeeds
- [ ] Successful registration auto-logins user
- [ ] Errors displayed appropriately

---

### Task 04: Create Forgot Password Screen

Implement password reset flow with email input and confirmation screen.

**File:** `mobile/src/screens/auth/ForgotPasswordScreen.tsx`

**Requirements:**
- Email input field with validation
- "Send reset link" button
- Loading state during request
- Success confirmation with instructions
- "Back to login" link
- Resend link available after 60 seconds
- Error handling (email not found, rate limiting, etc.)

**Acceptance Criteria:**
- [ ] Email input with validation
- [ ] Send button triggers API call
- [ ] Success screen shows after email sent
- [ ] Back to login navigation works
- [ ] Resend countdown works (60 seconds)
- [ ] Error handling for various failure modes

---

### Task 05: Create Biometric Auth Screen

Create a dedicated biometric authentication screen for quick secure access.

**File:** `mobile/src/screens/auth/BiometricAuthScreen.tsx`

**Requirements:**
- Biometric icon (Face ID/Touch ID based on device)
- "Authenticate to access Atom" prompt
- Fallback to password login link
- Auto-trigger biometric on mount
- Success/failure animation
- Support for both Face ID and Touch ID
- Handle biometric not available/enrolled
- Max 3 attempts before requiring password

**Acceptance Criteria:**
- [ ] Biometric prompt shows on screen load
- [ ] Successful biometric navigates to main app
- [ ] Failed biometric shows error and retry option
- [ ] "Use password" fallback works
- [ ] Max attempts limit enforced
- [ ] Proper icons for Face ID vs Touch ID

---

### Task 06: Update Main AppNavigator

Integrate AuthNavigator with the existing main app navigation for seamless authentication flow.

**File:** `mobile/src/navigation/AppNavigator.tsx`

**Requirements:**
- Wrap existing TabNavigator with AuthNavigator
- Preserve existing tab structure (Workflows, Analytics, Agents, Settings)
- Add Agents tab (currently missing)
- Add navigation to AgentChatScreen from agent list
- Update navigation types to include auth screens
- Handle logout by returning to auth flow
- Add Chat tab for quick agent access

**Acceptance Criteria:**
- [ ] AuthNavigator wraps main navigation
- [ ] Unauthenticated users see auth screens
- [ ] Authenticated users see main tabs
- [ ] Logout returns to login screen
- [ ] New Agents tab added to navigation
- [ ] Navigation types updated
- [ ] Deep links work for auth and main screens

---

### Task 07: Add Chat Tab and Agent Navigation

Create a dedicated Chat tab in the main navigation for quick access to agent conversations.

**Files:**
- `mobile/src/screens/chat/ChatTabScreen.tsx`
- `mobile/src/screens/chat/ConversationListScreen.tsx`

**Requirements:**
- Chat tab showing recent conversations
- New conversation button with agent selector
- Swipe to delete conversations
- Search conversations
- Conversation preview (last message, timestamp)
- Unread message indicators
- Navigate to AgentChatScreen on tap
- Empty state with "Start a conversation" CTA

**Acceptance Criteria:**
- [ ] Chat tab shows in bottom navigation
- [ ] Recent conversations list displays
- [ ] New conversation button works
- [ ] Swipe to delete functions
- [ ] Search filters conversations
- [ ] Unread badges show correctly
- [ ] Tapping navigates to AgentChatScreen

---

### Task 08: Configure App Navigation Deep Links

Set up deep linking configuration for auth and main app screens.

**File:** `mobile/app.config.js`

**Requirements:**
- Configure deep link scheme: `atom://`
- Auth deep links: atom://auth/login, atom://auth/register, atom://auth/reset
- Main app deep links: atom://chat, atom://agents, atom://workflows, atom://settings
- Agent deep link: atom://agent/{agent_id}
- Canvas deep link: atom://canvas/{canvas_id}
- Workflow deep link: atom://workflow/{workflow_id}
- Handle unrecognized deep links gracefully

**Acceptance Criteria:**
- [ ] Deep link scheme configured
- [ ] All auth deep links work
- [ ] All main app deep links work
- [ ] Agent/canvas/workflow deep links navigate correctly
- [ ] Unrecognized links show error screen
- [ ] Deep links work when app is closed (cold start)
- [ ] Deep links work when app is in background

---

## Verification Criteria

### Functional Verification
- [ ] **V-01:** Complete auth flow works (register → login → main app)
- [ ] **V-02:** Biometric authentication works on supported devices
- [ ] **V-03:** Password reset flow completes successfully
- [ ] **V-04:** Logout properly clears state and returns to login
- [ ] **V-05:** All deep links navigate to correct screens
- [ ] **V-06:** Session persists across app restarts (with valid token)
- [ ] **V-07:** Token refresh works automatically when near expiry
- [ ] **V-08:** Chat tab displays recent conversations

### UI/UX Verification
- [ ] **V-09:** Loading states shown during all async operations
- [ ] **V-10:** Form validation provides immediate feedback
- [ ] **V-11:** Error messages are user-friendly and actionable
- [ ] **V-12:** Transitions between auth and main app are smooth
- [ ] **V-13:** Keyboard doesn't hide input fields
- [ ] **V-14:** Touch targets meet minimum size (44x44 points)

### Security Verification
- [ ] **V-15:** Passwords stored securely (SecureStore)
- [ ] **V-16:** Tokens cleared on logout
- [ ] **V-17:** Biometric fallback requires password after 3 failed attempts
- [ ] **V-18:** Session tokens validated on app start

---

## must_haves

### Goal-Backward Requirements (Phase 65 Success Criteria)
1. **Mobile auth screens complete** - Login, Register, Forgot Password, Biometric screens fully functional
2. **Navigation flow seamless** - Auth to main app transition works smoothly
3. **Deep linking functional** - All deep links navigate to correct screens

### Plan-Specific must_haves
1. **M-01:** AuthNavigator with conditional rendering implemented
2. **M-02:** LoginScreen with email/password and biometric quick login
3. **M-03:** RegisterScreen with validation and terms acceptance
4. **M-04:** ForgotPasswordScreen with email reset flow
5. **M-05:** BiometricAuthScreen with fallback to password
6. **M-06:** Chat tab added to main navigation
7. **M-07:** Deep links configured for all screens
8. **M-08:** Session persistence and token refresh working

---

## Success Metrics

- Auth flow completion rate: >90% (from login to main app)
- Biometric authentication success rate: >85% on supported devices
- Password reset email delivery: >95%
- Deep link navigation success: >98%
- Form validation error rate: <5%

---

## Estimated Duration

**3-4 days** (8 tasks, ~4-6 hours each)

---

## Notes

- AuthContext already has most authentication logic implemented
- DeviceContext provides biometric capability detection
- Use expo-linking for deep link handling
- Consider adding social auth (Google, Apple) in future iteration
- Ensure accessibility (VoiceOver) for all auth screens
