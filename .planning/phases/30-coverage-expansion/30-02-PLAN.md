---
phase: 30-coverage-expansion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/test_atom_agent_endpoints_api_contracts.py
autonomous: true

must_haves:
  truths:
    - "atom_agent_endpoints.py reaches 50% coverage (+125 lines from 262)"
    - "Integration tests verify all API endpoint contracts (request/response)"
    - "Streaming endpoint tests cover all governance maturity levels"
    - "Error handling tests cover edge cases and validation"
    - "All tests pass with pytest"
  artifacts:
    - path: "tests/integration/test_atom_agent_endpoints_api_contracts.py"
      provides: "API contract tests for atom_agent_endpoints"
      min_lines: 500
      contains: "TestAtomAgentAPIContracts"
  key_links:
    - from: "tests/integration/test_atom_agent_endpoints_api_contracts.py"
      to: "core/atom_agent_endpoints.py"
      via: "FastAPI TestClient for endpoint testing"
      pattern: "from fastapi.testclient import TestClient"
    - from: "tests/integration/test_atom_agent_endpoints_api_contracts.py"
      to: "core.models"
      via: "factory fixtures for agent/execution creation"
      pattern: "AgentFactory|AgentExecutionFactory"
---

<objective>
Increase atom_agent_endpoints.py test coverage from 33.6% (262/774 lines) to 50% (387+ lines) by adding comprehensive API contract tests for all endpoints.

**Purpose:** atom_agent_endpoints.py is a critical API layer (2043 lines, 3 classes, 36 endpoints) handling chat, streaming, and agent interactions. Current coverage at 33.6% leaves API contracts and error paths untested.

**Output:** Comprehensive API contract tests (500+ lines) covering all endpoints, request/response validation, error handling, and governance integration.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-coverage-expansion/30-coverage-expansion-PHASE.md

# Existing Test Patterns
@tests/integration/test_atom_agent_endpoints_expanded.py
@.planning/phases/08-80-percent-coverage-push/08-80-percent-coverage-push-SUMMARY.md

# Source Under Test
@core/atom_agent_endpoints.py
</context>

<tasks>

<task type="auto">
  <name>Create comprehensive API contract tests</name>
  <files>tests/integration/test_atom_agent_endpoints_api_contracts.py</files>
  <action>
    Create comprehensive API contract tests extending existing test_atom_agent_endpoints_expanded.py:

    1. **TestAtomAgentAPIContracts** class with endpoint-specific tests:
       - **Chat Endpoint** (`POST /api/atom-agent/chat`):
         - `test_chat_with_student_agent`: Verify STUDENT governance restrictions
         - `test_chat_with_autonomous_agent`: Verify full execution for AUTONOMOUS
         - `test_chat_with_context`: Verify context parameter handling
         - `test_chat_invalid_request`: Verify 400 for invalid payloads
       - **Streaming Endpoint** (`POST /api/atom-agent/chat` with stream=True):
         - `test_streaming_response_format`: Verify SSE/event-stream format
         - `test_streaming_with_intern_agent`: Verify INTERN restrictions apply
         - `test_streaming_error_handling`: Verify graceful error handling
       - **Sessions Endpoint** (`GET /api/atom-agent/sessions`):
         - `test_list_sessions_pagination`: Verify pagination works
         - `test_list_sessions_filtering`: Verify user filtering
       - **Execute Generated Endpoint** (`POST /api/atom-agent/execute-generated`):
         - `test_execute_workflow`: Verify workflow execution triggered
         - `test_execute_invalid_workflow`: Verify 404 for non-existent workflow
       - **Feedback Endpoints**:
         - `test_submit_feedback`: Verify feedback saved
         - `test_feedback_validation`: Verify validation rules
       - **Health/Status Endpoints**:
         - `test_agent_status`: Verify status response format
         - `test_capabilities_endpoint`: Verify capabilities returned

    2. **Fixtures**: Use TestClient, AgentFactory, UserFactory, db_session
    3. **Mocking**: Mock LLM calls (OpenAI, Anthropic) to avoid API costs
    4. **Coverage Focus**: Map out uncovered lines in atom_agent_endpoints.py and create tests for each

    Target: 500+ lines, 25+ tests, coverage reaches 50%+
  </action>
  <verify>
    Run `pytest tests/integration/test_atom_agent_endpoints_api_contracts.py -v --cov=core/atom_agent_endpoints --cov-report=term-missing`
  </verify>
  <done>
    API contract tests pass, atom_agent_endpoints.py coverage at 50%+ (387+ lines)
  </done>
</task>

</tasks>

<verification>
Overall verification steps:
1. Run `pytest tests/integration/test_atom_agent_endpoints_api_contracts.py -v --cov=core/atom_agent_endpoints --cov-report=term-missing`
2. Verify coverage >= 50% (387+ of 774 lines)
3. Verify all tests pass (100% pass rate)
4. Check coverage report for remaining gaps (document for future phases)
</verification>

<success_criteria>
1. atom_agent_endpoints.py coverage >= 50% (387+ lines covered, up from 262)
2. All API endpoints have contract tests (request/response validation)
3. Error handling paths tested (400, 404, 500 responses)
4. Governance integration tested (STUDENT/INTERN/SUPERVISED/AUTONOMOUS)
5. Streaming functionality tested with mock responses
</success_criteria>

<output>
After completion, create `.planning/phases/30-coverage-expansion/30-02-SUMMARY.md` with:
- Final coverage percentage for atom_agent_endpoints.py
- Number of endpoints tested
- API contracts verified
- Any API contract violations found
</output>
