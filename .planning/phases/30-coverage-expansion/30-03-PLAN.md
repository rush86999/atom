---
phase: 30-coverage-expansion
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/property_tests/llm/test_byok_handler_provider_invariants.py
autonomous: true

must_haves:
  truths:
    - "byok_handler.py reaches 50% coverage (+68 lines from 207)"
    - "Property tests verify provider fallback invariants"
    - "Property tests verify cost-based routing deterministic behavior"
    - "Provider selection tests verify tier-based routing"
    - "All tests pass with pytest"
  artifacts:
    - path: "tests/property_tests/llm/test_byok_handler_provider_invariants.py"
      provides: "Property-based tests for BYOK provider fallback"
      min_lines: 300
      contains: "TestBYOKProviderInvariants"
  key_links:
    - from: "tests/property_tests/llm/test_byok_handler_provider_invariants.py"
      to: "core/llm/byok_handler.py"
      via: "direct import of BYOKHandler"
      pattern: "from core.llm.byok_handler import BYOKHandler"
    - from: "tests/property_tests/llm/test_byok_handler_provider_invariants.py"
      to: "core/byok_endpoints.py"
      via: "mock byok_manager for provider key management"
      pattern: "get_byok_manager"
---

<objective>
Increase byok_handler.py test coverage from 36.3% (207/549 lines) to 50% (275+ lines) by adding property-based tests for provider fallback invariants and cost-based routing.

**Purpose:** BYOKHandler manages multi-provider LLM routing (OpenAI, Anthropic, DeepSeek, Gemini) with cost optimization. Current coverage at 36.3% leaves provider fallback and routing logic untested.

**Output:** Property-based tests for provider invariants (300+ lines) covering fallback behavior, deterministic routing, and tier-based selection.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-coverage-expansion/30-coverage-expansion-PHASE.md

# Existing Test Patterns
@tests/unit/test_byok_handler.py
@tests/integration/test_byok_handler_integration.py
@.planning/phases/02-core-invariants/02-core-invariants-03-PLAN.md

# Source Under Test
@core/llm/byok_handler.py
</context>

<tasks>

<task type="auto">
  <name>Create property-based provider invariants tests</name>
  <files>tests/property_tests/llm/test_byok_handler_provider_invariants.py</files>
  <action>
    Create property-based tests for BYOKHandler provider selection and fallback invariants:

    1. **TestBYOKProviderInvariants** class with property tests:
       - `test_provider_fallback_always_returns_valid`: Using @given with available providers, verify fallback always returns a configured provider
       - `test_routing_is_deterministic`: Using @given with same inputs, verify same provider selected (no randomness in routing)
       - `test_complexity_based_routing_monotonic`: Using @given with query complexities, verify higher complexity routes to appropriate tier
       - `test_cost_efficient_model_selection`: Using @given with providers and complexities, verify models selected from COST_EFFICIENT_MODELS
       - `test_provider_tier_exhaustive`: Verify all providers in PROVIDER_TIERS have valid models
       - `test_api_key_fallback`: Verify env var fallback when BYOK not configured
       - `test_multi_provider_rotation`: Using @given with provider lists, verify rotation distributes load
       - `test_unavailable_provider_skip`: Verify unavailable providers are skipped in fallback chain

    2. **Strategies**: Use Hypothesis strategies (st.sampled_from, st.lists, st.text) for generating provider configs
    3. **Settings**: Use max_examples=50 for IO-bound tests, suppress_health_check for function-scoped fixtures
    4. **Mocking**: Mock byok_manager.get_api_key, mock OpenAI client responses
    5. **VALIDATED_BUG**: Document any bugs found with commit hashes if applicable

    Target: 300+ lines, 12+ property tests covering provider invariants
  </action>
  <verify>
    Run `pytest tests/property_tests/llm/test_byok_handler_provider_invariants.py -v --cov=core/llm/byok_handler --cov-report=term-missing`
  </verify>
  <done>
    Property tests pass, byok_handler.py coverage at 50%+ (275+ lines)
  </done>
</task>

</tasks>

<verification>
Overall verification steps:
1. Run `pytest tests/property_tests/llm/test_byok_handler_provider_invariants.py tests/unit/test_byok_handler.py -v --cov=core/llm/byok_handler --cov-report=term-missing`
2. Verify coverage >= 50% (275+ of 549 lines)
3. Verify all tests pass (100% pass rate)
4. Check coverage report for remaining gaps (document for future phases)
</verification>

<success_criteria>
1. byok_handler.py coverage >= 50% (275+ lines covered, up from 207)
2. Property tests verify provider fallback always returns valid provider
3. Property tests verify routing is deterministic (same inputs = same provider)
4. Provider tier assignments verified (budget/mid/premium/specialized)
5. Cost-efficient model selections validated for all complexity levels
</success_criteria>

<output>
After completion, create `.planning/phases/30-coverage-expansion/30-03-SUMMARY.md` with:
- Final coverage percentage for byok_handler.py
- Provider invariants tested and verified
- Any routing inconsistencies found
- Provider fallback chain validated
</output>
