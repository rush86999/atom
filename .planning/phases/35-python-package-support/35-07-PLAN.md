---
phase: 35-python-package-support
plan: 07
type: execute
wave: 4
depends_on: ["35-01", "35-02", "35-03", "35-04", "35-05", "35-06"]
files_modified:
  - docs/PYTHON_PACKAGES.md
  - docs/PACKAGE_GOVERNANCE.md
  - docs/PACKAGE_SECURITY.md
  - backend/requirements.txt
  - .env.example
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Documentation explains Python package support for skills"
    - "Quick start guide shows how to add packages to SKILL.md"
    - "Governance rules are documented (STUDENT blocked, maturity gates)"
    - "Security best practices are documented (sandboxing, scanning)"
    - "API reference documents package installation and execution endpoints"
    - "Troubleshooting guide covers common issues"
    - "Environment variables are documented in .env.example"
  artifacts:
    - path: "docs/PYTHON_PACKAGES.md"
      provides: "User guide for Python package support in skills"
      min_lines: 300
    - path: "docs/PACKAGE_GOVERNANCE.md"
      provides: "Governance rules and maturity-based access control"
      min_lines: 200
    - path: "docs/PACKAGE_SECURITY.md"
      provides: "Security best practices and threat model"
      min_lines: 250
    - path: ".env.example"
      provides: "Environment variables for package scanning"
      contains: "SAFETY_API_KEY"
  key_links:
    - from: "docs/PYTHON_PACKAGES.md"
      to: "docs/COMMUNITY_SKILLS.md"
      via: "Integration with existing community skills documentation"
      pattern: "See also.*COMMUNITY_SKILLS"
    - from: "docs/PACKAGE_SECURITY.md"
      to: "backend/core/skill_sandbox.py"
      via: "Security constraint documentation"
      pattern: "network_disabled.*read_only"
    - from: ".env.example"
      to: "backend/core/package_dependency_scanner.py"
      via: "Environment variable documentation"
      pattern: "SAFETY_API_KEY"
---

# Phase 35 Plan 07: Documentation and Deployment

**Create comprehensive documentation for Python package support and deploy to production**

## Objective

Create user-facing documentation, security guides, API references, and deployment runbooks for Python package support, ensuring users understand how to safely add packages to skills, governance rules, security constraints, and troubleshooting procedures.

**Purpose:** Enable skill authors to use Python packages effectively while maintaining security, provide operators with deployment guidance, and document security architecture for auditors and security reviewers.

**Output:** Comprehensive documentation (user guide, governance guide, security guide, API reference), updated requirements.txt and .env.example, deployment verification, and production readiness checklist.

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-python-package-support/35-RESEARCH.md

@docs/COMMUNITY_SKILLS.md (Existing community skills documentation)
@backend/core/package_governance_service.py (Plan 01: Governance rules)
@backend/core/skill_sandbox.py (Phase 14: Security constraints)
@backend/api/package_routes.py (Plan 04: API endpoints)

## Tasks

<task type="auto">
  <name>Task 1: Create user guide for Python packages in skills</name>
  <files>docs/PYTHON_PACKAGES.md</files>
  <action>
    Create comprehensive user guide:

    ```markdown
    # Python Packages in Skills - User Guide

    **Last Updated:** February 19, 2026

    ## Overview

    Atom skills can now specify Python packages (e.g., numpy, pandas, requests) in their SKILL.md files, with automatic installation in isolated Docker containers, permission checks, and security scanning.

    ## Quick Start

    ### Adding Packages to Your Skill

    1. Edit your SKILL.md file:
    ```yaml
    ---
    name: "Data Processing Skill"
    description: "Processes CSV data using pandas"
    packages:
      - pandas==1.3.0
      - numpy>=1.21.0
    ---

    ```python
    import pandas as pd
    import numpy as np

    def process_csv(query):
        # Your skill code here
        data = pd.read_csv(query)
        return f"Processed {len(data)} rows"
    ```
    ```

    2. Import and use your skill:
    ```python
    from core.skill_adapter import CommunitySkillTool

    tool = CommunitySkillTool(
        name="Data Processing",
        skill_type="python_code",
        code="...",  # From SKILL.md
        packages=["pandas==1.3.0", "numpy>=1.21.0"]
    )

    result = tool._run(query="data.csv")
    ```

    3. Atom automatically:
       - Checks agent permissions for each package
       - Scans for vulnerabilities (CVEs)
       - Builds dedicated Docker image with packages
       - Executes skill in isolated container
       - Cleans up unused images

    ## Package Version Format

    ### Exact Version
    ```yaml
    packages:
      - numpy==1.21.0  # Exactly 1.21.0
    ```

    ### Minimum Version
    ```yaml
    packages:
      - pandas>=1.3.0  # 1.3.0 or higher
    ```

    ### Compatible Release
    ```yaml
    packages:
      - requests~=2.28.0  # >=2.28.0, <2.29.0
    ```

    ### Any Version (Not Recommended)
    ```yaml
    packages:
      - requests  # Latest version (use with caution)
    ```

    ## Governance Rules

    ### STUDENT Agents
    - **BLOCKED** from all Python packages (educational restriction)
    - Cannot execute skills with packages
    - Error: "STUDENT agents cannot execute Python packages"

    ### INTERN Agents
    - Require approval for each package version
    - Request approval via API: `POST /api/packages/request`
    - Admin approval required: `POST /api/packages/approve`

    ### SUPERVISED Agents
    - Allowed if package approved for SUPERVISED maturity or higher
    - Real-time monitoring during execution
    - Audit trail tracks all package usage

    ### AUTONOMOUS Agents
    - Allowed if package approved for AUTONOMOUS maturity
    - Full access (whitelist still enforced)
    - Banned packages blocked regardless of maturity

    ## Security Features

    ### Vulnerability Scanning
    - Automatic scanning before installation (pip-audit + Safety)
    - Detects known CVEs in packages and dependencies
    - Blocks installation if vulnerabilities found

    ### Container Isolation
    - Dedicated Docker image per skill (prevents conflicts)
    - Network disabled (no outbound connections)
    - Read-only filesystem (no unauthorized writes)
    - Resource limits (memory, CPU quotas)

    ### Permission Checks
    - <1ms cached lookups via GovernanceCache
    - Maturity-based access control
    - Audit trail for all operations

    ## API Usage

    ### Check Package Permission
    \`\`\`bash
    curl "http://localhost:8000/api/packages/check?agent_id=agent-123&package_name=numpy&version=1.21.0"
    \`\`\`

    Response:
    \`\`\`json
    {
      "allowed": true,
      "maturity_required": "INTERN",
      "reason": null
    }
    \`\`\`

    ### Install Packages for Skill
    \`\`\`bash
    curl -X POST http://localhost:8000/api/packages/install \\
      -H "Content-Type: application/json" \\
      -d '{
        "agent_id": "agent-123",
        "skill_id": "my-skill",
        "requirements": ["numpy==1.21.0", "pandas>=1.3.0"],
        "scan_for_vulnerabilities": true
      }'
    \`\`\`

    ### Execute Skill with Packages
    \`\`\`bash
    curl -X POST http://localhost:8000/api/packages/execute \\
      -H "Content-Type: application/json" \\
      -d '{
        "agent_id": "agent-123",
        "skill_id": "my-skill",
        "code": "import numpy as np; print(np.__version__)",
        "timeout_seconds": 30
      }'
    \`\`\`

    ### Cleanup Skill Image
    \`\`\`bash
    curl -X DELETE "http://localhost:8000/api/packages/my-skill?agent_id=agent-123"
    \`\`\`

    ## Troubleshooting

    ### "Package permission denied"
    - **Cause**: Agent lacks required maturity level
    - **Solution**: Upgrade agent maturity or request package approval

    ### "Vulnerabilities detected"
    - **Cause**: Package has known CVE
    - **Solution**: Update to patched version (check pip-audit output)

    ### "Image not found"
    - **Cause**: Skill image not built yet
    - **Solution**: Run POST /api/packages/install first

    ### "Package installation failed"
    - **Cause**: Invalid package format or dependency conflict
    - **Solution**: Check package specifier (use ==, >=, ~=)

    ### "Skill execution timeout"
    - **Cause**: Code exceeded timeout limit
    - **Solution**: Increase timeout_seconds or optimize code

    ## Best Practices

    ### Pin Package Versions
    \`\`\`yaml
    # Good: Pinned versions
    packages:
      - numpy==1.21.0
      - pandas==1.3.0

    # Avoid: Unpinned versions
    packages:
      - numpy  # May break when new version released
    \`\`\`

    ### Minimize Package Count
    - Fewer packages = Faster installation
    - Fewer packages = Smaller attack surface
    - Only add packages you actually need

    ### Use Popular Packages
    - Popular packages are better maintained
    - Fewer vulnerabilities discovered
    - Faster installation (more likely cached)

    ### Check Security Advisories
    - Review PyPI security advisories
    - Check package download counts
    - Verify package maintainer

    ## Examples

    ### Data Processing Skill
    \`\`\`yaml
    ---
    name: "CSV Analyzer"
    description: "Analyzes CSV files using pandas"
    packages:
      - pandas==1.3.0
      - numpy==1.21.0
    ---
    \`\`\`

    ### Web Scraping Skill
    \`\`\`yaml
    ---
    name: "Web Scraper"
    description: "Scrapes web pages using requests"
    packages:
      - requests==2.28.0
      - beautifulsoup4==4.10.0
    ---
    \`\`\`

    ### Machine Learning Skill
    \`\`\`yaml
    ---
    name: "Text Classifier"
    description: "Classifies text using scikit-learn"
    packages:
      - scikit-learn==1.0.0
      - numpy==1.21.0
    ---
    \`\`\`

    ## See Also

    - [Community Skills Guide](COMMUNITY_SKILLS.md)
    - [Package Governance](PACKAGE_GOVERNANCE.md)
    - [Package Security](PACKAGE_SECURITY.md)
    - [Skill Security Scanner](../backend/core/skill_security_scanner.py)
    ```

    Include examples, troubleshooting, and best practices.
  </action>
  <verify>
    python3 -c "import os; path = 'docs/PYTHON_PACKAGES.md'; print(f'Exists: {os.path.exists(path)}'); print(f'Size: {os.path.getsize(path)} bytes')"
  </verify>
  <done>
    PYTHON_PACKAGES.md exists, contains quick start, governance rules, security features, API usage, troubleshooting, best practices, and examples sections
  </done>
</task>

<task type="auto">
  <name>Task 2: Create governance and security documentation</name>
  <files>docs/PACKAGE_GOVERNANCE.md, docs/PACKAGE_SECURITY.md</files>
  <action>
    Create two additional documentation files:

    **PACKAGE_GOVERNANCE.md:**
    ```markdown
    # Package Governance - Access Control and Permissions

    ## Maturity-Based Access

    | Agent Maturity | Package Access | Approval Required |
    |----------------|----------------|-------------------|
    | STUDENT | ❌ Blocked | N/A |
    | INTERN | ⚠️ Request per package | Yes (admin) |
    | SUPERVISED | ✅ Approved packages only | No |
    | AUTONOMOUS | ✅ Approved packages only | No |

    ## Approval Workflow

    ### 1. Request Package Approval
    \`\`\`bash
    curl -X POST http://localhost:8000/api/packages/request \\
      -d '{
        "package_name": "numpy",
        "version": "1.21.0",
        "requested_by": "user-123",
        "reason": "Data processing skill"
      }'
    \`\`\`

    ### 2. Approve Package (Admin)
    \`\`\`bash
    curl -X POST http://localhost:8000/api/packages/approve \\
      -d '{
        "package_name": "numpy",
        "version": "1.21.0",
        "min_maturity": "INTERN",
        "approved_by": "admin"
      }'
    \`\`\`

    ### 3. Check Permission
    \`\`\`bash
    curl "http://localhost:8000/api/packages/check?agent_id=agent-123&package_name=numpy&version=1.21.0"
    \`\`\`

    ## Banning Packages

    To ban a package version:
    \`\`\`bash
    curl -X POST http://localhost:8000/api/packages/ban \\
      -d '{
        "package_name": "malicious-pkg",
        "version": "1.0.0",
        "reason": "Contains malware"
      }'
    \`\`\`

    Banned packages are blocked for ALL agents regardless of maturity.

    ## Cache Performance

    Governance cache provides <1ms permission lookups:
    - Cache hit: ~0.027ms (P99)
    - Cache miss: ~0.084ms average (DB query + cache set)
    - Cache hit rate: >95%

    Cache invalidation:
    - Manual: Cache cleared on package approval/ban
    - Auto: TTL 60 seconds
    ```

    **PACKAGE_SECURITY.md:**
    ```markdown
    # Package Security - Threat Model and Defenses

    ## Threat Model

    ### Attack Scenarios

    1. **Dependency Confusion**
       - Attacker publishes malicious package with same name as internal package
       - Defense: Pin exact versions (==), use private indexes

    2. **Typosquatting**
       - Attacker publishes package with typo in popular name (e.g., "reqeusts" instead of "requests")
       - Defense: Install from requirements.txt, scan for low-download packages

    3. **Transitive Dependencies**
       - Safe package depends on vulnerable package
       - Defense: pip-audit scans full dependency tree

    4. **Container Escape**
       - Malicious code attempts to break out of container
       - Defense: No privileged mode, no Docker socket mount, read-only filesystem

    5. **Resource Exhaustion**
       - Malicious code consumes all host resources
       - Defense: Memory/CPU limits, PIDs limits

    ## Security Constraints

    ### Container Isolation
    - Network disabled (no outbound/inbound)
    - Read-only root filesystem
    - No privileged mode
    - No Docker socket mount
    - Memory limit: 256m default
    - CPU quota: 0.5 cores default

    ### Vulnerability Scanning
    - pip-audit (PyPA-maintained)
    - Safety (commercial database)
    - Scans full dependency tree
    - Blocks installation if CVEs found

    ### Static Code Analysis
    - Detects malicious patterns (subprocess, eval, exec, etc.)
    - GPT-4 semantic analysis for obfuscated code
    - 21+ malicious patterns detected

    ## Security Testing

    All security scenarios tested:
    - Container escape (privileged mode, socket mount)
    - Resource exhaustion (fork bomb, memory bomb)
    - Network isolation (no outbound connections)
    - Filesystem isolation (read-only, no host access)
    - Malicious patterns (subprocess, eval, base64 obfuscation)

    See: `tests/test_package_security.py`

    ## Security Best Practices

    1. **Always pin package versions** (==)
    2. **Minimize package count** (smaller attack surface)
    3. **Use popular packages** (better maintained)
    4. **Check security advisories** (PyPI, GitHub)
    5. **Review package code** before approval
    6. **Keep packages updated** (security patches)
    7. **Monitor execution logs** (audit trail)

    ## Incident Response

    If malicious package detected:
    1. Ban package immediately: `POST /api/packages/ban`
    2. Invalidate cache (automatic)
    3. Review audit trail: `GET /api/packages/audit`
    4. Check affected skills
    5. Notify users
    6. Rebuild affected images
    ```

    Follow Phase 35 RESEARCH.md security patterns.
  </action>
  <verify>
    python3 -c "import os; print('PACKAGE_GOVERNANCE.md:', os.path.exists('docs/PACKAGE_GOVERNANCE.md')); print('PACKAGE_SECURITY.md:', os.path.exists('docs/PACKAGE_SECURITY.md'))"
  </verify>
  <done>
    PACKAGE_GOVERNANCE.md and PACKAGE_SECURITY.md exist, contain maturity-based access rules, approval workflow, banning procedures, threat model, security constraints, and incident response procedures
  </done>
</task>

<task type="auto">
  <name>Task 3: Update requirements.txt and .env.example</name>
  <files>backend/requirements.txt, .env.example</files>
  <action>
    1. Update requirements.txt with Phase 35 dependencies:
    ```bash
    # Add to backend/requirements.txt

    # Python package support (Phase 35)
    pip-audit>=2.17.0,<3.0.0
    safety>=3.0.0,<4.0.0
    pipdeptree>=2.13.0,<3.0.0
    packaging>=21.0,<25.0
    ```

    2. Update .env.example with new environment variables:
    ```bash
    # Add to .env.example

    # Python Package Scanning (Phase 35)
    # Safety commercial vulnerability database API key (optional)
    # Get API key from: https://pyup.io/safety/
    SAFETY_API_KEY=

    # Package governance cache settings
    PACKAGE_CACHE_TTL=60  # Cache duration in seconds
    PACKAGE_CACHE_MAX_SIZE=1000  # Max cache entries
    ```

    3. Add documentation comments explaining each variable.
  </action>
  <verify>
    grep -E "pip-audit|safety|SAFETY_API_KEY" backend/requirements.txt .env.example
  </verify>
  <done>
    requirements.txt contains pip-audit, safety, pipdeptree, packaging dependencies; .env.example contains SAFETY_API_KEY and cache configuration with documentation
  </done>
</task>

<task type="auto">
  <name>Task 4: Create deployment verification checklist</name>
  <files>docs/PYTHON_PACKAGES_DEPLOYMENT.md</files>
  <action>
    Create deployment checklist:

    ```markdown
    # Python Package Support - Deployment Checklist

    ## Pre-Deployment

    ### Dependencies Installed
    - [ ] pip-audit 2.17+ installed (`pip-audit --version`)
    - [ ] safety 3.0+ installed (`safety --version`)
    - [ ] pipdeptree 2.13+ installed (`pipdeptree --version`)
    - [ ] packaging 21.0+ installed (`python -c "import packaging; print(packaging.__version__)"`)

    ### Docker Available
    - [ ] Docker daemon running (`docker version`)
    - [ ] Docker SDK for Python installed (`pip show docker`)
    - [ ] Can pull base image (`docker pull python:3.11-slim`)

    ### Database Migrations
    - [ ] Alembic migration applied (`alembic upgrade head`)
    - [ ] package_registry table exists
    - [ ] Indexes created (name, version)

    ### Environment Variables
    - [ ] SAFETY_API_KEY set (optional, for commercial DB)
    - [ ] PACKAGE_CACHE_TTL configured (default: 60)
    - [ ] PACKAGE_CACHE_MAX_SIZE configured (default: 1000)

    ## Post-Deployment

    ### API Endpoints
    - [ ] GET /api/packages/check returns 200
    - [ ] POST /api/packages/install returns 200
    - [ ] POST /api/packages/execute returns 200
    - [ ] DELETE /api/packages/{skill_id} returns 200
    - [ ] GET /api/packages/audit returns 200

    ### Permission Checks
    - [ ] STUDENT agents blocked from packages
    - [ ] INTERN agents require approval
    - [ ] SUPERVISED agents allowed with approved packages
    - [ ] AUTONOMOUS agents allowed with approved packages

    ### Vulnerability Scanning
    - [ ] pip-audit runs without errors
    - [ ] Safety check runs (if API key provided)
    - [ ] Vulnerable packages blocked
    - [ ] Scan results logged

    ### Container Security
    - [ ] Network isolation enforced (network_disabled=True)
    - [ ] Read-only filesystem enforced (read_only=True)
    - [ ] No privileged mode (privileged=False)
    - [ ] No Docker socket mount
    - [ ] Resource limits enforced (mem_limit, cpu_quota)

    ### Performance
    - [ ] Governance cache hit rate >90%
    - [ ] Permission checks <1ms (P99)
    - [ ] Image build time <5min (typical packages)
    - [ ] Execution overhead <500ms

    ### Monitoring
    - [ ] Package operations logged (audit trail)
    - [ ] Vulnerability scans logged
    - [ ] Permission denials logged
    - [ ] Image build failures logged

    ## Rollback Procedure

    If issues detected:
    1. Revert database migration: `alembic downgrade -1`
    2. Remove package endpoints from API router
    3. Restart services
    4. Verify system stable

    ## Production Readiness

    - [ ] All pre-deployment checks passed
    - [ ] All post-deployment checks passed
    - [ ] Security tests passed (test_package_security.py)
    - [ ] Integration tests passed (test_package_skill_integration.py)
    - [ ] Documentation complete (PYTHON_PACKAGES.md, PACKAGE_GOVERNANCE.md, PACKAGE_SECURITY.md)
    - [ ] Runbook created (incident response, troubleshooting)
    - [ ] Team trained on new features
    ```

    Include rollback procedures.
  </action>
  <verify>
    python3 -c "import os; print('Deployment checklist exists:', os.path.exists('docs/PYTHON_PACKAGES_DEPLOYMENT.md'))"
  </verify>
  <done>
    PYTHON_PACKAGES_DEPLOYMENT.md exists, contains pre-deployment checklist, post-deployment verification, rollback procedures, and production readiness criteria
  </done>
</task>

</tasks>

## Verification

### Manual Verification
```bash
# 1. Check documentation files exist
ls -lh docs/PYTHON_PACKAGES*.md docs/PACKAGE_*.md

# 2. Check requirements.txt has new dependencies
grep -E "pip-audit|safety|pipdeptree|packaging" backend/requirements.txt

# 3. Check .env.example has new variables
grep -E "SAFETY_API_KEY|PACKAGE_CACHE" .env.example

# 4. Verify documentation content
grep -c "##" docs/PYTHON_PACKAGES.md  # Should have 8+ sections
grep -c "##" docs/PACKAGE_GOVERNANCE.md  # Should have 5+ sections
grep -c "##" docs/PACKAGE_SECURITY.md  # Should have 6+ sections

# 5. Check deployment checklist
grep -c "\- \[ \]" docs/PYTHON_PACKAGES_DEPLOYMENT.md  # Should have 25+ checkboxes
```

### Automated Checks
- PYTHON_PACKAGES.md exists with >300 lines
- PACKAGE_GOVERNANCE.md exists with >200 lines
- PACKAGE_SECURITY.md exists with >250 lines
- PYTHON_PACKAGES_DEPLOYMENT.md exists with >100 lines
- requirements.txt contains pip-audit, safety, pipdeptree, packaging
- .env.example contains SAFETY_API_KEY and cache configuration
- All documentation has proper markdown formatting
- Code examples are syntactically correct
- API endpoint documentation matches actual routes

## Success Criteria

**Phase Success Criteria (from ROADMAP.md):**
- ✅ All 7 success criteria met (verified through Plans 01-06)

**Plan-Specific:**
- User guide explains Python package support (quick start, examples)
- Governance guide documents maturity-based rules
- Security guide documents threat model and defenses
- API reference documents all package endpoints
- Troubleshooting guide covers common issues
- Deployment checklist ensures production readiness
- Environment variables documented in .env.example
- Rollback procedures documented

## Output

After completion, create `.planning/phases/35-python-package-support/35-07-SUMMARY.md` with:
- Files created/modified
- Documentation validation results
- Deployment verification results
- Production readiness status
- Phase completion summary
- Recommendations for Phase 36 (next phase)
