---
phase: 29-test-failure-fixes-quality-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/test_agent_cancellation.py
  - backend/core/agent_task_registry.py
  - backend/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "Agent task cancellation tests handle asyncio task cleanup correctly"
    - "Flaky tests (test_unregister_task, test_register_task, test_get_all_running_agents) are stable"
    - "Tests verify task registration, cancellation, and cleanup without race conditions"
  artifacts:
    - path: "backend/tests/test_agent_cancellation.py"
      provides: "Fixed agent task cancellation tests (no flaky async cleanup)"
      exports: ["test_cancel_single_task", "test_cancel_agent_tasks", "test_cleanup_completed_tasks", "test_unregister_task"]
    - path: "backend/core/agent_task_registry.py"
      provides: "AgentTaskRegistry with proper async cleanup"
      exports: ["register_task", "cancel_task", "unregister_task", "cleanup_completed_tasks"]
    - path: "backend/tests/conftest.py"
      provides: "Global registry reset fixture for test isolation"
      contains: "reset_agent_task_registry"
  key_links:
    - from: "backend/tests/test_agent_cancellation.py"
      to: "backend/core/agent_task_registry.py"
      via: "imports AgentTaskRegistry for task cancellation testing"
      pattern: "from core.agent_task_registry import AgentTaskRegistry, agent_task_registry"
    - from: "backend/tests/conftest.py"
      to: "backend/core/agent_task_registry.py"
      via: "resets global registry before each test"
      pattern: "from core.agent_task_registry import agent_task_registry"
---

<objective>
Fix agent task cancellation flaky tests (test_unregister_task, test_register_task, test_get_all_running_agents).

**Problem**: Task cancellation tests have race conditions in async cleanup. Tasks may not be fully cancelled when assertions run, causing intermittent failures.

**Root Cause**:
1. `test_unregister_task` expects task to be gone immediately after `unregister_task()` — but cleanup has 0.1s delay
2. `test_register_task` and `test_get_all_running_agents` may have registry state pollution from previous tests
3. Async tasks may not be fully done when `task.cancel()` is called (CancelledError propagates asynchronously)

**Purpose**: Ensure task cancellation tests handle async cleanup correctly with explicit synchronization.

**Output**: Agent task cancellation tests stable over 3+ runs.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP_V2.md
@.planning/STATE.md
@backend/tests/test_agent_cancellation.py
@backend/core/agent_task_registry.py
@backend/tests/conftest.py
@backend/tests/docs/FLAKY_TEST_GUIDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix test_unregister_task race condition</name>
  <files>
    backend/tests/test_agent_cancellation.py
  </files>
  <action>
    Fix test_unregister_task race condition (line ~421):

    **Current Code**:
    ```python
    agent_task_registry.unregister_task(task_id)
    # Allow async cleanup to complete
    await asyncio.sleep(0.1)
    # Verify task is gone
    assert agent_task_registry.get_task(task_id) is None
    ```

    **Problem**: 0.1s may not be enough for cleanup on slow CI. Task might still be in registry.

    **Fix Options**:
    1. **Add explicit wait for task.done()**:
       ```python
       await asyncio.sleep(0.1)
       # Wait for task to actually be done
       assert task.done() or task.cancelled()
       # Then verify unregistered
       assert agent_task_registry.get_task(task_id) is None
       ```

    2. **Use longer timeout**:
       ```python
       await asyncio.sleep(0.5)  # Longer timeout for CI
       ```

    3. **Poll for completion**:
       ```python
       for _ in range(10):
           if agent_task_registry.get_task(task_id) is None:
               break
           await asyncio.sleep(0.1)
       else:
           assert False, "Task not unregistered after 1 second"
       ```

    **Why**: Race condition between unregister_task() and registry cleanup. Tests must wait for async operations to complete before asserting.

    **Recommendation**: Option 3 (polling) is most robust — waits for actual condition, not arbitrary time.
  </action>
  <verify>pytest backend/tests/test_agent_cancellation.py::TestTaskCleanup::test_unregister_task -v --tb=short</verify>
  <done>test_unregister_task uses polling to wait for task cleanup. No more race condition — test waits for actual condition (task is None) instead of arbitrary sleep.</done>
</task>

<task type="auto">
  <name>Task 2: Fix test_register_task and test_get_all_running_agents state pollution</name>
  <files>
    backend/tests/test_agent_cancellation.py
  </files>
  <action>
    Fix test_register_task and test_get_all_running_agents state pollution:

    1. **test_register_task** (line ~29):
       - Current: Creates task with UUID, verifies registration
       - Problem: May conflict with tasks from previous tests
       - Fix: Conftest.py already has `reset_agent_task_registry` fixture — verify it runs before this test
       - Add explicit cleanup if needed: `await asyncio.sleep(0.2)` after test

    2. **test_get_all_running_agents** (line ~158):
       - Current: Creates 3 agents, verifies running count
       - Problem: Other tests may have created tasks
       - Fix: Ensure registry is reset before test (autouse fixture)
       - Or: Count only tasks created in this test

    **Verify conftest.py reset**:
    ```python
    @pytest.fixture(autouse=True)
    def reset_agent_task_registry(request):
        from core.agent_task_registry import agent_task_registry
        agent_task_registry._reset()
        yield
        # No cleanup needed - each test gets fresh state
    ```

    **Why**: Global registry state pollution causes flaky tests. Each test must start with clean registry.

    **Code Pattern**:
    ```python
    # Explicit cleanup after test
    @pytest.mark.asyncio
    async def test_register_task(self):
        task_id = str(uuid.uuid4())
        # ... test code ...
        # Explicit cleanup
        task.cancel()
        await asyncio.sleep(0.1)
        agent_task_registry.unregister_task(task_id)
    ```
  </action>
  <verify>pytest backend/tests/test_agent_cancellation.py::TestAgentTaskRegistry::test_register_task backend/tests/test_agent_cancellation.py::TestAgentTaskRegistry::test_get_all_running_agents -v --tb=short</verify>
  <done>test_register_task and test_get_all_running_agents have explicit cleanup. Global registry is reset via autouse fixture. No state pollution between tests.</done>
</task>

<task type="auto">
  <name>Task 3: Fix async task cancellation synchronization</name>
  <files>
    backend/tests/test_agent_cancellation.py
    backend/core/agent_task_registry.py
  </files>
  <action>
    Fix async task cancellation synchronization across all tests:

    1. **test_cancel_single_task** (line ~228):
       - Current: Waits 0.2s after cancellation
       - Fix: Use explicit await on cancelled task
       - Pattern: `await asyncio.gather(task, return_exceptions=True)`

    2. **test_cancel_agent_tasks** (line ~270):
       - Current: Waits 0.2s for cancellations
       - Fix: Wait for all tasks to be done
       - Pattern: `await asyncio.gather(*tasks, return_exceptions=True)`

    3. **test_cancel_agent_run** (line ~317):
       - Current: Waits 0.2s
       - Fix: Use explicit wait pattern

    4. **Consider improving AgentTaskRegistry.cancel_task()**:
       ```python
       async def cancel_task(self, task_id: str) -> bool:
           if task_id not in self._tasks:
               return False
           agent_task = self._tasks[task_id]
           success = agent_task.cancel()
           if success:
               # Wait for task to actually be cancelled
               try:
                   await asyncio.wait_for(agent_task.task, timeout=5.0)
               except (asyncio.CancelledError, asyncio.TimeoutError):
                   pass
               self.unregister_task(task_id)
           return success
       ```

    **Why**: `task.cancel()` sets cancellation flag but doesn't wait for task to handle it. Must await task completion to avoid race conditions.

    **Code Pattern**:
    ```python
    # Robust cancellation test
    success = await agent_task_registry.cancel_task(task_id)
    assert success is True
    # Verify task is actually done
    task = agent_task_registry.get_task(task_id)
    assert task is None or task.task.done()
    ```
  </action>
  <verify>pytest backend/tests/test_agent_cancellation.py::TestTaskCancellation -v --tb=short</verify>
  <done>Async task cancellation tests use explicit synchronization (gather/wait_for). Tests wait for tasks to actually be cancelled before asserting. No race conditions.</done>
</task>

</tasks>

<verification>
**Overall Phase Verification**:

1. Run all agent cancellation tests: `pytest backend/tests/test_agent_cancellation.py -v`

2. Verify all tests pass:
   - TestAgentTaskRegistry (6 tests)
   - TestTaskCancellation (4 tests)
   - TestHelperFunctions (1 test)
   - TestTaskCleanup (2 tests)

3. Run tests 10 times to confirm no flaky behavior: `for i in {1..10}; do pytest backend/tests/test_agent_cancellation.py -v --tb=short || exit 1; done`

4. Run in parallel to verify no state pollution: `pytest backend/tests/test_agent_cancellation.py -n auto -v`

5. Verify conftest.py autouse fixture resets registry before each test
</verification>

<success_criteria>
1. All agent cancellation tests pass consistently over 10 runs (zero failures)

2. Tests use explicit synchronization instead of arbitrary sleep:
   - Poll for actual conditions (task is None, task.done())
   - Use asyncio.gather/wait_for to wait for task completion

3. No global registry state pollution between tests:
   - autouse fixture resets registry before each test
   - Tests clean up tasks explicitly

4. Tests pass in parallel execution mode (pytest -n auto)

5. Document fix in test comments: "Previously flaky due to race condition. Fixed by polling for actual condition instead of sleep."
</success_criteria>

<output>
After completion, create `.planning/phases/29-test-failure-fixes-quality-foundation/29-04-SUMMARY.md` with:
- Tests fixed (13 tests total)
- Race condition fixes (polling, explicit synchronization)
- Test results (pass/fail counts, flakiness verification over 10 runs)
- Any AgentTaskRegistry improvements made
</output>
