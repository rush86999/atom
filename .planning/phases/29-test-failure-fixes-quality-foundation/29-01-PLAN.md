---
phase: 29-test-failure-fixes-quality-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/governance/test_agent_governance_invariants.py
  - backend/tests/property_tests/llm/test_llm_streaming_invariants.py
  - backend/tests/property_tests/episodes/test_hybrid_retrieval_invariants.py
  - backend/tests/property_tests/episodes/test_agent_graduation_lifecycle.py
  - backend/tests/property_tests/episodes/test_episode_lifecycle_invariants.py
  - backend/tests/property_tests/security/test_owasp_security_invariants.py
  - backend/tests/property_tests/database/test_database_acid_invariants.py
  - backend/tests/property_tests/llm/test_token_counting_invariants.py
  - backend/tests/property_tests/governance/test_governance_invariants.py
  - backend/tests/property_tests/governance/test_governance_cache_invariants.py
autonomous: true

must_haves:
  truths:
    - "All property tests import and use hypothesis strategies correctly (no TypeError)"
    - "st.just() and st.sampled_from() strategies work with Hypothesis 6.x"
    - "Property tests run successfully with pytest -v"
    - "Property tests generate diverse test cases via Hypothesis"
  artifacts:
    - path: "backend/tests/property_tests/governance/test_agent_governance_invariants.py"
      provides: "Fixed property tests for agent governance invariants"
      exports: ["test_maturity_never_decreases", "test_confidence_bounds"]
    - path: "backend/tests/property_tests/llm/test_llm_streaming_invariants.py"
      provides: "Fixed property tests for LLM streaming invariants"
      exports: ["test_streaming_chunks_are_nonempty", "test_token_counts_match"]
    - path: "backend/tests/property_tests/episodes/test_hybrid_retrieval_invariants.py"
      provides: "Fixed property tests for hybrid retrieval invariants"
      exports: ["test_hybrid_retrieval_consistency", "test_temporal_precedence"]
    - path: "backend/tests/property_tests/episodes/test_agent_graduation_lifecycle.py"
      provides: "Fixed property tests for graduation lifecycle invariants"
      exports: ["test_graduation_criteria_satisfaction", "test_readiness_monotonicity"]
    - path: "backend/tests/property_tests/episodes/test_episode_lifecycle_invariants.py"
      provides: "Fixed property tests for episode lifecycle invariants"
      exports: ["test_decay_precedence", "test_consolidation_merge"]
    - path: "backend/tests/property_tests/security/test_owasp_security_invariants.py"
      provides: "Fixed property tests for OWASP security invariants"
      exports: ["test_sql_injection_prevention", "test_xss_prevention"]
    - path: "backend/tests/property_tests/database/test_database_acid_invariants.py"
      provides: "Fixed property tests for database ACID invariants"
      exports: ["test_atomicity_all_or_nothing", "test_isolation_concurrent"]
    - path: "backend/tests/property_tests/llm/test_token_counting_invariants.py"
      provides: "Fixed property tests for token counting invariants"
      exports: ["test_token_count_accuracy", "test_cost_calculation"]
    - path: "backend/tests/property_tests/governance/test_governance_invariants.py"
      provides: "Fixed property tests for governance invariants"
      exports: ["test_action_complexity_gating", "test_maturity_permissions"]
    - path: "backend/tests/property_tests/governance/test_governance_cache_invariants.py"
      provides: "Fixed property tests for governance cache invariants"
      exports: ["test_cache_consistency", "test_invalidation_propagation"]
  key_links:
    - from: "backend/tests/property_tests/governance/test_agent_governance_invariants.py"
      to: "backend/core/agent_governance_service.py"
      via: "imports AgentGovernanceService for property testing"
      pattern: "from core.agent_governance_service import AgentGovernanceService"
    - from: "backend/tests/property_tests/llm/test_llm_streaming_invariants.py"
      to: "backend/core/llm/byok_handler.py"
      via: "imports BYOKHandler for streaming invariant testing"
      pattern: "from core.llm.byok_handler import BYOKHandler"
    - from: "backend/tests/property_tests/episodes/test_hybrid_retrieval_invariants.py"
      to: "backend/core/episode_retrieval_service.py"
      via: "imports EpisodeRetrievalService for hybrid retrieval testing"
      pattern: "from core.episode_retrieval_service import EpisodeRetrievalService"
---

<objective>
Fix Hypothesis TypeError in property tests across 10 modules.

**Problem**: Hypothesis 6.x changed strategy API. st.just() and st.sampled_from() require proper import from hypothesis.strategies. Many property tests import strategies incorrectly, causing TypeError during test collection.

**Root Cause**: Tests import `from hypothesis import strategies as st` then use `st.just()` and `st.sampled_from()`, but Hypothesis 6.x requires `from hypothesis.strategies import just, sampled_from` or proper module-level access.

**Purpose**: Ensure all property tests can run and generate diverse test cases via Hypothesis, enabling property-based testing for critical invariants (governance, LLM streaming, episodic memory, security, database ACID).

**Output**: 10 property test modules fixed with proper Hypothesis imports, all tests passing with pytest.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP_V2.md
@.planning/STATE.md
@backend/tests/property_tests/INVARIANTS.md
@backend/tests/property_tests/COMPREHENSIVE_SUMMARY.md
@backend/tests/conftest.py
@backend/core/agent_governance_service.py
@backend/core/llm/byok_handler.py
@backend/core/episode_retrieval_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Hypothesis imports in governance property tests</name>
  <files>
    backend/tests/property_tests/governance/test_agent_governance_invariants.py
    backend/tests/property_tests/governance/test_governance_invariants.py
    backend/tests/property_tests/governance/test_governance_cache_invariants.py
  </files>
  <action>
    Fix Hypothesis imports in 3 governance property test modules:

    1. **test_agent_governance_invariants.py**:
       - Change: `from hypothesis import strategies as st`
       - To: `from hypothesis import given, settings, assume, example`
       - Add: `from hypothesis.strategies import text, integers, floats, lists, sampled_from, just, dictionaries, booleans, datetimes`
       - Replace: `st.just()` with `just()`, `st.sampled_from()` with `sampled_from()`
       - Fix: `st.integers()` with `integers()`, `st.text()` with `text()`

    2. **test_governance_invariants.py**:
       - Apply same pattern: proper imports from hypothesis.strategies
       - Replace all `st.` prefix with direct strategy calls
       - Verify `@given` decorators use strategies correctly

    3. **test_governance_cache_invariants.py**:
       - Apply same pattern
       - Fix cache-related strategies (e.g., `sampled_from(cache_keys)`)

    **Why**: Hypothesis 6.x API requires proper strategy imports. The old `strategies as st` pattern causes TypeError because `st.just()` creates a strategy class, not a function.

    **Verification**: Run `pytest backend/tests/property_tests/governance/ -v` and verify all tests pass with Hypothesis generating diverse examples.
  </action>
  <verify>pytest backend/tests/property_tests/governance/ -v --tb=short</verify>
  <done>All 3 governance property test modules import Hypothesis correctly. All tests pass with example generation visible in pytest output.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Hypothesis imports in LLM and episodic memory property tests</name>
  <files>
    backend/tests/property_tests/llm/test_llm_streaming_invariants.py
    backend/tests/property_tests/llm/test_token_counting_invariants.py
    backend/tests/property_tests/episodes/test_hybrid_retrieval_invariants.py
    backend/tests/property_tests/episodes/test_agent_graduation_lifecycle.py
    backend/tests/property_tests/episodes/test_episode_lifecycle_invariants.py
  </files>
  <action>
    Fix Hypothesis imports in 5 LLM and episodic memory property test modules:

    1. **test_llm_streaming_invariants.py**:
       - Change: `from hypothesis import strategies as st`
       - To: Proper imports from `hypothesis.strategies`
       - Fix: Streaming-related strategies (text(), lists(), integers())

    2. **test_token_counting_invariants.py**:
       - Apply same pattern
       - Fix token counting strategies (integers() for token counts)

    3. **test_hybrid_retrieval_invariants.py**:
       - Apply same pattern
       - Fix retrieval-related strategies (lists(text()), sampled_from(retrieval_modes))

    4. **test_agent_graduation_lifecycle.py**:
       - Apply same pattern
       - Fix graduation strategies (sampled_from(maturity_levels), floats() for scores)

    5. **test_episode_lifecycle_invariants.py**:
       - Apply same pattern
       - Fix lifecycle strategies (datetimes() for timestamps, floats() for decay)

    **Why**: Consistent fix pattern across all modules. Ensures property tests can generate diverse test cases for LLM streaming and episodic memory invariants.

    **Verification**: Run `pytest backend/tests/property_tests/llm/ backend/tests/property_tests/episodes/ -v` and verify all tests pass.
  </action>
  <verify>pytest backend/tests/property_tests/llm/ backend/tests/property_tests/episodes/ -v --tb=short</verify>
  <done>All 5 LLM and episodic memory property test modules import Hypothesis correctly. All tests pass with diverse example generation.</done>
</task>

<task type="auto">
  <name>Task 3: Fix Hypothesis imports in security and database property tests</name>
  <files>
    backend/tests/property_tests/security/test_owasp_security_invariants.py
    backend/tests/property_tests/database/test_database_acid_invariants.py
  </files>
  <action>
    Fix Hypothesis imports in 2 security and database property test modules:

    1. **test_owasp_security_invariants.py**:
       - Change: `from hypothesis import strategies as st`
       - To: Proper imports from `hypothesis.strategies`
       - Fix: Security-related strategies (text() for injection strings, sampled_from(attack_patterns))

    2. **test_database_acid_invariants.py**:
       - Apply same pattern
       - Fix database strategies (integers() for IDs, text() for data values)
       - Ensure async test patterns work with Hypothesis

    **Why**: Security and database invariants are critical. Property tests must generate diverse malicious inputs (SQL injection, XSS) and database operations to verify invariants hold.

    **Verification**: Run `pytest backend/tests/property_tests/security/test_owasp_security_invariants.py backend/tests/property_tests/database/test_database_acid_invariants.py -v` and verify all tests pass.

    **Note**: Database tests use `@pytest.mark.asyncio` with `@given` â€” ensure decorators are in correct order (pytest.mark.asyncio first).
  </action>
  <verify>pytest backend/tests/property_tests/security/test_owasp_security_invariants.py backend/tests/property_tests/database/test_database_acid_invariants.py -v --tb=short</verify>
  <done>All 2 security and database property test modules import Hypothesis correctly. All tests pass with malicious input and database operation generation.</done>
</task>

</tasks>

<verification>
**Overall Phase Verification**:

1. Run all fixed property tests: `pytest backend/tests/property_tests/governance/ backend/tests/property_tests/llm/ backend/tests/property_tests/episodes/ backend/tests/property_tests/security/ backend/tests/property_tests/database/test_database_acid_invariants.py -v`

2. Verify zero Hypothesis TypeErrors in test output

3. Verify Hypothesis generates diverse examples (check "Falsifying example" output or Hypothesis statistics)

4. Run property tests 3 times to confirm stability: `for i in 1 2 3; do pytest backend/tests/property_tests/ -v --tb=short || exit 1; done`
</verification>

<success_criteria>
1. All 10 property test modules import Hypothesis strategies correctly (no ImportError or TypeError)

2. All property tests run successfully with pytest (zero collection errors)

3. Hypothesis generates diverse test cases (visible in pytest output with "Falsifying example" or run statistics)

4. Property tests verify critical invariants:
   - Governance: Maturity never decreases, action complexity gating works
   - LLM: Streaming chunks are non-empty, token counts match
   - Episodic Memory: Hybrid retrieval consistency, temporal precedence
   - Security: SQL injection prevention, XSS prevention
   - Database: Atomicity (all-or-nothing), isolation (concurrent transactions)

5. All tests pass consistently over 3 runs (zero flaky property tests)
</success_criteria>

<output>
After completion, create `.planning/phases/29-test-failure-fixes-quality-foundation/29-01-SUMMARY.md` with:
- Modules fixed (10 total)
- Hypothesis import pattern applied
- Test results (pass/fail counts)
- Any invariants discovered or bugs found by Hypothesis during testing
</output>
