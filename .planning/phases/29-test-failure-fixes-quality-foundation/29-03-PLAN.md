---
phase: 29-test-failure-fixes-quality-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/unit/governance/test_agent_graduation_governance.py
  - backend/core/agent_graduation_service.py
  - backend/tests/factories/__init__.py
  - backend/tests/factories/agent_factory.py
autonomous: true

must_haves:
  truths:
    - "Graduation governance tests use correct factory parameters for metadata_json"
    - "All 3 graduation governance tests pass with proper agent metadata handling"
    - "Tests verify maturity transitions, confidence thresholds, and audit logging"
  artifacts:
    - path: "backend/tests/unit/governance/test_agent_graduation_governance.py"
      provides: "Fixed graduation governance unit tests (3 tests)"
      exports: ["test_student_to_intern_transition_criteria", "test_supervision_metrics_integration", "test_promote_agent_updates_maturity_level"]
    - path: "backend/core/agent_graduation_service.py"
      provides: "AgentGraduationService with metadata handling"
      exports: ["calculate_readiness_score", "promote_agent", "validate_graduation_with_supervision"]
    - path: "backend/tests/factories/agent_factory.py"
      provides: "AgentFactory with metadata_json support"
      contains: "class AgentFactory"
  key_links:
    - from: "backend/tests/unit/governance/test_agent_graduation_governance.py"
      to: "backend/core/agent_graduation_service.py"
      via: "imports AgentGraduationService for graduation testing"
      pattern: "from core.agent_graduation_service import AgentGraduationService"
    - from: "backend/tests/unit/governance/test_agent_graduation_governance.py"
      to: "backend/tests/factories/__init__.py"
      via: "imports StudentAgentFactory, InternAgentFactory for test data"
      pattern: "from tests.factories import StudentAgentFactory, InternAgentFactory"
---

<objective>
Fix graduation governance test failures (3 tests with metadata_json factory parameter).

**Problem**: Graduation tests fail because AgentFactory doesn't accept `metadata_json` parameter, or tests use wrong field names for agent metadata.

**Root Cause**:
1. `test_promote_agent_updates_timestamp` expects agent.metadata["promoted_at"] but factory doesn't create metadata dict
2. `test_promotion_metadata_updated` expects metadata updates but field name may be wrong
3. Tests may use `metadata` instead of `configuration` for agent metadata

**Purpose**: Ensure graduation governance tests verify maturity transitions, confidence thresholds, and audit trail with proper agent metadata.

**Output**: 3 graduation governance tests passing with correct factory usage.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP_V2.md
@.planning/STATE.md
@backend/tests/unit/governance/test_agent_graduation_governance.py
@backend/core/agent_graduation_service.py
@backend/core/models.py
@backend/tests/factories/agent_factory.py
@backend/tests/factories/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix maturity level transition tests</name>
  <files>
    backend/tests/unit/governance/test_agent_graduation_governance.py
  </files>
  <action>
    Fix maturity level transition tests with correct metadata handling:

    1. **Identify the correct metadata field**:
       - Check AgentRegistry model: is it `metadata` or `configuration`?
       - Run: `grep -A 20 "class AgentRegistry" backend/core/models.py | head -30`
       - Look for JSON field definitions

    2. **Fix test_student_to_intern_transition_criteria** (line ~58):
       - Current: Uses factory without metadata
       - Fix: If test expects metadata["promoted_at"], ensure factory creates it
       - Or: Update test to use correct field name

    3. **Fix test_intern_to_supervised_transition_criteria** (line ~76):
       - Apply same pattern
       - Verify readiness score calculation works with correct metadata

    4. **Fix test_supervised_to_autonomous_transition_criteria** (line ~91):
       - Apply same pattern
       - Verify AUTONOMOUS transition criteria (0% intervention rate)

    **Why**: Graduation tests verify agents can transition between maturity levels. Metadata stores promotion history (promoted_at, promoted_by) for audit trail.

    **Code Pattern**:
    ```python
    # Check model field name first
    from core.models import AgentRegistry
    # If field is 'configuration', use:
    agent.configuration = {"promoted_at": datetime.now().isoformat()}

    # If field is 'metadata', use:
    agent.metadata = {"promoted_at": datetime.now().isoformat()}
    ```
  </action>
  <verify>pytest backend/tests/unit/governance/test_agent_graduation_governance.py::TestMaturityLevelTransitions -v --tb=short</verify>
  <done>Maturity level transition tests use correct metadata field name. All 4 transition tests pass (STUDENT->INTERN, INTERN->SUPERVISED, SUPERVISED->AUTONOMOUS, invalid level).</done>
</task>

<task type="auto">
  <name>Task 2: Fix promotion metadata and timestamp tests</name>
  <files>
    backend/tests/unit/governance/test_agent_graduation_governance.py
  </files>
  <action>
    Fix promotion metadata and timestamp tests:

    1. **test_promote_agent_updates_maturity_level** (line ~246):
       - Current: Expects agent.status to update
       - Fix: Verify both status and metadata/configuration update
       - Check db_session.refresh(agent) is called

    2. **test_promotion_metadata_updated** (line ~294):
       - Current: Expects agent.configuration["promoted_at"] and ["promoted_by"]
       - Fix: Use correct field name (configuration vs metadata)
       - Verify graduation service sets these fields

    3. **test_promote_agent_updates_timestamp** (line ~563):
       - Current: Expects agent.updated_at to increase
       - Fix: SQLAlchemy may not update updated_at for JSON field changes
       - Either: Enable onupdate for updated_at, or verify promoted_at instead

    4. **test_graduation_audit_trail** (line ~384):
       - Current: Expects audit trail with metadata
       - Fix: Ensure audit includes promotion metadata

    **Why**: Audit trail requires proper metadata tracking. Graduation promotions must log who promoted (validated_by) and when (promoted_at).

    **Code Pattern**:
    ```python
    # Verify correct field
    success = await graduation_service.promote_agent(
        agent_id=agent.id,
        new_maturity="INTERN",
        validated_by="test_user"
    )
    db_session.refresh(agent)
    # Use correct field name
    assert "promoted_at" in agent.configuration  # or agent.metadata
    assert agent.configuration["promoted_by"] == "test_user"
    ```
  </action>
  <verify>pytest backend/tests/unit/governance/test_agent_graduation_governance.py::TestPermissionMatrixValidation -v --tb=short</verify>
  <done>Permission matrix validation tests pass with correct metadata field usage. Tests verify maturity level updates and promotion metadata tracking.</done>
</task>

<task type="auto">
  <name>Task 3: Fix supervision metrics integration tests</name>
  <files>
    backend/tests/unit/governance/test_agent_graduation_governance.py
  </files>
  <action>
    Fix supervision metrics integration tests:

    1. **test_calculate_supervision_metrics** (line ~433):
       - Current: Creates SupervisedAgentFactory
       - Fix: Ensure agent has supervision sessions for metrics calculation
       - Verify metrics return all required fields (total_supervision_hours, intervention_rate, etc.)

    2. **test_supervision_metrics_with_no_sessions** (line ~459):
       - Current: Expects zero/default metrics
       - Fix: Verify intervention_rate = 1.0 (high penalty) when no data
       - Verify total_sessions = 0

    3. **test_performance_trend_calculation** (line ~475):
       - Current: Creates SupervisionSession objects manually
       - Fix: Use proper UUID generation to avoid collisions
       - Verify trend calculation (improving, stable, declining, unknown)

    4. **test_validate_with_supervision_combines_metrics** (line ~522):
       - Current: Expects combined episode + supervision metrics
       - Fix: Verify both metric sets are returned
       - Check readiness score combines both

    **Why**: Supervision metrics are critical for SUPERVISED -> AUTONOMOUS graduation. Tests must verify metrics calculation with and without supervision sessions.

    **Code Pattern**:
    ```python
    # Use unique IDs to avoid collisions
    import uuid
    session = SupervisionSession(
        id=str(uuid.uuid4()),
        agent_id=agent.id,
        agent_name=agent.name,
        supervisor_id="test_user",
        workspace_id="default",
        trigger_context={},
        status="completed",
        started_at=datetime.now(),
        duration_seconds=3600,
        intervention_count=2,
        supervisor_rating=4.5
    )
    ```
  </action>
  <verify>pytest backend/tests/unit/governance/test_agent_graduation_governance.py::TestSupervisionMetricsIntegration -v --tb=short</verify>
  <done>Supervision metrics integration tests pass with proper session creation and UUID generation. Tests verify metrics calculation, trend analysis, and combined validation.</done>
</task>

</tasks>

<verification>
**Overall Phase Verification**:

1. Run all graduation governance tests: `pytest backend/tests/unit/governance/test_agent_graduation_governance.py -v`

2. Verify all test classes pass:
   - TestMaturityLevelTransitions (4 tests)
   - TestConfidenceScoreThresholds (3 tests)
   - TestPermissionMatrixValidation (3 tests)
   - TestGraduationRequestProcessing (3 tests)
   - TestGraduationAuditLogging (3 tests)
   - TestSupervisionMetricsIntegration (3 tests)
   - TestCombinedValidation (2 tests)
   - TestEdgeCases (4 tests)

3. Verify correct metadata field name: Check if model uses `configuration` or `metadata`

4. Run tests 3 times to confirm no flaky factory behavior: `for i in 1 2 3; do pytest backend/tests/unit/governance/test_agent_graduation_governance.py -v --tb=short || exit 1; done`
</verification>

<success_criteria>
1. All 3 graduation governance test classes pass consistently (zero failures over 3 runs)

2. Tests verify actual graduation behavior:
   - Maturity transitions (STUDENT->INTERN->SUPERVISED->AUTONOMOUS)
   - Confidence score thresholds and normalization
   - Permission matrix updates and metadata tracking
   - Supervision metrics calculation and trend analysis

3. Tests use correct metadata field name (configuration or metadata)

4. Factories create agents with proper metadata for promotion tracking

5. No UUID collision issues in session or episode creation
</success_criteria>

<output>
After completion, create `.planning/phases/29-test-failure-fixes-quality-foundation/29-03-SUMMARY.md` with:
- Tests fixed (3 test classes, 22 tests total)
- Metadata field name identified (configuration vs metadata)
- Factory pattern changes
- Test results (pass/fail counts)
- Any graduation service bugs discovered during testing
</output>
