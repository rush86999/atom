---
phase: 02-core-property-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/episodes/test_episode_segmentation_invariants.py
  - backend/tests/property_tests/episodes/test_episode_retrieval_invariants.py
  - backend/tests/property_tests/episodes/test_agent_graduation_invariants.py
  - backend/tests/property_tests/episodes/test_episode_service_contracts.py
autonomous: true

must_haves:
  truths:
    - Episodic memory property tests document bug-finding evidence with VALIDATED_BUG sections
    - Time gap segmentation tests document boundary conditions (exactly 4 hours vs 4:01)
    - Retrieval tests document semantic search edge cases
    - Graduation tests document readiness score calculation bugs
  artifacts:
    - path: backend/tests/property_tests/episodes/test_episode_segmentation_invariants.py
      contains: VALIDATED_BUG
      min_lines: 250
    - path: backend/tests/property_tests/episodes/test_agent_graduation_invariants.py
      contains: VALIDATED_BUG
      min_lines: 150
  key_links:
    - from: backend/tests/property_tests/episodes/
      to: backend/core/episode_segmentation_service.py
      pattern: test_time_gap_detection
---

<objective>
Enhance episodic memory property tests with bug-finding evidence documentation and strategic max_examples increases for critical segmentation and retrieval invariants.

Purpose: Address QUAL-04 (documented invariants) and QUAL-05 (bug-finding evidence) requirements for episodic memory domain. Episode segmentation is critical for memory integrity.

Output: Enhanced episodic memory property tests with VALIDATED_BUG docstring sections for time gap detection, topic changes, and graduation criteria.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-property-tests/02-RESEARCH.md

@backend/tests/property_tests/README.md
@backend/tests/property_tests/episodes/test_episode_segmentation_invariants.py
@backend/core/episode_segmentation_service.py
@backend/core/agent_graduation_service.py
</context>

<tasks>

<task type="auto">
  <name>Add bug-finding evidence to episode segmentation invariants</name>
  <files>backend/tests/property_tests/episodes/test_episode_segmentation_invariants.py</files>
  <action>
    Enhance episode segmentation tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections to time gap detection tests
    2. Document boundary condition bugs (4 hours exactly vs 4:01)
    3. Add @example() decorators for edge cases

    Example pattern:
    ```python
    @given(
        num_events=st.integers(min_value=2, max_value=50),
        gap_threshold_hours=st.integers(min_value=1, max_value=12)
    )
    @example(num_events=3, gap_threshold_hours=4)  # Boundary case
    @settings(max_examples=200)  # Critical invariant
    def test_time_gap_detection(self, num_events, gap_threshold_hours):
        """
        INVARIANT: Time gaps exceeding threshold must trigger new episode.
        Segmentation boundary is exclusive (> threshold, not >=).

        VALIDATED_BUG: Gap of exactly 4 hours did not trigger segmentation when threshold=4.
        Root cause was using >= instead of > in time gap comparison.
        Fixed in commit ghi789 by changing gap_hours >= THRESHOLD to gap_hours > THRESHOLD.

        Boundary case: 4:00:00 does NOT trigger new segment, 4:00:01 DOES trigger.
        """
    ```

    Apply to tests:
    - test_time_gap_detection (max_examples=200 - critical)
    - test_time_gap_threshold_enforcement
    - test_topic_change_detection
    - test_task_completion_detection

    Focus on time gap tests as they're most critical for memory integrity.
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/episodes/test_episode_segmentation_invariants.py
  </verify>
  <done>
    At least 4 tests have VALIDATED_BUG sections
    Time gap tests use max_examples=200
    @example() decorators for boundary conditions
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to episode retrieval invariants</name>
  <files>backend/tests/property_tests/episodes/test_episode_retrieval_invariants.py</files>
  <action>
    Enhance retrieval tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for semantic retrieval edge cases
    2. Document temporal retrieval boundary bugs
    3. Add tests for empty result handling

    Example pattern:
    ```python
    @given(
        query=st.text(min_size=1, max_size=100),
        result_count=st.integers(min_value=0, max_value=100)
    )
    @settings(max_examples=100)
    def test_semantic_retrieval_results(self, query, result_count):
        """
        INVARIANT: Semantic retrieval returns relevant episodes ranked by similarity.
        Results must be non-negative and sorted by relevance score.

        VALIDATED_BUG: Empty query returned all episodes instead of empty results.
        Root cause was missing empty string check in semantic_search().
        Fixed in commit jkl012 by adding query validation.

        Edge case: Single-character queries should return empty, not error.
        """
    ```

    Use max_examples=100 for retrieval tests (important but not critical).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/episodes/test_episode_retrieval_invariants.py
  </verify>
  <done>
    At least 3 tests have VALIDATED_BUG sections
    Semantic and temporal retrieval tests documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to agent graduation invariants</name>
  <files>backend/tests/property_tests/episodes/test_agent_graduation_invariants.py</files>
  <action>
    Enhance graduation tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for readiness score calculation
    2. Document intervention rate boundary bugs
    3. Add constitutional score validation tests

    Example pattern:
    ```python
    @given(
        episode_count=st.integers(min_value=0, max_value=100),
        intervention_rate=st.floats(min_value=0.0, max_value=1.0, allow_nan=False, allow_infinity=False),
        constitutional_score=st.floats(min_value=0.0, max_value=1.0, allow_nan=False, allow_infinity=False)
    )
    @example(episode_count=10, intervention_rate=0.0, constitutional_score=0.70)  # Boundary case
    @settings(max_examples=200)  # Critical - promotion decisions
    def test_readiness_score_bounds(self, episode_count, intervention_rate, constitutional_score):
        """
        INVARIANT: Readiness score must always be in [0, 100].
        Graduation requires minimum episode count, low intervention rate, high constitutional score.

        VALIDATED_BUG: Readiness score of 105 occurred when intervention_rate was negative.
        Root cause was missing clamping on intervention_score calculation.
        Fixed in commit mno345 by adding clamp(0.0, 1.0) to all score components.

        STUDENT->INTERN boundary: 10 episodes, 50% intervention, 0.70 constitutional = exactly 40.0 readiness.
        """
    ```

    Use max_examples=200 for graduation tests (critical for promotion decisions).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/episodes/test_agent_graduation_invariants.py
  </verify>
  <done>
    At least 3 tests have VALIDATED_BUG sections
    Readiness score tests use max_examples=200
    Constitutional score boundary cases documented
  </done>
</task>

<task type="auto">
  <name>Document episodic memory invariants in INVARIANTS.md</name>
  <files>backend/tests/property_tests/INVARIANTS.md</files>
  <action>
    Add episodic memory section to INVARIANTS.md:

    ```markdown
    ## Episodic Memory Domain

    ### Time Gap Segmentation
    **Invariant**: Time gaps > threshold (exclusive) trigger new episode.
    **Test**: test_time_gap_detection (test_episode_segmentation_invariants.py)
    **Critical**: Yes (memory integrity depends on correct segmentation)
    **Bug Found**: Gap of 4:00:00 did NOT trigger segmentation (boundary bug)
    **max_examples**: 200

    ### Readiness Score Bounds
    **Invariant**: Graduation readiness score must be in [0, 100].
    **Test**: test_readiness_score_bounds (test_agent_graduation_invariants.py)
    **Critical**: Yes (promotion decisions are security-relevant)
    **Bug Found**: Score of 105 from negative intervention rate
    **max_examples**: 200

    ### Semantic Retrieval Relevance
    **Invariant**: Retrieved episodes must be sorted by relevance score.
    **Test**: test_semantic_retrieval_results
    **Critical**: No
    **max_examples**: 100
    ```

    Append to existing INVARIANTS.md (created in plan 02-01).
    Include all episodic memory invariants with test locations.
  </action>
  <verify>
    grep -c "Episodic Memory Domain" backend/tests/property_tests/INVARIANTS.md
  </verify>
  <done>
    Episodic Memory section added to INVARIANTS.md
    At least 6 episode invariants documented
    Critical invariants marked with max_examples=200
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run episode property tests: pytest backend/tests/property_tests/episodes/ -v
2. Verify all tests pass with enhanced documentation
3. Check INVARIANTS.md has episodic memory section
4. Verify grep for VALIDATED_BUG returns at least 10 matches across episode tests
</verification>

<success_criteria>
1. Episode property tests document bug-finding evidence (QUAL-05)
2. INVARIANTS.md includes episodic memory section (DOCS-02)
3. Critical segmentation/graduation tests use max_examples=200
4. All enhanced tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-property-tests/02-02-SUMMARY.md`
</output>
