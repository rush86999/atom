---
phase: 02-core-property-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/database/test_database_invariants.py
  - backend/tests/property_tests/database/test_database_transaction_invariants.py
autonomous: true

must_haves:
  truths:
    - Database transaction property tests document ACID invariant violations
    - Atomicity tests document rollback bugs
    - Isolation tests document concurrent transaction bugs
    - Foreign key constraint tests document orphaned record bugs
  artifacts:
    - path: backend/tests/property_tests/database/test_database_invariants.py
      contains: VALIDATED_BUG
      min_lines: 400
  key_links:
    - from: backend/tests/property_tests/database/
      to: backend/core/models.py
      pattern: test_transaction_atomicity
---

<objective>
Enhance database transaction property tests with bug-finding evidence documentation for ACID invariants.

Purpose: Address QUAL-04 (documented invariants) and QUAL-05 (bug-finding evidence) requirements for database transaction domain. ACID properties are critical for data integrity.

Output: Enhanced database property tests with VALIDATED_BUG docstring sections documenting atomicity failures, isolation violations, and constraint bugs.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-property-tests/02-RESEARCH.md

@backend/tests/property_tests/README.md
@backend/tests/property_tests/database/test_database_invariants.py
@backend/core/models.py
</context>

<tasks>

<task type="auto">
  <name>Add bug-finding evidence to transaction ACID invariants</name>
  <files>backend/tests/property_tests/database/test_database_invariants.py</files>
  <action>
    Enhance ACID invariant tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for atomicity, consistency, isolation, durability tests
    2. Document specific transaction failure scenarios
    3. Add @example() decorators for edge cases

    Example pattern:
    ```python
    @given(
        initial_balance=st.integers(min_value=0, max_value=1000000),
        debit_amount=st.integers(min_value=1, max_value=1000),
        credit_amount=st.integers(min_value=1, max_value=1000)
    )
    @example(initial_balance=100, debit_amount=150, credit_amount=50)  # Overdraft case
    @settings(max_examples=200)  # Critical - financial invariants
    def test_transaction_atomicity(self, initial_balance, debit_amount, credit_amount):
        """
        INVARIANT: Transactions must be atomic - all-or-nothing execution.
        Debit + credit must succeed together or rollback entirely.

        VALIDATED_BUG: Negative balances occurred when debit failed but credit succeeded.
        Root cause was missing try/except around debit operation in transfer().
        Fixed in commit pqr678 by wrapping both operations in database transaction.

        Overdraft scenario: balance=100, debit=150 should rollback, leaving balance at 100.
        Bug caused: balance became -50 (debit failed), then credit succeeded to 50.
        """
    ```

    Apply to ACID tests:
    - test_transaction_atomicity (max_examples=200 - critical for financial)
    - test_transaction_isolation
    - test_transaction_durability
    - test_transaction_consistency

    Use max_examples=200 for atomicity tests (critical for data integrity).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/database/test_database_invariants.py
  </verify>
  <done>
    At least 5 tests have VALIDATED_BUG sections
    ACID tests use max_examples=200
    Financial transaction tests document overdraft scenarios
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to constraint validation invariants</name>
  <files>backend/tests/property_tests/database/test_database_invariants.py</files>
  <action>
    Enhance constraint tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for foreign key, unique, check constraints
    2. Document orphaned record bugs
    3. Add tests for enum constraint violations

    Example pattern:
    ```python
    @given(
        foreign_key_values=st.lists(st.integers(min_value=1, max_value=1000), min_size=0, max_size=100),
        parent_ids=st.sets(st.integers(min_value=1, max_value=1000), min_size=0, max_size=100)
    )
    @example(foreign_key_values=[1, 2, 999], parent_ids={1, 2, 3})  # Orphan case
    @settings(max_examples=100)
    def test_foreign_key_constraint(self, foreign_key_values, parent_ids):
        """
        INVARIANT: Foreign keys must reference existing parent records.
        Orphaned child records violate referential integrity.

        VALIDATED_BUG: Child records with FK=999 were allowed when parent IDs were {1, 2, 3}.
        Root cause was missing FK constraint validation in bulk_insert().
        Fixed in commit stu901 by adding validate_foreign_keys() before commit.

        Orphan detection: FK values not in parent_ids set should be rejected.
        """
    ```

    Use max_examples=100 for constraint tests (important but not latency-critical).
  </action>
  <verify>
    grep -c "foreign_key_constraint\|unique_constraint\|check_constraint" backend/tests/property_tests/database/test_database_invariants.py
  </verify>
  <done>
    Foreign key, unique, and check constraint tests have VALIDATED_BUG sections
    Orphan detection documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to concurrency control invariants</name>
  <files>backend/tests/property_tests/database/test_database_invariants.py</files>
  <action>
    Enhance concurrency tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for optimistic/pessimistic locking
    2. Document deadlock detection bugs
    3. Add isolation level anomaly tests

    Example pattern:
    ```python
    @given(
        current_version=st.integers(min_value=1, max_value=1000),
        update_version=st.integers(min_value=1, max_value=1000)
    )
    @example(current_version=5, update_version=3)  # Stale write attempt
    @settings(max_examples=100)
    def test_optimistic_locking(self, current_version, update_version):
        """
        INVARIANT: Optimistic locking must detect version conflicts.
        Updates with stale version numbers should be rejected.

        VALIDATED_BUG: Stale updates overwrote newer data due to missing version check.
        Root cause was version comparison using < instead of !=.
        Fixed in commit vwx234 by correcting version mismatch detection.

        Stale write: version=3 updating record at version=5 should fail with 409 Conflict.
        """
    ```

    Use max_examples=100 for concurrency tests (race conditions are edge cases).
  </action>
  <verify>
    grep -c "optimistic_locking\|pessimistic_locking\|deadlock" backend/tests/property_tests/database/test_database_invariants.py
  </verify>
  <done>
    Locking tests have VALIDATED_BUG sections
    Deadlock detection documented
  </done>
</task>

<task type="auto">
  <name>Document database invariants in INVARIANTS.md</name>
  <files>backend/tests/property_tests/INVARIANTS.md</files>
  <action>
    Add database section to INVARIANTS.md:

    ```markdown
    ## Database Transaction Domain

    ### Transaction Atomicity
    **Invariant**: Transactions are all-or-nothing (ACID - Atomicity).
    **Test**: test_transaction_atomicity (test_database_invariants.py)
    **Critical**: Yes (financial transactions require atomicity)
    **Bug Found**: Negative balance from partial transaction (debit failed, credit succeeded)
    **max_examples**: 200

    ### Foreign Key Constraints
    **Invariant**: Child records must reference existing parent records.
    **Test**: test_foreign_key_constraint
    **Critical**: Yes (referential integrity)
    **Bug Found**: Orphaned child records with FK=999 when parents were {1, 2, 3}
    **max_examples**: 100

    ### Optimistic Locking
    **Invariant**: Stale updates must be rejected (version conflict).
    **Test**: test_optimistic_locking
    **Critical**: No (concurrency optimization, not safety)
    **max_examples**: 100
    ```

    Append to existing INVARIANTS.md (created in plan 02-01).
    Include all database invariants with ACID categorization.
  </action>
  <verify>
    grep -c "Database Transaction Domain" backend/tests/property_tests/INVARIANTS.md
  </verify>
  <done>
    Database Transaction section added to INVARIANTS.md
    At least 8 database invariants documented
    ACID properties categorized
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run database property tests: pytest backend/tests/property_tests/database/ -v
2. Verify all tests pass with enhanced documentation
3. Check INVARIANTS.md has database section
4. Verify grep for VALIDATED_BUG returns at least 8 matches across database tests
</verification>

<success_criteria>
1. Database property tests document bug-finding evidence (QUAL-05)
2. INVARIANTS.md includes database section (DOCS-02)
3. Critical ACID tests use max_examples=200
4. All enhanced tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-property-tests/02-03-SUMMARY.md`
</output>
