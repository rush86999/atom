---
phase: 02-core-property-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/api/test_api_contracts_invariants.py
  - backend/tests/property_tests/api/test_api_response_invariants.py
  - backend/tests/property_tests/api/test_api_governance_invariants.py
autonomous: true

must_haves:
  truths:
    - API contract property tests document request/response validation bugs
    - Status code tests document error handling edge cases
    - Pagination tests document offset/size calculation bugs
    - Rate limiting tests document throttling boundary bugs
  artifacts:
    - path: backend/tests/property_tests/api/test_api_contracts_invariants.py
      contains: VALIDATED_BUG
      min_lines: 200
  key_links:
    - from: backend/tests/property_tests/api/
      to: backend/api/
      pattern: test_request_validation
---

<objective>
Enhance API contract property tests with bug-finding evidence documentation for request validation, response formats, and error handling.

Purpose: Address QUAL-04 (documented invariants) and QUAL-05 (bug-finding evidence) requirements for API contract domain. API contracts define external interfaces.

Output: Enhanced API property tests with VALIDATED_BUG docstring sections for validation, status codes, and pagination invariants.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-property-tests/02-RESEARCH.md

@backend/tests/property_tests/README.md
@backend/tests/property_tests/api/test_api_contracts_invariants.py
@backend/core/atom_agent_endpoints.py
</context>

<tasks>

<task type="auto">
  <name>Add bug-finding evidence to request validation invariants</name>
  <files>backend/tests/property_tests/api/test_api_contracts_invariants.py</files>
  <action>
    Enhance request validation tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for required field validation
    2. Document type coercion bugs (string "123" to int 123)
    3. Add @example() decorators for malformed input

    Example pattern:
    ```python
    @given(
        request_body=st.dictionaries(st.text(), st.one_of(st.text(), st.integers()), min_size=0, max_size=20),
        required_fields=st.sets(st.text(), min_size=1, max_size=5)
    )
    @example(request_body={}, required_fields={'name', 'email'})  # Missing all required
    @settings(max_examples=100)
    def test_required_fields_validation(self, request_body, required_fields):
        """
        INVARIANT: Required fields must be present in request body.
        Missing required fields should return 400 with field names.

        VALIDATED_BUG: Requests with empty dict {} were accepted when fields were optional.
        Root cause was incorrect has_fields() logic returning True for empty input.
        Fixed in commit yza345 by adding explicit empty check.

        Empty body should return 400: {"error": "Missing required fields: name, email"}
        """
    ```

    Use max_examples=100 for validation tests (IO-bound, not critical).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/api/test_api_contracts_invariants.py
  </verify>
  <done>
    At least 3 validation tests have VALIDATED_BUG sections
    Required field, type, and length validation documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to response format invariants</name>
  <files>backend/tests/property_tests/api/test_api_response_invariants.py</files>
  <action>
    Enhance response format tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for response structure consistency
    2. Document timestamp format bugs (timezone issues)
    3. Add pagination metadata validation tests

    Example pattern:
    ```python
    @given(
        page=st.integers(min_value=1, max_value=1000),
        page_size=st.integers(min_value=1, max_value=1000),
        total_items=st.integers(min_value=0, max_value=100000)
    )
    @example(page=5, page_size=10, total_items=45)  # Last page edge case
    @settings(max_examples=100)
    def test_pagination_response_format(self, page, page_size, total_items):
        """
        INVARIANT: Paginated responses must include consistent metadata.
        total_pages, has_next, has_prev must be calculable from page/page_size/total.

        VALIDATED_BUG: Last page returned has_next=true when page=5, total_items=45, page_size=10.
        Root cause was has_next calculation using > instead of >= for remaining items.
        Fixed in commit bcd456 by correcting boundary check.

        Last page calculation: total_pages=(45+9)//10=5, so page 5 should have has_next=false.
        """
    ```

    Use max_examples=100 for response tests (IO-bound).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/api/test_api_response_invariants.py
  </verify>
  <done>
    At least 3 response tests have VALIDATED_BUG sections
    Pagination and timestamp bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to error handling invariants</name>
  <files>backend/tests/property_tests/api/test_api_governance_invariants.py</files>
  <action>
    Enhance error handling tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for status code invariants
    2. Document error response format consistency
    3. Add governance-specific error tests (permission denied, unauthorized)

    Example pattern:
    ```python
    @given(
        status_code=st.integers(min_value=100, max_value=599),
        response_body=st.dictionaries(st.text(), st.text(), min_size=0, max_size=10)
    )
    @example(status_code=401, response_body={})  # Missing error detail
    @settings(max_examples=100)
    def test_error_response_format(self, status_code, response_body):
        """
        INVARIANT: Error responses (4xx, 5xx) must include error_code and message.
        Format: {"error": str, "message": str, "error_code": str}

        VALIDATED_BUG: 401 responses returned without error_code field.
        Root cause was auth error handler returning dict instead of ErrorResponse model.
        Fixed in commit efg789 by using ErrorResponsemodel for all auth failures.

        401 Unauthorized must include: {"error_code": "UNAUTHORIZED", "message": "..."}
        """
    ```

    Use max_examples=100 for error tests (IO-bound).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/api/test_api_governance_invariants.py
  </verify>
  <done>
    At least 3 error handling tests have VALIDATED_BUG sections
    Status code and error format bugs documented
  </done>
</task>

<task type="auto">
  <name>Document API contract invariants in INVARIANTS.md</name>
  <files>backend/tests/property_tests/INVARIANTS.md</files>
  <action>
    Add API contract section to INVARIANTS.md:

    ```markdown
    ## API Contract Domain

    ### Required Fields Validation
    **Invariant**: Required fields must be present in request body.
    **Test**: test_required_fields_validation (test_api_contracts_invariants.py)
    **Critical**: No (API returns 400, not a safety issue)
    **Bug Found**: Empty dict {} accepted when validation logic inverted
    **max_examples**: 100

    ### Pagination Metadata
    **Invariant**: Paginated responses include total_pages, has_next, has_prev.
    **Test**: test_pagination_response_format
    **Critical**: No (UI issue if wrong, not safety)
    **Bug Found**: Last page returned has_next=true
    **max_examples**: 100

    ### Error Response Format
    **Invariant**: Error responses (4xx/5xx) include error_code and message.
    **Test**: test_error_response_format (test_api_governance_invariants.py)
    **Critical**: No (clients can parse errors, but not safety)
    **Bug Found**: 401 responses missing error_code field
    **max_examples**: 100
    ```

    Append to existing INVARIANTS.md (created in plan 02-01).
    Include all API contract invariants with test locations.
  </action>
  <verify>
    grep -c "API Contract Domain" backend/tests/property_tests/INVARIANTS.md
  </verify>
  <done>
    API Contract section added to INVARIANTS.md
    At least 6 API invariants documented
    Request validation and error format invariants included
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run API property tests: pytest backend/tests/property_tests/api/ -v
2. Verify all tests pass with enhanced documentation
3. Check INVARIANTS.md has API contract section
4. Verify grep for VALIDATED_BUG returns at least 9 matches across API tests
</verification>

<success_criteria>
1. API property tests document bug-finding evidence (QUAL-05)
2. INVARIANTS.md includes API contract section (DOCS-02)
3. Validation and error tests use max_examples=100
4. All enhanced tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-property-tests/02-04-SUMMARY.md`
</output>
