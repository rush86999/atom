---
phase: 02-core-property-tests
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/event_handling/test_event_handling_invariants.py
  - backend/tests/property_tests/event_handling/test_event_streaming_invariants.py
autonomous: true

must_haves:
  truths:
    - Event handling property tests document ordering invariants
    - Event emission tests document payload size validation bugs
    - Event batching tests document timeout boundary bugs
    - Dead letter queue tests document retry limit bugs
  artifacts:
    - path: backend/tests/property_tests/event_handling/test_event_handling_invariants.py
      contains: VALIDATED_BUG
      min_lines: 300
  key_links:
    - from: backend/tests/property_tests/event_handling/
      to: backend/core/
      pattern: test_chronological_ordering
---

<objective>
Enhance event handling property tests with bug-finding evidence documentation for ordering, batching, and delivery guarantee invariants.

Purpose: Address QUAL-04 (documented invariants) and QUAL-05 (bug-finding evidence) requirements for event handling domain. Event ordering affects workflow execution.

Output: Enhanced event property tests with VALIDATED_BUG docstring sections for ordering, batching, and DLQ invariants.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-property-tests/02-RESEARCH.md

@backend/tests/property_tests/README.md
@backend/tests/property_tests/event_handling/test_event_handling_invariants.py
</context>

<tasks>

<task type="auto">
  <name>Add bug-finding evidence to event ordering invariants</name>
  <files>backend/tests/property_tests/event_handling/test_event_handling_invariants.py</files>
  <action>
    Enhance event ordering tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for chronological ordering bugs
    2. Document sequence number gaps
    3. Add @example() decorators for out-of-order events

    Example pattern:
    ```python
    @given(
        event_timestamps=st.lists(st.integers(min_value=0, max_value=1000000), min_size=0, max_size=100)
    )
    @example(event_timestamps=[1000, 500, 2000])  # Out of order
    @settings(max_examples=100)
    def test_chronological_ordering(self, event_timestamps):
        """
        INVARIANT: Events should be ordered chronologically.
        Event processing must respect timestamp ordering regardless of arrival order.

        VALIDATED_BUG: Events arrived out-of-order were processed in arrival order.
        Root cause was missing sort step before event processing.
        Fixed in commit qrs789 by adding sort_by_timestamp() before processing.

        Out-of-order arrival: [1000, 500, 2000] should process as [500, 1000, 2000].
        Bug caused processing order [1000, 500, 2000] (incorrect causal dependencies).
        """
    ```

    Use max_examples=100 for ordering tests (ordering bugs are rare but critical).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/event_handling/test_event_handling_invariants.py
  </verify>
  <done>
    At least 3 ordering tests have VALIDATED_BUG sections
    Chronological and sequence ordering bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to event batching invariants</name>
  <files>backend/tests/property_tests/event_handling/test_event_handling_invariants.py</files>
  <action>
    Enhance batching tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for batch size calculation bugs
    2. Document timeout boundary bugs
    3. Add memory limit tests

    Example pattern:
    ```python
    @given(
        event_count=st.integers(min_value=0, max_value=10000),
        batch_size=st.integers(min_value=10, max_value=1000)
    )
    @example(event_count=1005, batch_size=100)  # Exact multiple + remainder
    @settings(max_examples=100)
    def test_batch_size(self, event_count, batch_size):
        """
        INVARIANT: Events should be batched correctly with remainder handling.
        Last batch may be partial but must not be empty.

        VALIDATED_BUG: Last batch was empty when event_count was exact multiple of batch_size.
        Root cause was off-by-one in remainder calculation (event_count % batch_size == 0).
        Fixed in commit tuv012 by adding last_batch_non_empty check.

        Exact multiple: 1000 events, batch_size=100 should produce 10 batches, not 10 + empty.
        """
    ```

    Use max_examples=100 for batching tests (performance optimization).
  </action>
  <verify>
    grep -c "batch" backend/tests/property_tests/event_handling/test_event_handling_invariants.py | head -5
  </verify>
  <done>
    Batching tests have VALIDATED_BUG sections
    Batch size and timeout bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to dead letter queue invariants</name>
  <files>backend/tests/property_tests/event_handling/test_event_handling_invariants.py</files>
  <action>
    Enhance DLQ tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for retry limit bugs
    2. Document retention policy bugs
    3. Add categorization tests

    Example pattern:
    ```python
    @given(
        retry_count=st.integers(min_value=0, max_value=10),
        max_retries=st.integers(min_value=1, max_value=10)
    )
    @example(retry_count=3, max_retries=3)  # Boundary case
    @settings(max_examples=100)
    def test_dlq_retry(self, retry_count, max_retries):
        """
        INVARIANT: Events exceeding max_retries should move to DLQ permanently.
        retry_count >= max_retries means no more retries (manual intervention required).

        VALIDATED_BUG: Events with retry_count=3 were retried when max_retries=3.
        Root cause was using >= instead of > for retry limit check.
        Fixed in commit wxy345 by changing to retry_count > max_retries.

        Boundary: retry_count=max_retries should go to DLQ, not retry again.
        """
    ```

    Use max_examples=100 for DLQ tests (error handling is edge case).
  </action>
  <verify>
    grep -c "dlq\|retry" backend/tests/property_tests/event_handling/test_event_handling_invariants.py | head -5
  </verify>
  <done>
    DLQ tests have VALIDATED_BUG sections
    Retry limit and retention bugs documented
  </done>
</task>

<task type="auto">
  <name>Document event handling invariants in INVARIANTS.md</name>
  <files>backend/tests/property_tests/INVARIANTS.md</files>
  <action>
    Add event handling section to INVARIANTS.md:

    ```markdown
    ## Event Handling Domain

    ### Chronological Ordering
    **Invariant**: Events must be processed in timestamp order.
    **Test**: test_chronological_ordering (test_event_handling_invariants.py)
    **Critical**: Yes (workflow correctness depends on ordering)
    **Bug Found**: Out-of-order events processed in arrival order
    **max_examples**: 100

    ### Event Batching
    **Invariant**: Events batched by size, last batch may be partial but not empty.
    **Test**: test_batch_size
    **Critical**: No (performance optimization)
    **Bug Found**: Empty last batch when event_count exact multiple of batch_size
    **max_examples**: 100

    ### DLQ Retry Limit
    **Invariant**: Events exceeding max_retries move to DLQ permanently.
    **Test**: test_dlq_retry
    **Critical**: No (manual intervention available)
    **Bug Found**: retry_count=3 retried when max_retries=3 (off-by-one)
    **max_examples**: 100
    ```

    Append to existing INVARIANTS.md (created in plan 02-01).
    Include all event handling invariants.
  </action>
  <verify>
    grep -c "Event Handling Domain" backend/tests/property_tests/INVARIANTS.md
  </verify>
  <done>
    Event Handling section added to INVARIANTS.md
    At least 6 event invariants documented
    Ordering, batching, and DLQ invariants included
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run event handling property tests: pytest backend/tests/property_tests/event_handling/ -v
2. Verify all tests pass with enhanced documentation
3. Check INVARIANTS.md has event handling section
4. Verify grep for VALIDATED_BUG returns at least 7 matches across event tests
</verification>

<success_criteria>
1. Event property tests document bug-finding evidence (QUAL-05)
2. INVARIANTS.md includes event handling section (DOCS-02)
3. Event tests use max_examples=100
4. All enhanced tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-property-tests/02-06-SUMMARY.md`
</output>
