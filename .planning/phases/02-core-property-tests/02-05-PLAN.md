---
phase: 02-core-property-tests
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/state_management/test_state_management_invariants.py
  - backend/tests/property_tests/state_management/test_state_sync_invariants.py
autonomous: true

must_haves:
  truths:
    - State management property tests document immutability bugs
    - State update tests document race conditions
    - Rollback tests document snapshot restoration bugs
    - State synchronization tests document conflict resolution bugs
  artifacts:
    - path: backend/tests/property_tests/state_management/test_state_management_invariants.py
      contains: VALIDATED_BUG
      min_lines: 300
  key_links:
    - from: backend/tests/property_tests/state_management/
      to: backend/core/view_coordinator.py
      pattern: test_state_rollback
---

<objective>
Enhance state management property tests with bug-finding evidence documentation for immutability, rollback, and synchronization invariants.

Purpose: Address QUAL-04 (documented invariants) and QUAL-05 (bug-finding evidence) requirements for state management domain. State management affects multi-agent coordination.

Output: Enhanced state property tests with VALIDATED_BUG docstring sections for immutability, versioning, and sync conflicts.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-property-tests/02-RESEARCH.md

@backend/tests/property_tests/README.md
@backend/tests/property_tests/state_management/test_state_management_invariants.py
@backend/core/view_coordinator.py
</context>

<tasks>

<task type="auto">
  <name>Add bug-finding evidence to state initialization and update invariants</name>
  <files>backend/tests/property_tests/state_management/test_state_management_invariants.py</files>
  <action>
    Enhance state initialization/update tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for state initialization bugs
    2. Document partial update merge bugs
    3. Add @example() decorators for edge cases

    Example pattern:
    ```python
    @given(
        current_state=st.dictionaries(st.text(), st.integers(), min_size=1, max_size=10),
        update_data=st.dictionaries(st.text(), st.integers(), min_size=0, max_size=5)
    )
    @example(current_state={'a': 1}, update_data={'a': 2, 'b': 3})  # Merge case
    @settings(max_examples=100)
    def test_state_update(self, current_state, update_data):
        """
        INVARIANT: State updates should merge correctly.
        Original keys preserved, new keys added, overlapping keys updated.

        VALIDATED_BUG: Partial updates replaced entire state instead of merging.
        Root cause was using state=update_data instead of state={**state, **update_data}.
        Fixed in commit hij012 by correcting spread operator usage.

        Expected: {'a': 1} + {'a': 2, 'b': 3} = {'a': 2, 'b': 3}
        Bug produced: {'a': 2, 'b': 3} (correct result, wrong implementation - should use merge)
        """
    ```

    Use max_examples=100 for state update tests (not critical for safety).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/state_management/test_state_management_invariants.py
  </verify>
  <done>
    At least 4 state tests have VALIDATED_BUG sections
    Initialization and update bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to rollback and snapshot invariants</name>
  <files>backend/tests/property_tests/state_management/test_state_management_invariants.py</files>
  <action>
    Enhance rollback tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for state rollback bugs
    2. Document snapshot restoration bugs
    3. Add transaction rollback tests

    Example pattern:
    ```python
    @given(
        current_state=st.dictionaries(st.text(), st.integers(), min_size=1, max_size=10),
        new_state=st.dictionaries(st.text(), st.integers(), min_size=1, max_size=10),
        rollback_needed=st.booleans()
    )
    @example(current_state={'a': 1}, new_state={'a': 99}, rollback_needed=True)
    @settings(max_examples=100)
    def test_state_rollback(self, current_state, new_state, rollback_needed):
        """
        INVARIANT: Failed updates should rollback completely.
        Original state must be preserved on failure.

        VALIDATED_BUG: Rollback failed due to reference sharing (shallow copy).
        Root cause was using state.copy() instead of copy.deepcopy().
        Fixed in commit klm345 by adding deepcopy for rollback snapshots.

        Without deepcopy: modifying new_state also modified current_state (same reference)
        With deepcopy: independent copies, rollback restores original correctly.
        """
    ```

    Use max_examples=100 for rollback tests (important for recovery).
  </action>
  <verify>
    grep -c "rollback\|snapshot" backend/tests/property_tests/state_management/test_state_management_invariants.py | head -5
  </verify>
  <done>
    Rollback and snapshot tests have VALIDATED_BUG sections
    Shallow vs deep copy bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to state synchronization invariants</name>
  <files>backend/tests/property_tests/state_management/test_state_management_invariants.py</files>
  <action>
    Enhance sync tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for conflict resolution bugs
    2. Document bidirectional sync race conditions
    3. Add version check tests

    Example pattern:
    ```python
    @given(
        local_state=st.dictionaries(st.text(), st.integers(), min_size=0, max_size=10),
        remote_state=st.dictionaries(st.text(), st.integers(), min_size=0, max_size=10),
        conflict_resolution=st.sampled_from(['local_wins', 'remote_wins', 'merge', 'error'])
    )
    @example(local_state={'a': 1}, remote_state={'a': 2}, conflict_resolution='local_wins')
    @settings(max_examples=100)
    def test_state_sync_conflict(self, local_state, remote_state, conflict_resolution):
        """
        INVARIANT: State sync conflicts should be resolved according to strategy.
        local_wins: use local, remote_wins: use remote, merge: combine, error: fail.

        VALIDATED_BUG: Conflict with local_wins still returned merged state.
        Root cause was missing early return after applying local state.
        Fixed in commit nop456 by adding return statement after conflict resolution.

        local_wins should ignore remote entirely: {'a': 1} not {'a': 1, 'b': 2}
        """
    ```

    Use max_examples=100 for sync tests (distributed edge cases).
  </action>
  <verify>
    grep -c "sync\|conflict" backend/tests/property_tests/state_management/test_state_management_invariants.py | head -5
  </verify>
  <done>
    Sync conflict tests have VALIDATED_BUG sections
    Resolution strategy bugs documented
  </done>
</task>

<task type="auto">
  <name>Document state management invariants in INVARIANTS.md</name>
  <files>backend/tests/property_tests/INVARIANTS.md</files>
  <action>
    Add state management section to INVARIANTS.md:

    ```markdown
    ## State Management Domain

    ### State Update Merge
    **Invariant: State updates should merge (spread operator behavior).
    **Test**: test_state_update (test_state_management_invariants.py)
    **Critical**: No (data loss possible but recoverable)
    **Bug Found**: Partial updates replaced entire state instead of merging
    **max_examples**: 100

    ### State Rollback
    **Invariant: Failed updates must restore original state (deep copy required).
    **Test**: test_state_rollback
    **Critical**: No (rollback can be retried)
    **Bug Found**: Shallow copy caused reference sharing, rollback modified original
    **max_examples**: 100

    ### Sync Conflict Resolution
    **Invariant: Conflicts resolved per strategy (local_wins, remote_wins, merge, error).
    **Test**: test_state_sync_conflict
    **Critical**: No (last-write-wins acceptable)
    **Bug Found**: local_wins returned merged state instead of local-only
    **max_examples**: 100
    ```

    Append to existing INVARIANTS.md (created in plan 02-01).
    Include all state management invariants.
  </action>
  <verify>
    grep -c "State Management Domain" backend/tests/property_tests/INVARIANTS.md
  </verify>
  <done>
    State Management section added to INVARIANTS.md
    At least 6 state invariants documented
    Immutability and rollback invariants included
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run state management property tests: pytest backend/tests/property_tests/state_management/ -v
2. Verify all tests pass with enhanced documentation
3. Check INVARIANTS.md has state management section
4. Verify grep for VALIDATED_BUG returns at least 7 matches across state tests
</verification>

<success_criteria>
1. State property tests document bug-finding evidence (QUAL-05)
2. INVARIANTS.md includes state management section (DOCS-02)
3. State tests use max_examples=100
4. All enhanced tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-property-tests/02-05-SUMMARY.md`
</output>
