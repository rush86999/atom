---
phase: 02-core-property-tests
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/tests/property_tests/file_operations/test_file_operations_invariants.py
  - backend/tests/property_tests/file_operations/test_file_security_invariants.py
autonomous: true

must_haves:
  truths:
    - File operations property tests document path traversal bugs
    - File permission tests document access control bugs
    - File size validation tests document overflow bugs
    - File locking tests document deadlock bugs
  artifacts:
    - path: backend/tests/property_tests/file_operations/test_file_operations_invariants.py
      contains: VALIDATED_BUG
      min_lines: 400
  key_links:
    - from: backend/tests/property_tests/file_operations/
      to: backend/tools/
      pattern: test_path_traversal_check
---

<objective>
Enhance file operations property tests with bug-finding evidence documentation for path validation, permissions, and security invariants.

Purpose: Address QUAL-04 (documented invariants) and QUAL-05 (bug-finding evidence) requirements for file operations domain. File security is critical for system safety.

Output: Enhanced file property tests with VALIDATED_BUG docstring sections for path traversal, permissions, and access control bugs.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-property-tests/02-RESEARCH.md

@backend/tests/property_tests/README.md
@backend/tests/property_tests/file_operations/test_file_operations_invariants.py
@backend/tools/browser_tool.py
@backend/tools/device_tool.py
</context>

<tasks>

<task type="auto">
  <name>Add bug-finding evidence to path validation invariants</name>
  <files>backend/tests/property_tests/file_operations/test_file_operations_invariants.py</files>
  <action>
    Enhance path validation tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for path traversal bugs
    2. Document symlink attack bugs
    3. Add @example() decorators for malicious paths

    Example pattern:
    ```python
    @given(
        file_path=st.text(min_size=1, max_size=300, alphabet='abcDEF0123456789-_./'),
        allowed_directories=st.sets(st.text(min_size=1, max_size=100), min_size=1, max_size=10)
    )
    @example(file_path='../../../etc/passwd', allowed_directories={'/uploads'})
    @settings(max_examples=200)  # Critical - security invariant
    def test_path_traversal_check(self, file_path, allowed_directories):
        """
        INVARIANT: Paths should be validated for traversal attacks.
        ../ patterns, encoded sequences (%2e%2e), and absolute paths must be blocked.

        VALIDATED_BUG: Path traversal with ../ was not detected when path started with allowed directory.
        Root cause was checking prefix before normalizing/decoding path.
        Fixed in commit yza678 by normalizing path before validation.

        Attack: /uploads/../../../etc/passwd passed /uploads prefix check.
        After fix: normalized to /etc/passwd, correctly rejected.
        """
    ```

    Use max_examples=200 for path security tests (critical for system safety).
  </action>
  <verify>
    grep -c "VALIDATED_BUG" backend/tests/property_tests/file_operations/test_file_operations_invariants.py
  </verify>
  <done>
    At least 4 path security tests have VALIDATED_BUG sections
    Path traversal and symlink bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to file permission invariants</name>
  <files>backend/tests/property_tests/file_operations/test_file_operations_invariants.py</files>
  <action>
    Enhance permission tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for permission check bugs
    2. Document Unix permission parsing bugs
    3. Add ownership validation tests

    Example pattern:
    ```python
    @given(
        requested_permission=st.sampled_from(['read', 'write', 'execute']),
        file_permission=st.integers(min_value=0, max_value=7)
    )
    @example(requested_permission='write', file_permission=4)  # Read-only
    @settings(max_examples=100)
    def test_permission_check(self, requested_permission, file_permission):
        """
        INVARIANT: Permission checks must validate against Unix permission bits.
        Read=4, Write=2, Execute=1 (bitwise).

        VALIDATED_BUG: Write permission granted when file_permission=4 (read-only).
        Root cause was checking (file_permission & requested_permission) instead of bit mask.
        Fixed in commit bcd890 by adding bit mask validation.

        Write requires bit 2: (permission & 2) != 0.
        permission=4 (100 binary) has no bit 2 set, should deny write.
        """
    ```

    Use max_examples=100 for permission tests (access control is important).
  </action>
  <verify>
    grep -c "permission" backend/tests/property_tests/file_operations/test_file_operations_invariants.py | head -5
  </verify>
  <done>
    Permission tests have VALIDATED_BUG sections
    Unix permission bit bugs documented
  </done>
</task>

<task type="auto">
  <name>Add bug-finding evidence to file size and validation invariants</name>
  <files>backend/tests/property_tests/file_operations/test_file_operations_invariants.py</files>
  <action>
    Enhance size validation tests with bug-finding evidence:

    1. Add VALIDATED_BUG sections for size limit bugs
    2. Document integer overflow bugs
    3. Add content type validation tests

    Example pattern:
    ```python
    @given(
        file_size=st.integers(min_value=0, max_value=10**9),
        max_file_size=st.integers(min_value=1000000, max_value=10**9)
    )
    @example(file_size=1000001, max_file_size=1000000)  # Just over limit
    @settings(max_examples=100)
    def test_file_size_validation(self, file_size, max_file_size):
        """
        INVARIANT: File sizes should be validated against upload limits.
        Files exceeding max_file_size should be rejected before processing.

        VALIDATED_BUG: File with size=1000001 was processed when max=1000000.
        Root cause was using <= instead of < for size comparison.
        Fixed in commit def901 by correcting boundary check.

        Boundary: max_file_size should be inclusive or consistently exclusive.
        Decision: exclusive (max_size is strict limit, not inclusive).
        """
    ```

    Use max_examples=100 for size validation tests (DoS prevention).
  </action>
  <verify>
    grep -c "size" backend/tests/property_tests/file_operations/test_file_operations_invariants.py | head -5
  </verify>
  <done>
    Size validation tests have VALIDATED_BUG sections
    Boundary and overflow bugs documented
  </done>
</task>

<task type="auto">
  <name>Document file operations invariants in INVARIANTS.md</name>
  <files>backend/tests/property_tests/INVARIANTS.md</files>
  <action>
    Add file operations section to INVARIANTS.md:

    ```markdown
    ## File Operations Domain

    ### Path Traversal Prevention
    **Invariant**: Path traversal attacks (../, %2e%2e) must be blocked.
    **Test**: test_path_traversal_check (test_file_operations_invariants.py)
    **Critical**: Yes (system security - arbitrary file access)
    **Bug Found**: /uploads/../../../etc/passwd passed prefix check before normalization
    **max_examples**: 200

    ### Unix Permission Validation
    **Invariant**: Permission checks validate against Unix bit masks (Read=4, Write=2, Execute=1).
    **Test**: test_permission_check
    **Critical**: Yes (access control - unauthorized file access)
    **Bug Found**: Write granted when permission=4 (read-only, missing bit 2)
    **max_examples**: 100

    ### File Size Validation
    **Invariant**: File uploads must respect size limits (DoS prevention).
    **Test**: test_file_size_validation
    **Critical**: Yes (DoS prevention)
    **Bug Found**: size=1000001 processed when max=1000000 (off-by-one)
    **max_examples**: 100
    ```

    Append to existing INVARIANTS.md (created in plan 02-01).
    Include all file operations invariants with security markings.
  </action>
  <verify>
    grep -c "File Operations Domain" backend/tests/property_tests/INVARIANTS.md
  </verify>
  <done>
    File Operations section added to INVARIANTS.md
    At least 8 file invariants documented
    Security-critical invariants marked
  </done>
</task>

</tasks>

<verification>
After completion:
1. Run file operations property tests: pytest backend/tests/property_tests/file_operations/ -v
2. Verify all tests pass with enhanced documentation
3. Check INVARIANTS.md has file operations section
4. Verify grep for VALIDATED_BUG returns at least 8 matches across file tests
</verification>

<success_criteria>
1. File property tests document bug-finding evidence (QUAL-05)
2. INVARIANTS.md includes file operations section (DOCS-02)
3. Security tests use max_examples=200
4. All enhanced tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-property-tests/02-07-SUMMARY.md`
</output>
