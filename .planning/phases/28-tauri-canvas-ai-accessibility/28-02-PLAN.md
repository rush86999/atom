---
phase: 28-tauri-canvas-ai-accessibility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend-nextjs/components/canvas/__tests__/canvas-accessibility-tree.test.tsx
  - frontend-nextjs/components/canvas/__tests__/agent-operation-tracker.test.tsx
autonomous: true

must_haves:
  truths:
    - "Canvas components render hidden accessibility divs with role='log'"
    - "Accessibility tree contains JSON-serialized canvas state"
    - "data-canvas-state attributes are present for programmatic access"
    - "Accessibility divs survive minification (Terser) in production builds"
  artifacts:
    - path: "frontend-nextjs/components/canvas/__tests__/canvas-accessibility-tree.test.tsx"
      provides: "Shared accessibility tree test utilities and helpers"
      min_lines: 50
    - path: "frontend-nextjs/components/canvas/__tests__/agent-operation-tracker.test.tsx"
      provides: "Component tests for AgentOperationTracker accessibility tree"
      min_lines: 100
  key_links:
    - from: "canvas-accessibility-tree.test.tsx"
      to: "frontend-nextjs/components/canvas/AgentOperationTracker.tsx"
      via: "Import component and test DOM rendering with React Testing Library"
      pattern: "import.*AgentOperationTracker|render.*AgentOperationTracker"
    - from: "agent-operation-tracker.test.tsx"
      to: "frontend-nextjs/components/canvas/types/index.ts"
      via: "Use type definitions for test data creation"
      pattern: "AgentOperationData|AgentOperationState|CanvasType"
---

<objective>
Create React Testing Library tests verifying canvas components render accessibility trees correctly. Focus on hidden divs with `role="log"`, `data-canvas-state` attributes, and JSON state serialization for AI agent consumption.

**Purpose:** Phase 20 implemented accessibility trees so AI agents can read canvas content without OCR. These tests verify the DOM structure survives React rendering and provides machine-readable state.

**Output:** Shared test utilities file + AgentOperationTracker component tests with 12+ test cases covering accessibility tree rendering, JSON serialization, and attribute presence.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-tauri-canvas-ai-accessibility/28-RESEARCH.md
@.planning/phases/20-canvas-ai-context/20-VERIFICATION.md
@frontend-nextjs/components/canvas/AgentOperationTracker.tsx
@frontend-nextjs/components/canvas/types/index.ts
@frontend-nextjs/components/Agents/__tests__/AgentManager.test.tsx
@frontend-nextjs/jest.config.js
</context>

<tasks>

<task type="auto">
  <name>Create accessibility tree test utilities</name>
  <files>frontend-nextjs/components/canvas/__tests__/canvas-accessibility-tree.test.tsx</files>
  <action>
    Create shared test utilities file for accessibility tree testing:

    **File: `frontend-nextjs/components/canvas/__tests__/canvas-accessibility-tree.test.tsx`**

    This file provides reusable helpers for testing canvas accessibility trees:

    1. `getAccessibilityTree(container)` - Query helper for `[role="log"]` elements
    2. `parseCanvasState(accessibilityElement)` - Parse JSON from textContent
    3. `assertCanvasDataAttributes(element, expectedAttrs)` - Verify data-* attributes
    4. `createMockOperationData(overrides)` - Factory for test data matching AgentOperationData interface
    5. `mockWebSocket()` - Mock WebSocket for canvas components

    **Implementation:**
    ```typescript
    import { within } from '@testing-library/react';
    import type { AgentOperationData } from '../AgentOperationTracker';

    export const getAccessibilityTree = (container: HTMLElement) =>
      container.querySelector('[role="log"]');

    export const parseCanvasState = (element: HTMLElement | null) => {
      if (!element) return null;
      const text = element.textContent || '';
      try {
        return JSON.parse(text);
      } catch {
        return null;
      }
    };

    export const assertCanvasDataAttributes = (
      element: HTMLElement,
      expectedAttrs: Record<string, string | number | boolean>
    ) => {
      Object.entries(expectedAttrs).forEach(([key, value]) => {
        expect(element).toHaveAttribute(`data-${key}`, String(value));
      });
    };

    export const createMockOperationData = (overrides: Partial<AgentOperationData> = {}): AgentOperationData => ({
      operation_id: 'test-op-123',
      agent_id: 'test-agent-456',
      agent_name: 'TestAgent',
      operation_type: 'test_operation',
      status: 'running',
      current_step: 'Processing test data',
      current_step_index: 1,
      total_steps: 5,
      progress: 20,
      context: {
        what: 'Testing accessibility tree',
        why: 'Verify AI agents can read canvas state',
        next: 'Complete test suite'
      },
      logs: [],
      started_at: new Date().toISOString(),
      ...overrides
    });

    export const mockWebSocket = () => ({
      socket: { addEventListener: jest.fn(), removeEventListener: jest.fn() },
      connected: false
    });
    ```

    **DO NOT:**
    - Include test cases (those are in the component test file)
    - Mock actual Tauri APIs (use standard jsdom environment)
    - Test visual rendering (CSS, pixels, animations are irrelevant)
  </action>
  <verify>
    Run: `cd frontend-nextjs && npm test -- canvas-accessibility-tree.test.tsx --verbose`
    Expected: File validates as TypeScript module, utilities can be imported
  </verify>
  <done>
    Utility file exists at `frontend-nextjs/components/canvas/__tests__/canvas-accessibility-tree.test.tsx` with 5+ helper functions for accessibility tree testing
  </done>
</task>

<task type="auto">
  <name>Create AgentOperationTracker accessibility tests</name>
  <files>frontend-nextjs/components/canvas/__tests__/agent-operation-tracker.test.tsx</files>
  <action>
    Create component test file for AgentOperationTracker accessibility tree:

    **File: `frontend-nextjs/components/canvas/__tests__/agent-operation-tracker.test.tsx`**

    **Test Structure (12+ tests):**

    1. **Accessibility Tree Presence Tests:**
       - `should render hidden accessibility div with role="log"` - Verify aria markup
       - `should render accessibility tree with correct aria-live attribute` - Verify `aria-live="polite"`
       - `should render accessibility tree with correct aria-label` - Verify `aria-label="Agent operation state"`

    2. **Data Attributes Tests:**
       - `should include data-canvas-state attribute` - Verify `data-canvas-state="agent_operation_tracker"`
       - `should include data-operation-id attribute` - Verify operation ID propagation
       - `should include data-status attribute` - Verify status propagation
       - `should include data-progress attribute` - Verify progress propagation
       - `should include all context data attributes` - Verify what/why/next context

    3. **JSON State Serialization Tests:**
       - `should serialize full operation state as JSON` - Parse textContent and verify structure
       - `should include operation_id in JSON state` - Verify key fields present
       - `should include context object in JSON state` - Verify nested serialization
       - `should include logs array in JSON state` - Verify array serialization
       - `should update JSON when operation state changes` - Test reactivity

    4. **Edge Cases:**
       - `should render loading state accessibility tree when no operation` - Verify null/undefined handling
       - `should handle missing optional fields gracefully` - Test partial data

    **Test Pattern (from RESEARCH.md):**
    ```typescript
    import { render, screen } from '@testing-library/react';
    import '@testing-library/jest-dom';
    import AgentOperationTracker from '../AgentOperationTracker';
    import { createMockOperationData, getAccessibilityTree, parseCanvasState } from './canvas-accessibility-tree.test';

    // Mock WebSocket
    jest.mock('@/hooks/useWebSocket', () => ({
      __esModule: true,
      default: () => ({ socket: null, connected: false })
    }));

    describe('AgentOperationTracker Accessibility Tree', () => {
      test('should render hidden accessibility div with role="log"', () => {
        const mockData = createMockOperationData();
        // Mock WebSocket message to set operation
        const { container } = render(<AgentOperationTracker operationId={mockData.operation_id} userId="test-user" className="" />);

        // Access accessibility tree (hidden from visual display)
        const accessibilityDiv = container.querySelector('[role="log"]');
        expect(accessibilityDiv).toBeInTheDocument();
      });

      test('should serialize full operation state as JSON', () => {
        const mockData = createMockOperationData({ operation_id: 'op-123', status: 'running' });
        const { container } = render(<AgentOperationTracker operationId="op-123" userId="test-user" />);

        const accessibilityDiv = getAccessibilityTree(container);
        const state = parseCanvasState(accessibilityDiv);

        expect(state).toMatchObject({
          operation_id: 'op-123',
          status: 'running',
          agent_name: 'TestAgent'
        });
      });
    });
    ```

    **DO NOT:**
    - Test visual rendering (colors, layout, animations are irrelevant for accessibility)
    - Test actual WebSocket connections (mock the hook)
    - Test Tauri-specific behavior (that's for Plan 03 manual verification)
  </action>
  <verify>
    Run: `cd frontend-nextjs && npm test -- agent-operation-tracker.test.tsx --verbose`
    Expected: All 12+ tests pass, coverage >80% for AgentOperationTracker
  </verify>
  <done>
    Test file exists at `frontend-nextjs/components/canvas/__tests__/agent-operation-tracker.test.tsx` with 12+ passing tests covering accessibility tree rendering, data attributes, JSON serialization, and edge cases
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
- Both test files exist in `frontend-nextjs/components/canvas/__tests__/`
- All tests pass: `npm test -- --testPathPattern="canvas-accessibility-tree|agent-operation-tracker"`
- Tests verify `role="log"` elements are present in DOM
- Tests verify JSON state is parseable from textContent
- Code coverage >80% for tested components
</verification>

<success_criteria>
- 12+ component tests pass for AgentOperationTracker
- 5+ utility functions available for testing other canvas components
- Tests confirm accessibility divs contain valid JSON
- Tests verify all required data attributes are present
- Combined test execution time <10 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/28-tauri-canvas-ai-accessibility/28-02-SUMMARY.md` with component test results, coverage metrics, and any findings about accessibility tree structure
</output>
