---
phase: 27-redis-docker-compose
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - tests/test_agent_communication.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Existing agent communication tests pass with Docker Compose Valkey"
    - "Tests can be run without external Redis (use Docker Compose services)"
    - "No test code changes required (existing tests already mock Redis)"
    - "Integration tests demonstrate Redis pub/sub functionality"
  artifacts:
    - path: "tests/test_agent_communication.py"
      provides: "Test coverage for agent communication with Redis"
      min_lines: 900
  key_links:
    - from: "tests/test_agent_communication.py::TestRedisPubSub"
      to: "docker-compose-personal.yml:valkey"
      via: "pytest with docker-compose services"
      pattern: "redis_url=\"redis://localhost:6379/0\""
---

<objective>
Verify agent communication tests pass with Docker Compose Valkey service.

Purpose: Validate that the Valkey integration works correctly with existing test suite. Ensure developers can run full test suite without external Redis.

Output: Passing test results for agent communication with Valkey.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/27-redis-docker-compose/27-CONTEXT.md
@tests/test_agent_communication.py
@core/agent_communication.py
@.planning/phases/27-redis-docker-compose/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Run agent communication tests with Valkey</name>
  <files>tests/test_agent_communication.py</files>
  <action>
    Run the agent communication test suite to verify Redis integration:

    1. First, start Docker Compose with Valkey service:
       ```bash
       docker-compose -f docker-compose-personal.yml up -d valkey
       ```

    2. Wait for Valkey to be healthy:
       ```bash
       docker-compose -f docker-compose-personal.yml ps valkey
       ```

    3. Run the full agent communication test suite:
       ```bash
       cd /Users/rushiparikh/projects/atom/backend
       pytest tests/test_agent_communication.py -v
       ```

    4. Verify specifically that Redis-related tests pass:
       ```bash
       pytest tests/test_agent_communication.py::TestRedisPubSub -v
       ```

    5. If any tests fail, investigate the failure:
       - Check if Valkey is running: `docker-compose ps valkey`
       - Check if tests expect localhost:6379 (may need port forwarding)
       - Review test error messages for connection issues

    NOTE: The existing tests use mocks for Redis (AsyncMock), so they should pass without actual Redis. The value here is verifying the tests still pass and documenting the setup.

    DO NOT modify test files unless absolutely necessary for Docker Compose integration
    DO document any test failures and resolution in the SUMMARY
  </action>
  <verify>pytest tests/test_agent_communication.py -v shows all 35 tests passing</verify>
  <done>All 35 agent communication tests pass, Redis integration tests verified</done>
</task>

<task type="auto">
  <name>Create docker-compose test helper script</name>
  <files>backend/tests/docker-compose-test-helper.sh</files>
  <action>
    Create a helper script for running tests with Docker Compose services:

    Create `backend/tests/docker-compose-test-helper.sh`:

    ```bash
    #!/bin/bash
    # Helper script to run tests with Docker Compose services (Valkey, etc.)
    #
    # Usage: ./tests/docker-compose-test-helper.sh [test_file]
    #
    # Examples:
    #   ./tests/docker-compose-test-helper.sh test_agent_communication.py
    #   ./tests/docker-compose-test-helper.sh  # Run all tests

    set -e

    # Colors for output
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    RED='\033[0;31m'
    NC='\033[0m' # No Color

    echo -e "${YELLOW}Starting Docker Compose services for testing...${NC}"

    # Start Valkey service from Personal Edition
    cd "$(dirname "$0")/.."
    docker-compose -f docker-compose-personal.yml up -d valkey

    # Wait for Valkey to be healthy
    echo -e "${YELLOW}Waiting for Valkey to be healthy...${NC}"
    timeout 30 bash -c 'until docker-compose -f docker-compose-personal.yml ps valkey | grep -q "healthy"; do sleep 1; done'

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Valkey is healthy!${NC}"
    else
        echo -e "${RED}Valkey health check timed out${NC}"
        docker-compose -f docker-compose-personal.yml logs valkey
        exit 1
    fi

    # Run tests
    echo -e "${YELLOW}Running tests...${NC}"
    if [ -n "$1" ]; then
        pytest "tests/$1" -v
    else
        pytest tests/ -v
    fi

    TEST_RESULT=$?

    # Optionally: keep services running for debugging
    echo -e "${YELLOW}Tests completed with exit code: $TEST_RESULT${NC}"
    echo -e "${YELLOW}Docker Compose services still running. Stop with: docker-compose -f docker-compose-personal.yml down${NC}"

    exit $TEST_RESULT
    ```

    Make executable:
    ```bash
    chmod +x backend/tests/docker-compose-test-helper.sh
    ```

    This helper provides a convenient way for developers to run tests that require Docker Compose services.
  </action>
  <verify>test -x backend/tests/docker-compose-test-helper.sh && ./backend/tests/docker-compose-test-helper.sh test_agent_communication.py</verify>
  <done>Helper script created, executable, and runs tests with Docker Compose Valkey service</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Verify all tests pass:
   ```bash
   pytest tests/test_agent_communication.py -v --tb=short
   ```

2. Verify helper script works:
   ```bash
   ./tests/docker-compose-test-helper.sh test_agent_communication.py
   ```

3. Confirm Valkey is accessible:
   ```bash
   docker-compose -f docker-compose-personal.yml exec valkey redis-cli ping
   # Expected output: PONG
   ```

4. Verify test coverage:
   ```bash
   pytest tests/test_agent_communication.py --cov=core.agent_communication --cov-report=term-missing
   ```
</verification>

<success_criteria>
- [ ] All 35 agent communication tests pass
- [ ] Test helper script created and executable
- [ ] Helper script successfully starts Valkey and runs tests
- [ ] Valkey service responds to redis-cli ping
- [ ] No test code modifications required (existing mocks work)
- [ ] Test run documented in SUMMARY with results
</success_criteria>

<output>
After completion, create `.planning/phases/27-redis-docker-compose/27-02-SUMMARY.md` with:
- Test execution results (pass/fail counts)
- Any test failures and resolutions
- Helper script documentation
- Valkey connectivity verification results
</output>
