---
phase: 27-redis-docker-compose
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose-personal.yml
  - .env.personal
autonomous: true
user_setup: []

must_haves:
  truths:
    - "docker-compose up includes Valkey service on port 6379"
    - "Backend can connect to Valkey via REDIS_URL environment variable"
    - "No external Redis dependency required for Personal Edition"
    - "In-memory configuration (no persistence volume) for development"
    - "Valkey container has health check for startup detection"
  artifacts:
    - path: "docker-compose-personal.yml"
      provides: "Valkey service definition"
      contains: "valkey/valkey:latest"
    - path: ".env.personal"
      provides: "REDIS_URL environment variable"
      contains: "REDIS_URL=redis://valkey:6379"
  key_links:
    - from: "docker-compose-personal.yml:atom-backend"
      to: "valkey:6379"
      via: "depends_on and REDIS_URL environment variable"
      pattern: "REDIS_URL=redis://valkey:6379"
    - from: "core/agent_communication.py"
      to: "valkey:6379"
      via: "REDIS_URL environment variable"
      pattern: "self._redis_url = redis_url or os.getenv\\(\"REDIS_URL\"\\)"
---

<objective>
Add Valkey (Redis-compatible database) to Docker Compose for local development.

Purpose: Enable agent communication via Redis pub/sub without external dependency. Remove need for developers to run Redis separately.

Output: Updated docker-compose-personal.yml with valkey service, .env.personal with REDIS_URL.
</objective>

<execution_context>
@/Users/rushiparikh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rushiparikh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/27-redis-docker-compose/27-CONTEXT.md
@docker-compose-personal.yml
@.env.personal
@core/agent_communication.py
</context>

<tasks>

<task type="auto">
  <name>Add Valkey service to docker-compose-personal.yml</name>
  <files>docker-compose-personal.yml</files>
  <action>
    Add valkey service to docker-compose-personal.yml:

    1. Add new service named "valkey" after atom-backend service (before atom-frontend):
       - image: valkey/valkey:latest (per user decision - use latest for simplicity)
       - container_name: atom-personal-valkey
       - ports: "6379:6379" (default Redis port, no code changes needed)
       - healthcheck: CMD ["redis-cli", "ping"] with interval/timeout/retries
       - restart: unless-stopped
       - NO volumes (in-memory only per user decision for Personal Edition)
       - NO command (default Valkey startup)

    2. Update atom-backend service:
       - Add environment variable: REDIS_URL=redis://valkey:6379
       - Add depends_on: valkey (with condition: service_healthy)

    3. Add comment explaining Valkey is Redis-compatible and why in-memory only

    DO NOT add persistence volumes (per CONTEXT.md decision - Personal Edition is in-memory only)
    DO NOT change port from 6379 (existing code expects this)
  </action>
  <verify>grep -A 10 "valkey:" docker-compose-personal.yml shows service definition with valkey/valkey:latest image</verify>
  <done>Valkey service defined in docker-compose-personal.yml with healthcheck, backend depends_on valkey with REDIS_URL set</done>
</task>

<task type="auto">
  <name>Add REDIS_URL to .env.personal template</name>
  <files>.env.personal</files>
  <action>
    Add REDIS_URL to .env.personal:

    1. Add new section after "LANCEDB_PATH" section:
       ```
       # ==============================================================================
       # REDIS-ENABLED AGENT COMMUNICATION (Personal Edition includes Valkey)
       # ==============================================================================
       # Valkey (Redis-compatible) runs via Docker Compose
       # No external Redis required - comes with Personal Edition
       REDIS_URL=redis://valkey:6379
       ```

    2. Add comment that Valkey is included in Personal Edition docker-compose

    DO NOT change any existing values
    DO NOT add to .env (only .env.personal template)
  </action>
  <verify>grep "REDIS_URL=redis://valkey:6379" .env.personal returns the line</verify>
  <done>REDIS_URL documented in .env.personal template with docker service reference</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Validate docker-compose syntax:
   ```bash
   docker-compose -f docker-compose-personal.yml config
   ```

2. Verify service definitions:
   ```bash
   docker-compose -f docker-compose-personal.yml ps --all
   ```

3. Confirm Valkey accessible from backend:
   ```bash
   docker-compose -f docker-compose-personal.yml run atom-backend python -c "import os; print(os.getenv('REDIS_URL'))"
   ```

4. Verify existing tests still pass (no code changes required):
   ```bash
   pytest tests/test_agent_communication.py -v -k "test_redis_disabled_by_env or test_redis_fallback_to_in_memory"  # Should still work
   ```
</verification>

<success_criteria>
- [ ] docker-compose-personal.yml includes valkey service with valkey/valkey:latest image
- [ ] Valkey service has healthcheck using redis-cli ping
- [ ] Backend atom-backend service has REDIS_URL=redis://valkey:6379 environment variable
- [ ] Backend depends_on valkey with service_healthy condition
- [ ] .env.personal documents REDIS_URL with explanation
- [ ] docker-compose config validates without errors
- [ ] No code changes required to agent_communication.py (already reads REDIS_URL env var)
</success_criteria>

<output>
After completion, create `.planning/phases/27-redis-docker-compose/27-01-SUMMARY.md` with:
- Valkey service configuration details
- Any deviations from CONTEXT.md decisions
- docker-compose validation output
</output>
